#===== FILE: ABSORB.rb =====#
#-------------------------------------------------------------------------------
#  Giga Drain
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GIGADRAIN) do
  EliteBattle.playMoveAnimation(:ABSORB, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, "giga")
end
#-------------------------------------------------------------------------------
#  Mega Drain
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MEGADRAIN) do
  EliteBattle.playMoveAnimation(:ABSORB, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, "mega")
end
#-------------------------------------------------------------------------------
#  Absorb
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ABSORB) do | args |
  type = args[0]; type = "absorb" if type.nil?
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width, @viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(100,166,94)) if type == "mega"
  fp["bg"].opacity = 0
  ext = ["eb210","eb210_2"]
  ext = ["eb210","eb207"] if type == "mega"
  ext = ["eb200"] if type == "giga"
  cxT, cyT = @targetSprite.getCenter(true)
  cxP, cyP = @userSprite.getCenter(true)
  mx = !@targetIsPlayer ? (cxT-cxP)/2 : (cxP-cxT)/2
  mx += @targetIsPlayer ? cxT : cxP
  my = !@targetIsPlayer ? (cyP-cyT)/2 : (cyT-cyP)/2
  my += @targetIsPlayer ? cyP : cyT
  curves = []
  zoom = []
  frames = ["giga","mega"].include?(type) ? 32 : 16
  factor = (type == "giga" ? 2 : 1)
  pbSEPlay("Anim/Absorb2", factor==2 ? 100 : 80)
  for j in 0...frames
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/"+ext[rand(ext.length)])
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cxT
    fp["#{j}"].y = cyT
    z = [1,0.75,0.5,0.25][rand(4)]
    fp["#{j}"].zoom_x = z*@userSprite.zoom_x
    fp["#{j}"].zoom_y = z*@userSprite.zoom_y
    v = type == "mega" ? 1 : 0
    ox = -16*factor + rand(32*factor) - 32*v + rand(64*v)
    oy = -16*factor + rand(32*factor) - 32*v + rand(64*v)
    vert = rand(96)*(rand(2)==0 ? 1 : -1)*(factor**2)
    fp["#{j}"].z = 50
    fp["#{j}"].opacity = 0
    curve = calculateCurve(cxT+ox,cyT+oy,mx,my+vert+oy,cxP+ox,cyP+oy,32)
    curves.push(curve)
    zoom.push(z)
  end
  max = type == "giga" ? 16 : 8
  for j in 0...max
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/ebHealing")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    fp["s#{j}"].zoom_x = @userSprite.zoom_x
    fp["s#{j}"].zoom_y = @userSprite.zoom_x
    cx, cy = @userSprite.getCenter(true)
    fp["s#{j}"].x = cx - 48*@userSprite.zoom_x + rand(96)*@userSprite.zoom_x
    fp["s#{j}"].y = cy - 48*@userSprite.zoom_y + rand(96)*@userSprite.zoom_y
    fp["s#{j}"].visible = false
    fp["s#{j}"].z = 51
  end
  @sprites["battlebg"].defocus
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 128
    for j in 0...frames
      next if j>i/(32/frames)
      k = i - j*(32/frames)
      fp["#{j}"].visible = false if k >= frames
      k = frames - 1 if k >= frames
      k = 0 if k < 0
      if type == "giga"
        fp["#{j}"].tone.red += 4
        fp["#{j}"].tone.blue += 4
        fp["#{j}"].tone.green += 4
      end
      fp["#{j}"].x = curves[j][k][0]
      fp["#{j}"].y = curves[j][k][1]
      fp["#{j}"].opacity += (k < 16) ? 64 : -16
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x*zoom[j])*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y*zoom[j])*0.1
    end
    for k in 0...max
      next if type == "absorb"
      next if i < frames/2
      next if k>(i-frames/2)/(16/max)
      fp["s#{k}"].visible = true
      fp["s#{k}"].opacity -= 16
      fp["s#{k}"].y -= 2
    end
    if type == "giga"
      @userSprite.tone.red += 8 if @userSprite.tone.red < 128
      @userSprite.tone.green += 8 if @userSprite.tone.green < 128
      @userSprite.tone.blue += 8 if @userSprite.tone.blue < 128
    end
    pbSEPlay("Anim/Recovery",80) if type != "absorb" && i == (frames/2)
    @scene.wait(1,true)
  end
  for i in 0...8
    fp["bg"].opacity -= 16
    if type == "giga"
      @userSprite.tone.red -= 16
      @userSprite.tone.green -= 16
      @userSprite.tone.blue -= 16
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: ACROBATICS.rb =====#
#-------------------------------------------------------------------------------
#  ACROBATICS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ACROBATICS) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_4")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_4")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(41,145,182,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  #animation
  for i in 0...50
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i*3)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    for j in 0...50
      next if j>(i*3)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: AEROBLAST.rb =====#
#-------------------------------------------------------------------------------
#  AEROBLAST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AEROBLAST) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb263_bg_4")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_4")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_3_4")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_2")
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/HyperBeam") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: AIRSLASH.rb =====#
#-------------------------------------------------------------------------------
#  Air Slash
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AIRSLASH) do
  # inital configuration
  pbSEPlay("EBDX/Anim/flying1",80)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16, true)
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}
  cx, cy = @targetSprite.getCenter(true)
  da = []; dx = []; dy = []; doj = []
  for i in 0...32
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb159_2")
    fp["#{i}"].ox = 12
    fp["#{i}"].oy = 1
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = @targetSprite.z + 1
    r = 128*factor
    z = [1,1.25,0.75,1.5][rand(4)]
    fp["#{i}"].zoom_x = z
    #fp["#{i}"].zoom_y = factor
    fp["#{i}"].x = cx
    fp["#{i}"].y = cy
    fp["#{i}"].tone = Tone.new(255,255,255)
    da.push(rand(2)==0 ? 1 : -1)
    dx.push(cx - r + rand(r*2))
    dy.push(cy - r + rand(r*2))
    doj.push(rand(4)+1)
  end
  fp["slash"] = Sprite.new(@viewport)
  fp["slash"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb159")
  fp["slash"].ox = fp["slash"].bitmap.width/2
  fp["slash"].oy = fp["slash"].bitmap.height/2
  fp["slash"].x = cx
  fp["slash"].y = cy
  #fp["slash"].zoom_x = factor
  #fp["slash"].zoom_y = factor
  fp["slash"].z = @targetSprite.z
  fp["slash"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/normal3",80)
  # start animation
  shake = 2
  for i in 0...48
    fp["slash"].src_rect.height += 48 if i < 8
    for j in 0...32
      fp["#{j}"].angle += 32*da[j]
      fp["#{j}"].tone.red -= 8 if fp["#{j}"].tone.red > 0
      fp["#{j}"].tone.green -= 8 if fp["#{j}"].tone.green > 0
      fp["#{j}"].tone.blue -= 8 if fp["#{j}"].tone.blue > 0
      fp["#{j}"].opacity += 16*(i < 24 ? 4 : -1*doj[j])
      fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.05
      fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.05
    end
    if i >= 4
      fp["slash"].tone.red += 16 if fp["slash"].tone.red < 255
      fp["slash"].tone.green += 16 if fp["slash"].tone.green < 255
      fp["slash"].tone.blue += 16 if fp["slash"].tone.blue < 255
      fp["slash"].opacity -= 32 if i >= 8
    end
    if i >= 8
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: ALLYSWITCH.rb =====#
#-------------------------------------------------------------------------------
#  HEARTSWAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEARTSWAP) do
  EliteBattle.playMoveAnimation(:ALLYSWITCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ALLYSWITCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ALLYSWITCH) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["change1"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_3"))
  fp["change1"].keyFrame = 1
  fp["change1"].z = @targetSprite.z + 1
  fp["change2"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_3"))
  fp["change2"].keyFrame = 1
  fp["change2"].z = @userSprite.z + 1
  # shooting out the change1
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["change1"].x = points[i][0]
    fp["change1"].y = points[i][1]
    z = 1 + (1-(fp["change1"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change1"].zoom_x = z
    fp["change1"].zoom_y = z
    fp["change1"].update
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxT,cyT,mx,32,cxP,cyP,24)
    fp["change2"].x = points[i][0]
    fp["change2"].y = points[i][1]
    z = 1 + (1-(fp["change2"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change2"].zoom_x = z
    fp["change2"].zoom_y = z
    fp["change2"].update
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  pbSEPlay("Anim/Saint7")
  @targetSprite.color = Color.new(255,230,255,0)
  @userSprite.color = Color.new(255,230,255,0)
  fp["change1"].dispose
  fp["change2"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha += 18
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_4")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  for j in 0...32
    fp["p2#{j}"] = Sprite.new(@viewport)
    fp["p2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_4")
    fp["p2#{j}"].center!
    fp["p2#{j}"].x, fp["p2#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p2#{j}"].end_x = fp["p2#{j}"].x - r + x
    fp["p2#{j}"].end_y = fp["p2#{j}"].y - r + y
    fp["p2#{j}"].zoom_x = 0
    fp["p2#{j}"].zoom_y = 0
    fp["p2#{j}"].angle = rand(360)
    fp["p2#{j}"].z = @userSprite.z + 1
  end
  # sparkle animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
	  
	  fp["p2#{j}"].zoom_x += (1.6 - fp["p2#{j}"].zoom_x)*0.1
      fp["p2#{j}"].zoom_y += (1.6 - fp["p2#{j}"].zoom_y)*0.1
      fp["p2#{j}"].x += (fp["p2#{j}"].end_x - fp["p2#{j}"].x)*0.1
      fp["p2#{j}"].y += (fp["p2#{j}"].end_y - fp["p2#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
	  if fp["p2#{j}"].zoom_x >= 1
        fp["p2#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
      fp["p2#{j}"].color.alpha -= 8
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha -= 16 if i >= 48
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: ANCIENTPOWER.rb =====#
#-------------------------------------------------------------------------------
#  ANCIENTPOWER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ANCIENTPOWER) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["rock"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb504_3"))
  fp["rock"].keyFrame = 1
  fp["rock"].z = @targetSprite.z + 1
  # shooting out the rock
  pbSEPlay("Anim/Psych Up")
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-20,cxT,cyT,24)
    fp["rock"].x = points[i][0]
    fp["rock"].y = points[i][1]
    z = 1 + (1-(fp["rock"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["rock"].zoom_x = z
    fp["rock"].zoom_y = z
    fp["rock"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @targetSprite.color = Color.new(112,81,41,0)
  fp["rock"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504_4")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  for j in 0...24
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504_5")
    fp["c#{j}"].center!
    fp["c#{j}"].x, fp["c#{j}"].y = @targetSprite.getCenter(true)
    #fp["c#{j}"].y -= (@targetSprite.bitmap.height*0.5)*@userSprite.zoom_y
    r = (48 + rand(32))*@targetSprite.zoom_x
    fp["c#{j}"].end_x = fp["c#{j}"].x - r + rand(r*2)
    fp["c#{j}"].end_y = fp["c#{j}"].y - r + rand(r*2)#(52 - rand(64))*@targetSprite.zoom_y
    fp["c#{j}"].zoom_x = 0
    fp["c#{j}"].zoom_y = 0
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].z = @targetSprite.z + 1
    fp["c#{j}"].toggle = 1.2 + rand(10)/10.0
    fp["c#{j}"].visible = bomb
  end
  # poison animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/rock2") if i%8 == 0
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
    for j in 0...24
      next if j > i
      fp["c#{j}"].x += (fp["c#{j}"].end_x - fp["c#{j}"].x)*0.1
      fp["c#{j}"].y += (fp["c#{j}"].end_y - fp["c#{j}"].y)*0.1
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].toggle = -1 if fp["c#{j}"].opacity >= 255
      fp["c#{j}"].zoom_x += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_x)*0.1
      fp["c#{j}"].zoom_y += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_y)*0.1
	  if fp["c#{j}"].zoom_x >= 0.5
        fp["c#{j}"].opacity -= 20
      end
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: AQUAJET.rb =====#
#-------------------------------------------------------------------------------
#  LIQUIDATION
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LIQUIDATION) do | args |
  EliteBattle.playMoveAnimation(:AQUAJET, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  AQUAJET
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AQUAJET) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,75,131))
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("Anim/Water2",100) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Water1",100)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playCommonAnimation(:WHIRLPOOL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: AQUARING.rb =====#
#-------------------------------------------------------------------------------
#  AQUARING
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AQUARING) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,78,131))
  fp["bg"].opacity = 0
  # circles
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb536_2")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = @userSprite.z + 1
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 1 : 0.8)
  fp["cir"].zoom_y = (@targetIsPlayer ? 2 : 1.2)
  fp["cir"].opacity = 0
  fp["cir2"] = Sprite.new(@viewport)
  fp["cir2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb536_2")
  fp["cir2"].ox = fp["cir2"].bitmap.width/2
  fp["cir2"].oy = fp["cir2"].bitmap.height/2
  fp["cir2"].z = @userSprite.z + 1
  fp["cir2"].mirror = @userIsPlayer
  fp["cir2"].zoom_x = (@targetIsPlayer ? 0.75 : 0.6)
  fp["cir2"].zoom_y = (@targetIsPlayer ? 1 : 0.8)
  fp["cir2"].opacity = 0
  # water
  fp["water"] = Sprite.new(@viewport)
  fp["water"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb536")
  fp["water"].ox = fp["water"].bitmap.width/2
  fp["water"].oy = fp["water"].bitmap.height/2
  fp["water"].z = @userSprite.z + 1
  fp["water"].mirror = @userIsPlayer
  fp["water"].zoom_x = (@targetIsPlayer ? 1 : 0.8)
  fp["water"].zoom_y = (@targetIsPlayer ? 1 : 0.8)
  fp["water"].opacity = 0
  # user
  @userSprite.color = Color.new(51,153,255,0)
  shake = 4; k = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...40
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 24
	  fp["cir2"].x, fp["cir2"].y = @userSprite.getCenter
      fp["cir2"].angle -= 24*(@userIsPlayer ? -1 : 1)
      fp["cir2"].opacity += 24
	  fp["water"].x, fp["water"].y = @userSprite.getCenter
      fp["water"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["water"].opacity += 24
    end
    if i == 8
      @vector.set(vector2)
      pbSEPlay("Anim/Water3",80)
    end
	pbSEPlay("Anim/Bubble1",80) if i == 16
	if i < 20
      @userSprite.color.alpha += 10
    else
      @userSprite.color.alpha -= 16
    end
    fp["bg"].update
	#@userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    if i > 0
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity -= 30
      fp["cir"].x = cx
      fp["cir"].y = cy
	  fp["cir2"].angle -= 24*(@userIsPlayer ? -1 : 1)
      fp["cir2"].opacity -= 30
      fp["cir2"].x = cx
      fp["cir2"].y = cy
	  fp["water"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["water"].opacity -= 30
      fp["water"].x = cx
      fp["water"].y = cy
    end
  end
  16.times do
    fp["bg"].update
    fp["bg"].opacity -= 16
    fp["cir2"].opacity -= 16
    fp["water"].opacity -= 16
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: AQUATAIL.rb =====#
#-------------------------------------------------------------------------------
#  AQUATAIL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AQUATAIL) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632_7")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_0")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  # start animation
  k = 1
  for i in 0...32
    pbSEPlay("Anim/Bubble1",100) if i==4
	pbSEPlay("EBDX/Anim/iron2",80) if i == 4
	pbSEPlay("EBDX/Anim/normal4",80) if i == 4
	pbSEPlay("Anim/Bubble2",100) if i==15
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: ASTONISH.rb =====#
#-------------------------------------------------------------------------------
#  ASTONISH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ASTONISH) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632_3")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_9")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb176_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  # start animation
  k = 1
  for i in 0...32
    #pbSEPlay("EBDX/Anim/normal4",80) if i == 4
    pbSEPlay("EBDX/Anim/ground1",80) if i == 4
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: ATTRACT.rb =====#
#-------------------------------------------------------------------------------
#  HEARTSTAMP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEARTSTAMP) do
  EliteBattle.playMoveAnimation(:ATTRACT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ATTRACT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ATTRACT) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  factor = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(223,67,67))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb636_2")
    fp["#{i}"].src_rect.set(0,0*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Love",80) if i%12==0 && i <= 96
    if i >= 96
      @targetSprite.tone.all += 1.4*2 if @targetSprite.tone.all < 48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  #heart splatter
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb636_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
	factor[j] = rand(1)
    #fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/LoveSplatter") if i == 1
    for j in 0...32
	  next if !bomb
      next if i < 8
      next if j > (i-8)*2
	  if factor[j] == 0 || true
		  fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.03
		  fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.03
	  else
	  	  fp["p#{j}"].zoom_x += (1.0 - fp["p#{j}"].zoom_x)*0.03
		  fp["p#{j}"].zoom_y += (1.0 - fp["p#{j}"].zoom_y)*0.03
	  end
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 0.8
        fp["p#{j}"].opacity -= 25
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  20.times do
    @targetSprite.tone.all -= 1.6*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @targetSprite.tone.all = 0
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: AURASPHERE.rb =====#
#-------------------------------------------------------------------------------
#  Aura Sphere
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AURASPHERE) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb093_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = @userSprite.z + 1
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 0.75 : 1)
  fp["cir"].zoom_y = (@targetIsPlayer ? 0.75 : 1)
  fp["cir"].opacity = 0
  shake = 4; k = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...40
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 24
    end
    if i == 8
      @vector.set(vector2)
      pbSEPlay("Anim/eb_grass2",80)
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_2")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  fp["shot"] = Sprite.new(@viewport)
  fp["shot"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_3")
  fp["shot"].ox = fp["shot"].bitmap.width/2
  fp["shot"].oy = fp["shot"].bitmap.height/2
  fp["shot"].z = @userSprite.z + 1
  fp["shot"].zoom_x = @userSprite.zoom_x
  fp["shot"].zoom_y = @userSprite.zoom_x
  fp["shot"].opacity = 0
  x = defaultvector[0]; y = defaultvector[1]
  x2, y2 = @vector.spoof(defaultvector)
  fp["shot"].x = cx
  fp["shot"].y = cy
  pbSEPlay("EBDX/Anim/normal5",80)
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    @vector.reset if i == 0
    if i > 0
      fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
      fp["shot"].opacity += 32
      fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
      fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity -= 16
      fp["cir"].x = cx
      fp["cir"].y = cy
    end
    fp["bg"].update
    factor = @targetSprite.zoom_x if i == 12
    if i >= 12
      k *= -1 if i%4==0
      @targetSprite.zoom_x -= factor*0.01*k
      @targetSprite.zoom_y += factor*0.04*k
      @targetSprite.still
    end
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,i < 12)
  end
  shake = 2
  16.times do
    fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
    fp["shot"].opacity += 32
    fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
    fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
    fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
    fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
    fp["bg"].color.alpha += 16
    fp["bg"].update
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
    @targetSprite.still
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  16.times do
    fp["bg"].update
    @targetSprite.still
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].update
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: AURORABEAM.rb =====#
#-------------------------------------------------------------------------------
#  Aurora Beam
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AURORABEAM) do
  # inital configuration
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}; rndx = []; rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width, @viewport.height)
  fp["bg"].bitmap.fill_rect(0, 0, fp["bg"].bitmap.width, fp["bg"].bitmap.height, Color.black)
  fp["bg"].opacity = 0
  for i in 0...36
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb246")
    fp["#{i}"].src_rect.set(44*rand(4),0,44,44)
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/8
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(8))
    rndy.push(rand(8))
  end
  # start animation
  pbSEPlay("Anim/Psych Up")
  @sprites["battlebg"].defocus
  for i in 0...128
    pbSEPlay("Anim/Ice1", 75) if i%8==0
    cx, cy = @targetSprite.getCenter(true)
    ax, ay = @userSprite.getAnchor
    for j in 0...36
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay
      end
      next if j>(i/2)
      x2 = cx - 4*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 4*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].angle += 2
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].angle += 2
      else
        fp["#{j}"].opacity += 12
      end
    end
    if i >= 96
      fp["bg"].opacity -= 10
    else
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.7
    end
    if i >= 72
      if i >= 96
        @targetSprite.tone.red -= 4.8/2
        @targetSprite.tone.green -= 4.8/2
        @targetSprite.tone.blue -= 4.8/2
      else
        @targetSprite.tone.red += 4.8 if @targetSprite.tone.red < 96
        @targetSprite.tone.green += 4.8 if @targetSprite.tone.green < 96
        @targetSprite.tone.blue += 4.8 if @targetSprite.tone.blue < 96
      end
      @targetSprite.still
    end
    @vector.set(vector) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @targetSprite.tone = Tone.new(0,0,0,0)
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: AUTOTOMIZE.rb =====#
#-------------------------------------------------------------------------------
#  AUTOTOMIZE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AUTOTOMIZE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_1")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(192,192,192,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: AVALANCHE.rb =====#
#-------------------------------------------------------------------------------
#  AVALANCHE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AVALANCHE) do
  indexes = []
  max = @battle.pbSideSize(@targetIsPlayer ? 0 : 1)
  for i in 0...max
    i = (@targetIsPlayer ? i*2 : (i*2 + 1))
    indexes.push(i) if @sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].actualBitmap
  end
  vector = @scene.battle.doublebattle? ? EliteBattle.get_vector(:BATTLER, @targetIsPlayer) : @scene.getRealVector(@targetIndex, @targetIsPlayer)
  @vector.set(vector)
  @scene.wait(16, true)
  # set up animation
  dy = @vector.y2/12
  fp = {}; da = []; factors = []
  for m in 0...indexes.length
    @targetSprite = @sprites["pokemon_#{indexes[m]}"]
    if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
      factors.push(1)
      next
    end
    factors.push(@targetSprite.zoom_x)
  end
  for m in 0...indexes.length
    @targetSprite = @sprites["pokemon_#{indexes[m]}"]
    next if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
    for j in 0...96
      fp["r#{m}#{j}"] = Sprite.new(@viewport)
      fp["r#{m}#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb631")
      fp["r#{m}#{j}"].ox = fp["r#{m}#{j}"].bitmap.width/2
      fp["r#{m}#{j}"].oy = fp["r#{m}#{j}"].bitmap.height/2
      r = 64*factors[m]
      z = [1,0.5,0.75,0.25][rand(4)]
      fp["r#{m}#{j}"].zoom_x = z
      fp["r#{m}#{j}"].zoom_y = z
      fp["r#{m}#{j}"].x = @targetSprite.x - r + rand(r*2)
      fp["r#{m}#{j}"].y = rand(32*factors[m])
      fp["r#{m}#{j}"].visible = false
      fp["r#{m}#{j}"].angle = rand(360)
      fp["r#{m}#{j}"].z = @targetSprite.z + 1
      da.push(rand(2)==0 ? 1 : -1)
    end
    width = @targetSprite.bitmap.width/2 - 16
    max = 16# + (width/16)
    for j in 0...max
      fp["d#{m}#{j}"] = Sprite.new(@viewport)
      fp["d#{m}#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/ebDustParticle")
      fp["d#{m}#{j}"].ox = fp["d#{m}#{j}"].bitmap.width/2
      fp["d#{m}#{j}"].oy = fp["d#{m}#{j}"].bitmap.height/2
      fp["d#{m}#{j}"].opacity = 0
      fp["d#{m}#{j}"].angle = rand(360)
      fp["d#{m}#{j}"].x = @targetSprite.x - width*factors[m] + rand(width*2*factors[m])
      fp["d#{m}#{j}"].y = @targetSprite.y - 16*factors[m] + rand(32*factors[m])
      fp["d#{m}#{j}"].z = @targetSprite.z + (fp["d#{m}#{j}"].y < @targetSprite.y ? -1 : 1)
      zoom = [1,0.8,0.9,0.7][rand(4)]
      fp["d#{m}#{j}"].zoom_x = zoom*factors[m]
      fp["d#{m}#{j}"].zoom_y = zoom*factors[m]
    end
  end
  k = [-1,-1]
  # start animation
  for i in 0...80
    pbSEPlay("EBDX/Anim/rock2",70) if i%8==0
    for m in 0...indexes.length
      @targetSprite = @sprites["pokemon_#{indexes[m]}"]
      next if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
      for j in 0...96
        next if j>(i*2)
        fp["r#{m}#{j}"].y += dy
        fp["r#{m}#{j}"].visible = fp["r#{m}#{j}"].y < @targetSprite.y - 16*factors[m]
        fp["r#{m}#{j}"].angle += 8*da[j]
      end
      for j in 0...max
        next if i < 8
        next if j>(i-8)/2
        fp["d#{m}#{j}"].opacity += 25.5 if i < 18+j*2
        fp["d#{m}#{j}"].opacity -= 25.5 if i >= 22+j*2
        if fp["d#{m}#{j}"].x >= @targetSprite.x
          fp["d#{m}#{j}"].angle += 4
          fp["d#{m}#{j}"].x += 2
        else
          fp["d#{m}#{j}"].angle -= 4
          fp["d#{m}#{j}"].x -= 2
        end
      end
      if i >= 8 && i < 64
        k[m] *= -1 if i%4==0
        @targetSprite.zoom_y -= 0.04*k[m]*factors[m]
        @targetSprite.zoom_x += 0.02*k[m]*factors[m]
        @targetSprite.still
      end
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: BABYDOLLEYES.rb =====#
#-------------------------------------------------------------------------------
#  BABYDOLLEYES
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BABYDOLLEYES) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(5,true)
  fp = {}
  cx, cy = @userSprite.getCenter(true)
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.white)
  fp["bg"].opacity = 0
  #eyes
  fp["l"] = Sprite.new(@viewport)
  fp["l"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_7")
  fp["l"].ox = fp["l"].bitmap.width/2
  fp["l"].oy = fp["l"].bitmap.height/2
  if @userIsPlayer
  # fp["l"].x = cx + @userSprite.width/2 + 50
  # fp["l"].y = cy - @userSprite.height/2 - 5
	# fp["l"].x = 212
    # fp["l"].y = 245
	fp["l"].x = cx + 100
    fp["l"].y = cy - 50
  else 
	# fp["l"].x = 230
    # fp["l"].y = 200	
	fp["l"].x = cx - 65
    fp["l"].y = cy + 58
  end
  fp["l"].opacity = 0
  fp["l"].z = 29#(@userIsPlayer ? 29 : 19)
  fp["r"] = Sprite.new(@viewport)
  fp["r"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_7")
  fp["r"].ox = fp["r"].bitmap.width/2
  fp["r"].oy = fp["r"].bitmap.height/2
  if @userIsPlayer
  # fp["r"].x = cx + @userSprite.width/2 + 90
  # fp["r"].y = cy - @userSprite.height/2 - 5
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  else 
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  end
  fp["r"].opacity = 0
  fp["r"].z = 29#(@userIsPlayer ? 29 : 19)
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...19
	pbSEPlay("Anim/Leer",80) if i == 5
    @userSprite.still
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
	if i.between?(2,10)
		fp["l"].opacity += 20
		fp["r"].opacity += 20
	end
	if i.between?(11,19)
		fp["l"].opacity -= 20
		fp["r"].opacity -= 20
	end	
	fp["l"].angle += 15
	fp["r"].angle += 15
	if i.between?(2,10)
		if i%2==0
			fp["l"].zoom_x += 1
			fp["l"].zoom_y += 1
			fp["r"].zoom_x += 1
			fp["r"].zoom_y += 1
		end
		fp["l"].tone.red += 10
		fp["l"].tone.green += 10
		fp["l"].tone.blue += 10
		fp["r"].tone.red += 10
		fp["r"].tone.green += 10
		fp["r"].tone.blue += 10
	end
	if i.between?(11,19)
		if i%2==1
			fp["l"].zoom_x -= 1
			fp["l"].zoom_y -= 1
			fp["r"].zoom_x -= 1
			fp["r"].zoom_y -= 1
		end
		fp["l"].tone.red -= 10
		fp["l"].tone.green -= 10
		fp["l"].tone.blue -= 10
		fp["r"].tone.red -= 10
		fp["r"].tone.green -= 10
		fp["r"].tone.blue -= 10
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: BARRIER.rb =====#
#-------------------------------------------------------------------------------
#  BARRIER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BARRIER) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb605")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @targetIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 5
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
    if i.between?(7,11)
      #@targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: BATONPASS.rb =====#
#-------------------------------------------------------------------------------
#  BATONPASS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BATONPASS) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["weatherball"] = Sprite.new(@viewport)
  fp["weatherball"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_17")
  fp["weatherball"].ox = fp["weatherball"].bitmap.width/2
  fp["weatherball"].oy = fp["weatherball"].bitmap.height/2
  fp["weatherball"].z = 50
  fp["weatherball"].x, fp["weatherball"].y = @userSprite.getCenter
  fp["weatherball"].opacity = 0
  fp["weatherball"].zoom_x = factor*1.4
  fp["weatherball"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_18")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/throw")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].zoom_x -= factor*0.4/10
    fp["weatherball"].zoom_y -= factor*0.4/10
    fp["weatherball"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
	@userSprite.visible = false if i == 6
    @userSprite.hidden = true if i == 6
    @scene.wait(1,true)
  end
  10.times do
    fp["weatherball"].zoom_x += factor*0.4/10
    fp["weatherball"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["weatherball"].zoom_y -= factor*0.02
    elsif
      fp["weatherball"].zoom_x -= factor*0.02
      fp["weatherball"].zoom_y += factor*0.04
    end
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying1") if i == 10
  end
  for i in 0...20
    fp["weatherball"].y -= 32
    fp["weatherball"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end
#===== FILE: BEATUP.rb =====#
#-------------------------------------------------------------------------------
#  BEATUP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BEATUP) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_5")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_5")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(41,41,41,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  #animation
  for i in 0...50
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i*3)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal1",80) if i%4==0 && i < 16
    for j in 0...50
      next if j>(i*3)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: BELCH.rb =====#
#-------------------------------------------------------------------------------
#  ROAROFTIME
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROAROFTIME) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  rndx = [[],[]]; rndy = [[],[]]
  dx = [[],[]]; dy = [[],[]]
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb427_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  string = ["eb612_9","eb000"]
  rop = [255,80,40,135]
  px = []
  py = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for m in 0...2
    for i in 0...20
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      bmp = pbBitmap("Graphics/EBDX/Animations/Moves/"+string[m])
      fp["#{i}#{m}"].bitmap = Bitmap.new(bmp.width,bmp.height)
      fp["#{i}#{m}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height),(m==0 ? rop[rand(4)] : 255))
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].opacity = 0
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      fp["#{i}#{m}"].zoom_x = [0.5,1][m]
      fp["#{i}#{m}"].zoom_y = [0.5,1][m]
      rndx[m].push(rand(16))
      rndy[m].push(rand(16))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  k = 1
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Psych Up",80)
  @scene.wait(4,true)
  for i in 0...96
    pbSEPlay("Anim/Psych Up") if i%24 == 0
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...20
        if fp["#{j}#{m}"].opacity == 0
          dx[m][j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
        end
        next if j>(i/4)
        x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        x0 = dx[m][j]
        y0 = dy[m][j]
        fp["#{j}#{m}"].x += (x2 - x0)*0.04*(m+1)
        fp["#{j}#{m}"].y += (y2 - y0)*0.04*(m+1)
        fp["#{j}#{m}"].zoom_x += (1 - fp["#{j}#{m}"].zoom_x)*0.1
        fp["#{j}#{m}"].zoom_y += (1 - fp["#{j}#{m}"].zoom_y)*0.1
        fp["#{j}#{m}"].opacity += 51
        fp["#{j}#{m}"].angle += 8*(m+1)*j
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          fp["#{j}#{m}"].visible = false if nextx > cx && nexty < cy
        else
          fp["#{j}#{m}"].visible = false if nextx < cx && nexty > cy
        end
      end
    end
    for l in 0...12
      next if i < 12
      next if l>((i-12)/4)
      if fp["p#{l}"].opacity <= 0
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(128)
        px[l] = cx - 128*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 128*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(vector) if i == 64
    @vector.inc = 0.1 if i == 64
    fp["bg"].update
    if i < 64
      k*=-1 if i%4==0
      @scene.moveEntireScene(0,k*4,true,true)
    end
    #pbSEPlay("Anim/Water1") if i == 84
    if i.between?(85,90)
      @targetSprite.zoom_x += 0.01
      @targetSprite.zoom_y -= 0.04
    elsif i.between?(91,96)
      @targetSprite.zoom_x -= 0.01
      @targetSprite.zoom_y += 0.04
    end
    @scene.wait(1,(i>=64 && i<85))
  end
  for j in 0...20; for m in 0...2; fp["#{j}#{m}"].visible = false; end; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: BITE.rb =====#
#-------------------------------------------------------------------------------
#  Bite
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BITE) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(66,60,81))
  fp["bg"].opacity = 0
  fp["fang1"] = Sprite.new(@viewport)
  fp["fang1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang1"].ox = fp["fang1"].bitmap.width/2
  fp["fang1"].oy = fp["fang1"].bitmap.height - 20
  fp["fang1"].opacity = 0
  fp["fang1"].z = 41
  fp["fang2"] = Sprite.new(@viewport)
  fp["fang2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang2"].ox = fp["fang1"].bitmap.width/2
  fp["fang2"].oy = fp["fang1"].bitmap.height - 20
  fp["fang2"].opacity = 0
  fp["fang2"].z = 40
  fp["fang2"].angle = 180
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["fang1"].x = cx; fp["fang1"].y = cy
    fp["fang1"].zoom_x = @targetSprite.zoom_x; fp["fang1"].zoom_y = @targetSprite.zoom_y
    fp["fang2"].x = cx; fp["fang2"].y = cy
    fp["fang2"].zoom_x = @targetSprite.zoom_x; fp["fang2"].zoom_y = @targetSprite.zoom_y
    if i.between?(20,29)
      fp["fang1"].opacity += 5
      fp["fang1"].oy += 2
      fp["fang2"].opacity += 5
      fp["fang2"].oy += 2
    elsif i.between?(30,40)
      fp["fang1"].opacity += 25.5
      fp["fang1"].oy -= 4
      fp["fang2"].opacity += 25.5
      fp["fang2"].oy -= 4
    else
      fp["fang1"].opacity -= 26
      fp["fang1"].oy += 2
      fp["fang2"].opacity -= 26
      fp["fang2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Super Fang")
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: BLASTBURN.rb =====#
#-------------------------------------------------------------------------------
#  BLASTBURN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BLASTBURN) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  rndx = [[],[]]; rndy = [[],[]]
  dx = [[],[]]; dy = [[],[]]
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb638_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  string = ["eb638_2","eb638"]
  rop = [255,80,40,135]
  px = []
  py = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for m in 0...2
    for i in 0...20
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      bmp = pbBitmap("Graphics/EBDX/Animations/Moves/"+string[m])
      fp["#{i}#{m}"].bitmap = Bitmap.new(bmp.width,bmp.height)
      fp["#{i}#{m}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height),(m==0 ? rop[rand(4)] : 255))
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].opacity = 0
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      fp["#{i}#{m}"].zoom_x = [0.5,1][m]
      fp["#{i}#{m}"].zoom_y = [0.5,1][m]
      rndx[m].push(rand(16))
      rndy[m].push(rand(16))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  k = 1
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Fire5",80)
  @scene.wait(4,true)
  for i in 0...96
    pbSEPlay("Anim/Fire2") if i == 12
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...20
        if fp["#{j}#{m}"].opacity == 0
          dx[m][j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
        end
        next if j>(i/4)
        x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        x0 = dx[m][j]
        y0 = dy[m][j]
        fp["#{j}#{m}"].x += (x2 - x0)*0.04*(m+1)
        fp["#{j}#{m}"].y += (y2 - y0)*0.04*(m+1)
        fp["#{j}#{m}"].zoom_x += (1 - fp["#{j}#{m}"].zoom_x)*0.1
        fp["#{j}#{m}"].zoom_y += (1 - fp["#{j}#{m}"].zoom_y)*0.1
        fp["#{j}#{m}"].opacity += 51
        fp["#{j}#{m}"].angle += 8*(m+1)*j
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          fp["#{j}#{m}"].visible = false if nextx > cx && nexty < cy
        else
          fp["#{j}#{m}"].visible = false if nextx < cx && nexty > cy
        end
      end
    end
    for l in 0...12
      next if i < 12
      next if l>((i-12)/4)
      if fp["p#{l}"].opacity <= 0
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(128)
        px[l] = cx - 128*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 128*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(vector) if i == 64
    @vector.inc = 0.1 if i == 64
    fp["bg"].update
    if i < 64
      k*=-1 if i%4==0
      @scene.moveEntireScene(0,k*4,true,true)
    end
    pbSEPlay("Anim/Fire3") if i == 84
    if i.between?(85,90)
      @targetSprite.zoom_x += 0.01
      @targetSprite.zoom_y -= 0.04
    elsif i.between?(91,96)
      @targetSprite.zoom_x -= 0.01
      @targetSprite.zoom_y += 0.04
    end
    @scene.wait(1,(i>=64 && i<85))
  end
  for j in 0...20; for m in 0...2; fp["#{j}#{m}"].visible = false; end; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: BLIZZARD.rb =====#
#-------------------------------------------------------------------------------
#  SHEERCOLD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SHEERCOLD) do
  EliteBattle.playMoveAnimation(:BLIZZARD, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  BLIZZARD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BLIZZARD) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  #
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb616_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  #
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb611_3")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = @targetSprite.z + 1
    rndx.push(rand(256)); prndx.push(rand(72))
    rndy.push(rand(256)); prndy.push(rand(72))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  shake = 4
  # start animation
  #
for i in 0...30
    if i < 10
      fp["bg"].opacity += 25.5
    elsif i < 20
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Ice7", 80) if i == 15
    pbSEPlay("Anim/Wind8", 70) if i == 15
    fp["bg"].update
    @scene.wait(1,true)
  end
  #
  @vector.set(vector2)
  for i in 0...72
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += rangl[j]*2
      nextx = fp["#{j}"].x
      nexty = fp["#{j}"].y
       if !@targetIsPlayer
        fp["#{j}"].opacity -= 25 if j > 65#if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 25 if j > 65#if nextx < cx && nexty > cy
      end
    end
    if i >= 64
      #@targetSprite.x += 64*(@targetIsPlayer ? -1 : 1)
    elsif i >= 52
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(vector) if i == 16
    @vector.inc = 0.1 if i == 16
    @scene.wait(1,i < 64)
	pbSEPlay("Anim/Ice7", 100) if i == 50 || i == 96
    pbSEPlay("Anim/Wind8", 100) if i == 12 || i == 50
	fp["bg"].update
  end
    for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @vector.inc = 0.2
  @scene.wait(16,true)
end

#===== FILE: BLOCK.rb =====#
#-------------------------------------------------------------------------------
#  BLOCK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BLOCK) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(255,154,154))
  fp["bg"].opacity = 0
  fp["wrap1"] = Sprite.new(@viewport)
  fp["wrap1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_5")
  fp["wrap1"].ox = fp["wrap1"].bitmap.width/2 - 10
  fp["wrap1"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap1"].angle = -90
  fp["wrap1"].opacity = 0
  fp["wrap1"].z = 41
  fp["wrap2"] = Sprite.new(@viewport)
  fp["wrap2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_5")
  fp["wrap2"].ox = fp["wrap1"].bitmap.width/2 + 10
  fp["wrap2"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap2"].opacity = 0
  fp["wrap2"].z = 40
  fp["wrap2"].mirror = true
  fp["wrap2"].angle = 90
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...80
    cx, cy = @targetSprite.getCenter(true)
    fp["wrap1"].x = cx; fp["wrap1"].y = cy
    fp["wrap1"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap1"].zoom_y = 1.5*@targetSprite.zoom_y
    fp["wrap2"].x = cx; fp["wrap2"].y = cy
    fp["wrap2"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap2"].zoom_y = 1.5*@targetSprite.zoom_y
    if i.between?(20,35)
      fp["wrap1"].opacity += 5
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity += 5
      fp["wrap2"].oy += 2
    elsif i.between?(35,45)
      fp["wrap1"].opacity += 25.5
      fp["wrap1"].oy -= 2
      fp["wrap2"].opacity += 25.5
      fp["wrap2"].oy -= 2
    else
      fp["wrap1"].opacity -= 26
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity -= 26
      fp["wrap2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Wrap")
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: BOLTSTRIKE.rb =====#
#-------------------------------------------------------------------------------
#  Bolt Strike
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BOLTSTRIKE) do
  # Charging animation
  EliteBattle.playMoveAnimation(:CHARGE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  factor = @targetIsPlayer ? 2 : 1.5
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.black)
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.stretch_blt(Rect.new(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height),pbBitmap("Graphics/EBDX/Animations/Moves/eb064_bg"),Rect.new(0,0,512,384))
  fp["bg2"].opacity = 0
  l = 0
  m = 0
  q = 0
  for i in 0...24
    fp["c#{i}"] = Sprite.new(@viewport)
    fp["c#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb081")
    fp["c#{i}"].ox = fp["c#{i}"].bitmap.width/2
    fp["c#{i}"].oy = fp["c#{i}"].bitmap.height/2
    fp["c#{i}"].opacity = 0
    fp["c#{i}"].z = 51
    rndx.push(rand(256))
    rndy.push(rand(256))
  end
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 51
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb081_3")
  fp["circle"].src_rect.set(0,0,fp["circle"].bitmap.width/2,fp["circle"].bitmap.height)
  fp["circle"].ox = fp["circle"].src_rect.width/2
  fp["circle"].oy = fp["circle"].src_rect.height/2
  fp["circle"].opacity = 0
  fp["circle"].z = @targetSprite.z + 1
  fp["half"] = Sprite.new(@viewport)
  fp["half"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064")
  fp["half"].ox = fp["half"].src_rect.width/2
  fp["half"].oy = fp["half"].src_rect.height/2
  fp["half"].opacity = 0
  fp["half"].zoom_x = 0.5
  fp["half"].zoom_y = 0.5
  fp["half"].color = Color.new(255,255,255,255)
  fp["half"].z = @targetSprite.z + 2
  # start animation
  @vector.set(vector)
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["circle"].x = cx; fp["circle"].y = cy
    fp["half"].x = cx; fp["half"].y = cy
    pbSEPlay("Anim/Paralyze1") if i >= 16 && (i-16)%8==0
    if i == 16
      pbSEPlay("Anim/slam")
      pbSEPlay("Anim/Thunder3")
    end
    for k in 0...24
      next if i < 16
      if fp["c#{k}"].opacity == 0 && fp["c#{k}"].tone.gray == 0
        r = rand(2)
        fp["c#{k}"].zoom_x = (r==0 ? 1 : 0.5)
        fp["c#{k}"].zoom_y = (r==0 ? 1 : 0.5)
        fp["c#{k}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(128*factor)
        rndx[k] = cx - 128*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        rndy[k] = cy - 128*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["c#{k}"].x = @targetSprite.x
        fp["c#{k}"].y = @targetSprite.y
      end
      x2 = rndx[k]
      y2 = rndy[k]
      x0 = fp["c#{k}"].x
      y0 = fp["c#{k}"].y
      fp["c#{k}"].x += (x2 - x0)*0.1
      fp["c#{k}"].y += (y2 - y0)*0.1
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["c#{k}"].tone.gray = 1
        fp["c#{k}"].opacity -= 51
      else
        fp["c#{k}"].opacity += 51
      end
    end
    for n in 0...12
      next if i < 16
      if fp["#{n}"].opacity == 0 && fp["#{n}"].tone.gray == 0
        r = rand(2); r2 = rand(4)
        fp["#{n}"].zoom_x = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].zoom_y = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(64*factor)
        fp["#{n}"].x = cx - 64*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["#{n}"].y = cy - 64*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["#{n}"].angle = -Math.atan(1.0*(fp["#{n}"].y-cy)/(fp["#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      next if m>(i-16)/4
      fp["#{n}"].opacity += 51 if fp["#{n}"].tone.gray == 0
      fp["#{n}"].angle += 180 if (i-16)%3==0
      fp["#{n}"].tone.gray = 1 if fp["#{n}"].opacity >= 255
      q += 1 if fp["#{n}"].opacity >= 255
      fp["#{n}"].opacity -= 10 if fp["#{n}"].tone.gray > 0 && q > 96
    end
    if i < 64
      fp["bg2"].opacity += 15
    else
      fp["bg2"].opacity -= 32
    end
    if i.between?(16,24)
      @targetSprite.x += (@targetIsPlayer ? -8 : 4)*((i-16)/4>0 ? -1 : 1)
      @targetSprite.y -= (@targetIsPlayer ? -4 : 2)*((i-16)/4>0 ? -1 : 1)
    end
    @targetSprite.tone = Tone.new(250,250,250) if i == 16
    if i >= 16
      if (i-16)/3 > l
        m += 1
        m = 0 if m > 1
        l = (i-16)/3
      end
      @targetSprite.zoom_y -= 0.16*(m==0 ? 1 : -1)
      @targetSprite.zoom_x += 0.08*(m==0 ? 1 : -1)
      @targetSprite.tone.red -= 15 if @targetSprite.tone.red > 100
      @targetSprite.tone.green -= 17 if @targetSprite.tone.green > 80
      @targetSprite.tone.blue -= 19 if @targetSprite.tone.blue > 60
      fp["circle"].zoom_x += 0.2
      fp["circle"].zoom_y += 0.2
      fp["circle"].opacity += (i>=20 ? -24 : 48)
      fp["half"].zoom_x += 0.1
      fp["half"].zoom_y += 0.06
      fp["half"].opacity += (i>=24 ? -40 : 40)
    end
    @userSprite.color.alpha -= 20 if @userSprite.color.alpha > 0
    @userSprite.anim = true
    @scene.wait(1,(i < 16))
  end
  @vector.reset if !@multiHit
  20.times do
    fp["bg"].opacity -= 15
    @targetSprite.tone.red -= 5
    @targetSprite.tone.green -= 4
    @targetSprite.tone.blue -= 3
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: BONERUSH.rb =====#
#-------------------------------------------------------------------------------
#  BONEMERANG
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BONEMERANG) do
  EliteBattle.playMoveAnimation(:BONERUSH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  BONECLUB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BONECLUB) do
  EliteBattle.playMoveAnimation(:BONERUSH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  BONERUSH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BONERUSH) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["bone"] = Sprite.new(@viewport)
  fp["bone"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb623")
  fp["bone"].z = @targetSprite.z + 1
  fp["bone"].opacity = 0
  timeFactor = 40
  # shooting out the bone
  for i in 0...timeFactor
	pbSEPlay("Anim/wind7") if i%5 == 0
	fp["bone"].opacity += 50 if fp["bone"].opacity < 250
	fp["bone"].ox = fp["bone"].bitmap.width/2
    fp["bone"].oy = fp["bone"].bitmap.height/2
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,timeFactor)
    fp["bone"].x = points[i][0]
    fp["bone"].y = points[i][1]
    z = 1 + (1-(fp["bone"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["bone"].zoom_x = z
    fp["bone"].zoom_y = z
	fp["bone"].angle += 30
    fp["bone"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("Anim/wind7")
  fp["bone"].dispose
  # zooming onto the target
  5.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/hit")
  @scene.wait(10,true)
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: BOOMBURST.rb =====#
#-------------------------------------------------------------------------------
#  BOOMBURST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BOOMBURST) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_1")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: BOUNCE.rb =====#
#-------------------------------------------------------------------------------
#  BOUNCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BOUNCE) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:BOUNCE_UP, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:BOUNCE_DOWN, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:BOUNCE_UP) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["fly"] = Sprite.new(@viewport)
  fp["fly"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156")
  fp["fly"].ox = fp["fly"].bitmap.width/2
  fp["fly"].oy = fp["fly"].bitmap.height/2
  fp["fly"].z = 50
  fp["fly"].x, fp["fly"].y = @userSprite.getCenter
  fp["fly"].opacity = 0
  fp["fly"].zoom_x = factor*1.4
  fp["fly"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_2")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Refresh")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].zoom_x -= factor*0.4/10
    fp["fly"].zoom_y -= factor*0.4/10
    fp["fly"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @userSprite.visible = false if i == 6
    @userSprite.hidden = true if i == 6
    @scene.wait(1,true)
  end
  10.times do
    fp["fly"].zoom_x += factor*0.4/10
    fp["fly"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["fly"].zoom_y -= factor*0.02
    elsif
      fp["fly"].zoom_x -= factor*0.02
      fp["fly"].zoom_y += factor*0.04
    end
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying2") if i == 10
  end
  for i in 0...20
    fp["fly"].y -= 32
    fp["fly"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end

EliteBattle.defineMoveAnimation(:BOUNCE_DOWN) do
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  fp["drop"] = Sprite.new(@viewport)
  fp["drop"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_3")
  fp["drop"].ox = fp["drop"].bitmap.width/2
  fp["drop"].oy = fp["drop"].bitmap.height/2
  fp["drop"].y = 0
  fp["drop"].z = 50
  fp["drop"].visible = false
  # start animation
  @vector.set(defaultvector[0], defaultvector[1]+128, defaultvector[2], defaultvector[3], defaultvector[4], defaultvector[5])
  @sprites["battlebg"].defocus
  32.times do
    fp["bg"].opacity += 2
    @scene.wait(1,true)
  end
  @vector.set(vector)
  maxy = ((@targetIsPlayer ? @vector.y : @vector.y2)*0.1).ceil*10 - 80
  fp["drop"].y = -((maxy-(@targetIsPlayer ? @vector.y-80 : @vector.y2-80))*0.1).ceil*10
  fp["drop"].x = @targetSprite.x
  pbSEPlay("Anim/Wind1")
  for i in 0...20
    @scene.wait(1,true)
    if i >= 10
      fp["drop"].visible = true
      fp["drop"].x = @targetSprite.x
      fp["drop"].y += maxy/10
      fp["drop"].zoom_x = @targetSprite.zoom_x
      fp["drop"].zoom_y = @targetSprite.zoom_y*1.4
    end
    fp["bg"].opacity -= 51 if i >= 15
  end
  @sprites["battlebg"].focus
  @userSprite.hidden = false
  @userSprite.visible = true
  pbDisposeSpriteHash(fp)
  EliteBattle.playMoveAnimation(:TACKLE, @scene, @userIndex, @targetIndex, 0, false, nil, false, true)
end

#===== FILE: BRAVEBIRD.rb =====#
#-------------------------------------------------------------------------------
#  BRAVEBIRD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BRAVEBIRD) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  shake = 4; k = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...20
	pbSEPlay("Anim/wind1",80) if i == 2
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
	  @userSprite.opacity-=25
    end
    if i == 8
      @vector.set(vector2)
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb628_2")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  fp["shot"] = Sprite.new(@viewport)
  fp["shot"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb628")
  fp["shot"].ox = fp["shot"].bitmap.width/2
  fp["shot"].oy = fp["shot"].bitmap.height/2
  fp["shot"].z = @userSprite.z + 1
  fp["shot"].zoom_x = @userSprite.zoom_x*0.8
  fp["shot"].zoom_y = @userSprite.zoom_y*0.8
  fp["shot"].opacity = 0
  x = defaultvector[0]; y = defaultvector[1]
  x2, y2 = @vector.spoof(defaultvector)
  fp["shot"].x = cx
  fp["shot"].y = cy
  pbSEPlay("EBDX/Anim/normal1",80)
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    @vector.reset if i == 0
    if i > 0
      fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
      fp["shot"].opacity += 32
      fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
      fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
    end
    fp["bg"].update
    factor = @targetSprite.zoom_x if i == 12
    if i >= 12
      k *= -1 if i%4==0
      @targetSprite.zoom_x -= factor*0.01*k
      @targetSprite.zoom_y += factor*0.04*k
      @targetSprite.still
    end
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,i < 12)
  end
  shake = 2
  16.times do
    fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
    fp["shot"].opacity += 32
    fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
    fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
    fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
    fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
    fp["bg"].color.alpha += 16
    fp["bg"].update
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
    @targetSprite.still
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  16.times do
    fp["bg"].update
    fp["bg"].opacity -= 16
	@userSprite.opacity+=20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: BRICKBREAK.rb =====#
#-------------------------------------------------------------------------------
#  BRICKBREAK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BRICKBREAK) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  @scene.wait(17,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...72
    k *= - 1 if i%4==0
    for j in 0...12
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...96
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: BRINE.rb =====#
#-------------------------------------------------------------------------------
#  BRINE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BRINE) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["ball"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb536"))
  fp["ball"].keyFrame = 1
  fp["ball"].z = @targetSprite.z + 1
  @vector.set(EliteBattle.get_vector(:DUAL))
  @scene.wait(5,true)
  # shooting out the ball
  for i in 0...24
	pbSEPlay("Anim/bubble1") if i == 5
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getCenter(true)
    #cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    my = @vector.y + (@vector.y2 - @vector.y)*0.5
    points = calculateCurve(cxP-20,cyP-100,mx,-62,cxT-75,cyT-100,24)
    fp["ball"].x = points[i][0]
    fp["ball"].y = points[i][1]
    z = 1 + (1-(fp["ball"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["ball"].zoom_x = z
    fp["ball"].zoom_y = z
    fp["ball"].update
	if i.between?(16,8)
		@targetSprite.color.alpha += 18
		@targetSprite.anim = true
		@targetSprite.still
	end
    @scene.wait(1,true)
  end
  @targetSprite.color = Color.new(70,70,70,0)
  fp["ball"].dispose
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	if rand(1)
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
	else
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_3")
	end
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/bubble2") if i == 5
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.01
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.01
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.25
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.25
      if fp["p#{j}"].zoom_x >= 0.5
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: BUBBLE.rb =====#
#-------------------------------------------------------------------------------
#  BUBBLE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BUBBLE) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  rndNote = 0
  # fp["bg"] = Sprite.new(@viewport)
  # fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  # fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  # fp["bg"].opacity = 0
  for i in 0...10
    fp["#{i}"] = Sprite.new(@viewport)
	rndNote = rand(0..4)
	if rndNote == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618")
	elsif rndNote == 1 || rndNote == 4
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
	elsif rndNote == 2
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_3")
	elsif rndNote == 3
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_4")
	end
    #fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].src_rect.set(0,101*0,53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end 
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...10
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    #fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Bubble1",100) if i==0 || i == 40 || i == 70
	pbSEPlay("Anim/Bubble2",100) if i==10 || i == 50 || i == 80
    if i >= 96
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Bubble1",100)
  pbSEPlay("Anim/Bubble2",100)
  20.times do
    # @targetSprite.tone.red -= 2.4*2
    # @targetSprite.tone.green += 1.2*2
    # @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -1 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 1 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    #fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: BUBBLEBEAM.rb =====#
#-------------------------------------------------------------------------------
#  BUBBLEBEAM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BUBBLEBEAM) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  rndNote = 0
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(102,178,255))
  fp["bg"].opacity = 0
  for i in 0...25
    fp["#{i}"] = Sprite.new(@viewport)
	rndNote = rand(0..4)
	if rndNote == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618")
	elsif rndNote == 1 || rndNote == 4
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
	elsif rndNote == 2
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_3")
	elsif rndNote == 3
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_4")
	end
    #fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].src_rect.set(0,101*0,53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end 
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...160#132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...25
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Bubble1",100) if i%5==0
	pbSEPlay("Anim/Bubble2",100) if i%10==0
    if i >= 96
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Bubble1",100)
  pbSEPlay("Anim/Bubble2",100)
  20.times do
    # @targetSprite.tone.red -= 2.4*2
    # @targetSprite.tone.green += 1.2*2
    # @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -3 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 3 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: BUGBITE.rb =====#
#-------------------------------------------------------------------------------
#  Bug Bite
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BUGBITE) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16, true)
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  dx = []
  dy = []
  da = []
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb008")
    fp["s#{j}"].src_rect.set(32*rand(2),0,32,32)
    fp["s#{j}"].ox = fp["s#{j}"].src_rect.width/2
    fp["s#{j}"].oy = fp["s#{j}"].src_rect.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb008_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 32*factor
    x = cx - r + rand(r*2)
    y = cy - r + rand(r)
    fp["#{j}"].x = x
    fp["#{j}"].y = y
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    ox = (x < cx ? x-rand(24*factor)-24*factor : x+rand(24*factor)+24*factor)
    oy = y - rand(24*factor) - 24*factor
    dx.push(ox)
    dy.push(oy)
    a = (x < cx ? rand(6)+1 : -rand(6)-1)
    da.push(a)
  end
  # play animation
  for i in 0...64
    for j in 0...32
      next if j>i
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.2).abs < 1
        fp["#{j}"].y += 4
        fp["#{j}"].opacity -= 16
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.2
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.2
      end
      fp["#{j}"].angle += da[j]*8
    end
    for j in 0...12
      next if j>(i/4)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
    end
    @targetSprite.zoom_y = factor + 0.32 if i%4 == 0 && i < 48
    @targetSprite.zoom_y -= 0.08 if @targetSprite.zoom_y > factor
    pbSEPlay("EBDX/Anim/bug1",80) if i%4==0 && i < 48
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: BULKUP.rb =====#
#-------------------------------------------------------------------------------
#  ROCKPOLISH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROCKPOLISH) do
  EliteBattle.playMoveAnimation(:BULKUP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  BULKUP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BULKUP) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(209,148,42,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: BULLETPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  CHIPAWAY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CHIPAWAY) do
  EliteBattle.playMoveAnimation(:BULLETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FAKEOUT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FAKEOUT) do
  EliteBattle.playMoveAnimation(:BULLETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  COVET
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:COVET) do
  EliteBattle.playMoveAnimation(:BULLETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MEFIRST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MEFIRST) do
  EliteBattle.playMoveAnimation(:BULLETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  BULLETPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BULLETPUNCH) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/move1",80) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playMoveAnimation(:COMETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: BULLETSEED.rb =====#
#-------------------------------------------------------------------------------
#  BULLETSEED
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BULLETSEED) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(0,204,102))
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...20
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb223")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 12
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Follow Me")
  for i in 0...40
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...20
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 30
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 10
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>35) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 20
    @vector.inc = 0.1 if i == 20
    @scene.wait(1,true)
  end
  fp["172"].dispose
  fp["182"].dispose
  fp["192"].dispose
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      #fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: CALMMIND.rb =====#
#-------------------------------------------------------------------------------
#  PSYCHOBOOST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYCHOBOOST) do | args |
  EliteBattle.playMoveAnimation(:CALMMIND, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  KINESIS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:KINESIS) do | args |
  EliteBattle.playMoveAnimation(:CALMMIND, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  LUNARDANCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LUNARDANCE) do | args |
  EliteBattle.playMoveAnimation(:CALMMIND, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  TELEKINESIS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TELEKINESIS) do | args |
  EliteBattle.playMoveAnimation(:CALMMIND, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  TRICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TRICK) do | args |
  EliteBattle.playMoveAnimation(:CALMMIND, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  CALMMIND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CALMMIND) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 6
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb452",true)
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  fp["bg"].oy = fp["bg"].src_rect.height/2
  fp["bg"].y = @viewport.height/2
  shake = 8
  zoom = -1
  #
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_4")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,51,255,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
  pbSEPlay("EBDX/Anim/psychic1",80) if i == 12
    pbSEPlay("EBDX/Anim/psychic2",80) if i == 20
    if i < 10
      fp["bg"].opacity += 25.5
    elsif i < 20
      fp["bg"].color.alpha -= 25.5
    elsif i >= 67
      fp["bg"].color.alpha += 25.5
      @targetSprite.tone.red += 18
      @targetSprite.tone.green += 18
      @targetSprite.tone.blue += 18
      #@targetSprite.zoom_x += 0.04*factor
      #@targetSprite.zoom_y += 0.04*factor
    elsif i >= 40
      @targetSprite.ox += shake
      shake = -8 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
      shake = 8 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
      @targetSprite.still
    end
    zoom *= -1 if i%2 == 0
    fp["bg"].update
    fp["bg"].zoom_y += 0.04*zoom
	#
    k *= -1 if i%4==0
    #pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  10.times do
    fp["bg"].opacity -= 25.5
    @targetSprite.still
	@scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CHARGE.rb =====#
#-------------------------------------------------------------------------------
#  Charge
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CHARGE) do | args |
  beam, strike = *args; beam = false if beam.nil?; strike = false if strike.nil?
  factor = 2
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.black)
  fp["bg"].opacity = 0
  @userSprite.color = Color.new(217,189,52,0) if strike
  rndx = []
  rndy = []
  for i in 0...8
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb081_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  for i in 0...16
    fp["c#{i}"] = Sprite.new(@viewport)
    fp["c#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb081")
    fp["c#{i}"].ox = fp["c#{i}"].bitmap.width/2
    fp["c#{i}"].oy = fp["c#{i}"].bitmap.height/2
    fp["c#{i}"].opacity = 0
    fp["c#{i}"].z = 51
    rndx.push(0)
    rndy.push(0)
  end
  m = 0
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb081_3")
  fp["circle"].ox = fp["circle"].bitmap.width/4
  fp["circle"].oy = fp["circle"].bitmap.height/2
  fp["circle"].opacity = 0
  fp["circle"].src_rect.set(0,0,484,488)
  fp["circle"].z = 50
  fp["circle"].zoom_x = 0.5
  fp["circle"].zoom_y = 0.5
  # start animation
  @vector.set(@scene.getRealVector(@userIndex, !@targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...112
    pbSEPlay("Anim/Flash3",90) if i == 32
    pbSEPlay("Anim/Saint8") if i == 64
    cx, cy = @userSprite.getCenter
    for j in 0...8
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(96*factor)
        fp["#{j}"].x = cx - 96*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 96*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/8)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*(180.0/Math::PI)# + (rand{4}==0 ? 180 : 0)
      fp["#{j}"].mirror = !fp["#{j}"].mirror if i%2==0
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    for k in 0...16
      if fp["c#{k}"].opacity == 0
        r = rand(2)
        fp["c#{k}"].zoom_x = (r==0 ? 1 : 0.5)
        fp["c#{k}"].zoom_y = (r==0 ? 1 : 0.5)
        fp["c#{k}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        rndx[k] = cx - 48*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        rndy[k] = cy - 48*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
        fp["c#{k}"].x = cx
        fp["c#{k}"].y = cy
      end
      next if k>(i/4)
      x2 = rndx[k]
      y2 = rndy[k]
      x0 = fp["c#{k}"].x
      y0 = fp["c#{k}"].y
      fp["c#{k}"].x += (x2 - x0)*0.05
      fp["c#{k}"].y += (y2 - y0)*0.05
      fp["c#{k}"].opacity += 5
    end
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].opacity += 25.5
    if i < 124
      fp["circle"].zoom_x += 0.01
      fp["circle"].zoom_y += 0.01
    else
      fp["circle"].zoom_x += 0.05
      fp["circle"].zoom_y += 0.05
    end
    m = 1 if i%4==0
    fp["circle"].src_rect.x = 484*m
    m = 0 if i%2==0
    if i < 96
      if strike
        fp["bg"].opacity += 10 if fp["bg"].opacity < 255
      else
        fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.75
      end
    else
      fp["bg"].opacity -= 10 if !beam && !strike
    end
    if strike && i > 16
      @userSprite.color.alpha += 10 if @userSprite.color.alpha < 200
      fp["circle"].opacity -= 76.5 if i > 106
      for k in 0...16
        next if i < 96
        fp["c#{k}"].opacity -= 30.5
      end
      for j in 0...8
        next if i < 96
        fp["#{j}"].opacity -= 30.5
      end
    end
    @userSprite.still if !strike
    @userSprite.anim = true if strike
    @scene.wait(1,true)
  end
  if strike
    for i in 0...2
      8.times do
        @userSprite.x -= (@targetIsPlayer ? 12 : -6)*(i==0 ? 1 : -1)
        @userSprite.y += (@targetIsPlayer ? 4 : -2)*(i==0 ? 1 : -1)
        @userSprite.zoom_y -= (factor*0.04)*(i==0 ? 1 : -1)
        @userSprite.still
        @scene.wait
      end
    end
  end
  pbDisposeSpriteHash(fp)
  if !beam && !strike
    @sprites["battlebg"].focus
    @vector.reset if !@multiHit
    @viewport.color = Color.new(255,255,255,255)
    10.times do
      @viewport.color.alpha -= 25.5
      @scene.wait(1,true)
    end
  end
end

#===== FILE: CHARGEBEAM.rb =====#
#-------------------------------------------------------------------------------
#  Charge Beam
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CHARGEBEAM) do
  # Charging animation
  EliteBattle.playMoveAnimation(:CHARGE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
  @viewport.color = Color.new(255,255,255,255)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  dx = []
  dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 255*0.75
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb078")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  shake = 4
  # start animation
  pbSEPlay("Anim/Flash")
  pbSEPlay("Anim/Pollen")
  for i in 0...96
    pbSEPlay("Anim/Paralyze1") if i%8==0
    cx, cy = @targetSprite.getCenter(true)
    ax, ay = @userSprite.getAnchor
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      next if j>(i)
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      x0 = dx[j]
      y0 = dy[j]
      fp["#{j}"].x += (x2 - x0)*0.05
      fp["#{j}"].y += (y2 - y0)*0.05
      fp["#{j}"].opacity += 32
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x + (x2 - x0)*0.05
      nexty = fp["#{j}"].y + (y2 - y0)*0.05
      if !@targetIsPlayer
        fp["#{j}"].visible = false if nextx > cx && nexty < cy
      else
        fp["#{j}"].visible = false if nextx < cx && nexty > cy
      end
    end
    if i >= 32
      cx, cy = @targetSprite.getCenter(true)
      @targetSprite.tone.red += 8 if @targetSprite.tone.red < 160
      @targetSprite.tone.green += 6.4 if @targetSprite.tone.green < 128
      @targetSprite.tone.blue += 6.4 if @targetSprite.tone.blue < 128
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 24
    @vector.inc = 0.1 if i == 24
    @viewport.color.alpha -= 5 if @viewport.color.alpha > 0
    @scene.wait(1,true)
  end
  20.times do
    cx, cy = @targetSprite.getCenter(true)
    @targetSprite.tone.red -= 8
    @targetSprite.tone.green -= 6.4
    @targetSprite.tone.blue -= 6.4
    @targetSprite.ox += shake
    shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @targetSprite.tone = Tone.new(0,0,0)
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: CHARM.rb =====#
#-------------------------------------------------------------------------------
#  CAPTIVATE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CAPTIVATE) do
  EliteBattle.playMoveAnimation(:CHARM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DRAININGKISS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAININGKISS) do
  EliteBattle.playMoveAnimation(:CHARM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  CHARM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CHARM) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  factor = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(223,67,182))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb636")
    fp["#{i}"].src_rect.set(0,0*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Love",80) if i%12==0 && i <= 96
    if i >= 96
      @targetSprite.tone.all += 1.4*2 if @targetSprite.tone.all < 48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  #heart splatter
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb636")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
	factor[j] = rand(1)
    #fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/LoveSplatter") if i == 1
    for j in 0...32
	  next if !bomb
      next if i < 8
      next if j > (i-8)*2
	  if factor[j] == 0 || true
		  fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.03
		  fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.03
	  else
	  	  fp["p#{j}"].zoom_x += (1.0 - fp["p#{j}"].zoom_x)*0.03
		  fp["p#{j}"].zoom_y += (1.0 - fp["p#{j}"].zoom_y)*0.03
	  end
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 0.8
        fp["p#{j}"].opacity -= 25
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  20.times do
    @targetSprite.tone.all -= 1.6*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @targetSprite.tone.all = 0
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: CHATTER.rb =====#
#-------------------------------------------------------------------------------
#  CHATTER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CHATTER) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  for j in 0...24
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 6
  for i in 0...12
    @userSprite.still
	 pbSEPlay("Cries/#{@userSprite.species}",100) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  @scene.wait(5,true)
  #
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
	if j == 1 || j == 4 || j == 7 || j == 10
		fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_5")
	end
	if j == 2 || j == 5 || j == 8 || j == 11
		fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_6")
	end
	if j == 0 || j == 3 || j == 6 || j == 9 || j == 12
		fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_7")
	end
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    #fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  # anim2
  for i in 0...32
    for j in 0...12
      next if j>(i*2)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CLAMP.rb =====#
#-------------------------------------------------------------------------------
#  CLAMP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CLAMP) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(153,204,255))
  fp["bg"].opacity = 0
  fp["wrap1"] = Sprite.new(@viewport)
  fp["wrap1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_2")
  fp["wrap1"].ox = fp["wrap1"].bitmap.width/2 - 10
  fp["wrap1"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap1"].angle = -90
  fp["wrap1"].opacity = 0
  fp["wrap1"].z = 41
  fp["wrap2"] = Sprite.new(@viewport)
  fp["wrap2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_2")
  fp["wrap2"].ox = fp["wrap1"].bitmap.width/2 + 10
  fp["wrap2"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap2"].opacity = 0
  fp["wrap2"].z = 40
  fp["wrap2"].mirror = true
  fp["wrap2"].angle = 90
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...80
    cx, cy = @targetSprite.getCenter(true)
    fp["wrap1"].x = cx; fp["wrap1"].y = cy
    fp["wrap1"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap1"].zoom_y = 1.5*@targetSprite.zoom_y
    fp["wrap2"].x = cx; fp["wrap2"].y = cy
    fp["wrap2"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap2"].zoom_y = 1.5*@targetSprite.zoom_y
    if i.between?(20,35)
      fp["wrap1"].opacity += 5
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity += 5
      fp["wrap2"].oy += 2
    elsif i.between?(35,45)
      fp["wrap1"].opacity += 25.5
      fp["wrap1"].oy -= 2
      fp["wrap2"].opacity += 25.5
      fp["wrap2"].oy -= 2
    else
      fp["wrap1"].opacity -= 26
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity -= 26
      fp["wrap2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Wrap")
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CLEARSMOG.rb =====#
#-------------------------------------------------------------------------------
#  CLEARSMOG
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CLEARSMOG) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(255,166,166,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CLOSECOMBAT.rb =====#
#-------------------------------------------------------------------------------
#  Close Combat
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CLOSECOMBAT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...72
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...96
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: COIL.rb =====#
#-------------------------------------------------------------------------------
#  ACIDARMOR
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ACIDARMOR) do
  EliteBattle.playMoveAnimation(:COIL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  COIL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:COIL) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(205,154,255))
  fp["bg"].opacity = 0
  fp["wrap1"] = Sprite.new(@viewport)
  fp["wrap1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_7")
  fp["wrap1"].ox = fp["wrap1"].bitmap.width/2 - 10
  fp["wrap1"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap1"].angle = -90
  fp["wrap1"].opacity = 0
  fp["wrap1"].z = 41
  fp["wrap2"] = Sprite.new(@viewport)
  fp["wrap2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_7")
  fp["wrap2"].ox = fp["wrap1"].bitmap.width/2 + 10
  fp["wrap2"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap2"].opacity = 0
  fp["wrap2"].z = 40
  fp["wrap2"].mirror = true
  fp["wrap2"].angle = 90
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...80
    cx, cy = @targetSprite.getCenter(true)
    fp["wrap1"].x = cx; fp["wrap1"].y = cy
    fp["wrap1"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap1"].zoom_y = 1.5*@targetSprite.zoom_y
    fp["wrap2"].x = cx; fp["wrap2"].y = cy
    fp["wrap2"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap2"].zoom_y = 1.5*@targetSprite.zoom_y
    if i.between?(20,35)
      fp["wrap1"].opacity += 5
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity += 5
      fp["wrap2"].oy += 2
    elsif i.between?(35,45)
      fp["wrap1"].opacity += 25.5
      fp["wrap1"].oy -= 2
      fp["wrap2"].opacity += 25.5
      fp["wrap2"].oy -= 2
    else
      fp["wrap1"].opacity -= 26
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity -= 26
      fp["wrap2"].oy += 2
    end
    pbSEPlay("EBDX/Anim/poison1") if i%20 == 0
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: COMETPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  BELLYDRUM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BELLYDRUM) do
  EliteBattle.playMoveAnimation(:COMETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  COMETPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:COMETPUNCH) do
  # configure animation
  fp = {};
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  # anim2
  for i in 0...32
    for j in 0...12
      next if j>(i*2)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CONFUSERAY.rb =====#
#-------------------------------------------------------------------------------
#  CONFUSERAY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CONFUSERAY) do
  # inital configuration
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}; rndx = []; rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width, @viewport.height)
  fp["bg"].bitmap.fill_rect(0, 0, fp["bg"].bitmap.width, fp["bg"].bitmap.height, Color.new(68,41,85))
  fp["bg"].opacity = 0
  for i in 0...36
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb246_2")
    fp["#{i}"].src_rect.set(44*rand(4),0,44,44)
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/8
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(8))
    rndy.push(rand(8))
  end
  # start animation
  pbSEPlay("Anim/Psych Up")
  @sprites["battlebg"].defocus
  for i in 0...128
    pbSEPlay("Anim/Psych Up", 75) if i%24==0 && i < 100
    cx, cy = @targetSprite.getCenter(true)
    ax, ay = @userSprite.getAnchor
    for j in 0...36
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay
      end
      next if j>(i/2)
      x2 = cx - 4*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 4*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].angle += 2
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].angle += 2
      else
        fp["#{j}"].opacity += 12
      end
    end
    if i >= 96
      fp["bg"].opacity -= 10
    else
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.7
    end
	pbSEPlay("Anim/NightShade") if i == 90
    if i >= 72
      if i >= 96
        @targetSprite.tone.red -= 4.8/2
        @targetSprite.tone.green -= 4.8/2
        @targetSprite.tone.blue -= 4.8/2
      else
        @targetSprite.tone.red += 4.8 if @targetSprite.tone.red < 96
        @targetSprite.tone.green += 4.8 if @targetSprite.tone.green < 96
        @targetSprite.tone.blue += 4.8 if @targetSprite.tone.blue < 96
      end
      @targetSprite.still
    end
    @vector.set(vector) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @targetSprite.tone = Tone.new(0,0,0,0)
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: CONVERSION.rb =====#
#-------------------------------------------------------------------------------
#  CONVERSION2
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CONVERSION2) do
  EliteBattle.playMoveAnimation(:CONVERSION, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  CONVERSION
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CONVERSION) do
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @vector.set(vector2)
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(52,117,161))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_11")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_10")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/Saint4",80) if i == 8
    pbSEPlay("Anim/Psych Up",90) if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: COTTONSPORE.rb =====#
#-------------------------------------------------------------------------------
#  COTTONSPORE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:COTTONSPORE) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_9")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(228,228,228,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: COUNTER.rb =====#
#-------------------------------------------------------------------------------
#  COUNTER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:COUNTER) do
  factor = @userSprite.zoom_x
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(8,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb606")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @userIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @userSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 10
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
	@scene.wait(1,true)				
    if i.between?(7,11)
      #@targetSprite.still
      @userSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: CRABHAMMER.rb =====#
#-------------------------------------------------------------------------------
#  Crabhammer
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CRABHAMMER) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(57,106,173))
  fp["bg"].opacity = 0
  @vector.set(vector)
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 8
    @scene.wait(1,true)
  end
  fp["hammer1"] = Sprite.new(@viewport)
  fp["hammer1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb540_2")
  fp["hammer1"].ox = fp["hammer1"].bitmap.width/2
  fp["hammer1"].oy = fp["hammer1"].bitmap.height
  fp["hammer1"].z = @targetSprite.z + 1
  fp["hammer1"].x = @targetSprite.x
  fp["hammer2"] = Sprite.new(@viewport)
  fp["hammer2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb540_3")
  fp["hammer2"].ox = fp["hammer2"].bitmap.width/2
  fp["hammer2"].oy = fp["hammer2"].bitmap.height - 24
  fp["hammer2"].z = @targetSprite.z + 1
  fp["hammer2"].x = @targetSprite.x
  fp["frame"] = Sprite.new(@viewport)
  fp["frame"].z = @targetSprite.z + 2
  fp["frame"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb540")
  fp["frame"].src_rect.set(0,0,64,64)
  fp["frame"].ox = 32
  fp["frame"].oy = 32
  fp["frame"].zoom_x = 0.5*@targetSprite.zoom_x
  fp["frame"].zoom_y = 0.5*@targetSprite.zoom_y
  fp["frame"].x, fp["frame"].y = @targetSprite.getCenter(true)
  fp["frame"].opacity = 0
  fp["frame"].tone = Tone.new(255,255,255)
  px = []; py = []
  for i in 0...24
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  pbSEPlay("Anim/Water1",80)
  for i in 0...64
    fp["hammer1"].y += @targetSprite.y/8.0
    fp["hammer1"].visible = fp["hammer1"].y < @targetSprite.y
    if i >= 2
      fp["hammer2"].y += @targetSprite.y/8.0
      fp["hammer2"].visible = fp["hammer2"].y < @targetSprite.y
    end
    pbSEPlay("EBDX/Anim/normal1",80) if i == 11
    if i.between?(11,15)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*@targetSprite.zoom_y
      @targetSprite.tone.all -= 12.8
      fp["frame"].zoom_x += 0.1*@targetSprite.zoom_x
      fp["frame"].zoom_y += 0.1*@targetSprite.zoom_y
      fp["frame"].opacity += 51
    end
    fp["frame"].tone = Tone.new(0,0,0) if i == 16
    if i.between?(16,20)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*@targetSprite.zoom_y
      @targetSprite.tone.all+=12.8
      fp["frame"].angle += 2
    end
    fp["p#{i}"].src_rect.x = 64 if i == 10
    if i >= 20
      fp["frame"].opacity -= 25.5
      fp["frame"].zoom_x += 0.1*@targetSprite.zoom_x
      fp["frame"].zoom_y += 0.1*@targetSprite.zoom_y
      fp["frame"].angle += 2
    end
    for l in 0...24
      next if i < 10
      next if l>((i-10)*8)
      cx, cy = @targetSprite.getCenter(true)
      if fp["p#{l}"].opacity <= 0 && fp["p#{l}"].tone.blue <= 0
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x = rand(128); y = rand(128)
        px[l] = cx - 64*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 64*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.1
      fp["p#{l}"].y += (y2 - y0)*0.1
      fp["p#{l}"].opacity -= 8
      fp["p#{l}"].tone.blue = 1 if fp["p#{l}"].opacity <= 0
    end
    fp["bg"].opacity -= 8 if i >= 48
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CROSSCHOP.rb =====#
#-------------------------------------------------------------------------------
#  CROSSCHOP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CROSSCHOP) do
  EliteBattle.playMoveAnimation(:BULKUP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  rndx = []
  rndy = []
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(131,84,42))
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_8")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..20
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	cx, cy = @targetSprite.getCenter(true)
	for k in 0...16
		next if i < 4
		if j == 0 && i == 6
			fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
			fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
			@targetSprite.still if k.between?(flashStart,flashStart+2)
			@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
			@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
			@scene.wait(1,true)
			pbSEPlay("EBDX/Anim/normal1",100) if k == 4
			fp["claw"].src_rect.height += 15
			fp["claw"].opacity -= 45 if k >= 5
			j = 1 if k == 15		
		end
		#
		if fp["#{k}"].opacity == 0 && fp["#{k}"].visible
			fp["#{k}"].x = cx
			fp["#{k}"].y = cy
		end
		x2 = cx - 64*@targetSprite.zoom_x + rndx[k]*@targetSprite.zoom_x
		y2 = cy - 64*@targetSprite.zoom_y + rndy[k]*@targetSprite.zoom_y
		x0 = fp["#{k}"].x
		y0 = fp["#{k}"].y
		fp["#{k}"].x += (x2 - x0)*0.2
		fp["#{k}"].y += (y2 - y0)*0.2
		fp["#{k}"].zoom_x += 0.01
		fp["#{k}"].zoom_y += 0.01
		if i < 20
			fp["#{k}"].tone.red -= 6; fp["#{k}"].tone.blue -= 6; fp["#{k}"].tone.green -= 6
		end
		if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
			fp["#{k}"].opacity -= 51
		else
			fp["#{k}"].opacity += 51
		end
		fp["#{k}"].visible = false if fp["#{k}"].opacity <= 0
		#
	end
	@scene.wait(1,true)
  end
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: CROSSPOISON.rb =====#
#-------------------------------------------------------------------------------
#  CROSSPOISON
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CROSSPOISON) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  rndx = []
  rndy = []
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(180,51,185))
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_5")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb427_2")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..20
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	cx, cy = @targetSprite.getCenter(true)
	pbSEPlay("Anim/Poison",85) if i == 5
	for k in 0...16
		next if i < 4
		if j == 0 && i == 6
			fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
			fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
			@targetSprite.still if k.between?(flashStart,flashStart+2)
			@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
			@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
			@scene.wait(1,true)
			pbSEPlay("EBDX/Anim/normal3",85) if k == 4
			fp["claw"].src_rect.height += 45
			fp["claw"].opacity -= 45 if k >= 5
			j = 1 if k == 16		
		end
		#
		if fp["#{k}"].opacity == 0 && fp["#{k}"].visible
			fp["#{k}"].x = cx
			fp["#{k}"].y = cy
		end
		x2 = cx - 64*@targetSprite.zoom_x + rndx[k]*@targetSprite.zoom_x
		y2 = cy - 64*@targetSprite.zoom_y + rndy[k]*@targetSprite.zoom_y
		x0 = fp["#{k}"].x
		y0 = fp["#{k}"].y
		fp["#{k}"].x += (x2 - x0)*0.2
		fp["#{k}"].y += (y2 - y0)*0.2
		fp["#{k}"].zoom_x += 0.01
		fp["#{k}"].zoom_y += 0.01
		if i < 20
			fp["#{k}"].tone.red -= 6; fp["#{k}"].tone.blue -= 6; fp["#{k}"].tone.green -= 6
		end
		if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
			fp["#{k}"].opacity -= 51
		else
			fp["#{k}"].opacity += 51
		end
		fp["#{k}"].visible = false if fp["#{k}"].opacity <= 0
		#
	end
	@scene.wait(1,true)
  end
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: CRUNCH.rb =====#
#-------------------------------------------------------------------------------
#  Crunch
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CRUNCH) do
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(66,60,81))
  fp["bg"].opacity = 0
  for i in 0...10
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb024")
    fp["#{i}"].ox = 6
    fp["#{i}"].oy = 5
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  fp["fang1"] = Sprite.new(@viewport)
  fp["fang1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang1"].ox = fp["fang1"].bitmap.width/2
  fp["fang1"].oy = fp["fang1"].bitmap.height - 20
  fp["fang1"].opacity = 0
  fp["fang1"].z = 41
  fp["fang2"] = Sprite.new(@viewport)
  fp["fang2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang2"].ox = fp["fang1"].bitmap.width/2
  fp["fang2"].oy = fp["fang1"].bitmap.height - 20
  fp["fang2"].opacity = 0
  fp["fang2"].z = 40
  fp["fang2"].angle = 180
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["fang1"].x = cx; fp["fang1"].y = cy
    fp["fang1"].zoom_x = @targetSprite.zoom_x; fp["fang1"].zoom_y = @targetSprite.zoom_y
    fp["fang2"].x = cx; fp["fang2"].y = cy
    fp["fang2"].zoom_x = @targetSprite.zoom_x; fp["fang2"].zoom_y = @targetSprite.zoom_y
    if i.between?(20,29)
      fp["fang1"].opacity += 5
      fp["fang1"].oy += 2
      fp["fang2"].opacity += 5
      fp["fang2"].oy += 2
    elsif i.between?(30,40)
      fp["fang1"].opacity += 25.5
      fp["fang1"].oy -= 4
      fp["fang2"].opacity += 25.5
      fp["fang2"].oy -= 4
    else
      fp["fang1"].opacity -= 26
      fp["fang1"].oy += 2
      fp["fang2"].opacity -= 26
      fp["fang2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Super Fang")
    end
    for j in 0...10
      next if i < 40
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].angle += 16
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.001
      fp["#{j}"].zoom_y += 0.001
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 45
        fp["#{j}"].angle += 16
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      if i >= 56
        @targetSprite.tone.red -= 3*2
        @targetSprite.tone.green -= 3*2
        @targetSprite.tone.blue -= 3*2
        fp["bg"].opacity -= 10
      else
        @targetSprite.tone.red += 3*2 if @targetSprite.tone.red < 48*2
        @targetSprite.tone.green += 3*2 if @targetSprite.tone.green < 48*2
        @targetSprite.tone.blue += 3*2 if @targetSprite.tone.blue < 48*2
      end
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CRUSHCLAW.rb =====#
#-------------------------------------------------------------------------------
#  CRUSHCLAW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CRUSHCLAW) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  @userSprite.oy = oy
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp["claw1"] = Sprite.new(@viewport)
  fp["claw1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_3")
  fp["claw1"].src_rect.set(-82,0,82,174)
  fp["claw1"].ox = fp["claw1"].src_rect.width
  fp["claw1"].oy = fp["claw1"].src_rect.height/2
  fp["claw1"].x = cx - 32*@targetSprite.zoom_x
  fp["claw1"].y = cy
  fp["claw1"].z = @targetIsPlayer ? 29 : 19
  fp["claw2"] = Sprite.new(@viewport)
  fp["claw2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_3")
  fp["claw2"].src_rect.set(-82,0,82,174)
  fp["claw2"].ox = 0
  fp["claw2"].oy = fp["claw2"].src_rect.height/2
  fp["claw2"].x = cx + 32*@targetSprite.zoom_x
  fp["claw2"].y = cy
  fp["claw2"].z = @targetIsPlayer ? 29 : 19
  fp["claw2"].mirror = true
  shake = 4
  for i in 0...32
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal3") if i == 4 || i == 16
    for j in 1..2
      next if (j-1)>(i/12)
      fp["claw#{j}"].src_rect.x += 82 if fp["claw#{j}"].src_rect.x < 82*3 && i%2==0
    end
    fp["claw1"].visible = false if i == 16
    fp["claw2"].visible = false if i == 32
    if i.between?(4,12) || i.between?(20,28)
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CRUSHGRIP.rb =====#
#-------------------------------------------------------------------------------
#  BIND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BIND) do
  EliteBattle.playMoveAnimation(:CRUSHGRIP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  VICEGRIP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:VICEGRIP) do
  EliteBattle.playMoveAnimation(:CRUSHGRIP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  CRUSHGRIP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CRUSHGRIP) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(255,255,154))
  fp["bg"].opacity = 0
  fp["wrap1"] = Sprite.new(@viewport)
  fp["wrap1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_4")
  fp["wrap1"].ox = fp["wrap1"].bitmap.width/2 - 10
  fp["wrap1"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap1"].angle = -90
  fp["wrap1"].opacity = 0
  fp["wrap1"].z = 41
  fp["wrap2"] = Sprite.new(@viewport)
  fp["wrap2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_4")
  fp["wrap2"].ox = fp["wrap1"].bitmap.width/2 + 10
  fp["wrap2"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap2"].opacity = 0
  fp["wrap2"].z = 40
  fp["wrap2"].mirror = true
  fp["wrap2"].angle = 90
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...80
    cx, cy = @targetSprite.getCenter(true)
    fp["wrap1"].x = cx; fp["wrap1"].y = cy
    fp["wrap1"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap1"].zoom_y = 1.5*@targetSprite.zoom_y
    fp["wrap2"].x = cx; fp["wrap2"].y = cy
    fp["wrap2"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap2"].zoom_y = 1.5*@targetSprite.zoom_y
    if i.between?(20,35)
      fp["wrap1"].opacity += 5
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity += 5
      fp["wrap2"].oy += 2
    elsif i.between?(35,45)
      fp["wrap1"].opacity += 25.5
      fp["wrap1"].oy -= 2
      fp["wrap2"].opacity += 25.5
      fp["wrap2"].oy -= 2
    else
      fp["wrap1"].opacity -= 26
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity -= 26
      fp["wrap2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Wrap")
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: CURSE.rb =====#
#-------------------------------------------------------------------------------
#  CURSE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CURSE) do
  if $game_switches[213]
    EliteBattle.playMoveAnimation(:NIGHTSHADE, @scene, @userIndex, @targetIndex)
  else
    EliteBattle.playMoveAnimation(:DRAGONDANCE, @scene, @userIndex, @targetIndex)
  end
end


#===== FILE: CUT.rb =====#
#-------------------------------------------------------------------------------
#  CUT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CUT) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.white)
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_4")
  fp["claw"].mirror = true if rand(1)==0
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...16
	    fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
	    fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
		@targetSprite.still if k.between?(flashStart,flashStart+2)
		@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
		@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
		@scene.wait(1,true)
		pbSEPlay("EBDX/Anim/normal3",85) if k == 4
		fp["claw"].src_rect.height += 60
		fp["claw"].opacity -= 60 if k >= 5
		@scene.wait(1,true)
	  end
	  j = 1
	end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: DARKPULSE.rb =====#
#-------------------------------------------------------------------------------
#  DARKPULSE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DARKPULSE) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb093_bg_2")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_1_2")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = @userSprite.z + 1
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 0.75 : 1)
  fp["cir"].zoom_y = (@targetIsPlayer ? 0.75 : 1)
  fp["cir"].opacity = 0
  shake = 4; k = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...40
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 24
    end
    if i == 8
      @vector.set(vector2)
      pbSEPlay("EBDX/Anim/ghost3",80)
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_2_2")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  fp["shot"] = Sprite.new(@viewport)
  fp["shot"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_3_2")
  fp["shot"].ox = fp["shot"].bitmap.width/2
  fp["shot"].oy = fp["shot"].bitmap.height/2
  fp["shot"].z = @userSprite.z + 1
  fp["shot"].zoom_x = @userSprite.zoom_x
  fp["shot"].zoom_y = @userSprite.zoom_x
  fp["shot"].opacity = 0
  x = defaultvector[0]; y = defaultvector[1]
  x2, y2 = @vector.spoof(defaultvector)
  fp["shot"].x = cx
  fp["shot"].y = cy
  pbSEPlay("Anim/Nightshade",80)
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    @vector.reset if i == 0
    if i > 0
      fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
      fp["shot"].opacity += 32
      fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
      fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity -= 16
      fp["cir"].x = cx
      fp["cir"].y = cy
    end
    fp["bg"].update
    factor = @targetSprite.zoom_x if i == 12
    if i >= 12
      k *= -1 if i%4==0
      @targetSprite.zoom_x -= factor*0.01*k
      @targetSprite.zoom_y += factor*0.04*k
      @targetSprite.still
    end
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,i < 12)
  end
  shake = 2
  16.times do
    fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
    fp["shot"].opacity += 32
    fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
    fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
    fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
    fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
    fp["bg"].color.alpha += 16
    fp["bg"].update
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
    @targetSprite.still
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  16.times do
    fp["bg"].update
    @targetSprite.still
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].update
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: DARKVOID.rb =====#
#-------------------------------------------------------------------------------
#  DARKVOID
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DARKVOID) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb263_bg_2")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_4_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_3_2")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_0_2")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_2_2")
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Nightshade")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Nightshade") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: DAZZLINGGLEAM.rb =====#
#-------------------------------------------------------------------------------
#  DAZZLINGGLEAM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DAZZLINGGLEAM) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.black)
  fp["bg"].opacity = 0
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  # charging animation
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb613_2")
    fp["s#{j}"].center!
    r = 64*@userSprite.zoom_x
    x1, y1 = randCircleCord(r)
    fp["s#{j}"].x = cx - r + x1
    fp["s#{j}"].y = cy - r + y1
    fp["s#{j}"].opacity = 0
    z = [1.1,1,0.9,1.2,0.8][rand(5)]
    fp["s#{j}"].zoom_x = z
    fp["s#{j}"].zoom_y = z
    fp["s#{j}"].z = @userSprite.z + 1
  end
  fp["glow"] = Sprite.new(@viewport)
  fp["glow"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb613_3")
  fp["glow"].center!
  fp["glow"].x = cx
  fp["glow"].y = cy
  fp["glow"].opacity = 0
  fp["glow"].toggle = 1
  for j in 0...2
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb613_#{5+j}")
    fp["c#{j}"].center!
    fp["c#{j}"].toggle = 1
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].param = 1
    fp["c#{j}"].zoom_x = @userSprite.zoom_x
    fp["c#{j}"].zoom_y = @userSprite.zoom_y
    fp["c#{j}"].z = @userSprite.z + 1
  end
  for j in 0...8
    fp["t#{j}"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb613"))
    fp["t#{j}"].z = @userSprite.z + 1
    r = @viewport.width
    x1, y1 = randCircleCord(r)
    fp["t#{j}"].x = cx - r + x1
    fp["t#{j}"].y = cy - r + y1
    fp["t#{j}"].color = Color.white
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb613_4")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].color = Color.new(192,56,121,0)
  fp["circle"].param = 0
  fp["circle"].z = @userSprite.z + 2
  fp["circle"].opacity = 0
  fp["ripples"] = Sprite.new(@viewport)
  fp["ripples"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb613_7")
  fp["ripples"].center!
  fp["ripples"].x = cx
  fp["ripples"].y = cy
  fp["ripples"].opacity = 0
  fp["ripples"].zoom_x = @userSprite.zoom_x
  fp["ripples"].zoom_y = @userSprite.zoom_y
  fp["ripples"].color = Color.new(255,255,255,0)
  fp["ripples"].z = @userSprite.z + 2
  pbSEPlay("Anim/Harden")
  for i in 0...148
    pbSEPlay("Anim/Refresh") if i == 16
    pbSEPlay("Anim/Saint8") if i == 68
    for j in 0...8
      next if j > i/4
      fp["s#{j}"].opacity += 48
      fp["s#{j}"].zoom_x -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_x > 0
      fp["s#{j}"].zoom_y -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_y > 0
      fp["s#{j}"].x -= (cx - fp["s#{j}"].x)*0.01
      fp["s#{j}"].y -= (cy - fp["s#{j}"].y)*0.01
    end
    for j in 0...8
      next if i < 16
      next if j > (i-16)/8
      fp["t#{j}"].x -= (fp["t#{j}"].x - cx)*0.1
      fp["t#{j}"].y -= (fp["t#{j}"].y - cy)*0.1
      fp["t#{j}"].color.alpha -= 8
      fp["t#{j}"].update if i < 128
      fp["t#{j}"].visible = false if i == 128
    end
    for j in 0...2
      next if i < 32
      fp["c#{j}"].param -= fp["c#{j}"].toggle*0.0625*(j+1)
      if j == 0
        fp["c#{j}"].zoom_x = fp["c#{j}"].param*@userSprite.zoom_x
      else
        fp["c#{j}"].zoom_y = fp["c#{j}"].param*@userSprite.zoom_y
      end
      fp["c#{j}"].opacity += i < 132 ? 8 : -32
      fp["c#{j}"].toggle *= -1 if fp["c#{j}"].param <= 0 || fp["c#{j}"].param >= 1
      fp["c#{j}"].x = cx
      fp["c#{j}"].y = cy
    end
    if i >= 32
      fp["circle"].zoom_x += 0.03125 if fp["circle"].zoom_x < 1
      fp["circle"].zoom_y += 0.03125 if fp["circle"].zoom_y < 1
      fp["circle"].param = (fp["circle"].param == 0 ? 255 : 0) if i%12 == 0 || i%12 == 4
      fp["circle"].color.alpha = fp["circle"].param if i < 132
      fp["circle"].opacity += 8
      fp["glow"].opacity += i < 132 ? 4 : -32
      fp["glow"].zoom_x -= 0.02*fp["glow"].toggle
      fp["glow"].zoom_y -= 0.02*fp["glow"].toggle
      fp["glow"].toggle *= -1 if i%4 == 0
    end
    pbSEPlay("EBDX/Anim/move2") if i == 132
    pbSEPlay("EBDX/Anim/normal5",80) if i == 132
    # shooting at the target
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 132
    fp["circle"].z = @targetSprite.z + 1 if i == 132
    if i >= 132
      cx, cy = @userSprite.getCenter(true)
      x1, y1 = @targetSprite.getCenter(true)
      fp["ripples"].opacity += i < 140 ? 32 : - 32
      fp["ripples"].zoom_x += 0.1*@userSprite.zoom_x
      fp["ripples"].zoom_y += 0.1*@userSprite.zoom_y
      fp["ripples"].color.alpha += 16
      fp["ripples"].x = cx
      fp["ripples"].y = cy
      fp["circle"].color.alpha = 0
      fp["circle"].zoom_x = @vector.zoom1
      fp["circle"].zoom_y = @vector.zoom1
      fp["circle"].x += (x1 - fp["circle"].x)*0.1
      fp["circle"].y -= (fp["circle"].y - y1)*0.1
      fp["circle"].opacity -= 64 if i >= 144
    end
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/iron4")
  pbSEPlay("EBDX/Anim/iron1")
  # hitting the target
  for j in 0...24
    fp["r2#{j}"] = Sprite.new(@viewport)
    fp["r2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_10")
    fp["r2#{j}"].center!
    fp["r2#{j}"].x = @targetSprite.x - @targetSprite.ox + rand(@targetSprite.bitmap.width)
    fp["r2#{j}"].y = @targetSprite.y - @targetSprite.oy + rand(@targetSprite.bitmap.height)
    fp["r2#{j}"].z = @targetSprite.z + 1 + rand(2)
    fp["r2#{j}"].visible = false
  end
  for j in 0...32
    fp["r#{j}"] = Sprite.new(@viewport)
    b = rand(2)
    fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb613_#{8+b}")
    fp["r#{j}"].center!
    fp["r#{j}"].ox /= 2 if b == 0
    fp["r#{j}"].src_rect.set(rand(2)*fp["r#{j}"].bitmap.width/2,0,fp["r#{j}"].bitmap.width/2,fp["r#{j}"].bitmap.height) if b == 0
    fp["r#{j}"].x = x1
    fp["r#{j}"].y = y1
    r = (48 + rand(49))*@targetSprite.zoom_x
    rx, ry = randCircleCord(r)
    fp["r#{j}"].end_x = x1 - r + rx
    fp["r#{j}"].end_y = y1 - r + ry
    fp["r#{j}"].opacity = 0
    fp["r#{j}"].toggle = 2
    fp["r#{j}"].z = @targetSprite.z + 1
    fp["r#{j}"].zoom_x = @targetSprite.zoom_x
    fp["r#{j}"].zoom_y = @targetSprite.zoom_y
    fp["r#{j}"].param = 0
    fp["r#{j}"].speed = rand(15)
  end
  k = 1
  for i in 0...64
    for j in 0...32
      #next if j > i
      fp["r#{j}"].opacity += 16*fp["r#{j}"].toggle
      fp["r#{j}"].toggle = -4 if fp["r#{j}"].param >= 24+fp["r#{j}"].speed
      fp["r#{j}"].x += (fp["r#{j}"].end_x - fp["r#{j}"].x)*0.05
      fp["r#{j}"].y += (fp["r#{j}"].end_y - fp["r#{j}"].y)*0.05
      fp["r#{j}"].zoom_x -= fp["r#{j}"].zoom_x*0.02
      fp["r#{j}"].zoom_y -= fp["r#{j}"].zoom_y*0.02
      fp["r#{j}"].param += 1
    end
    for j in 0...24
      next if i < 8
      next if j > (i-8)/2
      fp["r2#{j}"].visible = true
      fp["r2#{j}"].opacity -= 24
      fp["r2#{j}"].zoom_x -= 0.02
      fp["r2#{j}"].zoom_y -= 0.02
    end
    if i >= 24
      @targetSprite.ox += k*2
      k *= -1 if i%2 == 0
      pbSEPlay("EBDX/Anim/normal2",50) if i%4 == 0
    end
    @targetSprite.still
    @scene.wait
  end
  @vector.reset
  for key in fp.keys
    next if key == "bg"
    fp[key].dispose
  end
  16.times do
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  fp["bg"].dispose
  fp.clear
end

#===== FILE: DEFENDORDER.rb =====#
#-------------------------------------------------------------------------------
#  DEFENDORDER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DEFENDORDER) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  numElements = 60
  for j in 0...numElements
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010_3")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 45*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(103,113,164,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...numElements
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 24
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 10
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: DESTINYBOND.rb =====#
#-------------------------------------------------------------------------------
#  DESTINYBOND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DESTINYBOND) do
  # set up animation
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb195_3")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  k = 0
  c = [Tone.new(75,60,81),Tone.new(0,0,0)]
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...128
    cx, cy = @userSprite.getCenter
    for j in 0...12
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        x, y = randCircleCord(64*factor)
        fp["#{j}"].x = cx - 64*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 64*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    if i < 96
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.6
    else
      fp["bg"].opacity -= 5
    end
    if i < 112
      if i%16 == 0
        k += 1
        k = 0 if k > 1
      end
      @userSprite.tone.red += (c[k].red - @userSprite.tone.red)*0.2
      @userSprite.tone.green += (c[k].green - @userSprite.tone.green)*0.2
      @userSprite.tone.blue += (c[k].blue - @userSprite.tone.blue)*0.2
    end
    pbSEPlay("Anim/Absorb2",100) if i == 16
    pbSEPlay("Anim/PerishSong",70) if i == 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.tone = Tone.new(0,0,0)
  @vector.reset
  pbDisposeSpriteHash(fp)
 end
#===== FILE: DETECT.rb =====#
#-------------------------------------------------------------------------------
#  QUICKGUARD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:QUICKGUARD) do
  EliteBattle.playMoveAnimation(:DETECT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  WIDEGUARD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WIDEGUARD) do
  EliteBattle.playMoveAnimation(:DETECT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DETECT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DETECT) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb608")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @targetIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 5
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
    if i.between?(7,11)
      #@targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: DIG.rb =====#
#-------------------------------------------------------------------------------
#  DIG
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DIG) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:DIG_DOWN, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:DIG_UP, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:DIG_DOWN) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  splash = 50
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(129,111,68))
  fp["bg"].opacity = 0
  fp["dig"] = Sprite.new(@viewport)
  fp["dig"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_6")
  fp["dig"].ox = fp["dig"].bitmap.width/2
  fp["dig"].oy = fp["dig"].bitmap.height/2
  fp["dig"].z = 50
  fp["dig"].x, fp["dig"].y = @userSprite.getCenter
  fp["dig"].opacity = 0
  fp["dig"].zoom_x = factor*1.4
  fp["dig"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_8")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("EBDX/Anim/rock2")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["dig"].x = cx
    fp["dig"].y = cy
    fp["dig"].zoom_x -= factor*0.4/10
    fp["dig"].zoom_y -= factor*0.4/10
    fp["dig"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["dig"].zoom_x
    fp["dnt"].zoom_y = fp["dig"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @userSprite.visible = false if i == 6
    @userSprite.hidden = true if i == 6
    @scene.wait(1,true)
  end
  10.times do
    fp["dig"].zoom_x += factor*0.4/10
    fp["dig"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["dig"].zoom_x
    fp["dnt"].zoom_y = fp["dig"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1],vector[2],vector[3],vector[4],vector[5])
  for i in 0...13
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["dig"].zoom_y -= factor*0.02
    elsif
      fp["dig"].zoom_x -= factor*0.02
      fp["dig"].zoom_y += factor*0.04
    end
    fp["dig"].x = cx
    fp["dig"].y = cy
    fp["dig"].y -= 25*(i-1) if i <= 6 && i > 1
	fp["dig"].y -= 149 + 15 if i == 7
	fp["dig"].y -= 164 + 10 if i == 8
	fp["dig"].y -= 174 + 5  if i == 9
	fp["dig"].y -= 197      if i == 10
	fp["dig"].y -= 197      if i == 11
	fp["dig"].y -= 197 - 10 if i == 12
	fp["dig"].y += 32*(i-13) if i >= 13
    pbSEPlay("Anim/rock1") if i == 10
  end
  # init splash
  for j in 0...splash
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @userSprite.getCenter(true)
	fp["p#{j}"].y + 30
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y + 30
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @userSprite.z + 1
    #fp["p#{j}"].color = Color.new(136,48,138)
  end
  # splash animation
  for i in 0...64
	fp["dig"].y += 32			 if i >= 0 && i < 10
    fp["dig"].opacity -= 30 if i >= 0 && i < 10
	pbSEPlay("Anim/rock2",90) if i == 5
    for j in 0...splash
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1 - 15
      if fp["p#{j}"].zoom_x >= 0.5
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end
########################################################################################################################
EliteBattle.defineMoveAnimation(:DIG_UP) do
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  splash = 50
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(129,111,68))
  fp["bg"].opacity = 0
  fp["drop"] = Sprite.new(@viewport)
  fp["drop"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_7")
  fp["drop"].ox = fp["drop"].bitmap.width/2
  fp["drop"].oy = fp["drop"].bitmap.height/2
  fp["drop"].y = 0
  fp["drop"].z = 50
  fp["drop"].visible = false
  # start animation
  @vector.set(defaultvector[0], defaultvector[1], defaultvector[2], defaultvector[3], defaultvector[4], defaultvector[5])
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  fp["drop"].y = @targetSprite.y + 30
  fp["drop"].x = @targetSprite.x
  pbSEPlay("Anim/rock1")
  # init splash
  for j in 0...splash
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
	fp["p#{j}"].y += 40
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y + 30
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
    #fp["p#{j}"].color = Color.new(136,48,138)
  end
  # splash animation
  for i in 0...64
	pbSEPlay("Anim/rock2",90) if i == 5
    for j in 0...splash
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1 - 15
      if fp["p#{j}"].zoom_x >= 0.5
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	if i > 5 && i <= 15
		fp["drop"].visible = true
		fp["drop"].x = @targetSprite.x
		fp["drop"].y -= 25
		fp["drop"].zoom_x = @targetSprite.zoom_x
		fp["drop"].zoom_y = @targetSprite.zoom_y*1.4
	else 
		fp["drop"].opacity -= 30
	end
	@scene.wait(1,i < 8)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.hidden = false
  @userSprite.visible = true
  @vector.reset
  pbDisposeSpriteHash(fp)
end

#===== FILE: DISARMINGVOICE.rb =====#
#-------------------------------------------------------------------------------
#  DISARMINGVOICE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DISARMINGVOICE) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  rndNote = 0
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(255,204,255))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
	rndNote = rand(2)
	if rndNote == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_9")
	else
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_10")
	end
    #fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].src_rect.set(0,101*0,53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end 
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/DisarmingVoice",80) if i==0 
    if i >= 96
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    # @targetSprite.tone.red -= 2.4*2
    # @targetSprite.tone.green += 1.2*2
    # @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -1 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 1 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: DISCHARGE.rb =====#
#-------------------------------------------------------------------------------
#  DISCHARGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DISCHARGE) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  EliteBattle.playMoveAnimation(:CHARGE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playMoveAnimation(:THUNDERBOLT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: DIVE.rb =====#
#-------------------------------------------------------------------------------
#  DIVE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DIVE) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:DIVE_DOWN, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:DIVE_UP, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:DIVE_DOWN) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  splash = 50
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,78,131))
  fp["bg"].opacity = 0
  fp["dive"] = Sprite.new(@viewport)
  fp["dive"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_4")
  fp["dive"].ox = fp["dive"].bitmap.width/2
  fp["dive"].oy = fp["dive"].bitmap.height/2
  fp["dive"].z = 50
  fp["dive"].x, fp["dive"].y = @userSprite.getCenter
  fp["dive"].opacity = 0
  fp["dive"].zoom_x = factor*1.4
  fp["dive"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_2")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # splash
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @userSprite.z + 1
    #fp["p#{j}"].color = Color.new(136,48,138)
  end
  # start animation
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Water2")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["dive"].x = cx
    fp["dive"].y = cy
    fp["dive"].zoom_x -= factor*0.4/10
    fp["dive"].zoom_y -= factor*0.4/10
    fp["dive"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["dive"].zoom_x
    fp["dnt"].zoom_y = fp["dive"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @userSprite.visible = false if i == 6
    @userSprite.hidden = true if i == 6
    @scene.wait(1,true)
  end
  10.times do
    fp["dive"].zoom_x += factor*0.4/10
    fp["dive"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["dive"].zoom_x
    fp["dnt"].zoom_y = fp["dive"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  #@vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  @vector.set(vector[0],vector[1],vector[2],vector[3],vector[4],vector[5])
  for i in 0...13
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["dive"].zoom_y -= factor*0.02
    elsif
      fp["dive"].zoom_x -= factor*0.02
      fp["dive"].zoom_y += factor*0.04
    end
    fp["dive"].x = cx
    fp["dive"].y = cy
    fp["dive"].y -= 25*(i-1) if i <= 6 && i > 1
	fp["dive"].y -= 149 + 15 if i == 7
	fp["dive"].y -= 164 + 10 if i == 8
	fp["dive"].y -= 174 + 5  if i == 9
	fp["dive"].y -= 197      if i == 10
	fp["dive"].y -= 197      if i == 11
	fp["dive"].y -= 197 - 10 if i == 12
	fp["dive"].y += 32*(i-13) if i >= 13
    pbSEPlay("Anim/Water1") if i == 10
  end
  # init splash
  for j in 0...splash
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @userSprite.getCenter(true)
	fp["p#{j}"].y + 30
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y + 30
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @userSprite.z + 1
    #fp["p#{j}"].color = Color.new(136,48,138)
  end
  # splash animation
  for i in 0...64
	fp["dive"].y += 32			 if i >= 0 && i < 10
    fp["dive"].opacity -= 30 if i >= 0 && i < 10
	pbSEPlay("Anim/Bubble1",90) if i == 5
    for j in 0...splash
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1 - 15
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end
########################################################################################################################
EliteBattle.defineMoveAnimation(:DIVE_UP) do
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  splash = 50
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,78,131))
  fp["bg"].opacity = 0
  fp["drop"] = Sprite.new(@viewport)
  fp["drop"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_5")
  fp["drop"].ox = fp["drop"].bitmap.width/2
  fp["drop"].oy = fp["drop"].bitmap.height/2
  fp["drop"].y = 0
  fp["drop"].z = 50
  fp["drop"].visible = false
  # start animation
  @vector.set(defaultvector[0], defaultvector[1], defaultvector[2], defaultvector[3], defaultvector[4], defaultvector[5])
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  fp["drop"].y = @targetSprite.y + 30
  fp["drop"].x = @targetSprite.x
  pbSEPlay("Anim/Water1")
  # init splash
  for j in 0...splash
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
	fp["p#{j}"].y += 30
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y + 30
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
    #fp["p#{j}"].color = Color.new(136,48,138)
  end
  # splash animation
  for i in 0...64
	pbSEPlay("Anim/Bubble1",90) if i == 5
    for j in 0...splash
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1 - 15
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	if i > 0 && i <= 10
		fp["drop"].visible = true
		fp["drop"].x = @targetSprite.x
		fp["drop"].y -= 25
		fp["drop"].zoom_x = @targetSprite.zoom_x
		fp["drop"].zoom_y = @targetSprite.zoom_y*1.4
	else 
		fp["drop"].opacity -= 20
	end
	@scene.wait(1,i < 8)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.hidden = false
  @userSprite.visible = true
  @vector.reset
  pbDisposeSpriteHash(fp)
end

#===== FILE: DIZZYPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  DIZZYPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DIZZYPUNCH) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  @multiHit = true
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playCommonAnimation(:BIRDSPLASH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @multiHit = false
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: DOOMDESIRE.rb =====#
#-------------------------------------------------------------------------------
#  DOOMDESIRE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DOOMDESIRE) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:SWORDSDANCE, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:DOOMDESIRE_ATT, @scene, @userIndex, @targetIndex)
  end
end
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DOOMDESIRE_ATT) do
  # set up animation
  fp = {}
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
# clash
  @vector.set(vector)
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_7")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("EBDX/Anim/iron4",60) #change
  #pbSEPlay("Anim/Psych Up",60) #change
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  #pbSEPlay("EBDX/Anim/psychic4",80) #change
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_13")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_4")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_11")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/iron1",80) if i == 8 || i == 16 || i == 24 # keep
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end
#===== FILE: DOUBLEKICK.rb =====#
#-------------------------------------------------------------------------------
#  TRIPLEKICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TRIPLEKICK) do
  EliteBattle.playMoveAnimation(:DOUBLEKICK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  LOWKICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LOWKICK) do
  EliteBattle.playMoveAnimation(:DOUBLEKICK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  LOWSWEEP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LOWSWEEP) do
  EliteBattle.playMoveAnimation(:DOUBLEKICK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ROLLINGKICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROLLINGKICK) do
  EliteBattle.playMoveAnimation(:DOUBLEKICK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DOUBLEKICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DOUBLEKICK) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 5
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...2
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb137")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...15
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb137_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...20
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...2
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...15
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: DOUBLETEAM.rb =====#
#-------------------------------------------------------------------------------
#  MINIMIZE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MINIMIZE) do | args |
  EliteBattle.playMoveAnimation(:DOUBLETEAM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ACUPRESSURE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ACUPRESSURE) do | args |
  EliteBattle.playMoveAnimation(:DOUBLETEAM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  TEETERDANCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TEETERDANCE) do | args |
  EliteBattle.playMoveAnimation(:DOUBLETEAM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SKETCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SKETCH) do | args |
  EliteBattle.playMoveAnimation(:DOUBLETEAM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  AGILITY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AGILITY) do
  EliteBattle.playMoveAnimation(:DOUBLETEAM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DOUBLETEAM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DOUBLETEAM) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(8,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 40
  xOrigin = @userSprite.ox
  for i in 0...ports
	pbSEPlay("EBDX/Anim/move1",80) if i%10 == 0
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRAGONASCENT.rb =====#
#-------------------------------------------------------------------------------
#  DRACOMETEOR
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRACOMETEOR) do
  EliteBattle.playMoveAnimation(:DRAGONASCENT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DRAGONASCENT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONASCENT) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_4")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  shake = 4; k = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...20
	pbSEPlay("Anim/wind1",80) if i == 2
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
	  @userSprite.opacity-=25
    end
    if i == 8
      @vector.set(vector2)
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb628_6")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  fp["shot"] = Sprite.new(@viewport)
  fp["shot"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb628_5")
  fp["shot"].ox = fp["shot"].bitmap.width/2
  fp["shot"].oy = fp["shot"].bitmap.height/2
  fp["shot"].z = @userSprite.z + 1
  fp["shot"].zoom_x = @userSprite.zoom_x*0.8
  fp["shot"].zoom_y = @userSprite.zoom_y*0.8
  fp["shot"].opacity = 0
  x = defaultvector[0]; y = defaultvector[1]
  x2, y2 = @vector.spoof(defaultvector)
  fp["shot"].x = cx
  fp["shot"].y = cy
  pbSEPlay("EBDX/Anim/normal1",80)
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    @vector.reset if i == 0
    if i > 0
      fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
      fp["shot"].opacity += 32
      fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
      fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
    end
    fp["bg"].update
    factor = @targetSprite.zoom_x if i == 12
    if i >= 12
      k *= -1 if i%4==0
      @targetSprite.zoom_x -= factor*0.01*k
      @targetSprite.zoom_y += factor*0.04*k
      @targetSprite.still
    end
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,i < 12)
  end
  shake = 2
  16.times do
    fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
    fp["shot"].opacity += 32
    fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
    fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
    fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
    fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
    fp["bg"].color.alpha += 16
    fp["bg"].update
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
    @targetSprite.still
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  16.times do
    fp["bg"].update
    fp["bg"].opacity -= 16
	@userSprite.opacity+=20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRAGONBREATH.rb =====#
#-------------------------------------------------------------------------------
#  Dragon Breath
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONBREATH) do
  # set up animation
  fp = {}
  rndx = []; rndy = []
  dx = []; dy = []
  @targetSprite.color = Color.new(255,0,0,0)
  for m in 0...2
    rndx.push([]); rndy.push([]); dx.push([]); dy.push([])
    for i in 0...96
      str = ["","_2"][rand(2)]
      str = "Graphics/EBDX/Animations/Moves/eb59"+str
      str = "Graphics/EBDX/Animations/Moves/eb59_3" if m == 1
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      fp["#{i}#{m}"].bitmap = pbBitmap(str)
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].angle = rand(360)
      fp["#{i}#{m}"].opacity = 0
      if m == 0
        fp["#{i}#{m}"].zoom_x = 0.8
        fp["#{i}#{m}"].zoom_y = 0.8
      end
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      rndx[m].push(rand([16,128][m]))
      rndy[m].push(rand([16,128][m]))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  shake = 4
  # start animation
  for i in 0...96
    pbSEPlay("EBDX/Anim/dragon2") if i==8
    pbSEPlay("EBDX/Anim/dragon1") if i==74
    uax, uay = @userSprite.getAnchor(true)
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...96
        next if j>(i*2)
        if fp["#{j}#{m}"].opacity == 0 && fp["#{j}#{m}"].tone.gray == 0
          dx[m][j] = uax - [8,64][m]*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = uay - [8,64][m]*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
          if m == 1
            fp["#{j}#{m}"].opacity = 55 + rand(151)
            z = [0.5,0.75,1,0.3][rand(4)]
            fp["#{j}#{m}"].zoom_x = z
            fp["#{j}#{m}"].zoom_y = z
          end
        end
        x0 = dx[m][j]
        y0 = dy[m][j]
        x2 = cx - [8,64][m]*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - [8,64][m]*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        fp["#{j}#{m}"].x += (x2 - x0)*0.1
        fp["#{j}#{m}"].y += (y2 - y0)*0.1
        fp["#{j}#{m}"].opacity += 51 if m == 0
        fp["#{j}#{m}"].zoom_x += 0.04 if m == 0
        fp["#{j}#{m}"].zoom_y += 0.04 if m == 0
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          if nextx > cx && nexty < cy
            fp["#{j}#{m}"].visible = false if m == 0
            fp["#{j}#{m}"].opacity -= 75 if m == 1
            fp["#{j}#{m}"].tone.gray = 1 if m == 1
          end
        else
          if nextx < cx && nexty > cy
            fp["#{j}#{m}"].visible = false if m == 0
            fp["#{j}#{m}"].opacity -= 75 if m == 1
            fp["#{j}#{m}"].tone.gray = 1 if m == 1
          end
        end
      end
    end
    if i >= 58 && i < 74
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.color.alpha += 12
      @targetSprite.still
    end
    @targetSprite.zoom_y += 0.16 if i == 74
    if i >= 74 && i < 90
      @targetSprite.color.alpha -= 12
      @targetSprite.ox = @targetSprite.bitmap.width/2
      @targetSprite.still
      @targetSprite.zoom_y -= 0.01
    end
    @targetSprite.anim = true
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1, !(i >= 74 && i < 90))
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRAGONCLAW.rb =====#
#-------------------------------------------------------------------------------
#  Dragon Claw
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONCLAW) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp["claw1"] = Sprite.new(@viewport)
  fp["claw1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_3")
  fp["claw1"].src_rect.set(-82,0,82,174)
  fp["claw1"].ox = fp["claw1"].src_rect.width
  fp["claw1"].oy = fp["claw1"].src_rect.height/2
  fp["claw1"].x = cx - 32*@targetSprite.zoom_x
  fp["claw1"].y = cy
  fp["claw1"].z = @targetIsPlayer ? 29 : 19
  fp["claw2"] = Sprite.new(@viewport)
  fp["claw2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_3")
  fp["claw2"].src_rect.set(-82,0,82,174)
  fp["claw2"].ox = 0
  fp["claw2"].oy = fp["claw2"].src_rect.height/2
  fp["claw2"].x = cx + 32*@targetSprite.zoom_x
  fp["claw2"].y = cy
  fp["claw2"].z = @targetIsPlayer ? 29 : 19
  fp["claw2"].mirror = true
  shake = 4
  for i in 0...32
    @targetSprite.still
    pbSEPlay("Anim/Slash10") if i == 4 || i == 16
    for j in 1..2
      next if (j-1)>(i/12)
      fp["claw#{j}"].src_rect.x += 82 if fp["claw#{j}"].src_rect.x < 82*3 && i%2==0
    end
    fp["claw1"].visible = false if i == 16
    fp["claw2"].visible = false if i == 32
    if i.between?(4,12) || i.between?(20,28)
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRAGONDANCE.rb =====#
#-------------------------------------------------------------------------------
#  Dragon Dance
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONDANCE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRAGONHAMMER.rb =====#
#-------------------------------------------------------------------------------
#  DRAGONHAMMER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONHAMMER) do
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  pbSEPlay("EBDX/Anim/iron2",80,80)
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...2
    4.times do
      @userSprite.x += 8*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @userSprite.x -= 2*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @scene.wait
    end
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb631_3")
    fp["#{i}"].ox = 6
    fp["#{i}"].oy = 6
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
	fp["#{i}"].angle = rand(360)
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  factor = 1
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb520_3")
  frame.src_rect.set(0,0,114,114)
  frame.ox = 57
  frame.oy = 57
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  # start animation
  for i in 1..30
    if i == 6
      pbSEPlay("EBDX/Anim/dragon1",100)
      pbSEPlay("EBDX/Anim/iron1",80)
    end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 114 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...16
      next if i < 6
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      fp["#{j}"].angle += 2
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: DRAGONPULSE.rb =====#
#-------------------------------------------------------------------------------
#  DRAGONPULSE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONPULSE) do
  # set up animation
  fp = {}
  rndx = []; rndy = []
  dx = []; dy = []
  @targetSprite.color = Color.new(0,0,255,0)
  for m in 0...2
    rndx.push([]); rndy.push([]); dx.push([]); dy.push([])
    for i in 0...96
      str = ["","_2"][rand(2)]
      str = "Graphics/EBDX/Animations/Moves/eb649"+str
      str = "Graphics/EBDX/Animations/Moves/eb649_3" if m == 1
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      fp["#{i}#{m}"].bitmap = pbBitmap(str)
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].angle = rand(360)
      fp["#{i}#{m}"].opacity = 0
      if m == 0
        fp["#{i}#{m}"].zoom_x = 0.8
        fp["#{i}#{m}"].zoom_y = 0.8
      end
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      rndx[m].push(rand([16,128][m]))
      rndy[m].push(rand([16,128][m]))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  shake = 4
  # start animation
  for i in 0...96
    pbSEPlay("EBDX/Anim/dragon2") if i==8
    pbSEPlay("EBDX/Anim/dragon1") if i==74
    uax, uay = @userSprite.getAnchor(true)
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...96
        next if j>(i*2)
        if fp["#{j}#{m}"].opacity == 0 && fp["#{j}#{m}"].tone.gray == 0
          dx[m][j] = uax - [8,64][m]*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = uay - [8,64][m]*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
          if m == 1
            fp["#{j}#{m}"].opacity = 55 + rand(151)
            z = [0.5,0.75,1,0.3][rand(4)]
            fp["#{j}#{m}"].zoom_x = z
            fp["#{j}#{m}"].zoom_y = z
          end
        end
        x0 = dx[m][j]
        y0 = dy[m][j]
        x2 = cx - [8,64][m]*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - [8,64][m]*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        fp["#{j}#{m}"].x += (x2 - x0)*0.1
        fp["#{j}#{m}"].y += (y2 - y0)*0.1
        fp["#{j}#{m}"].opacity += 51 if m == 0
        fp["#{j}#{m}"].zoom_x += 0.04 if m == 0
        fp["#{j}#{m}"].zoom_y += 0.04 if m == 0
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          if nextx > cx && nexty < cy
            fp["#{j}#{m}"].visible = false if m == 0
            fp["#{j}#{m}"].opacity -= 75 if m == 1
            fp["#{j}#{m}"].tone.gray = 1 if m == 1
          end
        else
          if nextx < cx && nexty > cy
            fp["#{j}#{m}"].visible = false if m == 0
            fp["#{j}#{m}"].opacity -= 75 if m == 1
            fp["#{j}#{m}"].tone.gray = 1 if m == 1
          end
        end
      end
    end
    if i >= 58 && i < 74
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.color.alpha += 12
      @targetSprite.still
    end
    @targetSprite.zoom_y += 0.16 if i == 74
    if i >= 74 && i < 90
      @targetSprite.color.alpha -= 12
      @targetSprite.ox = @targetSprite.bitmap.width/2
      @targetSprite.still
      @targetSprite.zoom_y -= 0.01
    end
    @targetSprite.anim = true
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1, !(i >= 74 && i < 90))
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRAGONRAGE.rb =====#
#-------------------------------------------------------------------------------
#  DRAGONRAGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONRAGE) do
  # set up animation
  fp = {}
  rndx = []; rndy = []
  dx = []; dy = []
  @targetSprite.color = Color.new(255,0,0,0)
  for m in 0...2
    rndx.push([]); rndy.push([]); dx.push([]); dy.push([])
    for i in 0...96
      str = ["","_2"][rand(2)]
      str = "Graphics/EBDX/Animations/Moves/eb650"+str
      str = "Graphics/EBDX/Animations/Moves/eb650_3" if m == 1
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      fp["#{i}#{m}"].bitmap = pbBitmap(str)
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].angle = rand(360)
      fp["#{i}#{m}"].opacity = 0
      if m == 0
        fp["#{i}#{m}"].zoom_x = 0.8
        fp["#{i}#{m}"].zoom_y = 0.8
      end
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      rndx[m].push(rand([16,128][m]))
      rndy[m].push(rand([16,128][m]))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  shake = 4
  # start animation
  for i in 0...96
    pbSEPlay("EBDX/Anim/dragon2") if i==8
    pbSEPlay("EBDX/Anim/dragon1") if i==74
    uax, uay = @userSprite.getAnchor(true)
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...96
        next if j>(i*2)
        if fp["#{j}#{m}"].opacity == 0 && fp["#{j}#{m}"].tone.gray == 0
          dx[m][j] = uax - [8,64][m]*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = uay - [8,64][m]*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
          if m == 1
            fp["#{j}#{m}"].opacity = 55 + rand(151)
            z = [0.5,0.75,1,0.3][rand(4)]
            fp["#{j}#{m}"].zoom_x = z
            fp["#{j}#{m}"].zoom_y = z
          end
        end
        x0 = dx[m][j]
        y0 = dy[m][j]
        x2 = cx - [8,64][m]*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - [8,64][m]*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        fp["#{j}#{m}"].x += (x2 - x0)*0.1
        fp["#{j}#{m}"].y += (y2 - y0)*0.1
        fp["#{j}#{m}"].opacity += 51 if m == 0
        fp["#{j}#{m}"].zoom_x += 0.04 if m == 0
        fp["#{j}#{m}"].zoom_y += 0.04 if m == 0
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          if nextx > cx && nexty < cy
            fp["#{j}#{m}"].visible = false if m == 0
            fp["#{j}#{m}"].opacity -= 75 if m == 1
            fp["#{j}#{m}"].tone.gray = 1 if m == 1
          end
        else
          if nextx < cx && nexty > cy
            fp["#{j}#{m}"].visible = false if m == 0
            fp["#{j}#{m}"].opacity -= 75 if m == 1
            fp["#{j}#{m}"].tone.gray = 1 if m == 1
          end
        end
      end
    end
    if i >= 58 && i < 74
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.color.alpha += 12
      @targetSprite.still
    end
    @targetSprite.zoom_y += 0.16 if i == 74
    if i >= 74 && i < 90
      @targetSprite.color.alpha -= 12
      @targetSprite.ox = @targetSprite.bitmap.width/2
      @targetSprite.still
      @targetSprite.zoom_y -= 0.01
    end
    @targetSprite.anim = true
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1, !(i >= 74 && i < 90))
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRAGONTAIL.rb =====#
#-------------------------------------------------------------------------------
#  DRAGONRUSH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONRUSH) do
  EliteBattle.playMoveAnimation(:DRAGONTAIL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DRAGONTAIL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAGONTAIL) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_8")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  # start animation
  k = 1
  for i in 0...32
    #pbSEPlay("EBDX/Anim/normal4",80) if i == 4
    pbSEPlay("EBDX/Anim/iron2",80) if i == 4
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRAINPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  DRAINPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRAINPUNCH) do
  #@vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playMoveAnimation(:ABSORB, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: DRILLPECK.rb =====#
#-------------------------------------------------------------------------------
#  DRILLPECK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRILLPECK) do | args |
  factor = @targetSprite.zoom_x
  factorHorn = @userIsPlayer ? 1.9 : 2.5
  hornXMove = @userIsPlayer ? 2 : -2
  hornYMove = @userIsPlayer ? 10 : -10
  hornXOffset = @userIsPlayer ? 100 : -120
  hornYOffset = @userIsPlayer ? 100 : -120
  hornMoveHit = @userIsPlayer ? 3 : -3
  hornAngle = @userIsPlayer ? 0 : 180
  userOX = @userSprite.ox
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(204,229,255))
  fp["bg"].opacity = 0
  # phase 1
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # user move
  for i in 0...30
    @userSprite.still
	#default movement
    if i.between?(0,20)
		@userSprite.ox += hornXMove
	else
		@userSprite.ox -= hornYMove
    end
    @scene.wait(1,true)
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(7,true)
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/normal1",80)
  fp["horn"] = Sprite.new(@viewport)
  fp["horn"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626")
  fp["horn"].ox = fp["horn"].bitmap.width/2
  fp["horn"].oy = fp["horn"].bitmap.height/2
  fp["horn"].x, fp["horn"].y = @targetSprite.getCenter(true)
  fp["horn"].x -= hornXOffset
  fp["horn"].y += hornYOffset
  fp["horn"].opacity = 0
  fp["horn"].zoom = factorHorn
  fp["horn"].angle = hornAngle
  fp["horn"].z = 41
  # horn attack
  for i in 1..20
	if i.between?(1,15)
		fp["horn"].opacity += 20
		fp["horn"].x += hornMoveHit 
		fp["horn"].y -= hornMoveHit
	else
		fp["horn"].opacity -= 50
	end
	@scene.wait(1,true)
  end
  # phase 3
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(10,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  # anim2
  for i in 0...32
    for j in 0...12
      next if j>(i*2)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: DRILLRUN.rb =====#
#-------------------------------------------------------------------------------
#  DRILLRUN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DRILLRUN) do | args |
  factor = @targetSprite.zoom_x
  factorHorn = @userIsPlayer ? 1.9 : 2.5
  hornXMove = @userIsPlayer ? 2 : -2
  hornYMove = @userIsPlayer ? 10 : -10
  hornXOffset = @userIsPlayer ? 100 : -120
  hornYOffset = @userIsPlayer ? 100 : -120
  hornMoveHit = @userIsPlayer ? 3 : -3
  hornAngle = @userIsPlayer ? 0 : 180
  userOX = @userSprite.ox
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(131,92,42))
  fp["bg"].opacity = 0
  # phase 1
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # user move
  for i in 0...30
    @userSprite.still
	#default movement
    if i.between?(0,20)
		@userSprite.ox += hornXMove
	else
		@userSprite.ox -= hornYMove
    end
    @scene.wait(1,true)
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(7,true)
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/normal1",80)
  fp["horn"] = Sprite.new(@viewport)
  fp["horn"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626")
  fp["horn"].ox = fp["horn"].bitmap.width/2
  fp["horn"].oy = fp["horn"].bitmap.height/2
  fp["horn"].x, fp["horn"].y = @targetSprite.getCenter(true)
  fp["horn"].x -= hornXOffset
  fp["horn"].y += hornYOffset
  fp["horn"].opacity = 0
  fp["horn"].zoom = factorHorn
  fp["horn"].angle = hornAngle
  fp["horn"].z = 41
  # horn attack
  for i in 1..20
	if i.between?(1,15)
		fp["horn"].opacity += 20
		fp["horn"].x += hornMoveHit 
		fp["horn"].y -= hornMoveHit
	else
		fp["horn"].opacity -= 50
	end
	@scene.wait(1,true)
  end
  # phase 3
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(10,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  # anim2
  for i in 0...32
    for j in 0...12
      next if j>(i*2)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: DUALCHOP.rb =====#
#-------------------------------------------------------------------------------
#  DUALCHOP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DUALCHOP) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  dx = []
  dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb027_bg_02")
  fp["bg"].opacity = 0
  fp["bg"].z = 50
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb027_2_02")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 128*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    z = [1,0.75,0.5][rand(3)]
    fp["s#{j}"].zoom_x = z
    fp["s#{j}"].zoom_y = z
    fp["s#{j}"].x = cx
    fp["s#{j}"].y = cy
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    dx.push(x)
    dy.push(y)
  end
  fp["slash"] = Sprite.new(@viewport)
  fp["slash"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb027_02")
  fp["slash"].oy = fp["slash"].bitmap.height/2
  fp["slash"].y = cy
  fp["slash"].x = @viewport.width
  fp["slash"].opacity = 0
  fp["slash"].z = 50
  # play animation
  pbSEPlay("Anim/gust",90)
  for m in 0...2
    shake = 2
    for i in 0...(m < 1 ? 32 : 16)
      fp["bg"].opacity += 16 if m < 1
      fp["bg"].update
      if m < 1
        fp["slash"].x -= 64 if i >= 28
        fp["slash"].opacity += 64 if i >= 28
      else
        fp["slash"].x += 64 if i >= 12
        fp["slash"].opacity += 64 if i >= 12
      end
      @scene.wait(1,true)
    end
    pbSEPlay("Anim/hit")
    for i in 0...16
      fp["bg"].opacity -= 16
      for j in 0...12
        fp["s#{j}"].visible = true
        fp["s#{j}"].x -= (fp["s#{j}"].x - dx[j])*0.1
        fp["s#{j}"].y -= (fp["s#{j}"].y - dy[j])*0.1
        fp["s#{j}"].zoom_x -= 0.04
        fp["s#{j}"].zoom_y -= 0.04
        fp["s#{j}"].tone.gray += 16
        fp["s#{j}"].tone.red -= 8
        fp["s#{j}"].tone.green -= 8
        fp["s#{j}"].tone.blue -= 8
        fp["s#{j}"].opacity -= 16
      end
      if m < 1
        fp["slash"].x -= 64
      else
        fp["slash"].x += 64
      end
      fp["slash"].opacity -= 32
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
      @scene.wait
    end
    @targetSprite.ox = @targetSprite.bitmap.width/2
    dx.clear
    dy.clear
    fp["slash"].mirror = true
    fp["slash"].ox = fp["slash"].bitmap.width
    fp["slash"].opacity = 0
    fp["slash"].x = 0
    for j in 0...12
      fp["s#{j}"].x = cx
      fp["s#{j}"].y = cy
      fp["s#{j}"].tone = Tone.new(0,0,0,0)
      fp["s#{j}"].opacity = 255
      fp["s#{j}"].visible = false
      z = [1,0.75,0.5][rand(3)]
      fp["s#{j}"].zoom_x = z
      fp["s#{j}"].zoom_y = z
      r = 128*factor
      x, y = randCircleCord(r)
      x = cx - r + x
      y = cy - r + y
      dx.push(x)
      dy.push(y)
    end
  end
  @scene.wait(8)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: DYNAMICPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  DYNAMICPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DYNAMICPUNCH) do
  #@vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  @multiHit = true
  EliteBattle.playMoveAnimation(:BULKUP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playMoveAnimation(:BRICKBREAK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playCommonAnimation(:EXPLOSION, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @multiHit = false
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: EARTHPOWER.rb =====#
#-------------------------------------------------------------------------------
#  Earth Power
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:EARTHPOWER) do
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 8
    @scene.wait(1,true)
  end
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  y0 = @targetSprite.y
  x = [cx - 64*factor, cx + 64*factor, cx]
  y = [y0, y0, y0 + 24*factor]
  dx = []
  for k in 0...3
    fp["f#{k}"] = Sprite.new(@viewport)
    fp["f#{k}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb224")
    fp["f#{k}"].ox = fp["f#{k}"].bitmap.width/2
    fp["f#{k}"].oy = fp["f#{k}"].bitmap.height
    fp["f#{k}"].zoom_x = factor + 0.25
    fp["f#{k}"].zoom_y = 0
    fp["f#{k}"].x = x[k]
    fp["f#{k}"].y = y[k]
    fp["f#{k}"].z = @targetSprite.z
    for m in 0...16
      fp["p#{k}#{m}"] = Sprite.new(@viewport)
      fp["p#{k}#{m}"].bitmap = Bitmap.new(8,8)
      fp["p#{k}#{m}"].ox = 4
      fp["p#{k}#{m}"].oy = 4
      c = [Color.new(139,7,7),Color.new(239,90,1)][rand(2)]
      fp["p#{k}#{m}"].bitmap.bmp_circle(c)
      fp["p#{k}#{m}"].visible = false
      z = [1,0.5,0.75,0.25][rand(4)]
      fp["p#{k}#{m}"].zoom_x = z
      fp["p#{k}#{m}"].zoom_y = z
      fp["p#{k}#{m}"].x = x[k] - 16 + rand(32)
      fp["p#{k}#{m}"].y = y[k] - rand(32)
      fp["p#{k}#{m}"].z = @targetSprite.z + 1
      dx.push((rand(2)==0 ? 1 : -1)*2)
    end
  end
  # start animation
  for k in 0...3
    @scene.wait(8,true)
    j = -1
    l = 6
    pbSEPlay("EBDX/Anim/rock1",80)
    pbSEPlay("Anim/Earth4",50,50)
    for i in 0...24
      j *= -1 if i%4==0
      l -= 2 if i%8==0
      fp["f#{k}"].zoom_x -= 0.1 if fp["f#{k}"].zoom_x > 0
      fp["f#{k}"].zoom_y += 0.3
      fp["f#{k}"].opacity -= 24
      @scene.moveEntireScene(0, j*l, true, true) if i < 16
      for m in 0...16
        next if m>(i*2)
        fp["p#{k}#{m}"].visible = true
        fp["p#{k}#{m}"].y -= 16
        fp["p#{k}#{m}"].x += dx[m]
        fp["p#{k}#{m}"].opacity -= 16
      end
      @scene.wait
    end
  end
  16.times do
    fp["bg"].opacity -= 8
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: EARTHQUAKE.rb =====#
#-------------------------------------------------------------------------------
#  FISSURE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FISSURE) do
  EliteBattle.playMoveAnimation(:EARTHQUAKE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  BULLDOZE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BULLDOZE) do
  EliteBattle.playMoveAnimation(:EARTHQUAKE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MAGNITUDE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MAGNITUDE) do
  EliteBattle.playMoveAnimation(:EARTHQUAKE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ROTOTILLER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROTOTILLER) do
  EliteBattle.playMoveAnimation(:EARTHQUAKE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  Earthquake
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:EARTHQUAKE) do
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 8
    @scene.wait(1,true)
  end
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  y0 = @targetSprite.y
  x = [cx - 64*factor, cx + 64*factor, cx]
  y = [y0, y0, y0 + 24*factor]
  dx = []
  # start animation
    j = -1
    pbSEPlay("EBDX/Anim/rock1",110)
    pbSEPlay("Anim/Earth4",80,70)
    for i in 0...70
      j *= -1 if i%4==0
      if i <= 55
		  if i%2 == 0
			l = 35 
		  else
			l = -35
		  end
	  else
		  if i%2 == 0
			l = 15 
		  else
			l = -15
		  end
	  end
      @scene.moveEntireScene(j*l, j, true, true)# if i < 24
      @scene.wait
    end
  #end
  16.times do
    fp["bg"].opacity -= 8
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: ECHOEDVOICE.rb =====#
#-------------------------------------------------------------------------------
#  BUGBUZZ
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BUGBUZZ) do | args |
  EliteBattle.playMoveAnimation(:ECHOEDVOICE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ECHOEDVOICE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ECHOEDVOICE) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_4")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
	pbSEPlay("Cries/#{@userSprite.species}",100) if i == 5
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: EGGBOMB.rb =====#
#-------------------------------------------------------------------------------
#  EGGBOMB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:EGGBOMB) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  factor = @targetSprite.zoom_x
  dx = []
  dy = []
  fp = {}
  fp["bomb"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb223_3"))
  fp["bomb"].keyFrame = 1
  fp["bomb"].z = @targetSprite.z + 1
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  # shooting out the bomb
  for i in 0...24
	pbSEPlay("Anim/throw") if i == 5
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["bomb"].x = points[i][0]
    fp["bomb"].y = points[i][1]
    z = 1 + (1-(fp["bomb"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["bomb"].zoom_x = z *2
    fp["bomb"].zoom_y = z *2
    fp["bomb"].update
	if i.between?(16,8)
		@targetSprite.color.alpha += 18
		@targetSprite.anim = true
		@targetSprite.still
	end
    @scene.wait(1,true)
  end
  @targetSprite.color = Color.new(74,4,4,0)
  fp["bomb"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...24
    fp["#{j}"] = Sprite.new(@viewport)
	if rand(0..1)==0
		fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010")
	else
		fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010_2")
	end
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # rest of the particles
  for i in 0...48
	pbSEPlay("Anim/Explosion1",100) if i%8 == 0
    for j in 0...24
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
		fp["#{j}"].color.alpha += rand(-50..50)
      end
    end
    @scene.wait
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: ELECTRICTERRAIN.rb =====#
#-------------------------------------------------------------------------------
#  ELECTRICTERRAIN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ELECTRICTERRAIN) do | args |
  beam, strike = *args; beam = false if beam.nil?; strike = false if strike.nil?
  factor = 2
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.black)
  fp["bg"].opacity = 0
  @userSprite.color = Color.new(217,189,52,0) if strike
  rndx = []
  rndy = []
  for i in 0...8
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb081_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  for i in 0...16
    fp["c#{i}"] = Sprite.new(@viewport)
    fp["c#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb081")
    fp["c#{i}"].ox = fp["c#{i}"].bitmap.width/2
    fp["c#{i}"].oy = fp["c#{i}"].bitmap.height/2
    fp["c#{i}"].opacity = 0
    fp["c#{i}"].z = 51
    rndx.push(0)
    rndy.push(0)
  end
  m = 0
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb081_3")
  fp["circle"].ox = fp["circle"].bitmap.width/4
  fp["circle"].oy = fp["circle"].bitmap.height/2
  fp["circle"].opacity = 0
  fp["circle"].src_rect.set(0,0,484,488)
  fp["circle"].z = 50
  fp["circle"].zoom_x = 0.5
  fp["circle"].zoom_y = 0.5
  # start animation
  #@vector.set(@scene.getRealVector(@userIndex, !@targetIsPlayer))
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...120
    pbSEPlay("EBDX/Anim/electric1",[i+10, 100].max) if i%14 == 0
    pbSEPlay("Anim/Saint8") if i == 64
    cx, cy = @userSprite.getCenter
    for j in 0...8
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(96*factor)
        fp["#{j}"].x = cx - 96*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 96*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/8)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*(180.0/Math::PI)# + (rand{4}==0 ? 180 : 0)
      fp["#{j}"].mirror = !fp["#{j}"].mirror if i%2==0
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    for k in 0...16
      if fp["c#{k}"].opacity == 0
        r = rand(2)
        fp["c#{k}"].zoom_x = (r==0 ? 1 : 0.5)
        fp["c#{k}"].zoom_y = (r==0 ? 1 : 0.5)
        fp["c#{k}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        rndx[k] = cx - 48*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        rndy[k] = cy - 48*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
        fp["c#{k}"].x = cx
        fp["c#{k}"].y = cy
      end
      next if k>(i/4)
      x2 = rndx[k]
      y2 = rndy[k]
      x0 = fp["c#{k}"].x
      y0 = fp["c#{k}"].y
      fp["c#{k}"].x += (x2 - x0)*0.05
      fp["c#{k}"].y += (y2 - y0)*0.05
      fp["c#{k}"].opacity += 5
    end
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].opacity += 25.5
    if i < 35
      fp["circle"].zoom_x += 0.01
      fp["circle"].zoom_y += 0.01
    end
	if i >=35 && i < 85
      fp["circle"].zoom_x += 0.05
      fp["circle"].zoom_y += 0.05
	  fp["circle"].opacity += 25 if fp["circle"].opacity < 200
	  for k in 0...16
		fp["c#{k}"].opacity -= 10
	  end
    end
	if i >= 85
      fp["circle"].zoom_x += 0.1
      fp["circle"].zoom_y += 0.1
	  for k in 0...16
		fp["c#{k}"].opacity -= 10
	  end
	  fp["circle"].opacity -= 45 if i >= 100
    end
    m = 1 if i%4==0
    fp["circle"].src_rect.x = 484*m
    m = 0 if i%2==0
    if i < 96
      if strike
        fp["bg"].opacity += 10 if fp["bg"].opacity < 255
      else
        fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.75
      end
    else
      fp["bg"].opacity -= 10 if !beam && !strike
    end
    @userSprite.still if !strike
    @userSprite.anim = true if strike
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  if !beam && !strike
    @sprites["battlebg"].focus
    @vector.reset if !@multiHit
    #@viewport.color = Color.new(255,255,255,255)
    10.times do
      @viewport.color.alpha -= 25.5
      @scene.wait(1,true)
    end
  end
end

#===== FILE: ELECTROBALL.rb =====#
#-------------------------------------------------------------------------------
#  ELECTROBALL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ELECTROBALL) do
  x1, y1 = @targetSprite.getCenter(true)
  x2, y2 = @userSprite.getCenter(true)
  if @targetIsPlayer
    cx = x1 + (x2 - x1)*0.65
    cy = y1 - (y1 - y2)*0.65
  else
    cx = x2 + (x1 - x2)*0.5
    cy = y2 - (y2 - y1)*0.5
  end
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  for j in 0...16
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610_2")
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].opacity = 0
    fp["p#{j}"].z = 20
  end
  for j in 0...32
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610_1")
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].angle = rand(360)
    fp["c#{j}"].ox = 12
    fp["c#{j}"].oy = 18 + rand(24)
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].z = 20
    fp["c#{j}"].color = Color.new(255,255,0,0)
    fp["c#{j}"].toggle = 1
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].z = 20
  pbSEPlay("Anim/Heal4")
  #start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...64
    fp["circle"].zoom_x += 0.125 if fp["circle"].zoom_x < 1
    fp["circle"].zoom_y += 0.125 if fp["circle"].zoom_y < 1
    fp["circle"].angle += 8
    for j in 0...16
      next if j > i/4
      if fp["p#{j}"].ox >= -16
        fp["p#{j}"].ox = -128
        fp["p#{j}"].angle = rand(360)
        fp["p#{j}"].opacity = 0
      end
      fp["p#{j}"].opacity += 32
      fp["p#{j}"].ox += 16
    end
    for j in 0...32
      fp["c#{j}"].toggle *= -1 if i%4==0
      next if j > i/2
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].color.alpha = 255*fp["c#{j}"].toggle
    end
	pbSEPlay("Anim/Paralyze1",85) if i%8==0
    @scene.wait
  end
  for key in fp.keys
    next if key == "circle" || key == "bg"
    fp[key].dispose
    fp.delete(key)
  end
  fp["circle2"] = Sprite.new(@viewport)
  fp["circle2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610_3")
  fp["circle2"].center!
  fp["circle2"].x = cx
  fp["circle2"].y = cy
  fp["circle2"].z = fp["circle"].z - 1
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))

  16.times do
    fp["circle2"].zoom_x = @vector.zoom1
    fp["circle2"].zoom_y = @vector.zoom1
    fp["circle"].zoom_x = @vector.zoom1
    fp["circle"].zoom_y = @vector.zoom1
    x1, y1 = @targetSprite.getCenter(true)
    x2, y2 = @userSprite.getCenter(true)
    if @targetIsPlayer
      cx = x1 + (x2 - x1)*0.65
      cy = y1 - (y1 - y2)*0.65
    else
      cx = x2 + (x1 - x2)*0.5
      cy = y2 - (y2 - y1)*0.5
    end
    fp["circle2"].x = cx
    fp["circle2"].y = cy
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].angle += 8
    @scene.wait(1,true)
  end
  fp["circle"].visible = false
  fp["circle2"].z = @targetSprite.z + 1
  pbSEPlay("Anim/Flash")
  8.times do
    fp["circle2"].x += (x1 - fp["circle2"].x)*0.5
    fp["circle2"].y -= (fp["circle2"].y - y1)*0.5
    @scene.wait
  end
  fp["circle2"].visible = false
  @targetSprite.anim = true
  @targetSprite.color = Color.new(240,240,0)
  2.times do
    @targetSprite.anim = true
    @scene.wait
  end
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610_4")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height
    fp["i#{j}"].angle = rand(360)
    fp["i#{j}"].z = @targetSprite.z + 1
    fp["i#{j}"].x = x1
    fp["i#{j}"].y = y1
  end
  pbSEPlay("EBDX/Anim/electric1",85)
  for i in 0...32
    for j in 0...16
      next if j > i
      fp["i#{j}"].opacity -= 16
      fp["i#{j}"].oy += 8
    end
    @targetSprite.color.alpha -= 16
    @targetSprite.anim = true
    @scene.wait
  end
    16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: ELECTROWEB.rb =====#
#-------------------------------------------------------------------------------
#  ELECTROWEB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ELECTROWEB) do
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []; px = []; py = []; rangl = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  factor = @targetSprite.zoom_x
  for i in 0...20
    fp["#{i}e"] = Sprite.new(@viewport)
    fp["#{i}e"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_3")
    fp["#{i}e"].ox = fp["#{i}e"].bitmap.width/2
    fp["#{i}e"].oy = fp["#{i}e"].bitmap.height/2
    fp["#{i}e"].opacity = 0
    fp["#{i}e"].z = @targetIsPlayer ? 29 : 19
  end  
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  #fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(255,255,102))
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for k in 0...64
    i = 63-k
    fp["#{i}"] = Sprite.new(@viewport)
    bmp = pbBitmap("Graphics/EBDX/Animations/Moves/eb078")
    fp["#{i}"].bitmap = Bitmap.new(bmp.width,bmp.height)
    fp["#{i}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height))
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16)); rndy.push(rand(16)); rangl.push(rand(2))
    dx.push(0); dy.push(0)
  end
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  for i in 0...64
    pbSEPlay("EBDX/Anim/electric2",60) if i%4==0 && i < 48
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...64
      if fp["#{j}"].opacity == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].zoom_x = 0.8#(!@targetIsPlayer ? 1.2 : 0.8)#@userSprite.zoom_x
        fp["#{j}"].zoom_y = 0.8#(!@targetIsPlayer ? 1.2 : 0.8)#@userSprite.zoom_y
        fp["#{j}"].opacity = 128 if !(j>i*2)
      end
      next if j>(i*2)
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      x0 = dx[j]
      y0 = dy[j]
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x += 0.04#(factor - fp["#{j}"].zoom_x)*0.2
      fp["#{j}"].zoom_y += 0.04#(factor - fp["#{j}"].zoom_y)*0.2
      fp["#{j}"].opacity += 32
      fp["#{j}"].angle += 8*(rangl[j]==0 ? -1 : 1)
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      fp["#{j}"].color.alpha -= 5 if fp["#{j}"].color.alpha > 0
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].visible = false if nextx > cx && nexty < cy
      else
        fp["#{j}"].visible = false if nextx < cx && nexty > cy
      end
    end
    @targetSprite.still if i >= 64
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 16
    @vector.inc = 0.1 if i == 64
    @scene.wait(1,true)
  end
    cxT, cyT = @targetSprite.getCenter(true)
    fp["net"] = Sprite.new(@viewport)
	fp["net"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb621_2")
	fp["net"].center!
	fp["net"].x = cxT
	fp["net"].y = cyT
	fp["net"].zoom_x = 0
	fp["net"].zoom_y = 0
	fp["net"].angle = rand(360)
	fp["net"].z = @targetSprite.z + 30
	for i in 0...30
		pbSEPlay("Anim/electric1",90) if i == 5
		next if i < 1
		fp["net"].zoom_x += (1.6 - fp["net"].zoom_x)*0.1
		fp["net"].zoom_y += (1.6 - fp["net"].zoom_y)*0.1
		if fp["net"].zoom_x >= 1
		  fp["net"].opacity -= 16
		end
	    fp["net"].color.alpha -= 8
		   k *= -1 if i%16 == 0
		for n in 0...20
		  next if n>(i/2)
		  if fp["#{n}e"].opacity == 0 && fp["#{n}e"].tone.gray == 0
			r2 = rand(4)
			fp["#{n}e"].zoom_x = [0.2,0.25,0.5,0.75][r2]
			fp["#{n}e"].zoom_y = [0.2,0.25,0.5,0.75][r2]
			cx, cy = @targetSprite.getCenter(true)
			x, y = randCircleCord(32*factor)
			fp["#{n}e"].x = cx - 32*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
			fp["#{n}e"].y = cy - 32*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
			fp["#{n}e"].angle = -Math.atan(1.0*(fp["#{n}e"].y-cy)/(fp["#{n}e"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
		  end
		  fp["#{n}e"].opacity += 155 if i < 27
		  fp["#{n}e"].angle += 180 if i%2 == 0
		  fp["#{n}e"].opacity -= 51 if i >= 27
		end
    #@targetSprite.tone.all -= 1*k
    @targetSprite.still
    @scene.wait(1,true)
	end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  for j in 0...48; fp["#{j}"].visible = false; end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: EMBER.rb =====#
#-------------------------------------------------------------------------------
#  EMBER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:EMBER) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  for i in 0...10
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...10
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    #fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Fire2",80) if i%12==0 && i <= 96
    pbSEPlay("Anim/Smokescreen",120) if i==84
    if i >= 96
      @targetSprite.tone.red += 2.4*2 if @targetSprite.tone.red < 48*2
      @targetSprite.tone.green -= 1.2*2 if @targetSprite.tone.green > -24*2
      @targetSprite.tone.blue -= 2.4*2 if @targetSprite.tone.blue > -48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 2.4*2
    @targetSprite.tone.green += 1.2*2
    @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    #fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: ENCORE.rb =====#
#-------------------------------------------------------------------------------
#  ENCORE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ENCORE) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...12
    @userSprite.still
	pbSEPlay("Cries/#{@userSprite.species}",85) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  #taunt
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  t = 1
  for j in 0..t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb643_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx + 20 if j == 0
    fp["#{j}"].x = cx - 20 if j == 1
    fp["#{j}"].y = cy - 40
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
  end
  # start animation
  for i in 0...30
	pbSEPlay("Anim/Taunt",100) if i == 3 || i == 9
    for j in 0..t
      next if j>(i*2)
	  next if i <= 5 && j == 1
      fp["#{j}"].visible = true
      if i > 20
        fp["#{j}"].opacity -= 32
      else
		if fp["#{j}"].zoom <= 1.5
			fp["#{j}"].zoom += 0.1
		else
		    fp["#{j}"].opacity -= 32
		end
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -=12
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ENDURE.rb =====#
#-------------------------------------------------------------------------------
#  BIDE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BIDE) do
  EliteBattle.playMoveAnimation(:ENDURE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end#-------------------------------------------------------------------------------
#  ENDURE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ENDURE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ENERGYBALL.rb =====#
#-------------------------------------------------------------------------------
#  Energy Ball
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ENERGYBALL) do
  x1, y1 = @targetSprite.getCenter(true)
  x2, y2 = @userSprite.getCenter(true)
  if @targetIsPlayer
    cx = x1 + (x2 - x1)*0.65
    cy = y1 - (y1 - y2)*0.65
  else
    cx = x2 + (x1 - x2)*0.5
    cy = y2 - (y2 - y1)*0.5
  end
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,131,75))
  fp["bg"].opacity = 0
  #
  for j in 0...16
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb600_2")
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].opacity = 0
    fp["p#{j}"].z = 20
  end
  for j in 0...32
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb600_1")
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].angle = rand(360)
    fp["c#{j}"].ox = 12
    fp["c#{j}"].oy = 18 + rand(24)
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].z = 20
    fp["c#{j}"].color = Color.new(64,122,70,0)
    fp["c#{j}"].toggle = 1
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb600")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].z = 20
  pbSEPlay("Anim/Heal4")
  #start animation
  #
  16.times do
    fp["bg"].opacity += 15
    @scene.wait(1,true)
  end
  #
  for i in 0...64
	pbSEPlay("EBDX/Anim/grass2") if i%16 == 0
    fp["circle"].zoom_x += 0.125 if fp["circle"].zoom_x < 1
    fp["circle"].zoom_y += 0.125 if fp["circle"].zoom_y < 1
    fp["circle"].angle += 8
    for j in 0...16
      next if j > i/4
      if fp["p#{j}"].ox >= -16
        fp["p#{j}"].ox = -128
        fp["p#{j}"].angle = rand(360)
        fp["p#{j}"].opacity = 0
      end
      fp["p#{j}"].opacity += 32
      fp["p#{j}"].ox += 16
    end
    for j in 0...32
      fp["c#{j}"].toggle *= -1 if i%4==0
      next if j > i/2
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].color.alpha = 255*fp["c#{j}"].toggle
    end
    @scene.wait
  end
  for key in fp.keys
    next if key == "circle" || key == "bg"
    fp[key].dispose
    fp.delete(key)
  end
  fp["circle2"] = Sprite.new(@viewport)
  fp["circle2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb600_3")
  fp["circle2"].center!
  fp["circle2"].x = cx
  fp["circle2"].y = cy
  fp["circle2"].z = fp["circle"].z - 1
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  16.times do
    fp["circle2"].zoom_x = @vector.zoom1
    fp["circle2"].zoom_y = @vector.zoom1
    fp["circle"].zoom_x = @vector.zoom1
    fp["circle"].zoom_y = @vector.zoom1
    x1, y1 = @targetSprite.getCenter(true)
    x2, y2 = @userSprite.getCenter(true)
    if @targetIsPlayer
      cx = x1 + (x2 - x1)*0.65
      cy = y1 - (y1 - y2)*0.65
    else
      cx = x2 + (x1 - x2)*0.5
      cy = y2 - (y2 - y1)*0.5
    end
    fp["circle2"].x = cx
    fp["circle2"].y = cy
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].angle += 8
    @scene.wait(1,true)
  end
  fp["circle"].visible = false
  fp["circle2"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/grass1")
  8.times do
    fp["circle2"].x += (x1 - fp["circle2"].x)*0.5
    fp["circle2"].y -= (fp["circle2"].y - y1)*0.5
    @scene.wait
  end
  fp["circle2"].visible = false
  @targetSprite.anim = true
  @targetSprite.color = Color.new(54,128,48)
  pbSEPlay("EBDX/Anim/grass1")
  2.times do
    @targetSprite.anim = true
    @scene.wait
  end
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb600_4")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height
    fp["i#{j}"].angle = rand(360)
    fp["i#{j}"].z = @targetSprite.z + 1
    fp["i#{j}"].x = x1
    fp["i#{j}"].y = y1
  end
  for i in 0...32
    for j in 0...16
      next if j > i
      fp["i#{j}"].opacity -= 16
      fp["i#{j}"].oy += 8
    end
    @targetSprite.color.alpha -= 16
    @targetSprite.anim = true
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: ERUPTION.rb =====#
#-------------------------------------------------------------------------------
#  MAGMASTORM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MAGMASTORM) do
  EliteBattle.playMoveAnimation(:ERUPTION, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ERUPTION
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ERUPTION) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  EliteBattle.playMoveAnimation(:SUNNYDAY, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  @vector.set(vector)
  @scene.wait(16,true)
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb642")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height/2
    fp["i#{j}"].opacity = 0
    fp["i#{j}"].zoom_x = @targetSprite.zoom_x
    fp["i#{j}"].zoom_y = @targetSprite.zoom_y
    fp["i#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["i#{j}"].x = @targetSprite.x + rand(32)*@targetSprite.zoom_x*(rand(2)==0 ? 1 : -1)
    fp["i#{j}"].y = @targetSprite.y - 8*@targetSprite.zoom_y + rand(16)*@targetSprite.zoom_y
  end
  for j in 0...5
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb642_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    fp["s#{j}"].opacity = 0
    fp["s#{j}"].zoom_x = @targetSprite.zoom_x
    fp["s#{j}"].zoom_y = @targetSprite.zoom_y
    fp["s#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["s#{j}"].x = @targetSprite.x - 48*@targetSprite.zoom_x + rand(96)*@targetSprite.zoom_x
    fp["s#{j}"].y = @targetSprite.y - 192*@targetSprite.zoom_y
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_12")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = 2
    fp["p#{j}"].zoom_y = 2
    fp["p#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["p#{j}"].x = fp["s#{j}"].x
    fp["p#{j}"].y = fp["s#{j}"].y + 192*@targetSprite.zoom_y
  end
  k = -2
  for i in 0...64
    k *= -1 if i%4==0 && i >= 8
    pbSEPlay("EBDX/Anim/rock1",70) if i%8==0 && i >0 && i < 48
    pbSEPlay("EBDX/Anim/fire2",90) if i%8==0 && i >0 && i < 48
    for j in 0...5
      next if j>(i/6)
      fp["s#{j}"].opacity += 64 if fp["s#{j}"].opacity < 150
      fp["s#{j}"].y += 24*@targetSprite.zoom_y if fp["s#{j}"].y < @targetSprite.y
      fp["s#{j}"].zoom_y -= 0.2*@targetSprite.zoom_y if fp["s#{j}"].y >= @targetSprite.y
      fp["s#{j}"].visible = false if fp["s#{j}"].zoom_y <= 0.4*@targetSprite.zoom_y
    end
    for j in 0...5
      next if i < 8
      next if j>(i-8)/8
      fp["p#{j}"].visible = true
      fp["p#{j}"].opacity -= 32
      fp["p#{j}"].zoom_x += 0.02
      fp["p#{j}"].zoom_y += 0.02
      fp["p#{j}"].angle += 8
    end
    for j in 0...16
      next if i < 8
      next if j>(i-8)/2
      fp["i#{j}"].opacity += 45*(fp["i#{j}"].zoom_x <= 0.5*@targetSprite.zoom_x ? -1 : 1)
      fp["i#{j}"].zoom_x -= 0.04*@targetSprite.zoom_x
      fp["i#{j}"].zoom_y -= 0.04*@targetSprite.zoom_y
      fp["i#{j}"].x += 2*@targetSprite.zoom_x*(fp["i#{j}"].x >= @targetSprite.x ? 1 : -1)
      fp["i#{j}"].angle += 4*(fp["i#{j}"].x >= @targetSprite.x ? 1 : -1)
    end
    @scene.moveEntireScene(0, k, true, true) if i >= 8 && i < 48
    @scene.wait
  end
  16.times do
	fp["i#{j}"].opacity -= 50
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: EXPLOSION.rb =====#
#-------------------------------------------------------------------------------
#  SELFDESTRUCT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SELFDESTRUCT) do
  EliteBattle.playMoveAnimation(:EXPLOSION, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  EXPLOSION
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:EXPLOSION) do
  #@vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @scene.wait(5,true)
  EliteBattle.playCommonAnimation(:EXPLOSION_SELF, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
# clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  #pbSEPlay("Anim/psychic3",60) #change
  pbSEPlay("Anim/superdamage",60) #change
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Explosion1",100) #change
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_19")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_17")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("Anim/Explosion1",100) if i == 8 || i == 18 || i == 28 # keep
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FAIRYWIND.rb =====#
#-------------------------------------------------------------------------------
#  FAIRYWIND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FAIRYWIND) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.white)
  fp["bg"].opacity = 0
  #
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb611_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = @targetSprite.z + 1
    rndx.push(rand(256)); prndx.push(rand(72))
    rndy.push(rand(256)); prndy.push(rand(72))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  shake = 4
  # start animation
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  @vector.set(vector2)
  pbSEPlay("Anim/Whirlwind")
  for i in 0...72
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += rangl[j]*2
      nextx = fp["#{j}"].x
      nexty = fp["#{j}"].y
      if !@targetIsPlayer
        fp["#{j}"].opacity -= 25 if j > 65#if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 25 if j > 65#if nextx < cx && nexty > cy
      end
    end
    if i >= 64
      #@targetSprite.x += 64*(@targetIsPlayer ? -1 : 1)
    elsif i >= 52
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(vector) if i == 16
    @vector.inc = 0.1 if i == 16
    @scene.wait(1,i < 64)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @vector.inc = 0.2
  @scene.wait(16,true)
end

#===== FILE: FALSESWIPE.rb =====#
#-------------------------------------------------------------------------------
#  FALSESWIPE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FALSESWIPE) do
  # inital configuration
  pbSEPlay("EBDX/Anim/flying1",80)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16, true)
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}
  cx, cy = @targetSprite.getCenter(true)
  da = []; dx = []; dy = []; doj = []
  for i in 0...32
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb159_3")
    fp["#{i}"].ox = 12
    fp["#{i}"].oy = 1
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = @targetSprite.z + 1
    r = 128*factor
    z = [1,1.25,0.75,1.5][rand(4)]
    fp["#{i}"].zoom_x = z
    #fp["#{i}"].zoom_y = factor
    fp["#{i}"].x = cx
    fp["#{i}"].y = cy
    fp["#{i}"].tone = Tone.new(255,255,255)
    da.push(rand(2)==0 ? 1 : -1)
    dx.push(cx - r + rand(r*2))
    dy.push(cy - r + rand(r*2))
    doj.push(rand(4)+1)
  end
  fp["slash"] = Sprite.new(@viewport)
  fp["slash"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb159_1")
  fp["slash"].ox = fp["slash"].bitmap.width/2
  fp["slash"].oy = fp["slash"].bitmap.height/2
  fp["slash"].x = cx
  fp["slash"].y = cy
  #fp["slash"].zoom_x = factor
  #fp["slash"].zoom_y = factor
  fp["slash"].z = @targetSprite.z
  fp["slash"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/normal3",80)
  # start animation
  shake = 2
  for i in 0...48
    fp["slash"].src_rect.height += 48 if i < 8
    for j in 0...32
      fp["#{j}"].angle += 32*da[j]
      fp["#{j}"].tone.red -= 8 if fp["#{j}"].tone.red > 0
      fp["#{j}"].tone.green -= 8 if fp["#{j}"].tone.green > 0
      fp["#{j}"].tone.blue -= 8 if fp["#{j}"].tone.blue > 0
      fp["#{j}"].opacity += 16*(i < 24 ? 4 : -1*doj[j])
      fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.05
      fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.05
    end
    if i >= 4
      fp["slash"].tone.red += 16 if fp["slash"].tone.red < 255
      fp["slash"].tone.green += 16 if fp["slash"].tone.green < 255
      fp["slash"].tone.blue += 16 if fp["slash"].tone.blue < 255
      fp["slash"].opacity -= 32 if i >= 8
    end
    if i >= 8
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: FEATHERDANCE.rb =====#
#-------------------------------------------------------------------------------
#  FEATHERDANCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FEATHERDANCE) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(64,64,64))
  fp["bg"].opacity = 0
  #
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb164")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FEINTATTACK.rb =====#
#-------------------------------------------------------------------------------
#  PURSUIT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PURSUIT) do | args |
  EliteBattle.playMoveAnimation(:FEINTATTACK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FEINTATTACK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FEINTATTACK) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/move1",80) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playMoveAnimation(:THIEF, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FINALGAMBIT.rb =====#
#-------------------------------------------------------------------------------
#  STORMTHROW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STORMTHROW) do
  EliteBattle.playMoveAnimation(:FINALGAMBIT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  REVERSAL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:REVERSAL) do
  EliteBattle.playMoveAnimation(:FINALGAMBIT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FINALGAMBIT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FINALGAMBIT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_2")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...72
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...96
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: FIREBLAST.rb =====#
#-------------------------------------------------------------------------------
#  FIREBLAST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FIREBLAST) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  #dragondance
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{j}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{j}"].ox = 26
    fp["#{j}"].oy = 101
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,0.75,0.8,0.75,0.6][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*2)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_1")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0  
    pbSEPlay("EBDX/Anim/fire2") if i%20 == 0
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
	  fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 6*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 54
      else
        fp["#{j}"].opacity += 54
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 2
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  #flareblitz
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  frame = []
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  pbSEPlay("EBDX/Anim/fire2",60)
  pbSEPlay("EBDX/Anim/fire3",60)
  @sprites["battlebg"].defocus
  for i in 0...16
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/fire4",80)
  @vector.set(vector)
  @scene.wait(20,true)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136_6")
  fp["flare"].src_rect.set(0,168*0,178,168)
  fp["flare"].ox = 178/2
  fp["flare"].oy = 168
  fp["flare"].x = cx
  fp["flare"].y = cy+80
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_4")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 25 if fp["flare"].opacity < 170 && i < 50
    fp["flare"].opacity -= 50 if i >= 50
	fp["flare"].src_rect.x += 178 if i%4==0
    fp["flare"].src_rect.x = 0 if fp["flare"].src_rect.x >= fp["flare"].bitmap.width
	fp["flare"].opacity -= 50 if i%2 == 0
	fp["flare"].opacity += 50 if i%2 == 1
    pbSEPlay("EBDX/Anim/fire1",80) if i%16 == 0
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FIREFANG.rb =====#
#-------------------------------------------------------------------------------
#  Fire Fang
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FIREFANG) do
  # set up animation
  fp = {}; rndx = []; rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 50
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)/2
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)/2
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  fp["fang1"] = Sprite.new(@viewport)
  fp["fang1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang1"].ox = fp["fang1"].bitmap.width/2
  fp["fang1"].oy = fp["fang1"].bitmap.height - 20
  fp["fang1"].opacity = 0
  fp["fang1"].z = 41
  fp["fang1"].tone = Tone.new(48,16,6)
  fp["fang2"] = Sprite.new(@viewport)
  fp["fang2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang2"].ox = fp["fang1"].bitmap.width/2
  fp["fang2"].oy = fp["fang1"].bitmap.height - 20
  fp["fang2"].opacity = 0
  fp["fang2"].z = 40
  fp["fang2"].angle = 180
  fp["fang2"].tone = Tone.new(48,16,6)
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["fang1"].x = cx; fp["fang1"].y = cy
    fp["fang1"].zoom_x = @targetSprite.zoom_x; fp["fang1"].zoom_y = @targetSprite.zoom_y
    fp["fang2"].x = cx; fp["fang2"].y = cy
    fp["fang2"].zoom_x = @targetSprite.zoom_x; fp["fang2"].zoom_y = @targetSprite.zoom_y
    if i.between?(20,29)
      fp["fang1"].opacity += 5
      fp["fang1"].oy += 2
      fp["fang2"].opacity += 5
      fp["fang2"].oy += 2
    elsif i.between?(30,40)
      fp["fang1"].opacity += 25.5
      fp["fang1"].oy -= 4
      fp["fang2"].opacity += 25.5
      fp["fang2"].oy -= 4
    else
      fp["fang1"].opacity -= 26
      fp["fang1"].oy += 2
      fp["fang2"].opacity -= 26
      fp["fang2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Super Fang")
      pbSEPlay("Anim/Fire2",75)
    end
    for j in 0...12
      next if i < 40
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].src_rect.x += 53 if i%2==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 24
        fp["#{j}"].tone.gray += 24
        fp["#{j}"].tone.red -= 8; fp["#{j}"].tone.green -= 8; fp["#{j}"].tone.blue -= 8
        fp["#{j}"].zoom_x -= 0.01
        fp["#{j}"].zoom_y += 0.02
      else
        fp["#{j}"].opacity += 45
      end
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      if i >= 56
        @targetSprite.tone.red -= 3*2
        @targetSprite.tone.green += 1.5*2
        @targetSprite.tone.blue += 3*2
        fp["bg"].opacity -= 10
      else
        @targetSprite.tone.red += 3*2 if @targetSprite.tone.red < 48*2
        @targetSprite.tone.green -= 1.5*2 if @targetSprite.tone.green > -24*2
        @targetSprite.tone.blue -= 3*2 if @targetSprite.tone.blue > -48*2
      end
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FIRELASH.rb =====#
#-------------------------------------------------------------------------------
#  FIRELASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FIRELASH) do
  pbSEPlay("EBDX/Anim/fire2",100)
  EliteBattle.playMoveAnimation(:DRAGONDANCE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  rndx = []
  rndy = []
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(131,42,42))
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_9")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_4")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..20
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	cx, cy = @targetSprite.getCenter(true)
	for k in 0...16
		next if i < 4
		if j == 0 && i == 6
			fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
			fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
			@targetSprite.still if k.between?(flashStart,flashStart+2)
			@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
			@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
			@scene.wait(1,true)
			pbSEPlay("Anim/Fire4",100) if k%4 == 0
			pbSEPlay("EBDX/Anim/normal3",100) if k == 4
			fp["claw"].src_rect.height += 15
			fp["claw"].opacity -= 45 if k >= 5
			j = 1 if k == 15		
		end
		#
		if fp["#{k}"].opacity == 0 && fp["#{k}"].visible
			fp["#{k}"].x = cx
			fp["#{k}"].y = cy
		end
		x2 = cx - 64*@targetSprite.zoom_x + rndx[k]*@targetSprite.zoom_x
		y2 = cy - 64*@targetSprite.zoom_y + rndy[k]*@targetSprite.zoom_y
		x0 = fp["#{k}"].x
		y0 = fp["#{k}"].y
		fp["#{k}"].x += (x2 - x0)*0.2
		fp["#{k}"].y += (y2 - y0)*0.2
		fp["#{k}"].zoom_x += 0.01
		fp["#{k}"].zoom_y += 0.01
		if i < 20
			fp["#{k}"].tone.red -= 6; fp["#{k}"].tone.blue -= 6; fp["#{k}"].tone.green -= 6
		end
		if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
			fp["#{k}"].opacity -= 51
		else
			fp["#{k}"].opacity += 51
		end
		fp["#{k}"].visible = false if fp["#{k}"].opacity <= 0
		#
	end
	@scene.wait(1,true)
  end
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: FIREPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  Blaze Kick
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BLAZEKICK) do
  EliteBattle.playMoveAnimation(:FIREPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  Fire Punch
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FIREPUNCH) do | args |
  kick = args[0]; kick = false if kick.nil?
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 50
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)/2
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)/2
    rndx.push(rand(144))
    rndy.push(rand(144))
  end
  fp["punch"] = Sprite.new(@viewport)
  fp["punch"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb#{kick ? 137 : 108}")
  fp["punch"].ox = fp["punch"].bitmap.width/2
  fp["punch"].oy = fp["punch"].bitmap.height/2
  fp["punch"].opacity = 0
  fp["punch"].z = 40
  fp["punch"].angle = 180
  fp["punch"].zoom_x = @targetIsPlayer ? 6 : 4
  fp["punch"].zoom_y = @targetIsPlayer ? 6 : 4
  fp["punch"].tone = Tone.new(48,16,6)
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("Anim/fog2", 75)
  @sprites["battlebg"].defocus
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["punch"].x = cx
    fp["punch"].y = cy
    fp["punch"].angle -= 45 if i < 40
    fp["punch"].zoom_x -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].zoom_y -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].opacity += 8 if i < 40
    if i >= 40
      fp["punch"].tone = Tone.new(255,255,255) if i == 40
      fp["punch"].tone.all -= 25.5
      fp["punch"].opacity -= 25.5
    end
    pbSEPlay("Anim/Fire3") if i==40
    for j in 0...12
      next if i < 40
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 72*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 72*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].src_rect.x += 53 if i%2==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 16
        fp["#{j}"].tone.gray += 16
        fp["#{j}"].tone.red -= 4; fp["#{j}"].tone.green -= 4; fp["#{j}"].tone.blue -= 4
        fp["#{j}"].zoom_x -= 0.005
        fp["#{j}"].zoom_y += 0.01
      else
        fp["#{j}"].opacity += 45
      end
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      if i >= 56
        @targetSprite.tone.red -= 3*2
        @targetSprite.tone.green += 1.5*2
        @targetSprite.tone.blue += 3*2
        fp["bg"].opacity -= 10
      else
        @targetSprite.tone.red += 3*2 if @targetSprite.tone.red < 48*2
        @targetSprite.tone.green -= 1.5*2 if @targetSprite.tone.green > -24*2
        @targetSprite.tone.blue -= 3*2 if @targetSprite.tone.blue > -48*2
      end
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FIRESPIN.rb =====#
#-------------------------------------------------------------------------------
#  FIRESPIN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FIRESPIN) do
  #-----------------------------------------------------------------------------
  #  configure variables
  @scene.wait(16, true) if @scene.afterAnim
  fp = {}; k = -1; flames = 8 ; shake = 2
  factor = @targetSprite.zoom_x
  reversed = []; cx, cy = @targetSprite.getCenter(true)
  #-----------------------------------------------------------------------------
  #  set up sprites
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  for j in 0...flames
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{j}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{j}"].ox = 26
    fp["#{j}"].oy = 101
    fp["#{j}"].zoom_x = factor
    fp["#{j}"].zoom_y = factor
    fp["#{j}"].opacity = 0
    fp["#{j}"].y = cy - 48*factor - k*2*factor
    fp["#{j}"].x = cx + 64*factor - (j%4)*32*factor
    reversed.push([false,true][j/4])
  end
  #-----------------------------------------------------------------------------
  #  play animation
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  vol = 80
  for i in 0...70
    k = i if i < 16
    pbSEPlay("Anim/Fire2",80) if i%12==0
    pbSEPlay("Anim/Smokescreen",120) if i==50
    vol -= 5 if i%8 == 0
    for j in 0...flames
      reversed[j] = true if fp["#{j}"].x <= cx - 64*factor
      reversed[j] = false if fp["#{j}"].x >= cx + 64*factor
      fp["#{j}"].z = reversed[j] ? @targetSprite.z - 1 : @targetSprite.z + 1
      fp["#{j}"].y = cy - 48*factor - k*2*factor - (reversed[j] ? 4*factor : 0) + 120 if !@targetIsPlayer
      fp["#{j}"].y = cy - 48*factor - k*2*factor - (reversed[j] ? 4*factor : 0) + 200 if @targetIsPlayer
      fp["#{j}"].x -= reversed[j] ? -4*factor : 4*factor
	  next if j>(i/4)
      fp["#{j}"].opacity += 16 if fp["#{j}"].opacity < 150
      fp["#{j}"].opacity -= 25 if i >= 48
	  fp["#{j}"].src_rect.x += 53 if j%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
    end
    if i >= 30
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
	end
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  #-----------------------------------------------------------------------------
  #  dispose sprites
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
  #-----------------------------------------------------------------------------
end

#===== FILE: FLAMEBURST.rb =====#
#-------------------------------------------------------------------------------
#  FLAMEBURST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLAMEBURST) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  for i in 0...10
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...10
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    #fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Fire2",80) if i%12==0 && i <= 96
    pbSEPlay("Anim/Smokescreen",120) if i==84
    if i >= 96
      @targetSprite.tone.red += 2.4*2 if @targetSprite.tone.red < 48*2
      @targetSprite.tone.green -= 1.2*2 if @targetSprite.tone.green > -24*2
      @targetSprite.tone.blue -= 2.4*2 if @targetSprite.tone.blue > -48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 2.4*2
    @targetSprite.tone.green += 1.2*2
    @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    #fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: FLAMECHARGE.rb =====#
#-------------------------------------------------------------------------------
#  FLAMEWHEEL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLAMEWHEEL) do | args |
  EliteBattle.playMoveAnimation(:FLAMECHARGE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FLAMECHARGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLAMECHARGE) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/fire1",100) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/fire2",100)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playCommonAnimation(:BURN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FLAMETHROWER.rb =====#
#-------------------------------------------------------------------------------
#  Flamethrower
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLAMETHROWER) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Fire2",80) if i%12==0 && i <= 96
    pbSEPlay("Anim/Smokescreen",120) if i==84
    if i >= 96
      @targetSprite.tone.red += 2.4*2 if @targetSprite.tone.red < 48*2
      @targetSprite.tone.green -= 1.2*2 if @targetSprite.tone.green > -24*2
      @targetSprite.tone.blue -= 2.4*2 if @targetSprite.tone.blue > -48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 2.4*2
    @targetSprite.tone.green += 1.2*2
    @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: FLAREBLITZ.rb =====#
#-------------------------------------------------------------------------------
#  Flare Blitz
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLAREBLITZ) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  frame = []
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  # animation start
  pbSEPlay("EBDX/Anim/fire2",60)
  pbSEPlay("EBDX/Anim/fire3",60)
  @sprites["battlebg"].defocus
  for i in 0...48
    for j in 0...16
      next if j>(i/2)
      fp["f#{j}"].visible = true
      fp["f#{j}"].y -= 8*@userSprite.zoom_y
      fp["f#{j}"].opacity -= 32 if frame[j] >= 8
      frame[j] += 1
    end
    fp["bg"].opacity += 8 if i >= 32
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/fire4",80)
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_2")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_3")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx - 32 + rand(64)
    fp["#{j}"].y = cy - 32 + rand(64)
    fp["#{j}"].z = @targetSprite.z + 1
    fp["#{j}"].visible = false
    fp["#{j}"].zoom_x = @targetSprite.zoom_x
    fp["#{j}"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_4")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/fire1",80) if i == 8
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}"].visible = true
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += 16
      fp["#{j}"].zoom_x += 0.1
      fp["#{j}"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FLASHCANNON.rb =====#
#-------------------------------------------------------------------------------
#  Flash Cannon
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLASHCANNON) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.black)
  fp["bg"].opacity = 0
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  # charging animation
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_2")
    fp["s#{j}"].center!
    r = 64*@userSprite.zoom_x
    x1, y1 = randCircleCord(r)
    fp["s#{j}"].x = cx - r + x1
    fp["s#{j}"].y = cy - r + y1
    fp["s#{j}"].opacity = 0
    z = [1.1,1,0.9,1.2,0.8][rand(5)]
    fp["s#{j}"].zoom_x = z
    fp["s#{j}"].zoom_y = z
    fp["s#{j}"].z = @userSprite.z + 1
  end
  fp["glow"] = Sprite.new(@viewport)
  fp["glow"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_3")
  fp["glow"].center!
  fp["glow"].x = cx
  fp["glow"].y = cy
  fp["glow"].opacity = 0
  fp["glow"].toggle = 1
  for j in 0...2
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_#{5+j}")
    fp["c#{j}"].center!
    fp["c#{j}"].toggle = 1
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].param = 1
    fp["c#{j}"].zoom_x = @userSprite.zoom_x
    fp["c#{j}"].zoom_y = @userSprite.zoom_y
    fp["c#{j}"].z = @userSprite.z + 1
  end
  for j in 0...8
    fp["t#{j}"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb519"))
    fp["t#{j}"].z = @userSprite.z + 1
    r = @viewport.width
    x1, y1 = randCircleCord(r)
    fp["t#{j}"].x = cx - r + x1
    fp["t#{j}"].y = cy - r + y1
    fp["t#{j}"].color = Color.white
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_4")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].color = Color.new(192,56,121,0)
  fp["circle"].param = 0
  fp["circle"].z = @userSprite.z + 2
  fp["circle"].opacity = 0
  fp["ripples"] = Sprite.new(@viewport)
  fp["ripples"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_7")
  fp["ripples"].center!
  fp["ripples"].x = cx
  fp["ripples"].y = cy
  fp["ripples"].opacity = 0
  fp["ripples"].zoom_x = @userSprite.zoom_x
  fp["ripples"].zoom_y = @userSprite.zoom_y
  fp["ripples"].color = Color.new(255,255,255,0)
  fp["ripples"].z = @userSprite.z + 2
  pbSEPlay("Anim/Harden")
  for i in 0...148
    pbSEPlay("Anim/Refresh") if i == 16
    pbSEPlay("Anim/Saint8") if i == 68
    for j in 0...8
      next if j > i/4
      fp["s#{j}"].opacity += 48
      fp["s#{j}"].zoom_x -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_x > 0
      fp["s#{j}"].zoom_y -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_y > 0
      fp["s#{j}"].x -= (cx - fp["s#{j}"].x)*0.01
      fp["s#{j}"].y -= (cy - fp["s#{j}"].y)*0.01
    end
    for j in 0...8
      next if i < 16
      next if j > (i-16)/8
      fp["t#{j}"].x -= (fp["t#{j}"].x - cx)*0.1
      fp["t#{j}"].y -= (fp["t#{j}"].y - cy)*0.1
      fp["t#{j}"].color.alpha -= 8
      fp["t#{j}"].update if i < 128
      fp["t#{j}"].visible = false if i == 128
    end
    for j in 0...2
      next if i < 32
      fp["c#{j}"].param -= fp["c#{j}"].toggle*0.0625*(j+1)
      if j == 0
        fp["c#{j}"].zoom_x = fp["c#{j}"].param*@userSprite.zoom_x
      else
        fp["c#{j}"].zoom_y = fp["c#{j}"].param*@userSprite.zoom_y
      end
      fp["c#{j}"].opacity += i < 132 ? 8 : -32
      fp["c#{j}"].toggle *= -1 if fp["c#{j}"].param <= 0 || fp["c#{j}"].param >= 1
      fp["c#{j}"].x = cx
      fp["c#{j}"].y = cy
    end
    if i >= 32
      fp["circle"].zoom_x += 0.03125 if fp["circle"].zoom_x < 1
      fp["circle"].zoom_y += 0.03125 if fp["circle"].zoom_y < 1
      fp["circle"].param = (fp["circle"].param == 0 ? 255 : 0) if i%12 == 0 || i%12 == 4
      fp["circle"].color.alpha = fp["circle"].param if i < 132
      fp["circle"].opacity += 8
      fp["glow"].opacity += i < 132 ? 4 : -32
      fp["glow"].zoom_x -= 0.02*fp["glow"].toggle
      fp["glow"].zoom_y -= 0.02*fp["glow"].toggle
      fp["glow"].toggle *= -1 if i%4 == 0
    end
    pbSEPlay("EBDX/Anim/move2") if i == 132
    pbSEPlay("EBDX/Anim/normal5",80) if i == 132
    # shooting at the target
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 132
    fp["circle"].z = @targetSprite.z + 1 if i == 132
    if i >= 132
      cx, cy = @userSprite.getCenter(true)
      x1, y1 = @targetSprite.getCenter(true)
      fp["ripples"].opacity += i < 140 ? 32 : - 32
      fp["ripples"].zoom_x += 0.1*@userSprite.zoom_x
      fp["ripples"].zoom_y += 0.1*@userSprite.zoom_y
      fp["ripples"].color.alpha += 16
      fp["ripples"].x = cx
      fp["ripples"].y = cy
      fp["circle"].color.alpha = 0
      fp["circle"].zoom_x = @vector.zoom1
      fp["circle"].zoom_y = @vector.zoom1
      fp["circle"].x += (x1 - fp["circle"].x)*0.1
      fp["circle"].y -= (fp["circle"].y - y1)*0.1
      fp["circle"].opacity -= 64 if i >= 144
    end
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/iron4")
  pbSEPlay("EBDX/Anim/iron1")
  # hitting the target
  for j in 0...24
    fp["r2#{j}"] = Sprite.new(@viewport)
    fp["r2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_10")
    fp["r2#{j}"].center!
    fp["r2#{j}"].x = @targetSprite.x - @targetSprite.ox + rand(@targetSprite.bitmap.width)
    fp["r2#{j}"].y = @targetSprite.y - @targetSprite.oy + rand(@targetSprite.bitmap.height)
    fp["r2#{j}"].z = @targetSprite.z + 1 + rand(2)
    fp["r2#{j}"].visible = false
  end
  for j in 0...32
    fp["r#{j}"] = Sprite.new(@viewport)
    b = rand(2)
    fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_#{8+b}")
    fp["r#{j}"].center!
    fp["r#{j}"].ox /= 2 if b == 0
    fp["r#{j}"].src_rect.set(rand(2)*fp["r#{j}"].bitmap.width/2,0,fp["r#{j}"].bitmap.width/2,fp["r#{j}"].bitmap.height) if b == 0
    fp["r#{j}"].x = x1
    fp["r#{j}"].y = y1
    r = (48 + rand(49))*@targetSprite.zoom_x
    rx, ry = randCircleCord(r)
    fp["r#{j}"].end_x = x1 - r + rx
    fp["r#{j}"].end_y = y1 - r + ry
    fp["r#{j}"].opacity = 0
    fp["r#{j}"].toggle = 2
    fp["r#{j}"].z = @targetSprite.z + 1
    fp["r#{j}"].zoom_x = @targetSprite.zoom_x
    fp["r#{j}"].zoom_y = @targetSprite.zoom_y
    fp["r#{j}"].param = 0
    fp["r#{j}"].speed = rand(15)
  end
  k = 1
  for i in 0...64
    for j in 0...32
      #next if j > i
      fp["r#{j}"].opacity += 16*fp["r#{j}"].toggle
      fp["r#{j}"].toggle = -4 if fp["r#{j}"].param >= 24+fp["r#{j}"].speed
      fp["r#{j}"].x += (fp["r#{j}"].end_x - fp["r#{j}"].x)*0.05
      fp["r#{j}"].y += (fp["r#{j}"].end_y - fp["r#{j}"].y)*0.05
      fp["r#{j}"].zoom_x -= fp["r#{j}"].zoom_x*0.02
      fp["r#{j}"].zoom_y -= fp["r#{j}"].zoom_y*0.02
      fp["r#{j}"].param += 1
    end
    for j in 0...24
      next if i < 8
      next if j > (i-8)/2
      fp["r2#{j}"].visible = true
      fp["r2#{j}"].opacity -= 24
      fp["r2#{j}"].zoom_x -= 0.02
      fp["r2#{j}"].zoom_y -= 0.02
    end
    if i >= 24
      @targetSprite.ox += k*2
      k *= -1 if i%2 == 0
      pbSEPlay("EBDX/Anim/normal2",50) if i%4 == 0
    end
    @targetSprite.still
    @scene.wait
  end
  @vector.reset
  for key in fp.keys
    next if key == "bg"
    fp[key].dispose
  end
  16.times do
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  fp["bg"].dispose
  fp.clear
end

#===== FILE: FLEURCANNON.rb =====#
#-------------------------------------------------------------------------------
#  FLEURCANNON
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLEURCANNON) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  rndx = [[],[]]; rndy = [[],[]]
  dx = [[],[]]; dy = [[],[]]
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb640_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  string = ["eb640_2","eb640"]
  rop = [255,80,40,135]
  px = []
  py = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for m in 0...2
    for i in 0...20
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      bmp = pbBitmap("Graphics/EBDX/Animations/Moves/"+string[m])
      fp["#{i}#{m}"].bitmap = Bitmap.new(bmp.width,bmp.height)
      fp["#{i}#{m}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height),(m==0 ? rop[rand(4)] : 255))
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].opacity = 0
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      fp["#{i}#{m}"].zoom_x = [0.5,1][m]
      fp["#{i}#{m}"].zoom_y = [0.5,1][m]
      rndx[m].push(rand(16))
      rndy[m].push(rand(16))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  k = 1
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Saint7",80)
  @scene.wait(4,true)
  for i in 0...96
    pbSEPlay("Anim/Saint8") if i == 12
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...20
        if fp["#{j}#{m}"].opacity == 0
          dx[m][j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
        end
        next if j>(i/4)
        x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        x0 = dx[m][j]
        y0 = dy[m][j]
        fp["#{j}#{m}"].x += (x2 - x0)*0.04*(m+1)
        fp["#{j}#{m}"].y += (y2 - y0)*0.04*(m+1)
        fp["#{j}#{m}"].zoom_x += (1 - fp["#{j}#{m}"].zoom_x)*0.1
        fp["#{j}#{m}"].zoom_y += (1 - fp["#{j}#{m}"].zoom_y)*0.1
        fp["#{j}#{m}"].opacity += 51
        fp["#{j}#{m}"].angle += 8*(m+1)*j
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          fp["#{j}#{m}"].visible = false if nextx > cx && nexty < cy
        else
          fp["#{j}#{m}"].visible = false if nextx < cx && nexty > cy
        end
      end
    end
    for l in 0...12
      next if i < 12
      next if l>((i-12)/4)
      if fp["p#{l}"].opacity <= 0
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(128)
        px[l] = cx - 128*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 128*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(vector) if i == 64
    @vector.inc = 0.1 if i == 64
    fp["bg"].update
    if i < 64
      k*=-1 if i%4==0
      @scene.moveEntireScene(0,k*4,true,true)
    end
    pbSEPlay("Anim/Saint6") if i == 84
    if i.between?(85,90)
      @targetSprite.zoom_x += 0.01
      @targetSprite.zoom_y -= 0.04
    elsif i.between?(91,96)
      @targetSprite.zoom_x -= 0.01
      @targetSprite.zoom_y += 0.04
    end
    @scene.wait(1,(i>=64 && i<85))
  end
  for j in 0...20; for m in 0...2; fp["#{j}#{m}"].visible = false; end; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: FLING.rb =====#
#-------------------------------------------------------------------------------
#  FLING
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLING) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["ball"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb223_2"))
  fp["ball"].keyFrame = 1
  fp["ball"].z = @targetSprite.z + 1
  @vector.set(EliteBattle.get_vector(:DUAL))
  @scene.wait(5,true)
  # shooting out the ball
  for i in 0...24
	pbSEPlay("EBDX/Anim/move1") if i == 5
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    my = @vector.y + (@vector.y2 - @vector.y)*0.5
    points = calculateCurve(cxP,cyP,mx,0,cxT,cyT,24)
    fp["ball"].x = points[i][0]
    fp["ball"].y = points[i][1]
    z = 1 + (1-(fp["ball"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["ball"].zoom_x = z
    fp["ball"].zoom_y = z
    fp["ball"].update
	if i.between?(16,8)
		@targetSprite.color.alpha += 18
		@targetSprite.anim = true
		@targetSprite.still
	end
    @scene.wait(1,true)
  end
  @targetSprite.color = Color.new(70,70,70,0)
  fp["ball"].dispose
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	if rand(1)
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb223_4")
	else
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb223_5")
	end
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("EBDX/Anim/normal1") if i == 5
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.01
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.01
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.25
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.25
      if fp["p#{j}"].zoom_x >= 0.5
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: FLORALHEALING.rb =====#
#-------------------------------------------------------------------------------
#  FLORALHEALING
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLORALHEALING) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(88,174,108))
  fp["bg"].opacity = 0
  #
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_7")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FLY.rb =====#
#-------------------------------------------------------------------------------
#  Fly
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLY) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:FLY_UP, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:FLY_DOWN, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:FLY_UP) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["fly"] = Sprite.new(@viewport)
  fp["fly"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156")
  fp["fly"].ox = fp["fly"].bitmap.width/2
  fp["fly"].oy = fp["fly"].bitmap.height/2
  fp["fly"].z = 50
  fp["fly"].x, fp["fly"].y = @userSprite.getCenter
  fp["fly"].opacity = 0
  fp["fly"].zoom_x = factor*1.4
  fp["fly"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_2")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Refresh")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].zoom_x -= factor*0.4/10
    fp["fly"].zoom_y -= factor*0.4/10
    fp["fly"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @userSprite.visible = false if i == 6
    @userSprite.hidden = true if i == 6
    @scene.wait(1,true)
  end
  10.times do
    fp["fly"].zoom_x += factor*0.4/10
    fp["fly"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["fly"].zoom_y -= factor*0.02
    elsif
      fp["fly"].zoom_x -= factor*0.02
      fp["fly"].zoom_y += factor*0.04
    end
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying2") if i == 10
  end
  for i in 0...20
    fp["fly"].y -= 32
    fp["fly"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end

EliteBattle.defineMoveAnimation(:FLY_DOWN) do
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  fp["drop"] = Sprite.new(@viewport)
  fp["drop"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_3")
  fp["drop"].ox = fp["drop"].bitmap.width/2
  fp["drop"].oy = fp["drop"].bitmap.height/2
  fp["drop"].y = 0
  fp["drop"].z = 50
  fp["drop"].visible = false
  # start animation
  @vector.set(defaultvector[0], defaultvector[1]+128, defaultvector[2], defaultvector[3], defaultvector[4], defaultvector[5])
  @sprites["battlebg"].defocus
  32.times do
    fp["bg"].opacity += 2
    @scene.wait(1,true)
  end
  @vector.set(vector)
  maxy = ((@targetIsPlayer ? @vector.y : @vector.y2)*0.1).ceil*10 - 80
  fp["drop"].y = -((maxy-(@targetIsPlayer ? @vector.y-80 : @vector.y2-80))*0.1).ceil*10
  fp["drop"].x = @targetSprite.x
  pbSEPlay("Anim/Wind1")
  for i in 0...20
    @scene.wait(1,true)
    if i >= 10
      fp["drop"].visible = true
      fp["drop"].x = @targetSprite.x
      fp["drop"].y += maxy/10
      fp["drop"].zoom_x = @targetSprite.zoom_x
      fp["drop"].zoom_y = @targetSprite.zoom_y*1.4
    end
    fp["bg"].opacity -= 51 if i >= 15
  end
  @sprites["battlebg"].focus
  @userSprite.hidden = false
  @userSprite.visible = true
  pbDisposeSpriteHash(fp)
  EliteBattle.playMoveAnimation(:TACKLE, @scene, @userIndex, @targetIndex, 0, false, nil, false, true)
end

#===== FILE: FOCUSBLAST.rb =====#
#-------------------------------------------------------------------------------
#  FOCUSBLAST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FOCUSBLAST) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.black)
  fp["bg"].opacity = 0
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  # charging animation
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb633_2")
    fp["s#{j}"].center!
    r = 64*@userSprite.zoom_x
    x1, y1 = randCircleCord(r)
    fp["s#{j}"].x = cx - r + x1
    fp["s#{j}"].y = cy - r + y1
    fp["s#{j}"].opacity = 0
    z = [1.1,1,0.9,1.2,0.8][rand(5)]
    fp["s#{j}"].zoom_x = z
    fp["s#{j}"].zoom_y = z
    fp["s#{j}"].z = @userSprite.z + 1
  end
  fp["glow"] = Sprite.new(@viewport)
  fp["glow"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb633_3")
  fp["glow"].center!
  fp["glow"].x = cx
  fp["glow"].y = cy
  fp["glow"].opacity = 0
  fp["glow"].toggle = 1
  for j in 0...2
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb633_#{5+j}")
    fp["c#{j}"].center!
    fp["c#{j}"].toggle = 1
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].param = 1
    fp["c#{j}"].zoom_x = @userSprite.zoom_x
    fp["c#{j}"].zoom_y = @userSprite.zoom_y
    fp["c#{j}"].z = @userSprite.z + 1
  end
  for j in 0...8
    fp["t#{j}"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb633"))
    fp["t#{j}"].z = @userSprite.z + 1
    r = @viewport.width
    x1, y1 = randCircleCord(r)
    fp["t#{j}"].x = cx - r + x1
    fp["t#{j}"].y = cy - r + y1
    fp["t#{j}"].color = Color.white
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb633_4")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].color = Color.new(192,56,121,0)
  fp["circle"].param = 0
  fp["circle"].z = @userSprite.z + 2
  fp["circle"].opacity = 0
  fp["ripples"] = Sprite.new(@viewport)
  fp["ripples"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb633_7")
  fp["ripples"].center!
  fp["ripples"].x = cx
  fp["ripples"].y = cy
  fp["ripples"].opacity = 0
  fp["ripples"].zoom_x = @userSprite.zoom_x
  fp["ripples"].zoom_y = @userSprite.zoom_y
  fp["ripples"].color = Color.new(255,255,255,0)
  fp["ripples"].z = @userSprite.z + 2
  pbSEPlay("Anim/Harden")
  for i in 0...148
    pbSEPlay("Anim/Refresh") if i == 16
    pbSEPlay("Anim/Saint8") if i == 68
    for j in 0...8
      next if j > i/4
      fp["s#{j}"].opacity += 48
      fp["s#{j}"].zoom_x -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_x > 0
      fp["s#{j}"].zoom_y -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_y > 0
      fp["s#{j}"].x -= (cx - fp["s#{j}"].x)*0.01
      fp["s#{j}"].y -= (cy - fp["s#{j}"].y)*0.01
    end
    for j in 0...8
      next if i < 16
      next if j > (i-16)/8
      fp["t#{j}"].x -= (fp["t#{j}"].x - cx)*0.1
      fp["t#{j}"].y -= (fp["t#{j}"].y - cy)*0.1
      fp["t#{j}"].color.alpha -= 8
      fp["t#{j}"].update if i < 128
      fp["t#{j}"].visible = false if i == 128
    end
    for j in 0...2
      next if i < 32
      fp["c#{j}"].param -= fp["c#{j}"].toggle*0.0625*(j+1)
      if j == 0
        fp["c#{j}"].zoom_x = fp["c#{j}"].param*@userSprite.zoom_x
      else
        fp["c#{j}"].zoom_y = fp["c#{j}"].param*@userSprite.zoom_y
      end
      fp["c#{j}"].opacity += i < 132 ? 8 : -32
      fp["c#{j}"].toggle *= -1 if fp["c#{j}"].param <= 0 || fp["c#{j}"].param >= 1
      fp["c#{j}"].x = cx
      fp["c#{j}"].y = cy
    end
    if i >= 32
      fp["circle"].zoom_x += 0.03125 if fp["circle"].zoom_x < 1
      fp["circle"].zoom_y += 0.03125 if fp["circle"].zoom_y < 1
      fp["circle"].param = (fp["circle"].param == 0 ? 255 : 0) if i%12 == 0 || i%12 == 4
      fp["circle"].color.alpha = fp["circle"].param if i < 132
      fp["circle"].opacity += 8
      fp["glow"].opacity += i < 132 ? 4 : -32
      fp["glow"].zoom_x -= 0.02*fp["glow"].toggle
      fp["glow"].zoom_y -= 0.02*fp["glow"].toggle
      fp["glow"].toggle *= -1 if i%4 == 0
    end
    pbSEPlay("EBDX/Anim/move2") if i == 132
    pbSEPlay("EBDX/Anim/normal5",80) if i == 132
    # shooting at the target
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 132
    fp["circle"].z = @targetSprite.z + 1 if i == 132
    if i >= 132
      cx, cy = @userSprite.getCenter(true)
      x1, y1 = @targetSprite.getCenter(true)
      fp["ripples"].opacity += i < 140 ? 32 : - 32
      fp["ripples"].zoom_x += 0.1*@userSprite.zoom_x
      fp["ripples"].zoom_y += 0.1*@userSprite.zoom_y
      fp["ripples"].color.alpha += 16
      fp["ripples"].x = cx
      fp["ripples"].y = cy
      fp["circle"].color.alpha = 0
      fp["circle"].zoom_x = @vector.zoom1
      fp["circle"].zoom_y = @vector.zoom1
      fp["circle"].x += (x1 - fp["circle"].x)*0.1
      fp["circle"].y -= (fp["circle"].y - y1)*0.1
      fp["circle"].opacity -= 64 if i >= 144
    end
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/iron4")
  pbSEPlay("EBDX/Anim/iron1")
  # hitting the target
  for j in 0...24
    fp["r2#{j}"] = Sprite.new(@viewport)
    fp["r2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb633_10")
    fp["r2#{j}"].center!
    fp["r2#{j}"].x = @targetSprite.x - @targetSprite.ox + rand(@targetSprite.bitmap.width)
    fp["r2#{j}"].y = @targetSprite.y - @targetSprite.oy + rand(@targetSprite.bitmap.height)
    fp["r2#{j}"].z = @targetSprite.z + 1 + rand(2)
    fp["r2#{j}"].visible = false
  end
  for j in 0...32
    fp["r#{j}"] = Sprite.new(@viewport)
    b = rand(2)
    fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb633_#{8+b}")
    fp["r#{j}"].center!
    fp["r#{j}"].ox /= 2 if b == 0
    fp["r#{j}"].src_rect.set(rand(2)*fp["r#{j}"].bitmap.width/2,0,fp["r#{j}"].bitmap.width/2,fp["r#{j}"].bitmap.height) if b == 0
    fp["r#{j}"].x = x1
    fp["r#{j}"].y = y1
    r = (48 + rand(49))*@targetSprite.zoom_x
    rx, ry = randCircleCord(r)
    fp["r#{j}"].end_x = x1 - r + rx
    fp["r#{j}"].end_y = y1 - r + ry
    fp["r#{j}"].opacity = 0
    fp["r#{j}"].toggle = 2
    fp["r#{j}"].z = @targetSprite.z + 1
    fp["r#{j}"].zoom_x = @targetSprite.zoom_x
    fp["r#{j}"].zoom_y = @targetSprite.zoom_y
    fp["r#{j}"].param = 0
    fp["r#{j}"].speed = rand(15)
  end
  k = 1
  for i in 0...64
    for j in 0...32
      #next if j > i
      fp["r#{j}"].opacity += 16*fp["r#{j}"].toggle
      fp["r#{j}"].toggle = -4 if fp["r#{j}"].param >= 24+fp["r#{j}"].speed
      fp["r#{j}"].x += (fp["r#{j}"].end_x - fp["r#{j}"].x)*0.05
      fp["r#{j}"].y += (fp["r#{j}"].end_y - fp["r#{j}"].y)*0.05
      fp["r#{j}"].zoom_x -= fp["r#{j}"].zoom_x*0.02
      fp["r#{j}"].zoom_y -= fp["r#{j}"].zoom_y*0.02
      fp["r#{j}"].param += 1
    end
    for j in 0...24
      next if i < 8
      next if j > (i-8)/2
      fp["r2#{j}"].visible = true
      fp["r2#{j}"].opacity -= 24
      fp["r2#{j}"].zoom_x -= 0.02
      fp["r2#{j}"].zoom_y -= 0.02
    end
    if i >= 24
      @targetSprite.ox += k*2
      k *= -1 if i%2 == 0
      pbSEPlay("EBDX/Anim/normal2",50) if i%4 == 0
    end
    @targetSprite.still
    @scene.wait
  end
  @vector.reset
  for key in fp.keys
    next if key == "bg"
    fp[key].dispose
  end
  16.times do
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  fp["bg"].dispose
  fp.clear
end

#===== FILE: FOCUSENERGY.rb =====#
#-------------------------------------------------------------------------------
#  FOCUSENERGY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FOCUSENERGY) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FOCUSPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  FOCUSPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FOCUSPUNCH) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:BULKUP, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:ROCKCLIMB, @scene, @userIndex, @targetIndex)
  end
end
#===== FILE: FORCEPALM.rb =====#
#-------------------------------------------------------------------------------
#  FORCEPALM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FORCEPALM) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb093_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_1_4")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = @userSprite.z + 1
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 0.75 : 1)
  fp["cir"].zoom_y = (@targetIsPlayer ? 0.75 : 1)
  fp["cir"].opacity = 0
  shake = 4; k = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...40
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 24
    end
    if i == 8
      @vector.set(vector2)
      pbSEPlay("Anim/grass2",80)
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_2_4")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  fp["shot"] = Sprite.new(@viewport)
  fp["shot"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_3_4")
  fp["shot"].ox = fp["shot"].bitmap.width/2
  fp["shot"].oy = fp["shot"].bitmap.height/2
  fp["shot"].z = @userSprite.z + 1
  fp["shot"].zoom_x = @userSprite.zoom_x
  fp["shot"].zoom_y = @userSprite.zoom_x
  fp["shot"].opacity = 0
  x = defaultvector[0]; y = defaultvector[1]
  x2, y2 = @vector.spoof(defaultvector)  
  fp["shot"].x = cx
  fp["shot"].y = cy
  pbSEPlay("EBDX/Anim/normal5",80)
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    @vector.reset if i == 0
    if i > 0
      fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
      fp["shot"].opacity += 32
      fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
      fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity -= 16
      fp["cir"].x = cx
      fp["cir"].y = cy
    end
    fp["bg"].update
    factor = @targetSprite.zoom_x if i == 12
    if i >= 12
      k *= -1 if i%4==0
      @targetSprite.zoom_x -= factor*0.01*k
      @targetSprite.zoom_y += factor*0.04*k
      @targetSprite.still
    end
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,i < 12)
  end
  shake = 2
  16.times do
    fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
    fp["shot"].opacity += 32
    fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
    fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
    fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
    fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
    fp["bg"].color.alpha += 16
    fp["bg"].update
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
    @targetSprite.still
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  16.times do
    fp["bg"].update
    @targetSprite.still
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].update
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: FORESIGHT.rb =====#
#-------------------------------------------------------------------------------
#  FORESIGHT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FORESIGHT) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(5,true)
  fp = {}
  cx, cy = @userSprite.getCenter(true)
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #eyes
  fp["l"] = Sprite.new(@viewport)
  fp["l"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_6")
  fp["l"].ox = fp["l"].bitmap.width/2
  fp["l"].oy = fp["l"].bitmap.height/2
  if @userIsPlayer
  # fp["l"].x = cx + @userSprite.width/2 + 50
  # fp["l"].y = cy - @userSprite.height/2 - 5
	# fp["l"].x = 212
    # fp["l"].y = 245
	fp["l"].x = cx + 100
    fp["l"].y = cy - 50
  else 
	# fp["l"].x = 230
    # fp["l"].y = 200	
	fp["l"].x = cx - 65
    fp["l"].y = cy + 58
  end
  fp["l"].opacity = 0
  fp["l"].z = 29#(@userIsPlayer ? 29 : 19)
  fp["r"] = Sprite.new(@viewport)
  fp["r"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_6")
  fp["r"].ox = fp["r"].bitmap.width/2
  fp["r"].oy = fp["r"].bitmap.height/2
  if @userIsPlayer
  # fp["r"].x = cx + @userSprite.width/2 + 90
  # fp["r"].y = cy - @userSprite.height/2 - 5
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  else 
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  end
  fp["r"].opacity = 0
  fp["r"].z = 29#(@userIsPlayer ? 29 : 19)
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...19
    @userSprite.still
	pbSEPlay("Anim/Leer",80) if i == 5
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
	if i.between?(2,10)
		fp["l"].opacity += 20
		fp["r"].opacity += 20
	end
	if i.between?(11,19)
		fp["l"].opacity -= 20
		fp["r"].opacity -= 20
	end	
	fp["l"].angle += 15
	fp["r"].angle += 15
	if i.between?(2,10)
		if i%2==0
			fp["l"].zoom_x += 1
			fp["l"].zoom_y += 1
			fp["r"].zoom_x += 1
			fp["r"].zoom_y += 1
		end
		fp["l"].tone.red += 10
		fp["l"].tone.green += 10
		fp["l"].tone.blue += 10
		fp["r"].tone.red += 10
		fp["r"].tone.green += 10
		fp["r"].tone.blue += 10
	end
	if i.between?(11,19)
		if i%2==1
			fp["l"].zoom_x -= 1
			fp["l"].zoom_y -= 1
			fp["r"].zoom_x -= 1
			fp["r"].zoom_y -= 1
		end
		fp["l"].tone.red -= 10
		fp["l"].tone.green -= 10
		fp["l"].tone.blue -= 10
		fp["r"].tone.red -= 10
		fp["r"].tone.green -= 10
		fp["r"].tone.blue -= 10
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: FRENZYPLANT.rb =====#
#-------------------------------------------------------------------------------
#  FRENZYPLANT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FRENZYPLANT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  rndx = [[],[]]; rndy = [[],[]]
  dx = [[],[]]; dy = [[],[]]
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb639_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  string = ["eb639_2","eb639"]
  rop = [255,80,40,135]
  px = []
  py = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for m in 0...2
    for i in 0...20
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      bmp = pbBitmap("Graphics/EBDX/Animations/Moves/"+string[m])
      fp["#{i}#{m}"].bitmap = Bitmap.new(bmp.width,bmp.height)
      fp["#{i}#{m}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height),(m==0 ? rop[rand(4)] : 255))
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].opacity = 0
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      fp["#{i}#{m}"].zoom_x = [0.5,1][m]
      fp["#{i}#{m}"].zoom_y = [0.5,1][m]
      rndx[m].push(rand(16))
      rndy[m].push(rand(16))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  k = 1
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/grass2",80)
  @scene.wait(4,true)
  for i in 0...96
    pbSEPlay("EBDX/Anim/grass1") if i == 12
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...20
        if fp["#{j}#{m}"].opacity == 0
          dx[m][j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
        end
        next if j>(i/4)
        x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        x0 = dx[m][j]
        y0 = dy[m][j]
        fp["#{j}#{m}"].x += (x2 - x0)*0.04*(m+1)
        fp["#{j}#{m}"].y += (y2 - y0)*0.04*(m+1)
        fp["#{j}#{m}"].zoom_x += (1 - fp["#{j}#{m}"].zoom_x)*0.1
        fp["#{j}#{m}"].zoom_y += (1 - fp["#{j}#{m}"].zoom_y)*0.1
        fp["#{j}#{m}"].opacity += 51
        fp["#{j}#{m}"].angle += 8*(m+1)*j
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          fp["#{j}#{m}"].visible = false if nextx > cx && nexty < cy
        else
          fp["#{j}#{m}"].visible = false if nextx < cx && nexty > cy
        end
      end
    end
    for l in 0...12
      next if i < 12
      next if l>((i-12)/4)
      if fp["p#{l}"].opacity <= 0
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(128)
        px[l] = cx - 128*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 128*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(vector) if i == 64
    @vector.inc = 0.1 if i == 64
    fp["bg"].update
    if i < 64
      k*=-1 if i%4==0
      @scene.moveEntireScene(0,k*4,true,true)
    end
    pbSEPlay("EBDX/Anim/grass2") if i == 84
    if i.between?(85,90)
      @targetSprite.zoom_x += 0.01
      @targetSprite.zoom_y -= 0.04
    elsif i.between?(91,96)
      @targetSprite.zoom_x -= 0.01
      @targetSprite.zoom_y += 0.04
    end
    @scene.wait(1,(i>=64 && i<85))
  end
  for j in 0...20; for m in 0...2; fp["#{j}#{m}"].visible = false; end; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: FURYCUTTER.rb =====#
#-------------------------------------------------------------------------------
#  FURYCUTTER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FURYCUTTER) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.white)
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_3")
  fp["claw"].mirror = true if rand(1)==0
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...16
	    fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
	    fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
		@targetSprite.still if k.between?(flashStart,flashStart+2)
		@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
		@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
		@scene.wait(1,true)
		pbSEPlay("EBDX/Anim/normal3",85) if k == 4
		fp["claw"].src_rect.height += 60
		fp["claw"].opacity -= 60 if k >= 5
		@scene.wait(1,true)
	  end
	  j = 1
	end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: FURYSWIPES.rb =====#
#-------------------------------------------------------------------------------
#  FURYSWIPES
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FURYSWIPES) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb601")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].mirror = true if @hitNum == 1 || @hitNum == 3 || @hitNum == 5 
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...32
		pbSEPlay("EBDX/Anim/normal3",85) if k == 4
		fp["claw"].src_rect.height += 20
		fp["claw"].opacity -= 32 if k >= 16
		@scene.wait(1,true)
	  end
	  j = 1
	end
    if i.between?(7,11)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: FUTURESIGHT.rb =====#
#-------------------------------------------------------------------------------
#  FUTURESIGHT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FUTURESIGHT) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:SCARYFACE, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:PSYCHIC, @scene, @userIndex, @targetIndex)
  end
end
#===== FILE: GIGAIMPACT.rb =====#
#-------------------------------------------------------------------------------
#  GIGAIMPACT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GIGAIMPACT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_14")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_7") #dragondance
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")#keep
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,55,55,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12 #keep
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  #pbSEPlay("Anim/psychic3",60) #change
  pbSEPlay("Anim/superdamage",60) #change
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/rock1",80) #change
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_13")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_4")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_11")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("Anim/TakeDownAttack",80) if i == 8 || i == 18 || i == 28 # keep
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: GLARE.rb =====#
#-------------------------------------------------------------------------------
#  GLARE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GLARE) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  cx, cy = @userSprite.getCenter(true)
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #eyes
  fp["l"] = Sprite.new(@viewport)
  fp["l"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_4")
  fp["l"].ox = fp["l"].bitmap.width/2
  fp["l"].oy = fp["l"].bitmap.height/2
  if @userIsPlayer
  # fp["l"].x = cx + @userSprite.width/2 + 50
  # fp["l"].y = cy - @userSprite.height/2 - 5
	fp["l"].x = 212
    fp["l"].y = 245
  else 
	fp["l"].x = 230
    fp["l"].y = 200
  end
  fp["l"].opacity = 0
  fp["l"].z = 29#(@userIsPlayer ? 29 : 19)
  fp["r"] = Sprite.new(@viewport)
  fp["r"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_4")
  fp["r"].ox = fp["r"].bitmap.width/2
  fp["r"].oy = fp["r"].bitmap.height/2
  if @userIsPlayer
  # fp["r"].x = cx + @userSprite.width/2 + 90
  # fp["r"].y = cy - @userSprite.height/2 - 5
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  else 
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  end
  fp["r"].opacity = 0
  fp["r"].z = 29#(@userIsPlayer ? 29 : 19)
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...19
    @userSprite.still
	pbSEPlay("Anim/ScaryFace",80) if i == 5
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
	if i.between?(2,10)
		fp["l"].opacity += 20
		fp["r"].opacity += 20
	end
	if i.between?(11,19)
		fp["l"].opacity -= 20
		fp["r"].opacity -= 20
	end	
	fp["l"].angle += 15
	fp["r"].angle += 15
	if i.between?(2,10)
		if i%2==0
			fp["l"].zoom_x += 1
			fp["l"].zoom_y += 1
			fp["r"].zoom_x += 1
			fp["r"].zoom_y += 1
		end
		fp["l"].tone.red += 10
		fp["l"].tone.green += 10
		fp["l"].tone.blue += 10
		fp["r"].tone.red += 10
		fp["r"].tone.green += 10
		fp["r"].tone.blue += 10
	end
	if i.between?(11,19)
		if i%2==1
			fp["l"].zoom_x -= 1
			fp["l"].zoom_y -= 1
			fp["r"].zoom_x -= 1
			fp["r"].zoom_y -= 1
		end
		fp["l"].tone.red -= 10
		fp["l"].tone.green -= 10
		fp["l"].tone.blue -= 10
		fp["r"].tone.red -= 10
		fp["r"].tone.green -= 10
		fp["r"].tone.blue -= 10
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: GRASSKNOT.rb =====#
#-------------------------------------------------------------------------------
#  GRASSKNOT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GRASSKNOT) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(0,204,102))
  fp["bg"].opacity = 0
  # set up animation
  16.times do
    fp["bg"].opacity += 15
    @scene.wait(1,true)
  end
  @multiHit = true
  EliteBattle.playMoveAnimation(:LEAFBLADE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playMoveAnimation(:COMETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @multiHit = false
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: GRASSWHISTLE.rb =====#
#-------------------------------------------------------------------------------
#  GRASSWHISTLE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GRASSWHISTLE) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  rndNote = 0
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(0,204,102))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
	rndNote = rand(2)
	if rndNote == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_3")
	else
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_4")
	end
    #fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].src_rect.set(0,101*0,53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end 
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/GrassWhistle",80) if i==0 
    if i >= 96
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    # @targetSprite.tone.red -= 2.4*2
    # @targetSprite.tone.green += 1.2*2
    # @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -1 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 1 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: GRASSYTERRAIN.rb =====#
#-------------------------------------------------------------------------------
#  MISTYTERRAIN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MISTYTERRAIN) do | args |
  beam, strike = *args; beam = false if beam.nil?; strike = false if strike.nil?
  factor = 2
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.white)
  fp["bg"].opacity = 0
  @userSprite.color = Color.new(52,218,96,0) if strike
  rndx = []
  rndy = []
  for i in 0...8
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb647_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  for i in 0...16
    fp["c#{i}"] = Sprite.new(@viewport)
    fp["c#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb647")
    fp["c#{i}"].ox = fp["c#{i}"].bitmap.width/2
    fp["c#{i}"].oy = fp["c#{i}"].bitmap.height/2
    fp["c#{i}"].opacity = 0
    fp["c#{i}"].z = 51
    rndx.push(0)
    rndy.push(0)
  end
  m = 0
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb647_3")
  fp["circle"].ox = fp["circle"].bitmap.width/4
  fp["circle"].oy = fp["circle"].bitmap.height/2
  fp["circle"].opacity = 0
  fp["circle"].src_rect.set(0,0,484,488)
  fp["circle"].z = 50
  fp["circle"].zoom_x = 0.5
  fp["circle"].zoom_y = 0.5
  # start animation
  #@vector.set(@scene.getRealVector(@userIndex, !@targetIsPlayer))
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...120
    pbSEPlay("EBDX/Anim/grass2",[i+10, 100].max) if i%14 == 0
    pbSEPlay("Anim/Saint8") if i == 64
    cx, cy = @userSprite.getCenter
    for j in 0...8
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(96*factor)
        fp["#{j}"].x = cx - 96*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 96*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/8)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*(180.0/Math::PI)# + (rand{4}==0 ? 180 : 0)
      fp["#{j}"].mirror = !fp["#{j}"].mirror if i%2==0
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    for k in 0...16
      if fp["c#{k}"].opacity == 0
        r = rand(2)
        fp["c#{k}"].zoom_x = (r==0 ? 1 : 0.5)
        fp["c#{k}"].zoom_y = (r==0 ? 1 : 0.5)
        fp["c#{k}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        rndx[k] = cx - 48*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        rndy[k] = cy - 48*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
        fp["c#{k}"].x = cx
        fp["c#{k}"].y = cy
      end
      next if k>(i/4)
      x2 = rndx[k]
      y2 = rndy[k]
      x0 = fp["c#{k}"].x
      y0 = fp["c#{k}"].y
      fp["c#{k}"].x += (x2 - x0)*0.05
      fp["c#{k}"].y += (y2 - y0)*0.05
      fp["c#{k}"].opacity += 5
    end
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].opacity += 25.5
    if i < 35
      fp["circle"].zoom_x += 0.01
      fp["circle"].zoom_y += 0.01
    end
	if i >=35 && i < 85
      fp["circle"].zoom_x += 0.05
      fp["circle"].zoom_y += 0.05
	  fp["circle"].opacity += 25 if fp["circle"].opacity < 200
	  for k in 0...16
		fp["c#{k}"].opacity -= 10
	  end
    end
	if i >= 85
      fp["circle"].zoom_x += 0.1
      fp["circle"].zoom_y += 0.1
	  for k in 0...16
		fp["c#{k}"].opacity -= 10
	  end
	  fp["circle"].opacity -= 45 if i >= 100
    end
    m = 1 if i%4==0
    fp["circle"].src_rect.x = 484*m
    m = 0 if i%2==0
    if i < 96
      if strike
        fp["bg"].opacity += 10 if fp["bg"].opacity < 255
      else
        fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.75
      end
    else
      fp["bg"].opacity -= 10 if !beam && !strike
    end
    @userSprite.still if !strike
    @userSprite.anim = true if strike
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  if !beam && !strike
    @sprites["battlebg"].focus
    @vector.reset if !@multiHit
    10.times do
      @viewport.color.alpha -= 25.5
      @scene.wait(1,true)
    end
  end
end

#===== FILE: GROWL.rb =====#
#-------------------------------------------------------------------------------
#  TICKLE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TICKLE) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  REST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:REST) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  NOBLEROAR
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NOBLEROAR) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ENTRAINMENT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ENTRAINMENT) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  YAWN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:YAWN) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  AFTERYOU
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AFTERYOU) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FAKETEARS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FAKETEARS) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ASSIST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ASSIST) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  HELPINGHAND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HELPINGHAND) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  PLAYNICE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PLAYNICE) do
  EliteBattle.playMoveAnimation(:GROWL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  GROWL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GROWL) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...12
    @userSprite.still
	pbSEPlay("Cries/#{@userSprite.species}",85) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: GROWTH.rb =====#
#-------------------------------------------------------------------------------
#  NATURALGIFT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NATURALGIFT) do
  EliteBattle.playMoveAnimation(:GROWTH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  NATUREPOWER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NATUREPOWER) do
  EliteBattle.playMoveAnimation(:GROWTH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  GROWTH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GROWTH) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(0,204,102,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: GUARDSWAP.rb =====#
#-------------------------------------------------------------------------------
#  GUARDSPLIT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GUARDSPLIT) do
  EliteBattle.playMoveAnimation(:GUARDSWAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  GUARDSWAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GUARDSWAP) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["change1"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_9"))
  fp["change1"].keyFrame = 1
  fp["change1"].z = @targetSprite.z + 1
  fp["change2"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_9"))
  fp["change2"].keyFrame = 1
  fp["change2"].z = @userSprite.z + 1
  # shooting out the change1
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["change1"].x = points[i][0]
    fp["change1"].y = points[i][1]
    z = 1 + (1-(fp["change1"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change1"].zoom_x = z
    fp["change1"].zoom_y = z
    fp["change1"].update
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxT,cyT,mx,32,cxP,cyP,24)
    fp["change2"].x = points[i][0]
    fp["change2"].y = points[i][1]
    z = 1 + (1-(fp["change2"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change2"].zoom_x = z
    fp["change2"].zoom_y = z
    fp["change2"].update
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  pbSEPlay("Anim/Saint7")
  @targetSprite.color = Color.new(178,255,255,0)
  @userSprite.color = Color.new(178,255,255,0)
  fp["change1"].dispose
  fp["change2"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha += 18
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_10")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  for j in 0...32
    fp["p2#{j}"] = Sprite.new(@viewport)
    fp["p2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_10")
    fp["p2#{j}"].center!
    fp["p2#{j}"].x, fp["p2#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p2#{j}"].end_x = fp["p2#{j}"].x - r + x
    fp["p2#{j}"].end_y = fp["p2#{j}"].y - r + y
    fp["p2#{j}"].zoom_x = 0
    fp["p2#{j}"].zoom_y = 0
    fp["p2#{j}"].angle = rand(360)
    fp["p2#{j}"].z = @userSprite.z + 1
  end
  # sparkle animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
	  
	  fp["p2#{j}"].zoom_x += (1.6 - fp["p2#{j}"].zoom_x)*0.1
      fp["p2#{j}"].zoom_y += (1.6 - fp["p2#{j}"].zoom_y)*0.1
      fp["p2#{j}"].x += (fp["p2#{j}"].end_x - fp["p2#{j}"].x)*0.1
      fp["p2#{j}"].y += (fp["p2#{j}"].end_y - fp["p2#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
	  if fp["p2#{j}"].zoom_x >= 1
        fp["p2#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
      fp["p2#{j}"].color.alpha -= 8
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha -= 16 if i >= 48
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: GUILLOTINE.rb =====#
#-------------------------------------------------------------------------------
#  GUILLOTINE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GUILLOTINE) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  shake  = 10
  idx =  0 # counter
  dir = -1 # direction
  userOX = @userSprite.ox
  j = 0
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_bg")
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_4")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  flashStart = 2
  8.times do
    fp["bg"].opacity += 24
    @scene.wait(1,true)
  end
  for i in 1..11
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...16
		@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
		@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
		@scene.wait(1,true)
		pbSEPlay("EBDX/Anim/normal3",85) if k == 4
		fp["claw"].src_rect.height += 30
		fp["claw"].opacity -= 60 if k >= 10
		if k.between?(0,16)
			@targetSprite.still
			if dir == -1 #move left 
				@targetSprite.ox -= shake
			else # move right
				@targetSprite.ox += shake
			end
		  idx += 1 
		  if idx == 2
			idx = 0
			dir = dir * -1
		  end
		end
		@scene.wait(1,true)
	  end
	  j = 1
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 25
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: GUNKSHOT.rb =====#
#-------------------------------------------------------------------------------
#  Gunk Shot
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GUNKSHOT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []; dx = []; dy = []
  @targetSprite.color = Color.new(181,42,165,0)
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb427_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb427_1")
    z = 1 - rand(61)/100.0
    fp["#{i}"].zoom_x = z
    fp["#{i}"].zoom_y = z
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].toggle = rand(2)==0 ? 1 : -1
    fp["#{i}"].param = 1 + rand(4)
    fp["#{i}"].z = @targetSprite.z + 1
    rndx.push(rand(192)); prndx.push(rand(64))
    rndy.push(rand(192)); prndy.push(rand(64))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  px = []
  py = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb427_2")
    fp["p#{i}"].ox = fp["p#{i}"].bitmap.width/2
    fp["p#{i}"].oy = fp["p#{i}"].bitmap.height/2
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  @vector.set(vector2)
  @sprites["battlebg"].defocus
  16.times { @targetSprite.anim = true; @scene.wait(1,true) }
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    fp["bg"].update
    @targetSprite.anim = true
    @scene.wait(1,true)
  end
  # shoot first
  for i in 0...96
    @vector.set(vector) if i == 16 # change vector
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 32*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 32*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 32*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 32*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 96*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 96*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += fp["#{j}"].toggle*(2 + fp["#{j}"].param)
      fp["#{j}"].tone.gray += 8
      fp["#{j}"].opacity -= 16
    end
    for l in 0...12
      next if i < 16
      next if l>((i-16)/4)
      if fp["p#{l}"].opacity <= 0 && i < 64
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        c = [Color.new(0,0,0,0),Color.new(165,91,239),Color.new(119,58,189)]
        fp["p#{l}"].color = c[rand(3)]
        x, y = randCircleCord(96)
        px[l] = cx - 48*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 48*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    if i > 7
      @targetSprite.color.alpha += 8 if @targetSprite.color.alpha < 128
      @targetSprite.still
    end
    fp["bg"].update
    @targetSprite.anim = true
    @scene.wait(1,true)
  end
  for i in 0...32
    if i < 12
    elsif i < 22
      fp["bg"].color.alpha += 25.5
    elsif i < 32
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.color.alpha -= 8
    @targetSprite.anim = true
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: GUST.rb =====#
#-------------------------------------------------------------------------------
#  GUST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GUST) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  numElements = 5
  for i in 0...numElements
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb637")
    fp["#{i}"].src_rect.set(0,128*rand(3),64,128)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...80
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...numElements
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 64 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 3
      end
    end
    pbSEPlay("Anim/Wind8",80) if i%24==0 && i <= 60
    if i >= 50
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: GYROBALL.rb =====#
#-------------------------------------------------------------------------------
#  GYROBALL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GYROBALL) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(174,174,174))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_15")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_14")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...72#96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/Psych Up",90) if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  EliteBattle.playMoveAnimation(:IRONHEAD, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: HAIL.rb =====#
#-------------------------------------------------------------------------------
#  HAIL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HAIL) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["weatherball"] = Sprite.new(@viewport)
  fp["weatherball"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_11")
  fp["weatherball"].ox = fp["weatherball"].bitmap.width/2
  fp["weatherball"].oy = fp["weatherball"].bitmap.height/2
  fp["weatherball"].z = 50
  fp["weatherball"].x, fp["weatherball"].y = @userSprite.getCenter
  fp["weatherball"].opacity = 0
  fp["weatherball"].zoom_x = factor*1.4
  fp["weatherball"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_12")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Ice8")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].zoom_x -= factor*0.4/10
    fp["weatherball"].zoom_y -= factor*0.4/10
    fp["weatherball"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  10.times do
    fp["weatherball"].zoom_x += factor*0.4/10
    fp["weatherball"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["weatherball"].zoom_y -= factor*0.02
    elsif
      fp["weatherball"].zoom_x -= factor*0.02
      fp["weatherball"].zoom_y += factor*0.04
    end
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying1") if i == 10
  end
  for i in 0...20
    fp["weatherball"].y -= 32
    fp["weatherball"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end
#===== FILE: HAMMERARM.rb =====#
#-------------------------------------------------------------------------------
#  HAMMERARM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HAMMERARM) do
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  pbSEPlay("EBDX/Anim/iron2",80,80)
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...2
    4.times do
      @userSprite.x += 8*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @userSprite.x -= 2*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @scene.wait
    end
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504_1")
    fp["#{i}"].ox = 6
    fp["#{i}"].oy = 6
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
	fp["#{i}"].angle = rand(360)
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  factor = 1
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb520_2")
  frame.src_rect.set(0,0,114,114)
  frame.ox = 57
  frame.oy = 57
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  # start animation
  for i in 1..30
    if i == 6
      pbSEPlay("EBDX/Anim/rock1",100)
      pbSEPlay("EBDX/Anim/iron1",80)
    end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 114 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...16
      next if i < 6
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      fp["#{j}"].angle += 2
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: HARDEN.rb =====#
#-------------------------------------------------------------------------------
#  DEFENSECURL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DEFENSECURL) do
  EliteBattle.playMoveAnimation(:HARDEN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  IRONDEFENSE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:IRONDEFENSE) do
  EliteBattle.playMoveAnimation(:HARDEN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  HARDEN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HARDEN) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(219,219,219))
  fp["bg"].opacity = 0
  fp["wrap1"] = Sprite.new(@viewport)
  fp["wrap1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_6")
  fp["wrap1"].ox = fp["wrap1"].bitmap.width/2 - 10
  fp["wrap1"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap1"].angle = -90
  fp["wrap1"].opacity = 0
  fp["wrap1"].z = 41
  fp["wrap2"] = Sprite.new(@viewport)
  fp["wrap2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_6")
  fp["wrap2"].ox = fp["wrap1"].bitmap.width/2 + 10
  fp["wrap2"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap2"].opacity = 0
  fp["wrap2"].z = 40
  fp["wrap2"].mirror = true
  fp["wrap2"].angle = 90
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...80
    cx, cy = @targetSprite.getCenter(true)
    fp["wrap1"].x = cx; fp["wrap1"].y = cy
    fp["wrap1"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap1"].zoom_y = 1.5*@targetSprite.zoom_y
    fp["wrap2"].x = cx; fp["wrap2"].y = cy
    fp["wrap2"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap2"].zoom_y = 1.5*@targetSprite.zoom_y
    if i.between?(20,35)
      fp["wrap1"].opacity += 5
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity += 5
      fp["wrap2"].oy += 2
    elsif i.between?(35,45)
      fp["wrap1"].opacity += 25.5
      fp["wrap1"].oy -= 2
      fp["wrap2"].opacity += 25.5
      fp["wrap2"].oy -= 2
    else
      fp["wrap1"].opacity -= 26
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity -= 26
      fp["wrap2"].oy += 2
    end
    pbSEPlay("EBDX/Anim/iron5") if i == 30 || i == 40
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: HEADBUTT.rb =====#
#-------------------------------------------------------------------------------
#  HEADBUTT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEADBUTT) do
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...2
    4.times do
      @userSprite.x += 8*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @userSprite.x -= 2*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @scene.wait
    end
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb008_2")
    fp["#{i}"].ox = 6
    fp["#{i}"].oy = 6
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  factor = 1
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb520_2")
  frame.src_rect.set(0,0,114,114)
  frame.ox = 57
  frame.oy = 57
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  # start animation
  for i in 1..30
    if i == 6
      pbSEPlay("Anim/Blow6",100)
    end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 114 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...16
      next if i < 6
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      fp["#{j}"].angle += 2
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: HEADSMASH.rb =====#
#-------------------------------------------------------------------------------
#  HEADSMASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEADSMASH) do
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  pbSEPlay("EBDX/Anim/iron2",80,80)
  pbSEPlay("EBDX/Anim/ground1",80)
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_2")
  #fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...2
    4.times do
      @userSprite.x += 8*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @userSprite.x -= 2*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @scene.wait
    end
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    #fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb008_2")
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504")
    fp["#{i}"].ox = 6
    fp["#{i}"].oy = 6
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  factor = 1
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb520_2")
  frame.src_rect.set(0,0,114,114)
  frame.ox = 57
  frame.oy = 57
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  # start animation
  16.times do
    fp["bg"].opacity += 30
    @scene.wait(1,true)
  end
  for i in 1..30
    if i == 6
      pbSEPlay("EBDX/Anim/iron3",90)
      pbSEPlay("EBDX/Anim/iron1",80)
    end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 114 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...16
      next if i < 6
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      fp["#{j}"].angle += 2
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 30
    @scene.wait(1,true)
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: HEALBELL.rb =====#
#-------------------------------------------------------------------------------
#  HEALBELL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEALBELL) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  rndNote = 0
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(255,255,153))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
	rndNote = rand(2)
	if rndNote == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_7")
	else
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_8")
	end
    #fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].src_rect.set(0,101*0,53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end 
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/HealBell",80) if i==0 
    if i >= 96
      # @targetSprite.ox += shake
      # shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      # shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      #@targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    # @targetSprite.tone.red -= 2.4*2
    # @targetSprite.tone.green += 1.2*2
    # @targetSprite.tone.blue += 2.4*2
    # @targetSprite.ox += shake
    # shake = -1 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    # shake = 1 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    # @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: HEALBLOCK.rb =====#
#-------------------------------------------------------------------------------
#  IMPRISON
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:IMPRISON) do
  EliteBattle.playMoveAnimation(:HEALBLOCK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  EMBARGO
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:EMBARGO) do
  EliteBattle.playMoveAnimation(:HEALBLOCK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  HEALBLOCK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEALBLOCK) do
  # set up animation
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  factor = @targetIsPlayer ? 2.5 : 1.5
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  sparks = 25
  for i in 0...sparks
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_3")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  k = 0
  c = [Tone.new(102,0,0),Tone.new(0,0,0)]
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...128
    cx, cy = @targetSprite.getCenter
    for j in 0...sparks
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        x, y = randCircleCord(64*factor)
        fp["#{j}"].x = cx - 64*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["#{j}"].y = cy - 64*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    if i < 96
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.6
    else
      fp["bg"].opacity -= 5
    end
    if i < 112
      if i%16 == 0
        k += 1
        k = 0 if k > 1
      end
      @targetSprite.tone.red += (c[k].red - @targetSprite.tone.red)*0.2
      @targetSprite.tone.green += (c[k].green - @targetSprite.tone.green)*0.2
      @targetSprite.tone.blue += (c[k].blue - @targetSprite.tone.blue)*0.2
    end
    pbSEPlay("Anim/PerishSong",100) if i == 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.tone = Tone.new(0,0,0)
  @vector.reset
  pbDisposeSpriteHash(fp)
 end
#===== FILE: HEALINGWISH.rb =====#
#-------------------------------------------------------------------------------
#  HEALINGWISH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEALINGWISH) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  @multiHit = true
  EliteBattle.playMoveAnimation(:RECOVER, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @multiHit = false
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation

  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: HEALORDER.rb =====#
#-------------------------------------------------------------------------------
#  HEALORDER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEALORDER) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  numElements = 60
  for j in 0...numElements
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010_4")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 45*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(105,164,103,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...numElements
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 24
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 10
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: HEALPULSE.rb =====#
#-------------------------------------------------------------------------------
#  HEALPULSE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEALPULSE) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
	pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: HEATWAVE.rb =====#
#-------------------------------------------------------------------------------
#  Heat Wave
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HEATWAVE) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  fp["wave"] = AnimatedPlane.new(@viewport)
  fp["wave"].bitmap = Bitmap.new(1026,@viewport.height)
  fp["wave"].bitmap.stretch_blt(Rect.new(0,0,fp["wave"].bitmap.width,fp["wave"].bitmap.height),pbBitmap("Graphics/EBDX/Animations/Moves/eb132"),Rect.new(0,0,1026,212))
  fp["wave"].opacity = 0
  fp["wave"].z = 50
  @vector.set(EliteBattle.get_vector(:DUAL))
  @vector.inc = 0.1
  pulse = 10
  shake = [4,4,4,4]
  # start animation
  for j in 0...64
    pbSEPlay("Anim/Wind8") if j == 24
    fp["wave"].ox += 48
    fp["wave"].opacity += pulse
    pulse = -5 if fp["wave"].opacity > 160
    pulse = +5 if fp["wave"].opacity < 100
    fp["bg"].opacity += 1 if fp["bg"].opacity < 255*0.35
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
      @sprites["pokemon_#{i}"].tone.all += 3 if j.between?(16,48)
      if j >= 32
        @sprites["pokemon_#{i}"].ox += shake[i]
        shake[i] = -4 if @sprites["pokemon_#{i}"].ox > @sprites["pokemon_#{i}"].bitmap.width/2 + 2
        shake[i] = 4 if @sprites["pokemon_#{i}"].ox < @sprites["pokemon_#{i}"].bitmap.width/2 - 2
      end
    end
    @sprites["pokemon_#{@userIndex}"].tone.all += 3 if j < 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  for i in 0...4
    next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
    next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
    @sprites["pokemon_#{i}"].ox = @sprites["pokemon_#{i}"].bitmap.width/2
  end
  for j in 0...64
    fp["wave"].ox += 48
    if j < 32
      fp["wave"].opacity += pulse
      pulse = -5 if fp["wave"].opacity > 160
      pulse = +5 if fp["wave"].opacity < 100
    end
    fp["wave"].opacity -= 4 if j >= 32
    fp["bg"].opacity -= 4 if j >= 32
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible)
      @sprites["pokemon_#{i}"].tone.all -= 3 if j >= 32
    end
    @sprites["pokemon_#{@userIndex}"].tone.all -= 3 if j >= 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: HIDDENPOWER.rb =====#
#-------------------------------------------------------------------------------
#  HIDDENPOWER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HIDDENPOWER) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb263_bg_4")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_4")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_3_4")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_2")
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: HIGHHORSEPOWER.rb =====#
#-------------------------------------------------------------------------------
#  STOMPINGTANTRUM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STOMPINGTANTRUM) do
  EliteBattle.playMoveAnimation(:HIGHHORSEPOWER, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  HIGHHORSEPOWER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HIGHHORSEPOWER) do
  # set up animation
  fp = {}
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 5
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...2
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb109")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...15
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb137_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...20
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...2
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...15
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
# set up animation
  @sprites["battlebg"].defocus
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  y0 = @targetSprite.y
  x = [cx - 64*factor, cx + 64*factor, cx]
  y = [y0, y0, y0 + 24*factor]
  dx = []
  # start animation
    j = -1
    pbSEPlay("EBDX/Anim/rock1",110)
    pbSEPlay("Anim/Earth4",80,70)
    for i in 0...70
      j *= -1 if i%4==0
      if i <= 55
		  if i%2 == 0
			l = 35 
		  else
			l = -35
		  end
	  else
		  if i%2 == 0
			l = 15 
		  else
			l = -15
		  end
	  end
      @scene.moveEntireScene(j*l, j, true, true)# if i < 24
      @scene.wait
    end
  #end
  16.times do
    fp["bg"].opacity -= 8
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: HIGHJUMPKICK.rb =====#
#-------------------------------------------------------------------------------
#  HIGHJUMPKICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HIGHJUMPKICK) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_2")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_0_2")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...72
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...96
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: HORNATTACK.rb =====#
#-------------------------------------------------------------------------------
#  SPIKECANNON
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPIKECANNON) do
  EliteBattle.playMoveAnimation(:HORNATTACK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  TWINEEDLE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TWINEEDLE) do
  EliteBattle.playMoveAnimation(:HORNATTACK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  PECK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PECK) do
  EliteBattle.playMoveAnimation(:HORNATTACK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  FELLSTINGER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FELLSTINGER) do
  EliteBattle.playMoveAnimation(:HORNATTACK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  FURYATTACK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FURYATTACK) do
  EliteBattle.playMoveAnimation(:HORNATTACK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  HORNATTACK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HORNATTACK) do | args |
  factor = @targetSprite.zoom_x
  factorHorn = @userIsPlayer ? 1.9 : 2.5
  hornXMove = @userIsPlayer ? 2 : -2
  hornYMove = @userIsPlayer ? 10 : -10
  hornXOffset = @userIsPlayer ? 60 : -120
  hornYOffset = @userIsPlayer ? 60 : -120
  hornMoveHit = @userIsPlayer ? 5 : -5
  hornAngle = @userIsPlayer ? 0 : 180
  userOX = @userSprite.ox
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  # phase 1
  if @hitNum == 0 #&& @multiHit
	  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer)) 
	  16.times do
		fp["bg"].opacity += 12
		@scene.wait(1,true)
	  end
	  # user move
	  for i in 0...30
		@userSprite.still
		#default movement
		if i.between?(0,20)
			@userSprite.ox += hornXMove
		else
			@userSprite.ox -= hornYMove
		end
		@scene.wait(1,true)
	  end
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(12,true)
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/normal1",80)
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  fp["horn"] = Sprite.new(@viewport)
  fp["horn"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626")
  fp["horn"].ox = fp["horn"].bitmap.width/2
  fp["horn"].oy = fp["horn"].bitmap.height/2
  fp["horn"].x, fp["horn"].y = @targetSprite.getCenter(true)
  fp["horn"].x -= hornXOffset
  fp["horn"].y += hornYOffset
  fp["horn"].opacity = 0
  fp["horn"].zoom = factorHorn
  fp["horn"].angle = hornAngle
  fp["horn"].z = 41
  # horn attack
  for i in 1..30
	if i.between?(1,15)
		fp["horn"].opacity += 20
		fp["horn"].x += hornMoveHit 
		fp["horn"].y -= hornMoveHit
	else
		fp["horn"].opacity -= 20
	end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: HORNDRILL.rb =====#
#-------------------------------------------------------------------------------
#  HORNDRILL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HORNDRILL) do | args |
  factor = @targetSprite.zoom_x
  factorHorn = @userIsPlayer ? 1.9 : 2.5
  hornXMove = @userIsPlayer ? 2 : -2
  hornYMove = @userIsPlayer ? 10 : -10
  hornXOffset = @userIsPlayer ? 60 : -120
  hornYOffset = @userIsPlayer ? 60 : -120
  hornMoveHit = @userIsPlayer ? 5 : -5
  hornAngle = @userIsPlayer ? 0 : 180
  userOX = @userSprite.ox
  targetOX = @targetSprite.ox
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_2")
  #fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_2")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  # phase 1
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  # user move
  for i in 0...30
    @userSprite.still
	#default movement
    if i.between?(0,20)
		@userSprite.ox += hornXMove
	else
		@userSprite.ox -= hornYMove
    end
    @scene.wait(1,true)
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(7,true)
  8.times do
    fp["bg"].opacity += 24
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/iron2",80)
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_0_2")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  fp["horn"] = Sprite.new(@viewport)
  fp["horn"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626")
  fp["horn"].ox = fp["horn"].bitmap.width/2
  fp["horn"].oy = fp["horn"].bitmap.height/2
  fp["horn"].x, fp["horn"].y = @targetSprite.getCenter(true)
  fp["horn"].x -= hornXOffset
  fp["horn"].y += hornYOffset
  fp["horn"].opacity = 0
  fp["horn"].zoom = factorHorn
  fp["horn"].angle = hornAngle
  fp["horn"].z = 41
  # horn attack
  for i in 1..30
	if i.between?(1,15)
		fp["horn"].opacity += 20
		fp["horn"].x += hornMoveHit 
		fp["horn"].y -= hornMoveHit
		@targetSprite.ox += 10 if i%2 == 0
		@targetSprite.ox -= 10 if i%2 == 1
	else
		fp["horn"].opacity -= 20
		@targetSprite.ox = targetOX
	end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  @targetSprite.ox = targetOX
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: HORNLEECH.rb =====#
#-------------------------------------------------------------------------------
#  HORNLEECH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HORNLEECH) do | args |
  factor = @targetSprite.zoom_x
  factorHorn = @userIsPlayer ? 1.9 : 2.5
  hornXMove = @userIsPlayer ? 2 : -2
  hornYMove = @userIsPlayer ? 10 : -10
  hornXOffset = @userIsPlayer ? 60 : -120
  hornYOffset = @userIsPlayer ? 60 : -120
  hornMoveHit = @userIsPlayer ? 5 : -5
  hornAngle = @userIsPlayer ? 0 : 180
  userOX = @userSprite.ox
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(153,255,153))
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_3")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  # phase 1
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # user move
  for i in 0...30
    @userSprite.still
	#default movement
    if i.between?(0,20)
		@userSprite.ox += hornXMove
	else
		@userSprite.ox -= hornYMove
    end
    @scene.wait(1,true)
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(10,true)
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/grass1",90)
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_0_3")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  fp["horn"] = Sprite.new(@viewport)
  fp["horn"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626")
  fp["horn"].ox = fp["horn"].bitmap.width/2
  fp["horn"].oy = fp["horn"].bitmap.height/2
  fp["horn"].x, fp["horn"].y = @targetSprite.getCenter(true)
  fp["horn"].x -= hornXOffset
  fp["horn"].y += hornYOffset
  fp["horn"].opacity = 0
  fp["horn"].zoom = factorHorn
  fp["horn"].angle = hornAngle
  fp["horn"].z = 41
  # horn attack
  for i in 1..30
	if i.between?(1,15)
		fp["horn"].opacity += 20
		fp["horn"].x += hornMoveHit 
		fp["horn"].y -= hornMoveHit
	else
		fp["horn"].opacity -= 20
	end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  EliteBattle.playMoveAnimation(:ABSORB, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: HOWL.rb =====#
#-------------------------------------------------------------------------------
#  HOWL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HOWL) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...12
    @userSprite.still
	 pbSEPlay("Cries/#{@userSprite.species}",100) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: HURRICANE.rb =====#
#-------------------------------------------------------------------------------
#  HURRICANE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HURRICANE) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(104,146,164))
  fp["bg"].opacity = 0
  fp["wave"] = AnimatedPlane.new(@viewport)
  fp["wave"].bitmap = Bitmap.new(1026,@viewport.height)
  fp["wave"].bitmap.stretch_blt(Rect.new(0,0,fp["wave"].bitmap.width,fp["wave"].bitmap.height),pbBitmap("Graphics/EBDX/Animations/Moves/eb132_3"),Rect.new(0,0,1026,212))
  fp["wave"].opacity = 0
  fp["wave"].z = 50
  rndx = []
  rndy = []
  numElements = 9
  for i in 0...numElements
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb637")
    fp["#{i}"].src_rect.set(0,128*rand(3),64,128)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  @vector.inc = 0.1
  pulse = 10
  shake = [4,4,4,4]
  # start animation
  for j in 0...80#64
    pbSEPlay("Anim/Wind8") if j == 24
    fp["wave"].ox += 48
    fp["wave"].opacity += pulse
    pulse = -5 if fp["wave"].opacity > 160
    pulse = +5 if fp["wave"].opacity < 100
    fp["bg"].opacity += 1 if fp["bg"].opacity < 255*0.35
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
      @sprites["pokemon_#{i}"].tone.all += 3 if j.between?(16,48)
      if j >= 32
        @sprites["pokemon_#{i}"].ox += shake[i]
        shake[i] = -4 if @sprites["pokemon_#{i}"].ox > @sprites["pokemon_#{i}"].bitmap.width/2 + 2
        shake[i] = 4 if @sprites["pokemon_#{i}"].ox < @sprites["pokemon_#{i}"].bitmap.width/2 - 2
      end
    end
	ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
	for i in 0...numElements
      if fp["#{i}"].opacity == 0 && fp["#{i}"].tone.gray == 0
        fp["#{i}"].zoom_x = @userSprite.zoom_x
        fp["#{i}"].zoom_y = @userSprite.zoom_y
        fp["#{i}"].x = ax
        fp["#{i}"].y = ay + 50*@userSprite.zoom_y
      end
      next if i>(j/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[i]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[i]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{i}"].x
      y0 = fp["#{i}"].y
      fp["#{i}"].x += (x2 - x0)*0.1
      fp["#{i}"].y += (y2 - y0)*0.1
      fp["#{i}"].zoom_x -= (fp["#{i}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{i}"].zoom_y -= (fp["#{i}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{i}"].src_rect.x += 64 if i%4==0
      fp["#{i}"].src_rect.x = 0 if fp["#{i}"].src_rect.x >= fp["#{i}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{i}"].opacity -= 8
        fp["#{i}"].tone.gray += 8
        fp["#{i}"].zoom_x -= 0.02
        fp["#{i}"].zoom_y += 0.04
      else
        fp["#{i}"].opacity += 3
      end
    end
    pbSEPlay("Anim/Wind8",80) if j%24==0 && j <= 60
    @sprites["pokemon_#{@userIndex}"].tone.all += 3 if j < 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  for i in 0...4
    next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
    next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
    @sprites["pokemon_#{i}"].ox = @sprites["pokemon_#{i}"].bitmap.width/2
  end
  for j in 0...64
    fp["wave"].ox += 48
    if j < 32
      fp["wave"].opacity += pulse
      pulse = -5 if fp["wave"].opacity > 160
      pulse = +5 if fp["wave"].opacity < 100
    end
    fp["wave"].opacity -= 4 if j >= 32
    fp["bg"].opacity -= 4 if j >= 32
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible)
      @sprites["pokemon_#{i}"].tone.all -= 3 if j >= 32
    end
    @sprites["pokemon_#{@userIndex}"].tone.all -= 3 if j >= 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: HYDROPUMP.rb =====#
#-------------------------------------------------------------------------------
#  Hydro Pump
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HYDROPUMP) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  rndx = [[],[]]; rndy = [[],[]]
  dx = [[],[]]; dy = [[],[]]
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb536_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  string = ["eb536_2","eb536"]
  rop = [255,80,40,135]
  px = []
  py = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for m in 0...2
    for i in 0...20
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      bmp = pbBitmap("Graphics/EBDX/Animations/Moves/"+string[m])
      fp["#{i}#{m}"].bitmap = Bitmap.new(bmp.width,bmp.height)
      fp["#{i}#{m}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height),(m==0 ? rop[rand(4)] : 255))
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].opacity = 0
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      fp["#{i}#{m}"].zoom_x = [0.5,1][m]
      fp["#{i}#{m}"].zoom_y = [0.5,1][m]
      rndx[m].push(rand(16))
      rndy[m].push(rand(16))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  k = 1
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Water3",80)
  @scene.wait(4,true)
  for i in 0...96
    pbSEPlay("Anim/Water5") if i == 12
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...20
        if fp["#{j}#{m}"].opacity == 0
          dx[m][j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
        end
        next if j>(i/4)
        x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        x0 = dx[m][j]
        y0 = dy[m][j]
        fp["#{j}#{m}"].x += (x2 - x0)*0.04*(m+1)
        fp["#{j}#{m}"].y += (y2 - y0)*0.04*(m+1)
        fp["#{j}#{m}"].zoom_x += (1 - fp["#{j}#{m}"].zoom_x)*0.1
        fp["#{j}#{m}"].zoom_y += (1 - fp["#{j}#{m}"].zoom_y)*0.1
        fp["#{j}#{m}"].opacity += 51
        fp["#{j}#{m}"].angle += 8*(m+1)*j
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          fp["#{j}#{m}"].visible = false if nextx > cx && nexty < cy
        else
          fp["#{j}#{m}"].visible = false if nextx < cx && nexty > cy
        end
      end
    end
    for l in 0...12
      next if i < 12
      next if l>((i-12)/4)
      if fp["p#{l}"].opacity <= 0
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(128)
        px[l] = cx - 128*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 128*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(vector) if i == 64
    @vector.inc = 0.1 if i == 64
    fp["bg"].update
    if i < 64
      k*=-1 if i%4==0
      @scene.moveEntireScene(0,k*4,true,true)
    end
    pbSEPlay("Anim/Water1") if i == 84
    if i.between?(85,90)
      @targetSprite.zoom_x += 0.01
      @targetSprite.zoom_y -= 0.04
    elsif i.between?(91,96)
      @targetSprite.zoom_x -= 0.01
      @targetSprite.zoom_y += 0.04
    end
    @scene.wait(1,(i>=64 && i<85))
  end
  for j in 0...20; for m in 0...2; fp["#{j}#{m}"].visible = false; end; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: HYPERBEAM.rb =====#
#-------------------------------------------------------------------------------
#  Hyper Beam
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HYPERBEAM) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb263_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_4")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_3")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_2")
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: HYPERVOICE.rb =====#
#-------------------------------------------------------------------------------
#  SYNCHRONOISE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SYNCHRONOISE) do
  EliteBattle.playMoveAnimation(:HYPERVOICE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  HYPERVOICE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HYPERVOICE) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_0")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
	pbSEPlay("Cries/#{@userSprite.species}",100) if i == 5
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: HYPNOSIS.rb =====#
#-------------------------------------------------------------------------------
#  HYPNOSIS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HYPNOSIS) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 6
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb452",true)
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  fp["bg"].oy = fp["bg"].src_rect.height/2
  fp["bg"].y = @viewport.height/2
  shake = 8
  zoom = -1
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_5")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...72
	pbSEPlay("EBDX/Anim/psychic1",80) if i == 40
    pbSEPlay("EBDX/Anim/psychic2",80) if i == 62
    if i < 10
      fp["bg"].opacity += 25.5
    elsif i < 20
      fp["bg"].color.alpha -= 25.5
    elsif i >= 67
      fp["bg"].color.alpha += 25.5
      @targetSprite.tone.red += 18
      @targetSprite.tone.green += 18
      @targetSprite.tone.blue += 18
      #@targetSprite.zoom_x += 0.04*factor
      #@targetSprite.zoom_y += 0.04*factor
    elsif i >= 40
      @targetSprite.ox += shake
      shake = -8 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
      shake = 8 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
      @targetSprite.still
    end
    zoom *= -1 if i%2 == 0
    fp["bg"].update
    fp["bg"].zoom_y += 0.04*zoom
    @scene.wait(1,(i<62))
	#
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...20
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      #fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    # if i >= 64
      # @targetSprite.ox += shake
      # shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      # shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      # @targetSprite.still
    # end
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
    5.times do
    @targetSprite.tone.red -= 18
    @targetSprite.tone.green -= 18
    @targetSprite.tone.blue -= 18
    #@targetSprite.zoom_x -= 0.04*factor
    #@targetSprite.zoom_y -= 0.04*factor
    @targetSprite.still
    @scene.wait
	end
	10.times do
    fp["bg"].opacity -= 25.5
    @targetSprite.still
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: ICEBALL.rb =====#
#-------------------------------------------------------------------------------
#  ICEBALL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ICEBALL) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["iceball"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb627"))
  fp["iceball"].keyFrame = 1
  fp["iceball"].z = @targetSprite.z + 1
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  # shooting out the iceball
  for i in 0...24
	pbSEPlay("EBDX/Anim/ice1") if i == 5
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["iceball"].x = points[i][0]
    fp["iceball"].y = points[i][1]
    z = 1 + (1-(fp["iceball"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["iceball"].zoom_x = z
    fp["iceball"].zoom_y = z
    fp["iceball"].update
	if i.between?(16,8)
		@targetSprite.color.alpha += 18
		@targetSprite.anim = true
		@targetSprite.still
	end
    @scene.wait(1,true)
  end
  @targetSprite.color = Color.new(204,255,255,0)
  fp["iceball"].dispose
  # zooming onto the target
  # 8.times do
    # @targetSprite.color.alpha += 18
    # @targetSprite.anim = true
    # @targetSprite.still
    # @scene.wait(1,true)
  # end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	if rand(1)
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb627_2")
	else
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb627_3")
	end
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("EBDX/Anim/ice2") if i == 5
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.03
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.03
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: ICEBEAM.rb =====#
#-------------------------------------------------------------------------------
#  Ice Beam
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ICEBEAM) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  factor = @targetIsPlayer ? 2 : 1
  @viewport.color = Color.new(255,255,255,155)
  # set up animation
  fp = {}; rndx = []; rndy = []; crndx = []; crndy = []; dx = []; dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(100,128,142))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["c#{i}"] = Sprite.new(@viewport)
    fp["c#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb250")
    fp["c#{i}"].ox = fp["c#{i}"].bitmap.width/2
    fp["c#{i}"].oy = fp["c#{i}"].bitmap.height/2
    fp["c#{i}"].opacity = 0
    fp["c#{i}"].z = 19
    crndx.push(rand(64))
    crndy.push(rand(64))
  end
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb243")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...96
    pbSEPlay("Anim/Ice8") if i == 12
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      next if j>(i)
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      x0 = dx[j]
      y0 = dy[j]
      fp["#{j}"].x += (x2 - x0)*0.05
      fp["#{j}"].y += (y2 - y0)*0.05
      fp["#{j}"].zoom_x = @targetIsPlayer ? @userSprite.zoom_x : @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetIsPlayer ? @userSprite.zoom_y : @targetSprite.zoom_y
      fp["#{j}"].opacity += 32
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x + (x2 - x0)*0.05
      nexty = fp["#{j}"].y + (y2 - y0)*0.05
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
        fp["#{j}"].visible = false if nextx > cx && nexty < cy
      else
        fp["#{j}"].visible = false if nextx < cx && nexty > cy
      end
    end
    pbSEPlay("Anim/Ice1") if i>32 && (i-32)%4==0
    for j in 0...16
      if fp["c#{j}"].opacity == 0 && fp["c#{j}"].tone.gray == 0
        fp["c#{j}"].zoom_x = factor*@targetSprite.zoom_x
        fp["c#{j}"].zoom_y = factor*@targetSprite.zoom_x
        fp["c#{j}"].x = cx
        fp["c#{j}"].y = cy
      end
      next if j>((i-12)/4)
      next if i<12
      x2 = cx - 32*@targetSprite.zoom_x + crndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + crndy[j]*@targetSprite.zoom_y
      x0 = fp["c#{j}"].x
      y0 = fp["c#{j}"].y
      fp["c#{j}"].x += (x2 - x0)*0.2
      fp["c#{j}"].y += (y2 - y0)*0.2
      fp["c#{j}"].angle += 2
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["c#{j}"].opacity -= 24
        fp["c#{j}"].tone.gray += 8
        fp["c#{j}"].angle += 2
      else
        fp["c#{j}"].opacity += 35
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    if i >= 32
      @targetSprite.tone.red += 5.4 if @targetSprite.tone.red < 108
      @targetSprite.tone.green += 6.4 if @targetSprite.tone.green < 128
      @targetSprite.tone.blue += 8 if @targetSprite.tone.blue < 160
      @targetSprite.still
    end
    @vector.set(vector) if i == 24
    @vector.inc = 0.1 if i == 24
    @viewport.color.alpha -= 5 if @viewport.color.alpha > 0
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 5.4
    @targetSprite.tone.green -= 6.4
    @targetSprite.tone.blue -= 8
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @targetSprite.tone = Tone.new(0,0,0)
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: ICEFANG.rb =====#
#-------------------------------------------------------------------------------
#  Ice Fang
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ICEFANG) do
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(100,128,142))
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb248")
    fp["#{i}"].src_rect.set(0,0,26,42)
    fp["#{i}"].ox = 13
    fp["#{i}"].oy = 21
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  fp["fang1"] = Sprite.new(@viewport)
  fp["fang1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang1"].ox = fp["fang1"].bitmap.width/2
  fp["fang1"].oy = fp["fang1"].bitmap.height - 20
  fp["fang1"].opacity = 0
  fp["fang1"].z = 41
  fp["fang1"].tone = Tone.new(6,16,48)
  fp["fang2"] = Sprite.new(@viewport)
  fp["fang2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang2"].ox = fp["fang1"].bitmap.width/2
  fp["fang2"].oy = fp["fang1"].bitmap.height - 20
  fp["fang2"].opacity = 0
  fp["fang2"].z = 40
  fp["fang2"].angle = 180
  fp["fang2"].tone = Tone.new(6,16,48)
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...92
    cx, cy = @targetSprite.getCenter(true)
    fp["fang1"].x = cx; fp["fang1"].y = cy
    fp["fang1"].zoom_x = @targetSprite.zoom_x; fp["fang1"].zoom_y = @targetSprite.zoom_y
    fp["fang2"].x = cx; fp["fang2"].y = cy
    fp["fang2"].zoom_x = @targetSprite.zoom_x; fp["fang2"].zoom_y = @targetSprite.zoom_y
    if i.between?(20,29)
      fp["fang1"].opacity += 5
      fp["fang1"].oy += 2
      fp["fang2"].opacity += 5
      fp["fang2"].oy += 2
    elsif i.between?(30,40)
      fp["fang1"].opacity += 25.5
      fp["fang1"].oy -= 4
      fp["fang2"].opacity += 25.5
      fp["fang2"].oy -= 4
    else
      fp["fang1"].opacity -= 26
      fp["fang1"].oy += 2
      fp["fang2"].opacity -= 26
      fp["fang2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Super Fang")
      pbSEPlay("EBDX/Anim/ice1",75)
    end
    for j in 0...12
      next if i < 40
      if fp["#{j}"].opacity == 0 && fp["#{j}"].src_rect.x == 0
        fp["#{j}"].x = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
        fp["#{j}"].y = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      end
      fp["#{j}"].src_rect.x += 26 if i%4==0 && fp["#{j}"].opacity >= 255
      fp["#{j}"].src_rect.x = 78 if fp["#{j}"].src_rect.x > 78
      if fp["#{j}"].src_rect.x==78
        fp["#{j}"].opacity -= 24
        fp["#{j}"].zoom_x += 0.02
        fp["#{j}"].zoom_y += 0.02
      elsif fp["#{j}"].opacity >= 255
        fp["#{j}"].opacity -= 24
      else
        fp["#{j}"].opacity += 45 if (i-40)/2 > j
      end
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      if i >= 56 && i < 72
        @targetSprite.tone.red -= 8
        @targetSprite.tone.green -= 8
        @targetSprite.tone.blue -= 8
        fp["bg"].opacity -= 10
      elsif i < 65
        @targetSprite.tone.red += 8
        @targetSprite.tone.green += 8
        @targetSprite.tone.blue += 8
      end
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    if i == 72
      @targetSprite.ox = @targetSprite.bitmap.width/2
      @vector.reset if !@multiHit
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: ICEPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  Ice Punch
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ICEPUNCH) do
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  angl = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(100,128,142))
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb248")
    fp["#{i}"].src_rect.set(rand(2)*26,0,26,42)
    fp["#{i}"].ox = 13
    fp["#{i}"].oy = 21
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    r = rand(101)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x - r*0.0075*@targetSprite.zoom_x)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y - r*0.0075*@targetSprite.zoom_y)
    rndx.push(rand(196))
    rndy.push(rand(196))
    angl.push((1+rand(3))*4*(rand(2)==0 ? 1 : -1))
  end
  fp["punch"] = Sprite.new(@viewport)
  fp["punch"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb108")
  fp["punch"].ox = fp["punch"].bitmap.width/2
  fp["punch"].oy = fp["punch"].bitmap.height/2
  fp["punch"].opacity = 0
  fp["punch"].z = 40
  fp["punch"].angle = 180
  fp["punch"].zoom_x = @targetIsPlayer ? 6 : 4
  fp["punch"].zoom_y = @targetIsPlayer ? 6 : 4
  fp["punch"].tone = Tone.new(6,16,48)
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  pbSEPlay("Anim/fog2",75)
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["punch"].x = cx
    fp["punch"].y = cy
    fp["punch"].angle -= 45 if i < 40
    fp["punch"].zoom_x -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].zoom_y -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].opacity += 8 if i < 40
    if i >= 40
      fp["punch"].tone = Tone.new(255,255,255) if i == 40
      fp["punch"].tone.all -= 25.5
      fp["punch"].opacity -= 25.5
    end
    pbSEPlay("Anim/Ice2") if i==40
    pbSEPlay("EBDX/Anim/ice1",75) if i==40
    for j in 0...12
      next if i < 40
      if fp["#{j}"].opacity == 0
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 98*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 98*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].opacity += 32
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      if i >= 56 && i < 72
        @targetSprite.tone.red -= 8
        @targetSprite.tone.green -= 8
        @targetSprite.tone.blue -= 8
        fp["bg"].opacity -= 10
      elsif i < 56
        @targetSprite.tone.red += 8
        @targetSprite.tone.green += 8
        @targetSprite.tone.blue += 8
      end
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @sprites["battlebg"].focus
  20.times do
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      fp["#{j}"].x = cx - 98*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      fp["#{j}"].y = cy - 98*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].opacity -= 13
    end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: ICESHARD.rb =====#
#-------------------------------------------------------------------------------
#  ICESHARD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ICESHARD) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(0,153,153))
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/move1",80) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playCommonAnimation(:FROZEN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ICICLECRASH.rb =====#
#-------------------------------------------------------------------------------
#  Icicle Crash
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ICICLECRASH) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  fp = {}
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb250")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height/2
    fp["i#{j}"].opacity = 0
    fp["i#{j}"].zoom_x = @targetSprite.zoom_x
    fp["i#{j}"].zoom_y = @targetSprite.zoom_y
    fp["i#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["i#{j}"].x = @targetSprite.x + rand(32)*@targetSprite.zoom_x*(rand(2)==0 ? 1 : -1)
    fp["i#{j}"].y = @targetSprite.y - 8*@targetSprite.zoom_y + rand(16)*@targetSprite.zoom_y
  end
  for j in 0...5
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    fp["s#{j}"].opacity = 0
    fp["s#{j}"].zoom_x = @targetSprite.zoom_x
    fp["s#{j}"].zoom_y = @targetSprite.zoom_y
    fp["s#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["s#{j}"].x = @targetSprite.x - 48*@targetSprite.zoom_x + rand(96)*@targetSprite.zoom_x
    fp["s#{j}"].y = @targetSprite.y - 192*@targetSprite.zoom_y
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = 2
    fp["p#{j}"].zoom_y = 2
    fp["p#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["p#{j}"].x = fp["s#{j}"].x
    fp["p#{j}"].y = fp["s#{j}"].y + 192*@targetSprite.zoom_y
  end
  k = -2
  for i in 0...64
    k *= -1 if i%4==0 && i >= 8
    pbSEPlay("EBDX/Anim/rock1",70) if i%8==0 && i >0 && i < 48
    for j in 0...5
      next if j>(i/6)
      fp["s#{j}"].opacity += 64
      fp["s#{j}"].y += 24*@targetSprite.zoom_y if fp["s#{j}"].y < @targetSprite.y
      fp["s#{j}"].zoom_y -= 0.2*@targetSprite.zoom_y if fp["s#{j}"].y >= @targetSprite.y
      fp["s#{j}"].visible = false if fp["s#{j}"].zoom_y <= 0.4*@targetSprite.zoom_y
    end
    for j in 0...5
      next if i < 8
      next if j>(i-8)/8
      fp["p#{j}"].visible = true
      fp["p#{j}"].opacity -= 32
      fp["p#{j}"].zoom_x += 0.02
      fp["p#{j}"].zoom_y += 0.02
      fp["p#{j}"].angle += 8
    end
    for j in 0...16
      next if i < 8
      next if j>(i-8)/2
      fp["i#{j}"].opacity += 32*(fp["i#{j}"].zoom_x <= 0.5*@targetSprite.zoom_x ? -1 : 1)
      fp["i#{j}"].zoom_x -= 0.02*@targetSprite.zoom_x
      fp["i#{j}"].zoom_y -= 0.02*@targetSprite.zoom_y
      fp["i#{j}"].x += 2*@targetSprite.zoom_x*(fp["i#{j}"].x >= @targetSprite.x ? 1 : -1)
      fp["i#{j}"].angle += 4*(fp["i#{j}"].x >= @targetSprite.x ? 1 : -1)
    end
    @scene.moveEntireScene(0, k, true, true) if i >= 8 && i < 48
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ICICLESPEAR.rb =====#
#-------------------------------------------------------------------------------
#  ICICLESPEAR
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ICICLESPEAR) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  shake = 6
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(204,255,255))
  fp["bg"].opacity = 0
  # shooting out the icespear
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  fp["icespear"] = Sprite.new(@viewport)
  fp["icespear"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244")
  fp["icespear"].z = @targetSprite.z + 1
  @targetSprite.color = Color.new(204,255,255,0)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  for v in 0..2
	  for i in 0...24
		pbSEPlay("EBDX/Anim/ice1") if i == 3
		pbSEPlay("EBDX/Anim/ice2") if i == 20
		cxT, cyT = @targetSprite.getCenter(true)
		cxP, cyP = @userSprite.getAnchor(true)
		mx = @vector.x + (@vector.x2 - @vector.x)*0.5
		points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
		fp["icespear"].x = points[i][0]
		fp["icespear"].y = points[i][1]
		z = 1 + (1-(fp["icespear"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
		fp["icespear"].zoom_x = z/2
		fp["icespear"].zoom_y = z/2
		fp["icespear"].update
		fp["icespear"].angle = 135 - i*3.75 if @userIsPlayer
		fp["icespear"].angle = -135 + i*5 if @targetIsPlayer
		if i >= 16 && i%2 == 0
			@targetSprite.ox += shake
		end
		if i >= 16 && i%2 == 1
			@targetSprite.ox -= shake
		end
		if i.between?(17,20)
		    @targetSprite.color.alpha += 25
			@targetSprite.anim = true
			@targetSprite.still
		end
		if i.between?(20,24)
		    @targetSprite.color.alpha -= 25
			@targetSprite.anim = true
			@targetSprite.still
		end
		@scene.wait(1,true)
	  end
  end
  fp["icespear"].dispose
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#===== FILE: ICYWIND.rb =====#
#-------------------------------------------------------------------------------
#  Icy Wind
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ICYWIND) do
  indexes = []
  max = @battle.pbSideSize(@targetIsPlayer ? 0 : 1)
  for i in 0...max
    i = (@targetIsPlayer ? i*2 : (i*2 + 1))
    indexes.push(i) if @sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].actualBitmap
  end
  # set up animation
  fp = {}
  rndx = [[],[]]; rndy = [[],[]]
  irndx = [[],[]]; irndy = [[],[]]
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(100,128,142))
  fp["bg"].opacity = 0
  for m in 0...indexes.length
    @targetSprite = @sprites["pokemon_#{indexes[m]}"]
    for i in 0...16
      fp["#{m}#{i}"] = Sprite.new(@viewport)
      fp["#{m}#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb250")
      fp["#{m}#{i}"].ox = fp["#{m}#{i}"].bitmap.width/2
      fp["#{m}#{i}"].oy = fp["#{m}#{i}"].bitmap.width/2
      fp["#{m}#{i}"].opacity = 0
      fp["#{m}#{i}"].z = (@targetIsPlayer ? 29 : 19)
      rndx[m].push(rand(64))
      rndy[m].push(rand(64))
    end
  end
  for m in 0...indexes.length
    @targetSprite = @sprites["pokemon_#{indexes[m]}"]
    next if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
    for i in 0...8
      fp["i#{m}#{i}"] = Sprite.new(@viewport)
      fp["i#{m}#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb248")
      fp["i#{m}#{i}"].src_rect.set(0,0,26,42)
      fp["i#{m}#{i}"].ox = 13
      fp["i#{m}#{i}"].oy = 21
      fp["i#{m}#{i}"].opacity = 0
      fp["i#{m}#{i}"].z = (@targetIsPlayer ? 29 : 19)
      fp["i#{m}#{i}"].zoom_x = (@targetSprite.zoom_x)/2
      fp["i#{m}#{i}"].zoom_y = (@targetSprite.zoom_y)/2
      irndx[m].push(rand(128))
      irndy[m].push(rand(128))
    end
  end
  shake = [2,2]
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...152
    for m in 0...indexes.length
      @targetSprite = @sprites["pokemon_#{indexes[m]}"]
      next if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
      for j in 0...16
        if fp["#{m}#{j}"].opacity == 0 && fp["#{m}#{j}"].tone.gray == 0
          fp["#{m}#{j}"].zoom_x = @userSprite.zoom_x
          fp["#{m}#{j}"].zoom_y = @userSprite.zoom_y
          cx, cy = @userSprite.getAnchor
          fp["#{m}#{j}"].x = cx
          fp["#{m}#{j}"].y = cy
        end
        cx, cy = @targetSprite.getCenter(true)
        next if j>(i/4)
        x2 = cx - 32*@targetSprite.zoom_x + rndx[m][j]*@targetSprite.zoom_x
        y2 = cy - 32*@targetSprite.zoom_y + rndy[m][j]*@targetSprite.zoom_y
        x0 = fp["#{m}#{j}"].x
        y0 = fp["#{m}#{j}"].y
        fp["#{m}#{j}"].x += (x2 - x0)*0.1
        fp["#{m}#{j}"].y += (y2 - y0)*0.1
        fp["#{m}#{j}"].zoom_x -= (fp["#{m}#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
        fp["#{m}#{j}"].zoom_y -= (fp["#{m}#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
        fp["#{m}#{j}"].angle += 2
        if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
          fp["#{m}#{j}"].opacity -= 8
          fp["#{m}#{j}"].tone.gray += 8
          fp["#{m}#{j}"].angle += 2
        else
          fp["#{m}#{j}"].opacity += 12
        end
      end
    end
    if i >= 132
      fp["bg"].opacity -= 7
    else
      fp["bg"].opacity += 2 if fp["bg"].opacity < 255*0.5
    end
    pbSEPlay("Anim/Ice7", 80) if i == 96
    pbSEPlay("Anim/Wind8", 70) if i == 12
    if i >= 96
      for m in 0...indexes.length
        @targetSprite = @sprites["pokemon_#{indexes[m]}"]
        next if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
        cx, cy = @targetSprite.getCenter(true)
        if i >= 132
          @targetSprite.tone.red -= 4.8
          @targetSprite.tone.green -= 4.8
          @targetSprite.tone.blue -= 4.8
        else
          @targetSprite.tone.red += 4.8 if @targetSprite.tone.red < 96
          @targetSprite.tone.green += 4.8 if @targetSprite.tone.green < 96
          @targetSprite.tone.blue += 4.8 if @targetSprite.tone.blue < 96
        end
        @targetSprite.ox += shake[m]
        shake[m] = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
        shake[m] = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
        @targetSprite.still
        for k in 0...8
          if fp["i#{m}#{k}"].opacity == 0 && fp["i#{m}#{k}"].src_rect.x == 0
            fp["i#{m}#{k}"].x = cx - 64*@targetSprite.zoom_x + irndx[m][k]*@targetSprite.zoom_x
            fp["i#{m}#{k}"].y = cy - 64*@targetSprite.zoom_y + irndy[m][k]*@targetSprite.zoom_y
          end
          fp["i#{m}#{k}"].src_rect.x += 26 if i%4==0 && fp["i#{m}#{k}"].opacity >= 255
          fp["i#{m}#{k}"].src_rect.x = 78 if fp["i#{m}#{k}"].src_rect.x > 78
          if fp["i#{m}#{k}"].src_rect.x==78
            fp["i#{m}#{k}"].opacity -= 24
            fp["i#{m}#{k}"].zoom_x += 0.02
            fp["i#{m}#{k}"].zoom_y += 0.02
          elsif fp["i#{m}#{k}"].opacity >= 255
            fp["i#{m}#{k}"].opacity -= 24
            pbSEPlay("Anim/Ice1",50)
          else
            fp["i#{m}#{k}"].opacity += 45 if (i-96)/2 > k
          end
        end
      end
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  for m in 0...indexes.length
    @targetSprite = @sprites["pokemon_#{indexes[m]}"]
    next if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
    @targetSprite.ox = @targetSprite.bitmap.width/2
    @targetSprite.tone = Tone.new(0,0,0,0)
  end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: INCINERATE.rb =====#
#-------------------------------------------------------------------------------
#  INCINERATE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:INCINERATE) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  for i in 0...10
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...10
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    #fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Fire2",80) if i%12==0 && i <= 96
    pbSEPlay("Anim/Smokescreen",120) if i==84
    if i >= 96
      @targetSprite.tone.red += 2.4*2 if @targetSprite.tone.red < 48*2
      @targetSprite.tone.green -= 1.2*2 if @targetSprite.tone.green > -24*2
      @targetSprite.tone.blue -= 2.4*2 if @targetSprite.tone.blue > -48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 2.4*2
    @targetSprite.tone.green += 1.2*2
    @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    #fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: INFERNO.rb =====#
#-------------------------------------------------------------------------------
#  INFERNO
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:INFERNO) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(102,32,32))
  fp["bg"].opacity = 0
  flames = 30
  for i in 0...flames
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136_5")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(120))
    rndy.push(rand(120))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...180
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...flames
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Fire2",80) if i%12==0 && i <= 96
    pbSEPlay("Anim/Smokescreen",120) if i==84
    if i >= 96
      @targetSprite.tone.red += 2.4*2 if @targetSprite.tone.red < 48*2
      @targetSprite.tone.green -= 1.2*2 if @targetSprite.tone.green > -24*2
      @targetSprite.tone.blue -= 2.4*2 if @targetSprite.tone.blue > -48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 2.4*2
    @targetSprite.tone.green += 1.2*2
    @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: INFESTATION.rb =====#
#-------------------------------------------------------------------------------
#  INFESTATION
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:INFESTATION) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  numElements = 60
  for j in 0...numElements
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010_5")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 45*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @targetSprite.z + 1
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(11,50,10,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...numElements
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 24
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 10
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: INGRAIN.rb =====#
#-------------------------------------------------------------------------------
#  INGRAIN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:INGRAIN) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  fp = {}
  # ini param
  factor = @targetIsPlayer ? 2 : 1.5
  roots = 3
  idx = []
  # ini fp
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(113,218,81))
  fp["bg"].opacity = 0
  for i in 0...roots
	  fp["seed#{i}"] = Sprite.new(@viewport)
	  fp["seed#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb625")
	  if rand(1) == 0
		fp["seed#{i}"].mirror = true
	  end
	  fp["seed#{i}"].src_rect.set(0,32*rand(3),32,32)
	  fp["seed#{i}"].ox = 16
	  fp["seed#{i}"].oy = 32
	  fp["seed#{i}"].zoom = @targetIsPlayer ? rand(5..6) : rand(3..4)
	  fp["seed#{i}"].opacity = 0
	  fp["seed#{i}"].z = @targetSprite.z + 100
	  idx[i] = 0
  end
  # set up animation
  @scene.wait(5,true)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  for i in 0...roots
	  fp["seed#{i}"].x, fp["seed#{i}"].y = @targetSprite.getCenter(true)
	  fp["seed#{i}"].x += 40 * factor * (i-1) 
	  fp["seed#{i}"].y += 90
  end
  for i in 0...50
	for m in 0...roots
		next if (m == 1 && i < 10) || (m == 2 && i <20)
		fp["seed#{m}"].opacity += 16 
	end 
	if i%2 == 0
		for j in 0...roots
			next if (j == 1 && i < 10) || (j == 2 && i <20)
			if fp["seed#{j}"].tone.all < 10
				fp["seed#{j}"].tone.all += 10
			else 
				fp["seed#{j}"].tone.all -= 10 
			end
			fp["seed#{j}"].src_rect.x += 32 if i%10==0 && fp["seed#{j}"].src_rect.x < 32*3
			pbSEPlay("Anim/LeechSeedThrowing") if i%10 == 0 && i <= 20
			pbSEPlay("Anim/LeechSeedGrowing") if i%5 == 0
			if fp["seed#{j}"].src_rect.x == 32*3 && idx[j] < 2
				pbSEPlay("Anim/LeechSeedPlanted")  
				idx[j] += 1
			end
		end
	end
    #@scene.wait(2,true) if i%2 == 0
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 10
	for i in 0...roots
		fp["seed#{i}"].opacity -= 15
	end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: IONDELUGE.rb =====#
#-------------------------------------------------------------------------------
#  IONDELUGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:IONDELUGE) do
    EliteBattle.playMoveAnimation(:IONDELUGE_UP, @scene, @userIndex, @targetIndex)
    EliteBattle.playMoveAnimation(:IONDELUGE_DOWN, @scene, @userIndex, @targetIndex)
end

EliteBattle.defineMoveAnimation(:IONDELUGE_UP) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["fly"] = Sprite.new(@viewport)
  fp["fly"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_15")
  fp["fly"].ox = fp["fly"].bitmap.width/2
  fp["fly"].oy = fp["fly"].bitmap.height/2
  fp["fly"].z = 50
  fp["fly"].x, fp["fly"].y = @userSprite.getCenter
  fp["fly"].opacity = 0
  fp["fly"].zoom_x = factor*1.4
  fp["fly"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_16")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Refresh")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].zoom_x -= factor*0.4/10
    fp["fly"].zoom_y -= factor*0.4/10
    fp["fly"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  10.times do
    fp["fly"].zoom_x += factor*0.4/10
    fp["fly"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["fly"].zoom_y -= factor*0.02
    elsif
      fp["fly"].zoom_x -= factor*0.02
      fp["fly"].zoom_y += factor*0.04
    end
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying2") if i == 10
  end
  for i in 0...20
    fp["fly"].y -= 32
    fp["fly"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  #@scene.wait(20,true)
end

EliteBattle.defineMoveAnimation(:IONDELUGE_DOWN) do
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  fp["drop"] = Sprite.new(@viewport)
  fp["drop"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_3")
  fp["drop"].ox = fp["drop"].bitmap.width/2
  fp["drop"].oy = fp["drop"].bitmap.height/2
  fp["drop"].y = 0
  fp["drop"].z = 50
  fp["drop"].visible = false
  # start animation
  @vector.set(defaultvector[0], defaultvector[1]+128, defaultvector[2], defaultvector[3], defaultvector[4], defaultvector[5])
  @sprites["battlebg"].defocus
  32.times do
    fp["bg"].opacity += 2
    @scene.wait(1,true)
  end
  @vector.set(vector)
  maxy = ((@targetIsPlayer ? @vector.y : @vector.y2)*0.1).ceil*10 - 80
  fp["drop"].y = -((maxy-(@targetIsPlayer ? @vector.y-80 : @vector.y2-80))*0.1).ceil*10
  fp["drop"].x = @targetSprite.x
  pbSEPlay("Anim/Wind1")
  for i in 0...20
    @scene.wait(1,true)
    if i >= 10
      fp["drop"].visible = true
      fp["drop"].x = @targetSprite.x
      fp["drop"].y += maxy/10
      fp["drop"].zoom_x = @targetSprite.zoom_x
      fp["drop"].zoom_y = @targetSprite.zoom_y*1.4
    end
    fp["bg"].opacity -= 51 if i >= 15
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
  EliteBattle.playMoveAnimation(:TACKLE, @scene, @userIndex, @targetIndex, 0, false, nil, false, true)
end

#===== FILE: IRONHEAD.rb =====#
#-------------------------------------------------------------------------------
#  Iron Head
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:IRONHEAD) do
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  pbSEPlay("EBDX/Anim/iron2",80,80)
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...2
    4.times do
      @userSprite.x += 8*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @userSprite.x -= 2*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @scene.wait
    end
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb024")
    fp["#{i}"].ox = 6
    fp["#{i}"].oy = 6
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  factor = 1
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb520")
  frame.src_rect.set(0,0,114,114)
  frame.ox = 57
  frame.oy = 57
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  # start animation
  for i in 1..30
    if i == 6
      pbSEPlay("EBDX/Anim/iron3",90)
      pbSEPlay("EBDX/Anim/iron1",80)
    end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 114 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...16
      next if i < 6
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      fp["#{j}"].angle += 2
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: IRONTAIL.rb =====#
#-------------------------------------------------------------------------------
#  IRONTAIL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:IRONTAIL) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632_5")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_3")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb024")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  # start animation
  k = 1
  for i in 0...32
	pbSEPlay("EBDX/Anim/iron3",90) if i == 4
    pbSEPlay("EBDX/Anim/iron1",80) if i == 4
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: JUDGMENT.rb =====#
#-------------------------------------------------------------------------------
#  JUDGMENT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:JUDGMENT) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.black)
  fp["bg"].opacity = 0
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  # charging animation
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_2")
    fp["s#{j}"].center!
    r = 64*@userSprite.zoom_x
    x1, y1 = randCircleCord(r)
    fp["s#{j}"].x = cx - r + x1
    fp["s#{j}"].y = cy - r + y1
    fp["s#{j}"].opacity = 0
    z = [1.1,1,0.9,1.2,0.8][rand(5)]
    fp["s#{j}"].zoom_x = z
    fp["s#{j}"].zoom_y = z
    fp["s#{j}"].z = @userSprite.z + 1
  end
  fp["glow"] = Sprite.new(@viewport)
  fp["glow"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_3")
  fp["glow"].center!
  fp["glow"].x = cx
  fp["glow"].y = cy
  fp["glow"].opacity = 0
  fp["glow"].toggle = 1
  for j in 0...2
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_#{5+j}")
    fp["c#{j}"].center!
    fp["c#{j}"].toggle = 1
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].param = 1
    fp["c#{j}"].zoom_x = @userSprite.zoom_x
    fp["c#{j}"].zoom_y = @userSprite.zoom_y
    fp["c#{j}"].z = @userSprite.z + 1
  end
  for j in 0...8
    fp["t#{j}"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb519"))
    fp["t#{j}"].z = @userSprite.z + 1
    r = @viewport.width
    x1, y1 = randCircleCord(r)
    fp["t#{j}"].x = cx - r + x1
    fp["t#{j}"].y = cy - r + y1
    fp["t#{j}"].color = Color.white
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_4")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].color = Color.new(192,56,121,0)
  fp["circle"].param = 0
  fp["circle"].z = @userSprite.z + 2
  fp["circle"].opacity = 0
  fp["ripples"] = Sprite.new(@viewport)
  fp["ripples"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_7_2")
  fp["ripples"].center!
  fp["ripples"].x = cx
  fp["ripples"].y = cy
  fp["ripples"].opacity = 0
  fp["ripples"].zoom_x = @userSprite.zoom_x
  fp["ripples"].zoom_y = @userSprite.zoom_y
  fp["ripples"].color = Color.new(255,255,255,0)
  fp["ripples"].z = @userSprite.z + 2
  pbSEPlay("Anim/Harden")
  for i in 0...148
    pbSEPlay("Anim/Refresh") if i == 16
    pbSEPlay("Anim/Saint8") if i == 68
    for j in 0...8
      next if j > i/4
      fp["s#{j}"].opacity += 48
      fp["s#{j}"].zoom_x -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_x > 0
      fp["s#{j}"].zoom_y -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_y > 0
      fp["s#{j}"].x -= (cx - fp["s#{j}"].x)*0.01
      fp["s#{j}"].y -= (cy - fp["s#{j}"].y)*0.01
    end
    for j in 0...8
      next if i < 16
      next if j > (i-16)/8
      fp["t#{j}"].x -= (fp["t#{j}"].x - cx)*0.1
      fp["t#{j}"].y -= (fp["t#{j}"].y - cy)*0.1
      fp["t#{j}"].color.alpha -= 8
      fp["t#{j}"].update if i < 128
      fp["t#{j}"].visible = false if i == 128
    end
    for j in 0...2
      next if i < 32
      fp["c#{j}"].param -= fp["c#{j}"].toggle*0.0625*(j+1)
      if j == 0
        fp["c#{j}"].zoom_x = fp["c#{j}"].param*@userSprite.zoom_x
      else
        fp["c#{j}"].zoom_y = fp["c#{j}"].param*@userSprite.zoom_y
      end
      fp["c#{j}"].opacity += i < 132 ? 8 : -32
      fp["c#{j}"].toggle *= -1 if fp["c#{j}"].param <= 0 || fp["c#{j}"].param >= 1
      fp["c#{j}"].x = cx
      fp["c#{j}"].y = cy
    end
    if i >= 32
      fp["circle"].zoom_x += 0.03125 if fp["circle"].zoom_x < 1
      fp["circle"].zoom_y += 0.03125 if fp["circle"].zoom_y < 1
      fp["circle"].param = (fp["circle"].param == 0 ? 255 : 0) if i%12 == 0 || i%12 == 4
      fp["circle"].color.alpha = fp["circle"].param if i < 132
      fp["circle"].opacity += 8
      fp["glow"].opacity += i < 132 ? 4 : -32
      fp["glow"].zoom_x -= 0.02*fp["glow"].toggle
      fp["glow"].zoom_y -= 0.02*fp["glow"].toggle
      fp["glow"].toggle *= -1 if i%4 == 0
    end
    pbSEPlay("EBDX/Anim/move2") if i == 132
    pbSEPlay("EBDX/Anim/normal5",80) if i == 132
    # shooting at the target
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 132
    fp["circle"].z = @targetSprite.z + 1 if i == 132
    if i >= 132
      cx, cy = @userSprite.getCenter(true)
      x1, y1 = @targetSprite.getCenter(true)
      fp["ripples"].opacity += i < 140 ? 32 : - 32
      fp["ripples"].zoom_x += 0.1*@userSprite.zoom_x
      fp["ripples"].zoom_y += 0.1*@userSprite.zoom_y
      fp["ripples"].color.alpha += 16
      fp["ripples"].x = cx
      fp["ripples"].y = cy
      fp["circle"].color.alpha = 0
      fp["circle"].zoom_x = @vector.zoom1
      fp["circle"].zoom_y = @vector.zoom1
      fp["circle"].x += (x1 - fp["circle"].x)*0.1
      fp["circle"].y -= (fp["circle"].y - y1)*0.1
      fp["circle"].opacity -= 64 if i >= 144
    end
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/iron4")
  pbSEPlay("EBDX/Anim/iron1")
  # hitting the target
  for j in 0...24
    fp["r2#{j}"] = Sprite.new(@viewport)
    fp["r2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_10")
    fp["r2#{j}"].center!
    fp["r2#{j}"].x = @targetSprite.x - @targetSprite.ox + rand(@targetSprite.bitmap.width)
    fp["r2#{j}"].y = @targetSprite.y - @targetSprite.oy + rand(@targetSprite.bitmap.height)
    fp["r2#{j}"].z = @targetSprite.z + 1 + rand(2)
    fp["r2#{j}"].visible = false
  end
  for j in 0...32
    fp["r#{j}"] = Sprite.new(@viewport)
    b = rand(2)
	if b == 0
		fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_8_2")
	else
		fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_#{8+b}")
	end
    fp["r#{j}"].center!
    fp["r#{j}"].ox /= 2 if b == 0
    fp["r#{j}"].src_rect.set(rand(2)*fp["r#{j}"].bitmap.width/2,0,fp["r#{j}"].bitmap.width/2,fp["r#{j}"].bitmap.height) if b == 0
    fp["r#{j}"].x = x1
    fp["r#{j}"].y = y1
    r = (48 + rand(49))*@targetSprite.zoom_x
    rx, ry = randCircleCord(r)
    fp["r#{j}"].end_x = x1 - r + rx
    fp["r#{j}"].end_y = y1 - r + ry
    fp["r#{j}"].opacity = 0
    fp["r#{j}"].toggle = 2
    fp["r#{j}"].z = @targetSprite.z + 1
    fp["r#{j}"].zoom_x = @targetSprite.zoom_x
    fp["r#{j}"].zoom_y = @targetSprite.zoom_y
    fp["r#{j}"].param = 0
    fp["r#{j}"].speed = rand(15)
  end
  k = 1
  for i in 0...64
    for j in 0...32
      #next if j > i
      fp["r#{j}"].opacity += 16*fp["r#{j}"].toggle
      fp["r#{j}"].toggle = -4 if fp["r#{j}"].param >= 24+fp["r#{j}"].speed
      fp["r#{j}"].x += (fp["r#{j}"].end_x - fp["r#{j}"].x)*0.05
      fp["r#{j}"].y += (fp["r#{j}"].end_y - fp["r#{j}"].y)*0.05
      fp["r#{j}"].zoom_x -= fp["r#{j}"].zoom_x*0.02
      fp["r#{j}"].zoom_y -= fp["r#{j}"].zoom_y*0.02
      fp["r#{j}"].param += 1
    end
    for j in 0...24
      next if i < 8
      next if j > (i-8)/2
      fp["r2#{j}"].visible = true
      fp["r2#{j}"].opacity -= 24
      fp["r2#{j}"].zoom_x -= 0.02
      fp["r2#{j}"].zoom_y -= 0.02
    end
    if i >= 24
      @targetSprite.ox += k*2
      k *= -1 if i%2 == 0
      pbSEPlay("EBDX/Anim/normal2",50) if i%4 == 0
    end
    @targetSprite.still
    @scene.wait
  end
  @vector.reset
  for key in fp.keys
    next if key == "bg"
    fp[key].dispose
  end
  16.times do
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  fp["bg"].dispose
  fp.clear
end

#===== FILE: JUMPKICK.rb =====#
#-------------------------------------------------------------------------------
#  SUBMISSION
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SUBMISSION) do
  EliteBattle.playMoveAnimation(:JUMPKICK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  JUMPKICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:JUMPKICK) do
  EliteBattle.playMoveAnimation(:DOUBLETEAM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_0_2")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...72
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...96
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: LASERFOCUS.rb =====#
#-------------------------------------------------------------------------------
#  LASERFOCUS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LASERFOCUS) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(5,true)
  fp = {}
  cx, cy = @userSprite.getCenter(true)
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #eyes
  fp["l"] = Sprite.new(@viewport)
  fp["l"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_3")
  fp["l"].ox = fp["l"].bitmap.width/2
  fp["l"].oy = fp["l"].bitmap.height/2
  if @userIsPlayer
  # fp["l"].x = cx + @userSprite.width/2 + 50
  # fp["l"].y = cy - @userSprite.height/2 - 5
	# fp["l"].x = 212
    # fp["l"].y = 245
	fp["l"].x = cx + 100
    fp["l"].y = cy - 50
  else 
	# fp["l"].x = 230
    # fp["l"].y = 200	
	fp["l"].x = cx - 65
    fp["l"].y = cy + 58
  end
  fp["l"].opacity = 0
  fp["l"].z = 29#(@userIsPlayer ? 29 : 19)
  fp["r"] = Sprite.new(@viewport)
  fp["r"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_3")
  fp["r"].ox = fp["r"].bitmap.width/2
  fp["r"].oy = fp["r"].bitmap.height/2
  if @userIsPlayer
  # fp["r"].x = cx + @userSprite.width/2 + 90
  # fp["r"].y = cy - @userSprite.height/2 - 5
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  else 
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  end
  fp["r"].opacity = 0
  fp["r"].z = 29#(@userIsPlayer ? 29 : 19)
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...19
    @userSprite.still
	pbSEPlay("Anim/LockOn",80) if i == 5
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
	if i.between?(2,10)
		fp["l"].opacity += 20
		fp["r"].opacity += 20
	end
	if i.between?(11,19)
		fp["l"].opacity -= 20
		fp["r"].opacity -= 20
	end	
	fp["l"].angle += 15
	fp["r"].angle += 15
	if i.between?(2,10)
		if i%2==0
			fp["l"].zoom_x += 1
			fp["l"].zoom_y += 1
			fp["r"].zoom_x += 1
			fp["r"].zoom_y += 1
		end
		fp["l"].tone.red += 10
		fp["l"].tone.green += 10
		fp["l"].tone.blue += 10
		fp["r"].tone.red += 10
		fp["r"].tone.green += 10
		fp["r"].tone.blue += 10
	end
	if i.between?(11,19)
		if i%2==1
			fp["l"].zoom_x -= 1
			fp["l"].zoom_y -= 1
			fp["r"].zoom_x -= 1
			fp["r"].zoom_y -= 1
		end
		fp["l"].tone.red -= 10
		fp["l"].tone.green -= 10
		fp["l"].tone.blue -= 10
		fp["r"].tone.red -= 10
		fp["r"].tone.green -= 10
		fp["r"].tone.blue -= 10
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: LASTRESORT.rb =====#
#-------------------------------------------------------------------------------
#  TRUMPCARD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TRUMPCARD) do
  EliteBattle.playMoveAnimation(:LASTRESORT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  LASTRESORT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LASTRESORT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_9")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_8") #dragondance
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")#keep
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(55,136,255,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12 #keep
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("Anim/psychic3",60) #change
  pbSEPlay("Anim/superdamage",60) #change
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/rock1",80) #change
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_13")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_4")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_11")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("Anim/TakeDownAttack",80) if i == 8 || i == 18 || i == 28 # keep
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: LAVAPLUME.rb =====#
#-------------------------------------------------------------------------------
#  LAVAPLUME
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LAVAPLUME) do
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 8
    @scene.wait(1,true)
  end
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  y0 = @targetSprite.y
  x = [cx - 64*factor, cx + 64*factor, cx]
  y = [y0, y0, y0 + 24*factor]
  dx = []
  for k in 0...3
    fp["f#{k}"] = Sprite.new(@viewport)
    fp["f#{k}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb224")
    fp["f#{k}"].ox = fp["f#{k}"].bitmap.width/2
    fp["f#{k}"].oy = fp["f#{k}"].bitmap.height
    fp["f#{k}"].zoom_x = factor + 0.25
    fp["f#{k}"].zoom_y = 0
    fp["f#{k}"].x = x[k]
    fp["f#{k}"].y = y[k]
    fp["f#{k}"].z = @targetSprite.z
    for m in 0...16
      fp["p#{k}#{m}"] = Sprite.new(@viewport)
      fp["p#{k}#{m}"].bitmap = Bitmap.new(8,8)
      fp["p#{k}#{m}"].ox = 4
      fp["p#{k}#{m}"].oy = 4
      c = [Color.new(139,7,7),Color.new(239,90,1)][rand(2)]
      fp["p#{k}#{m}"].bitmap.bmp_circle(c)
      fp["p#{k}#{m}"].visible = false
      z = [1,0.5,0.75,0.25][rand(4)]
      fp["p#{k}#{m}"].zoom_x = z
      fp["p#{k}#{m}"].zoom_y = z
      fp["p#{k}#{m}"].x = x[k] - 16 + rand(32)
      fp["p#{k}#{m}"].y = y[k] - rand(32)
      fp["p#{k}#{m}"].z = @targetSprite.z + 1
      dx.push((rand(2)==0 ? 1 : -1)*2)
    end
  end
  # start animation
  for k in 0...3
    @scene.wait(8,true)
    j = -1
    l = 6
    pbSEPlay("EBDX/Anim/rock1",80)
    pbSEPlay("Anim/Earth4",50,50)
    for i in 0...24
      j *= -1 if i%4==0
      l -= 2 if i%8==0
      fp["f#{k}"].zoom_x -= 0.1 if fp["f#{k}"].zoom_x > 0
      fp["f#{k}"].zoom_y += 0.3
      fp["f#{k}"].opacity -= 24
      @scene.moveEntireScene(0, j*l, true, true) if i < 16
      for m in 0...16
        next if m>(i*2)
        fp["p#{k}#{m}"].visible = true
        fp["p#{k}#{m}"].y -= 16
        fp["p#{k}#{m}"].x += dx[m]
        fp["p#{k}#{m}"].opacity -= 16
      end
	  @scene.wait
    end
  end
  16.times do
    fp["bg"].opacity -= 8
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: LEAFSTORM.rb =====#
#-------------------------------------------------------------------------------
#  Leaf Storm
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LEAFSTORM) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb191_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = 50
    rndx.push(rand(256)); prndx.push(rand(72))
    rndy.push(rand(256)); prndy.push(rand(72))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 1 : 1.5)*0.5
  fp["cir"].zoom_y = (@targetIsPlayer ? 1 : 1.5)*0.5
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_3")
    fp["#{i}s"].ox = fp["#{i}s"].bitmap.width/2
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height + 8*factor
    fp["#{i}s"].angle = rand(360)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.5 : 1)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.5 : 1)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  k = 0
  # start animation
  @vector.set(vector2)
  @sprites["battlebg"].defocus
  for i in 0...30
    if i < 10
      fp["bg"].opacity += 25.5
    elsif i < 20
      fp["bg"].color.alpha -= 25.5
    else
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 16*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 25.5
      fp["cir"].zoom_x += (@targetIsPlayer ? 1 : 1.5)*0.05
      fp["cir"].zoom_y += (@targetIsPlayer ? 1 : 1.5)*0.05
      k += 1 if i%4==0; k = 0 if k > 1
      fp["cir"].tone = [Tone.new(0,0,0),Tone.new(155,155,155)][k]
    end
    pbSEPlay("EBDX/Anim/grass2") if i == 20
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/wind1",90)
  for i in 0...96
    pbSEPlay("EBDX/Anim/grass1",60) if i%3==0 && i < 64
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += rangl[j]*2
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].opacity -= 51 if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 51 if nextx < cx && nexty > cy
      end
    end
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 16*(@userIsPlayer ? -1 : 1)
    fp["cir"].opacity -= (i>=72) ? 51 : 2
    k += 1 if i%4==0; k = 0 if k > 1
    fp["cir"].tone = [Tone.new(0,0,0),Tone.new(155,155,155)][k]
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].oy +=6*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = @userSprite.getCenter
    end
    #pbSEPlay("Anim/Comet Punch") if i == 64
    fp["bg"].update
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: LEAFTORNADO.rb =====#
#-------------------------------------------------------------------------------
#  LEAFTORNADO
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LEAFTORNADO) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(103,164,115))
  fp["bg"].opacity = 0
  fp["wave"] = AnimatedPlane.new(@viewport)
  fp["wave"].bitmap = Bitmap.new(1026,@viewport.height)
  fp["wave"].bitmap.stretch_blt(Rect.new(0,0,fp["wave"].bitmap.width,fp["wave"].bitmap.height),pbBitmap("Graphics/EBDX/Animations/Moves/eb132_4"),Rect.new(0,0,1026,212))
  fp["wave"].opacity = 0
  fp["wave"].z = 50
  rndx = []
  rndy = []
  numElements = 9
  for i in 0...numElements
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb637_2")
    fp["#{i}"].src_rect.set(0,128*rand(3),64,128)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  @vector.inc = 0.1
  pulse = 10
  shake = [4,4,4,4]
  # start animation
  for j in 0...80#64
    pbSEPlay("Anim/Wind8") if j == 24
    fp["wave"].ox += 48
    fp["wave"].opacity += pulse
    pulse = -5 if fp["wave"].opacity > 160
    pulse = +5 if fp["wave"].opacity < 100
    fp["bg"].opacity += 1 if fp["bg"].opacity < 255*0.35
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
      @sprites["pokemon_#{i}"].tone.all += 3 if j.between?(16,48)
      if j >= 32
        @sprites["pokemon_#{i}"].ox += shake[i]
        shake[i] = -4 if @sprites["pokemon_#{i}"].ox > @sprites["pokemon_#{i}"].bitmap.width/2 + 2
        shake[i] = 4 if @sprites["pokemon_#{i}"].ox < @sprites["pokemon_#{i}"].bitmap.width/2 - 2
      end
    end
	ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
	for i in 0...numElements
      if fp["#{i}"].opacity == 0 && fp["#{i}"].tone.gray == 0
        fp["#{i}"].zoom_x = @userSprite.zoom_x
        fp["#{i}"].zoom_y = @userSprite.zoom_y
        fp["#{i}"].x = ax
        fp["#{i}"].y = ay + 50*@userSprite.zoom_y
      end
      next if i>(j/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[i]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[i]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{i}"].x
      y0 = fp["#{i}"].y
      fp["#{i}"].x += (x2 - x0)*0.1
      fp["#{i}"].y += (y2 - y0)*0.1
      fp["#{i}"].zoom_x -= (fp["#{i}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{i}"].zoom_y -= (fp["#{i}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{i}"].src_rect.x += 64 if i%4==0
      fp["#{i}"].src_rect.x = 0 if fp["#{i}"].src_rect.x >= fp["#{i}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{i}"].opacity -= 8
        fp["#{i}"].tone.gray += 8
        fp["#{i}"].zoom_x -= 0.02
        fp["#{i}"].zoom_y += 0.04
      else
        fp["#{i}"].opacity += 3
      end
    end
    pbSEPlay("Anim/Wind8",80) if j%24==0 && j <= 60
    @sprites["pokemon_#{@userIndex}"].tone.all += 3 if j < 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  for i in 0...4
    next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
    next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
    @sprites["pokemon_#{i}"].ox = @sprites["pokemon_#{i}"].bitmap.width/2
  end
  for j in 0...64
    fp["wave"].ox += 48
    if j < 32
      fp["wave"].opacity += pulse
      pulse = -5 if fp["wave"].opacity > 160
      pulse = +5 if fp["wave"].opacity < 100
    end
    fp["wave"].opacity -= 4 if j >= 32
    fp["bg"].opacity -= 4 if j >= 32
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible)
      @sprites["pokemon_#{i}"].tone.all -= 3 if j >= 32
    end
    @sprites["pokemon_#{@userIndex}"].tone.all -= 3 if j >= 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: LEECHLIFE.rb =====#
#-------------------------------------------------------------------------------
#  LEECHLIFE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LEECHLIFE) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(66,60,81))
  fp["bg"].opacity = 0
  fp["fang1"] = Sprite.new(@viewport)
  fp["fang1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang1"].ox = fp["fang1"].bitmap.width/2
  fp["fang1"].oy = fp["fang1"].bitmap.height - 20
  fp["fang1"].opacity = 0
  fp["fang1"].z = 41
  fp["fang2"] = Sprite.new(@viewport)
  fp["fang2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang2"].ox = fp["fang1"].bitmap.width/2
  fp["fang2"].oy = fp["fang1"].bitmap.height - 20
  fp["fang2"].opacity = 0
  fp["fang2"].z = 40
  fp["fang2"].angle = 180
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["fang1"].x = cx; fp["fang1"].y = cy
    fp["fang1"].zoom_x = @targetSprite.zoom_x * 0.5; fp["fang1"].zoom_y = @targetSprite.zoom_y * 0.5
    fp["fang2"].x = cx; fp["fang2"].y = cy
    fp["fang2"].zoom_x = @targetSprite.zoom_x * 0.5; fp["fang2"].zoom_y = @targetSprite.zoom_y * 0.5
    if i.between?(20,29)
      fp["fang1"].opacity += 5
      fp["fang1"].oy += 2
      fp["fang2"].opacity += 5
      fp["fang2"].oy += 2
    elsif i.between?(30,40)
      fp["fang1"].opacity += 25.5
      fp["fang1"].oy -= 4
      fp["fang2"].opacity += 25.5
      fp["fang2"].oy -= 4
    else
      fp["fang1"].opacity -= 26
      fp["fang1"].oy += 2
      fp["fang2"].opacity -= 26
      fp["fang2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Bite")
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
     #fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  EliteBattle.playMoveAnimation(:ABSORB, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  pbDisposeSpriteHash(fp)
end

#===== FILE: LEECHSEED.rb =====#
#-------------------------------------------------------------------------------
#  WORRYSEED
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WORRYSEED) do
  EliteBattle.playMoveAnimation(:LEECHSEED, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  LEECHSEED
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LEECHSEED) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["seed"] = Sprite.new(@viewport)
  fp["seed"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb223")
  fp["seed"].z = @targetSprite.z + 1
  fp["seed"].opacity = 0
  timeFactor = 40
  # shooting out the seed
  for i in 0...timeFactor
	pbSEPlay("EBDX/Anim/poison1") if i == 0
	fp["seed"].opacity += 50 if fp["seed"].opacity < 250
	fp["seed"].ox = fp["seed"].bitmap.width/2
    fp["seed"].oy = fp["seed"].bitmap.height/2
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,timeFactor)
    fp["seed"].x = points[i][0]
    fp["seed"].y = points[i][1]
    z = 1 + (1-(fp["seed"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["seed"].zoom_x = z
    fp["seed"].zoom_y = z
	fp["seed"].angle += 30
    fp["seed"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("EBDX/Anim/poison1")
  fp["seed"].dispose
  EliteBattle.playMoveAnimation(:INGRAIN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  # zooming onto the target
  5.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  @scene.wait(10,true)
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: LEER.rb =====#
#-------------------------------------------------------------------------------
#  ODORSLEUTH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ODORSLEUTH) do
  EliteBattle.playMoveAnimation(:LEER, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  LEER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LEER) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(5,true)
  fp = {}
  cx, cy = @userSprite.getCenter(true)
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #eyes
  fp["l"] = Sprite.new(@viewport)
  fp["l"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619")
  fp["l"].ox = fp["l"].bitmap.width/2
  fp["l"].oy = fp["l"].bitmap.height/2
  if @userIsPlayer
	# fp["l"].x = 212
    # fp["l"].y = 245
	fp["l"].x = cx + 100
    fp["l"].y = cy - 50
  else 
	# fp["l"].x = 230
    # fp["l"].y = 200	
	fp["l"].x = cx - 65
    fp["l"].y = cy + 58
  end
  fp["l"].opacity = 0
  fp["l"].z = 29#(@userIsPlayer ? 29 : 19)
  fp["r"] = Sprite.new(@viewport)
  fp["r"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619")
  fp["r"].ox = fp["r"].bitmap.width/2
  fp["r"].oy = fp["r"].bitmap.height/2
  if @userIsPlayer
  # fp["r"].x = cx + @userSprite.width/2 + 90
  # fp["r"].y = cy - @userSprite.height/2 - 5
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  else 
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  end
  fp["r"].opacity = 0
  fp["r"].z = 29#(@userIsPlayer ? 29 : 19)
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...19
	pbSEPlay("Anim/Leer",80) if i == 5
    @userSprite.still
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
	if i.between?(2,10)
		fp["l"].opacity += 20
		fp["r"].opacity += 20
	end
	if i.between?(11,19)
		fp["l"].opacity -= 20
		fp["r"].opacity -= 20
	end	
	fp["l"].angle += 15
	fp["r"].angle += 15
	if i.between?(2,10)
		if i%2==0
			fp["l"].zoom_x += 1
			fp["l"].zoom_y += 1
			fp["r"].zoom_x += 1
			fp["r"].zoom_y += 1
		end
		fp["l"].tone.red += 10
		fp["l"].tone.green += 10
		fp["l"].tone.blue += 10
		fp["r"].tone.red += 10
		fp["r"].tone.green += 10
		fp["r"].tone.blue += 10
	end
	if i.between?(11,19)
		if i%2==1
			fp["l"].zoom_x -= 1
			fp["l"].zoom_y -= 1
			fp["r"].zoom_x -= 1
			fp["r"].zoom_y -= 1
		end
		fp["l"].tone.red -= 10
		fp["l"].tone.green -= 10
		fp["l"].tone.blue -= 10
		fp["r"].tone.red -= 10
		fp["r"].tone.green -= 10
		fp["r"].tone.blue -= 10
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: LICK.rb =====#
#-------------------------------------------------------------------------------
#  LICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LICK) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632_4")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_4")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_3")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  # start animation
  k = 1
  for i in 0...32
    pbSEPlay("EBDX/Anim/normal4",80) if i == 4
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: LIGHTSCREEN.rb =====#
#-------------------------------------------------------------------------------
#  LIGHTSCREEN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LIGHTSCREEN) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb603")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @targetIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 5
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
    if i.between?(7,11)
      #@targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: LIQUIDATION.rb =====#
#-------------------------------------------------------------------------------
#  SOAK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SOAK) do
  EliteBattle.playMoveAnimation(:LIQUIDATION, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  LIQUIDATION
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LIQUIDATION) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  for j in 0...32
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = Bitmap.new(8,8)
    fp["s#{j}"].bitmap.bmp_circle(Color.new(25,75,183))
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    fp["s#{j}"].x = cx
    fp["s#{j}"].y = cy
    fp["s#{j}"].z = @targetSprite.z
    fp["s#{j}"].angle = rand(360)
    fp["s#{j}"].visible = false
  end
  for j in 0...16
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb430_2")
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].angle = rand(360)
    fp["#{j}"].ox = - 80*factor
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @targetSprite.z + 1
    fp["#{j}"].opacity = 0
  end
  # play animation
  for i in 0...48
    for j in 0...16
      next if j>i
      fp["#{j}"].opacity += 32
      fp["#{j}"].ox += (80*factor/8).ceil
      fp["#{j}"].visible = false if fp["#{j}"].ox >= 0
    end
    for j in 0...32
      next if j>i*2
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].oy += 16
    end
    @targetSprite.zoom_y = factor + 0.32 if i%6 == 0 && i < 32
    @targetSprite.zoom_y -= 0.08 if @targetSprite.zoom_y > factor
    pbSEPlay("Anim/Water1",80) if i%6==0 && i < 32
    pbSEPlay("Anim/Bubble2",80) if i%4==0 && i < 32
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: LOCKON.rb =====#
#-------------------------------------------------------------------------------
#  LOCKON
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LOCKON) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(5,true)
  fp = {}
  cx, cy = @userSprite.getCenter(true)
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #eyes
  fp["l"] = Sprite.new(@viewport)
  fp["l"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_2")
  fp["l"].ox = fp["l"].bitmap.width/2
  fp["l"].oy = fp["l"].bitmap.height/2
  if @userIsPlayer
  # fp["l"].x = cx + @userSprite.width/2 + 50
  # fp["l"].y = cy - @userSprite.height/2 - 5
	# fp["l"].x = 212
    # fp["l"].y = 245
	fp["l"].x = cx + 100
    fp["l"].y = cy - 50
  else 
	# fp["l"].x = 230
    # fp["l"].y = 200	
	fp["l"].x = cx - 65
    fp["l"].y = cy + 58
  end
  fp["l"].opacity = 0
  fp["l"].z = 29#(@userIsPlayer ? 29 : 19)
  fp["r"] = Sprite.new(@viewport)
  fp["r"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_2")
  fp["r"].ox = fp["r"].bitmap.width/2
  fp["r"].oy = fp["r"].bitmap.height/2
  if @userIsPlayer
  # fp["r"].x = cx + @userSprite.width/2 + 90
  # fp["r"].y = cy - @userSprite.height/2 - 5
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  else 
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  end
  fp["r"].opacity = 0
  fp["r"].z = 29#(@userIsPlayer ? 29 : 19)
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...19
    @userSprite.still
	pbSEPlay("Anim/LockOn",80) if i == 5
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
	if i.between?(2,10)
		fp["l"].opacity += 20
		fp["r"].opacity += 20
	end
	if i.between?(11,19)
		fp["l"].opacity -= 20
		fp["r"].opacity -= 20
	end	
	fp["l"].angle += 15
	fp["r"].angle += 15
	if i.between?(2,10)
		if i%2==0
			fp["l"].zoom_x += 1
			fp["l"].zoom_y += 1
			fp["r"].zoom_x += 1
			fp["r"].zoom_y += 1
		end
		fp["l"].tone.red += 10
		fp["l"].tone.green += 10
		fp["l"].tone.blue += 10
		fp["r"].tone.red += 10
		fp["r"].tone.green += 10
		fp["r"].tone.blue += 10
	end
	if i.between?(11,19)
		if i%2==1
			fp["l"].zoom_x -= 1
			fp["l"].zoom_y -= 1
			fp["r"].zoom_x -= 1
			fp["r"].zoom_y -= 1
		end
		fp["l"].tone.red -= 10
		fp["l"].tone.green -= 10
		fp["l"].tone.blue -= 10
		fp["r"].tone.red -= 10
		fp["r"].tone.green -= 10
		fp["r"].tone.blue -= 10
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: LUCKYCHANT.rb =====#
#-------------------------------------------------------------------------------
#  LUCKYCHANT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LUCKYCHANT) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(204,229,255))
  fp["bg"].opacity = 0
  #
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: LUSTERPURGE.rb =====#
#-------------------------------------------------------------------------------
#  LUSTERPURGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LUSTERPURGE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_6")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_8")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_1") #dragondance
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")#keep
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(225,255,255,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12 #keep
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("EBDX/Anim/psychic3",60) #change
  pbSEPlay("Anim/Psych Up",60) #change
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/psychic4",80) #change
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_10")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_9")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_8")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/normal2",80) if i == 8 || i == 16 || i == 24 # keep
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MACHPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  MACHPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MACHPUNCH) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/move1",80) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MAGICALLEAF.rb =====#
#-------------------------------------------------------------------------------
#  MAGICALLEAF
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MAGICALLEAF) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  for i in 0...128
	rndLeaf = rand(2)
    fp["#{i}"] = Sprite.new(@viewport)
	if rndLeaf == 1
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_2")
	else
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_4")	
	end
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = 50
    rndx.push(rand(256)); prndx.push(rand(72))
    rndy.push(rand(256)); prndy.push(rand(72))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 1 : 1.5)*0.5
  fp["cir"].zoom_y = (@targetIsPlayer ? 1 : 1.5)*0.5
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_3")
    fp["#{i}s"].ox = fp["#{i}s"].bitmap.width/2
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height + 8*factor
    fp["#{i}s"].angle = rand(360)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.5 : 1)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.5 : 1)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  k = 0
  # start animation
  @vector.set(vector2)
  @sprites["battlebg"].defocus
  for i in 0...30
    if i < 10
      #fp["bg"].opacity += 25.5
    elsif i < 20
      #fp["bg"].color.alpha -= 25.5
    else
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 16*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 25.5
      fp["cir"].zoom_x += (@targetIsPlayer ? 1 : 1.5)*0.05
      fp["cir"].zoom_y += (@targetIsPlayer ? 1 : 1.5)*0.05
      k += 1 if i%4==0; k = 0 if k > 1
      fp["cir"].tone = [Tone.new(0,0,0),Tone.new(155,155,155)][k]
    end
    pbSEPlay("EBDX/Anim/grass2") if i == 20
    #fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/wind1",90)
  for i in 0...96
    pbSEPlay("EBDX/Anim/grass1",60) if i%3==0 && i < 64
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += rangl[j]*2
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].opacity -= 51 if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 51 if nextx < cx && nexty > cy
      end
    end
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 16*(@userIsPlayer ? -1 : 1)
    fp["cir"].opacity -= (i>=72) ? 51 : 2
    k += 1 if i%4==0; k = 0 if k > 1
    fp["cir"].tone = [Tone.new(0,0,0),Tone.new(155,155,155)][k]
    if i >= 64 
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].oy +=6*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = @userSprite.getCenter
    end
    #pbSEPlay("Anim/Comet Punch") if i == 64
    #fp["bg"].update
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: MAGICCOAT.rb =====#
#-------------------------------------------------------------------------------
#  MAGICCOAT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MAGICCOAT) do
  factor = @userSprite.zoom_x
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(10,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb607")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @userIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @userSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 5
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
    @scene.wait(1,true)				
    if i.between?(7,11)
      #@targetSprite.still
      @userSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: MAGNETBOMB.rb =====#
#-------------------------------------------------------------------------------
#  Magnet Bomb
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MAGNETBOMB) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}
  dx = []
  dy = []
  cx, cy = @targetSprite.getCenter(true)
  for j in 0..16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb523")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height/2
    r = 72*factor
    fp["i#{j}"].x = cx - r + rand(r*2)
    fp["i#{j}"].y = cy - r*1.5 + rand(r*2)
    fp["i#{j}"].z = @targetSprite.z + (rand(2)==0 ? 1 : -1)
    fp["i#{j}"].zoom_x = factor
    fp["i#{j}"].zoom_y = factor
    fp["i#{j}"].opacity = 0
    dx.push(rand(2)==0 ? 1 : -1)
    dy.push(rand(2)==0 ? 1 : -1)
  end
  for m in 0...12
    fp["d#{m}"] = Sprite.new(@viewport)
    fp["d#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb523_2")
    fp["d#{m}"].src_rect.set(0,0,80,78)
    fp["d#{m}"].ox = fp["d#{m}"].src_rect.width/2
    fp["d#{m}"].oy = fp["d#{m}"].src_rect.height/2
    r = 32*factor
    fp["d#{m}"].x = cx - r + rand(r*2)
    fp["d#{m}"].y = cy - r + rand(r*2)
    fp["d#{m}"].z = @targetSprite.z + 1
    fp["d#{m}"].opacity = 0
    fp["d#{m}"].angle = rand(360)
  end
  for m in 0...12
    fp["s#{m}"] = Sprite.new(@viewport)
    fp["s#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb523_2")
    fp["s#{m}"].src_rect.set(80,0,80,78)
    fp["s#{m}"].ox = fp["s#{m}"].src_rect.width/2
    fp["s#{m}"].oy = fp["s#{m}"].src_rect.height/2
    r = 32*factor
    fp["s#{m}"].x = fp["d#{m}"].x
    fp["s#{m}"].y = fp["d#{m}"].y
    fp["s#{m}"].z = @targetSprite.z + 1
    fp["s#{m}"].opacity = 0
    fp["s#{m}"].angle = fp["d#{m}"].angle
  end
  pbSEPlay("EBDX/Anim/iron4",100)
  for i in 0...48
    k = (i-16)/4
    pbSEPlay("EBDX/Anim/psychic4",80-20*k) if i >= 16 && i%4==0 && i < 28
    for j in 0...16
      next if j>(i/2)
      t = fp["i#{j}"].tone.red
      t += 32 if i%4==0
      t = 0 if t > 96
      fp["i#{j}"].tone = Tone.new(t,t,t)
      fp["i#{j}"].opacity += 16
      fp["i#{j}"].angle += dx[j]
    end
    @scene.wait
  end
  for i in 0...64
    pbSEPlay("EBDX/Anim/normal1",80) if i >= 2 && i%4==0 && i < 26
    for j in 0...16
      next if j>(i)
      fp["i#{j}"].x += (cx - fp["i#{j}"].x)*0.5
      fp["i#{j}"].y += (cy - fp["i#{j}"].y)*0.5
      fp["i#{j}"].angle += dx[j]
      fp["i#{j}"].visible = (cx - fp["i#{j}"].x)*0.5 >= 1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)/2
      fp["d#{m}"].opacity += 32*(fp["d#{m}"].zoom_x < 1.5 ? 1 : -1)
      fp["d#{m}"].zoom_x += 0.05
      fp["d#{m}"].zoom_y += 0.05
      fp["d#{m}"].angle += 4
      fp["s#{m}"].opacity += 32*(fp["s#{m}"].zoom_x < 1.5 ? 1 : -1)
      fp["s#{m}"].zoom_x += 0.05
      fp["s#{m}"].zoom_y += 0.05
      fp["s#{m}"].angle += 4
    end
    @targetSprite.still
    @scene.wait
  end
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: MAGNETRISE.rb =====#
#-------------------------------------------------------------------------------
#  MAGNETICFLUX
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MAGNETICFLUX) do
  EliteBattle.playMoveAnimation(:MAGNETRISE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  TAILGLOW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TAILGLOW) do
  EliteBattle.playMoveAnimation(:MAGNETRISE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  MAGNETRISE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MAGNETRISE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_6")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,255,102,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MEANLOOK.rb =====#
#-------------------------------------------------------------------------------
#  MEANLOOK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MEANLOOK) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(5,true)
  fp = {}
  cx, cy = @userSprite.getCenter(true)
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #eyes
  fp["l"] = Sprite.new(@viewport)
  fp["l"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_5")
  fp["l"].ox = fp["l"].bitmap.width/2
  fp["l"].oy = fp["l"].bitmap.height/2
  if @userIsPlayer
  # fp["l"].x = cx + @userSprite.width/2 + 50
  # fp["l"].y = cy - @userSprite.height/2 - 5
	# fp["l"].x = 212
    # fp["l"].y = 245
	fp["l"].x = cx + 100
    fp["l"].y = cy - 50
  else 
	# fp["l"].x = 230
    # fp["l"].y = 200	
	fp["l"].x = cx - 65
    fp["l"].y = cy + 58
  end
  fp["l"].opacity = 0
  fp["l"].z = 29#(@userIsPlayer ? 29 : 19)
  fp["r"] = Sprite.new(@viewport)
  fp["r"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_5")
  fp["r"].ox = fp["r"].bitmap.width/2
  fp["r"].oy = fp["r"].bitmap.height/2
  if @userIsPlayer
  # fp["r"].x = cx + @userSprite.width/2 + 90
  # fp["r"].y = cy - @userSprite.height/2 - 5
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  else 
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  end
  fp["r"].opacity = 0
  fp["r"].z = 29#(@userIsPlayer ? 29 : 19)
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 20
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...19
    @userSprite.still
	pbSEPlay("Anim/ScaryFace",80) if i == 5
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
	if i.between?(2,10)
		fp["l"].opacity += 20
		fp["r"].opacity += 20
	end
	if i.between?(11,19)
		fp["l"].opacity -= 20
		fp["r"].opacity -= 20
	end	
	fp["l"].angle += 15
	fp["r"].angle += 15
	if i.between?(2,10)
		if i%2==0
			fp["l"].zoom_x += 1
			fp["l"].zoom_y += 1
			fp["r"].zoom_x += 1
			fp["r"].zoom_y += 1
		end
		fp["l"].tone.red += 10
		fp["l"].tone.green += 10
		fp["l"].tone.blue += 10
		fp["r"].tone.red += 10
		fp["r"].tone.green += 10
		fp["r"].tone.blue += 10
	end
	if i.between?(11,19)
		if i%2==1
			fp["l"].zoom_x -= 1
			fp["l"].zoom_y -= 1
			fp["r"].zoom_x -= 1
			fp["r"].zoom_y -= 1
		end
		fp["l"].tone.red -= 10
		fp["l"].tone.green -= 10
		fp["l"].tone.blue -= 10
		fp["r"].tone.red -= 10
		fp["r"].tone.green -= 10
		fp["r"].tone.blue -= 10
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MEDITATE.rb =====#
#-------------------------------------------------------------------------------
#  QUIVERDANCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:QUIVERDANCE) do | args |
  EliteBattle.playMoveAnimation(:CALMMIND, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MEDITATE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MEDITATE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_3")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(204,0,204,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MEGAHORN.rb =====#
#-------------------------------------------------------------------------------
#  MEGAHORN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MEGAHORN) do | args |
  factor = @targetSprite.zoom_x
  factorHorn = @userIsPlayer ? 1.9 : 2.5
  hornXMove = @userIsPlayer ? 2 : -2
  hornYMove = @userIsPlayer ? 10 : -10
  hornXOffset = @userIsPlayer ? 60 : -120
  hornYOffset = @userIsPlayer ? 60 : -120
  hornMoveHit = @userIsPlayer ? 5 : -5
  hornAngle = @userIsPlayer ? 0 : 180
  userOX = @userSprite.ox
  targetOX = @targetSprite.ox
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_3")
  #fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_3")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  # phase 1
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  # user move
  for i in 0...30
    @userSprite.still
	#default movement
    if i.between?(0,20)
		@userSprite.ox += hornXMove
	else
		@userSprite.ox -= hornYMove
    end
    @scene.wait(1,true)
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(7,true)
  8.times do
    fp["bg"].opacity += 24
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/iron2",80)
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_0_3")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  fp["horn"] = Sprite.new(@viewport)
  fp["horn"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626")
  fp["horn"].ox = fp["horn"].bitmap.width/2
  fp["horn"].oy = fp["horn"].bitmap.height/2
  fp["horn"].x, fp["horn"].y = @targetSprite.getCenter(true)
  fp["horn"].x -= hornXOffset
  fp["horn"].y += hornYOffset
  fp["horn"].opacity = 0
  fp["horn"].zoom = factorHorn
  fp["horn"].angle = hornAngle
  fp["horn"].z = 41
  # horn attack
  for i in 1..30
	if i.between?(1,15)
		fp["horn"].opacity += 20
		fp["horn"].x += hornMoveHit 
		fp["horn"].y -= hornMoveHit
		@targetSprite.ox += 10 if i%2 == 0
		@targetSprite.ox -= 10 if i%2 == 1
	else
		fp["horn"].opacity -= 20
		@targetSprite.ox = targetOX
	end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  @targetSprite.ox = targetOX
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: MEGAKICK.rb =====#
#-------------------------------------------------------------------------------
#  MEGAKICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MEGAKICK) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_3")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_0_2")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...72
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...96
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: MEGAPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  MEGAPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MEGAPUNCH) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_3")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...72
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...96
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: MEMENTO.rb =====#
#-------------------------------------------------------------------------------
#  MEMENTO
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MEMENTO) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_8")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_14")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_7") #dragondance
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")#keep
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(38,38,38,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12 #keep
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("Anim/Darkness6",60) #change
  pbSEPlay("Anim/Psych Up",60) #change
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Explosion4",80) #change
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_16")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_11")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_14")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("Anim/Explosion1",80) if i == 8 || i == 16 || i == 24 # keep
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: METALCLAW.rb =====#
#-------------------------------------------------------------------------------
#  Metal Claw
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:METALCLAW) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  @userSprite.oy = oy
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp["claw1"] = Sprite.new(@viewport)
  fp["claw1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_3")
  fp["claw1"].src_rect.set(-82,0,82,174)
  fp["claw1"].ox = fp["claw1"].src_rect.width
  fp["claw1"].oy = fp["claw1"].src_rect.height/2
  fp["claw1"].x = cx - 32*@targetSprite.zoom_x
  fp["claw1"].y = cy
  fp["claw1"].z = @targetIsPlayer ? 29 : 19
  fp["claw2"] = Sprite.new(@viewport)
  fp["claw2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_3")
  fp["claw2"].src_rect.set(-82,0,82,174)
  fp["claw2"].ox = 0
  fp["claw2"].oy = fp["claw2"].src_rect.height/2
  fp["claw2"].x = cx + 32*@targetSprite.zoom_x
  fp["claw2"].y = cy
  fp["claw2"].z = @targetIsPlayer ? 29 : 19
  fp["claw2"].mirror = true
  shake = 4
  for i in 0...32
    @targetSprite.still
    pbSEPlay("EBDX/Anim/iron5") if i == 4 || i == 16
    for j in 1..2
      next if (j-1)>(i/12)
      fp["claw#{j}"].src_rect.x += 82 if fp["claw#{j}"].src_rect.x < 82*3 && i%2==0
    end
    fp["claw1"].visible = false if i == 16
    fp["claw2"].visible = false if i == 32
    if i.between?(4,12) || i.between?(20,28)
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: METALSOUND.rb =====#
#-------------------------------------------------------------------------------
#  METALSOUND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:METALSOUND) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_1")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: METEORMASH.rb =====#
#-------------------------------------------------------------------------------
#  METEORMASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:METEORMASH) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_7")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_11")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_1") #dragondance
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")#keep
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(225,255,255,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12 #keep
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("EBDX/Anim/iron4",60) #change
  #pbSEPlay("Anim/Psych Up",60) #change
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  #pbSEPlay("EBDX/Anim/psychic4",80) #change
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_13")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_4")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_11")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/iron1",80) if i == 8 || i == 16 || i == 24 # keep
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MIRRORCOAT.rb =====#
#-------------------------------------------------------------------------------
#  MIRRORCOAT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MIRRORCOAT) do
  factor = @userSprite.zoom_x
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(8,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb607")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @userIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      #@targetSprite.zoom_y-=0.05*factor
      @userSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 10
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
	@scene.wait(1,true)
    if i.between?(7,11)
      #@targetSprite.still
      @userSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: MIST.rb =====#
#-------------------------------------------------------------------------------
#  MIST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MIST) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_9")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(245,245,245,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MISTBALL.rb =====#
#-------------------------------------------------------------------------------
#  MISTBALL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MISTBALL) do
  x1, y1 = @targetSprite.getCenter(true)
  x2, y2 = @userSprite.getCenter(true)
  if @targetIsPlayer
    cx = x1 + (x2 - x1)*0.65
    cy = y1 - (y1 - y2)*0.65
  else
    cx = x2 + (x1 - x2)*0.5
    cy = y2 - (y2 - y1)*0.5
  end
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.white)
  fp["bg"].opacity = 0
  #
  for j in 0...16
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb630_2")
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].opacity = 0
    fp["p#{j}"].z = 20
  end
  for j in 0...32
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb630_1")
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].angle = rand(360)
    fp["c#{j}"].ox = 12
    fp["c#{j}"].oy = 18 + rand(24)
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].z = 20
    fp["c#{j}"].color = Color.new(123,64,89,0)
    fp["c#{j}"].toggle = 1
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb630")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].z = 20
  pbSEPlay("Anim/Heal4")
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...64
    pbSEPlay("EBDX/Anim/psychic4") if i%16 == 0
    fp["circle"].zoom_x += 0.125 if fp["circle"].zoom_x < 1
    fp["circle"].zoom_y += 0.125 if fp["circle"].zoom_y < 1
    fp["circle"].angle += 8
    for j in 0...16
      next if j > i/4
      if fp["p#{j}"].ox >= -16
        fp["p#{j}"].ox = -128
        fp["p#{j}"].angle = rand(360)
        fp["p#{j}"].opacity = 0
      end
      fp["p#{j}"].opacity += 32
      fp["p#{j}"].ox += 16
    end
    for j in 0...32
      fp["c#{j}"].toggle *= -1 if i%4==0
      next if j > i/2
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].color.alpha = 255*fp["c#{j}"].toggle
    end
    @scene.wait
  end
  pbSEPlay("EBDX/Anim/psychic4")
  for key in fp.keys
    next if key == "circle" || key == "bg"
    fp[key].dispose
    fp.delete(key)
  end
  fp["circle2"] = Sprite.new(@viewport)
  fp["circle2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb630_3")
  fp["circle2"].center!
  fp["circle2"].x = cx
  fp["circle2"].y = cy
  fp["circle2"].z = fp["circle"].z - 1
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  16.times do
    fp["circle2"].zoom_x = @vector.zoom1
    fp["circle2"].zoom_y = @vector.zoom1
    fp["circle"].zoom_x = @vector.zoom1
    fp["circle"].zoom_y = @vector.zoom1
    x1, y1 = @targetSprite.getCenter(true)
    x2, y2 = @userSprite.getCenter(true)
    if @targetIsPlayer
      cx = x1 + (x2 - x1)*0.65
      cy = y1 - (y1 - y2)*0.65
    else
      cx = x2 + (x1 - x2)*0.5
      cy = y2 - (y2 - y1)*0.5
    end
    fp["circle2"].x = cx
    fp["circle2"].y = cy
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].angle += 8
    @scene.wait(1,true)
  end
  fp["circle"].visible = false
  fp["circle2"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/psychic3")
  8.times do
    fp["circle2"].x += (x1 - fp["circle2"].x)*0.5
    fp["circle2"].y -= (fp["circle2"].y - y1)*0.5
    @scene.wait
  end
  fp["circle2"].visible = false
  @targetSprite.anim = true
  @targetSprite.color = Color.new(122,71,109)
  2.times do
    @targetSprite.anim = true
    @scene.wait
  end
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb630_4")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height
    fp["i#{j}"].angle = rand(360)
    fp["i#{j}"].z = @targetSprite.z + 1
    fp["i#{j}"].x = x1
    fp["i#{j}"].y = y1
  end
  for i in 0...32
    for j in 0...16
      next if j > i
      fp["i#{j}"].opacity -= 16
      fp["i#{j}"].oy += 8
    end
    @targetSprite.color.alpha -= 16
    @targetSprite.anim = true
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: MISTYTERRAIN.rb =====#
#-------------------------------------------------------------------------------
#  MISTYTERRAIN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MISTYTERRAIN) do | args |
  beam, strike = *args; beam = false if beam.nil?; strike = false if strike.nil?
  factor = 2
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.white)
  fp["bg"].opacity = 0
  @userSprite.color = Color.new(218,52,146,0) if strike
  rndx = []
  rndy = []
  for i in 0...8
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb646_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  for i in 0...16
    fp["c#{i}"] = Sprite.new(@viewport)
    fp["c#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb646")
    fp["c#{i}"].ox = fp["c#{i}"].bitmap.width/2
    fp["c#{i}"].oy = fp["c#{i}"].bitmap.height/2
    fp["c#{i}"].opacity = 0
    fp["c#{i}"].z = 51
    rndx.push(0)
    rndy.push(0)
  end
  m = 0
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb646_3")
  fp["circle"].ox = fp["circle"].bitmap.width/4
  fp["circle"].oy = fp["circle"].bitmap.height/2
  fp["circle"].opacity = 0
  fp["circle"].src_rect.set(0,0,484,488)
  fp["circle"].z = 50
  fp["circle"].zoom_x = 0.5
  fp["circle"].zoom_y = 0.5
  # start animation
  #@vector.set(@scene.getRealVector(@userIndex, !@targetIsPlayer))
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...120
    pbSEPlay("Anim/Saint6",[i+10, 100].max) if i%14 == 0
    pbSEPlay("Anim/Saint8") if i == 64
    cx, cy = @userSprite.getCenter
    for j in 0...8
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(96*factor)
        fp["#{j}"].x = cx - 96*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 96*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/8)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*(180.0/Math::PI)# + (rand{4}==0 ? 180 : 0)
      fp["#{j}"].mirror = !fp["#{j}"].mirror if i%2==0
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    for k in 0...16
      if fp["c#{k}"].opacity == 0
        r = rand(2)
        fp["c#{k}"].zoom_x = (r==0 ? 1 : 0.5)
        fp["c#{k}"].zoom_y = (r==0 ? 1 : 0.5)
        fp["c#{k}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        rndx[k] = cx - 48*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        rndy[k] = cy - 48*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
        fp["c#{k}"].x = cx
        fp["c#{k}"].y = cy
      end
      next if k>(i/4)
      x2 = rndx[k]
      y2 = rndy[k]
      x0 = fp["c#{k}"].x
      y0 = fp["c#{k}"].y
      fp["c#{k}"].x += (x2 - x0)*0.05
      fp["c#{k}"].y += (y2 - y0)*0.05
      fp["c#{k}"].opacity += 5
    end
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].opacity += 25.5
    if i < 35
      fp["circle"].zoom_x += 0.01
      fp["circle"].zoom_y += 0.01
    end
	if i >=35 && i < 85
      fp["circle"].zoom_x += 0.05
      fp["circle"].zoom_y += 0.05
	  fp["circle"].opacity += 25 if fp["circle"].opacity < 200
	  for k in 0...16
		fp["c#{k}"].opacity -= 10
	  end
    end
	if i >= 85
      fp["circle"].zoom_x += 0.1
      fp["circle"].zoom_y += 0.1
	  for k in 0...16
		fp["c#{k}"].opacity -= 10
	  end
	  fp["circle"].opacity -= 45 if i >= 100
    end
    m = 1 if i%4==0
    fp["circle"].src_rect.x = 484*m
    m = 0 if i%2==0
    if i < 96
      if strike
        fp["bg"].opacity += 10 if fp["bg"].opacity < 255
      else
        fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.75
      end
    else
      fp["bg"].opacity -= 10 if !beam && !strike
    end
    @userSprite.still if !strike
    @userSprite.anim = true if strike
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  if !beam && !strike
    @sprites["battlebg"].focus
    @vector.reset if !@multiHit
    10.times do
      @viewport.color.alpha -= 25.5
      @scene.wait(1,true)
    end
  end
end

#===== FILE: MOONBLAST.rb =====#
#-------------------------------------------------------------------------------
#  MOONBLAST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MOONBLAST) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.new(255,204,255))
  fp["bg"].opacity = 0
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  # charging animation
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_2")
    fp["s#{j}"].center!
    r = 64*@userSprite.zoom_x
    x1, y1 = randCircleCord(r)
    fp["s#{j}"].x = cx - r + x1
    fp["s#{j}"].y = cy - r + y1
    fp["s#{j}"].opacity = 0
    z = [1.1,1,0.9,1.2,0.8][rand(5)]
    fp["s#{j}"].zoom_x = z
    fp["s#{j}"].zoom_y = z
    fp["s#{j}"].z = @userSprite.z + 1
  end
  fp["glow"] = Sprite.new(@viewport)
  fp["glow"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_3")
  fp["glow"].center!
  fp["glow"].x = cx
  fp["glow"].y = cy
  fp["glow"].opacity = 0
  fp["glow"].toggle = 1
  for j in 0...2
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_#{5+j}")
    fp["c#{j}"].center!
    fp["c#{j}"].toggle = 1
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].param = 1
    fp["c#{j}"].zoom_x = @userSprite.zoom_x
    fp["c#{j}"].zoom_y = @userSprite.zoom_y
    fp["c#{j}"].z = @userSprite.z + 1
  end
  for j in 0...8
    fp["t#{j}"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb519"))
    fp["t#{j}"].z = @userSprite.z + 1
    r = @viewport.width
    x1, y1 = randCircleCord(r)
    fp["t#{j}"].x = cx - r + x1
    fp["t#{j}"].y = cy - r + y1
    fp["t#{j}"].color = Color.white
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_4")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].color = Color.new(192,56,121,0)
  fp["circle"].param = 0
  fp["circle"].z = @userSprite.z + 2
  fp["circle"].opacity = 0
  fp["ripples"] = Sprite.new(@viewport)
  fp["ripples"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_7_2")
  fp["ripples"].center!
  fp["ripples"].x = cx
  fp["ripples"].y = cy
  fp["ripples"].opacity = 0
  fp["ripples"].zoom_x = @userSprite.zoom_x
  fp["ripples"].zoom_y = @userSprite.zoom_y
  fp["ripples"].color = Color.new(255,255,255,0)
  fp["ripples"].z = @userSprite.z + 2
  pbSEPlay("Anim/Harden")
  for i in 0...148
    pbSEPlay("Anim/Refresh") if i == 16
    pbSEPlay("Anim/Saint8") if i == 68
    for j in 0...8
      next if j > i/4
      fp["s#{j}"].opacity += 48
      fp["s#{j}"].zoom_x -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_x > 0
      fp["s#{j}"].zoom_y -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_y > 0
      fp["s#{j}"].x -= (cx - fp["s#{j}"].x)*0.01
      fp["s#{j}"].y -= (cy - fp["s#{j}"].y)*0.01
    end
    for j in 0...8
      next if i < 16
      next if j > (i-16)/8
      fp["t#{j}"].x -= (fp["t#{j}"].x - cx)*0.1
      fp["t#{j}"].y -= (fp["t#{j}"].y - cy)*0.1
      fp["t#{j}"].color.alpha -= 8
      fp["t#{j}"].update if i < 128
      fp["t#{j}"].visible = false if i == 128
    end
    for j in 0...2
      next if i < 32
      fp["c#{j}"].param -= fp["c#{j}"].toggle*0.0625*(j+1)
      if j == 0
        fp["c#{j}"].zoom_x = fp["c#{j}"].param*@userSprite.zoom_x
      else
        fp["c#{j}"].zoom_y = fp["c#{j}"].param*@userSprite.zoom_y
      end
      fp["c#{j}"].opacity += i < 132 ? 8 : -32
      fp["c#{j}"].toggle *= -1 if fp["c#{j}"].param <= 0 || fp["c#{j}"].param >= 1
      fp["c#{j}"].x = cx
      fp["c#{j}"].y = cy
    end
    if i >= 32
      fp["circle"].zoom_x += 0.03125 if fp["circle"].zoom_x < 1
      fp["circle"].zoom_y += 0.03125 if fp["circle"].zoom_y < 1
      fp["circle"].param = (fp["circle"].param == 0 ? 255 : 0) if i%12 == 0 || i%12 == 4
      fp["circle"].color.alpha = fp["circle"].param if i < 132
      fp["circle"].opacity += 8
      fp["glow"].opacity += i < 132 ? 4 : -32
      fp["glow"].zoom_x -= 0.02*fp["glow"].toggle
      fp["glow"].zoom_y -= 0.02*fp["glow"].toggle
      fp["glow"].toggle *= -1 if i%4 == 0
    end
    pbSEPlay("EBDX/Anim/move2") if i == 132
    pbSEPlay("EBDX/Anim/normal5",80) if i == 132
    # shooting at the target
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 132
    fp["circle"].z = @targetSprite.z + 1 if i == 132
    if i >= 132
      cx, cy = @userSprite.getCenter(true)
      x1, y1 = @targetSprite.getCenter(true)
      fp["ripples"].opacity += i < 140 ? 32 : - 32
      fp["ripples"].zoom_x += 0.1*@userSprite.zoom_x
      fp["ripples"].zoom_y += 0.1*@userSprite.zoom_y
      fp["ripples"].color.alpha += 16
      fp["ripples"].x = cx
      fp["ripples"].y = cy
      fp["circle"].color.alpha = 0
      fp["circle"].zoom_x = @vector.zoom1
      fp["circle"].zoom_y = @vector.zoom1
      fp["circle"].x += (x1 - fp["circle"].x)*0.1
      fp["circle"].y -= (fp["circle"].y - y1)*0.1
      fp["circle"].opacity -= 64 if i >= 144
    end
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/iron4")
  pbSEPlay("EBDX/Anim/iron1")
  # hitting the target
  for j in 0...24
    fp["r2#{j}"] = Sprite.new(@viewport)
    fp["r2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_10")
    fp["r2#{j}"].center!
    fp["r2#{j}"].x = @targetSprite.x - @targetSprite.ox + rand(@targetSprite.bitmap.width)
    fp["r2#{j}"].y = @targetSprite.y - @targetSprite.oy + rand(@targetSprite.bitmap.height)
    fp["r2#{j}"].z = @targetSprite.z + 1 + rand(2)
    fp["r2#{j}"].visible = false
  end
  for j in 0...32
    fp["r#{j}"] = Sprite.new(@viewport)
    b = rand(2)
	if b == 0
		fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_8_2")
	else
		fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb519_#{8+b}")
	end
    fp["r#{j}"].center!
    fp["r#{j}"].ox /= 2 if b == 0
    fp["r#{j}"].src_rect.set(rand(2)*fp["r#{j}"].bitmap.width/2,0,fp["r#{j}"].bitmap.width/2,fp["r#{j}"].bitmap.height) if b == 0
    fp["r#{j}"].x = x1
    fp["r#{j}"].y = y1
    r = (48 + rand(49))*@targetSprite.zoom_x
    rx, ry = randCircleCord(r)
    fp["r#{j}"].end_x = x1 - r + rx
    fp["r#{j}"].end_y = y1 - r + ry
    fp["r#{j}"].opacity = 0
    fp["r#{j}"].toggle = 2
    fp["r#{j}"].z = @targetSprite.z + 1
    fp["r#{j}"].zoom_x = @targetSprite.zoom_x
    fp["r#{j}"].zoom_y = @targetSprite.zoom_y
    fp["r#{j}"].param = 0
    fp["r#{j}"].speed = rand(15)
  end
  k = 1
  for i in 0...64
    for j in 0...32
      #next if j > i
      fp["r#{j}"].opacity += 16*fp["r#{j}"].toggle
      fp["r#{j}"].toggle = -4 if fp["r#{j}"].param >= 24+fp["r#{j}"].speed
      fp["r#{j}"].x += (fp["r#{j}"].end_x - fp["r#{j}"].x)*0.05
      fp["r#{j}"].y += (fp["r#{j}"].end_y - fp["r#{j}"].y)*0.05
      fp["r#{j}"].zoom_x -= fp["r#{j}"].zoom_x*0.02
      fp["r#{j}"].zoom_y -= fp["r#{j}"].zoom_y*0.02
      fp["r#{j}"].param += 1
    end
    for j in 0...24
      next if i < 8
      next if j > (i-8)/2
      fp["r2#{j}"].visible = true
      fp["r2#{j}"].opacity -= 24
      fp["r2#{j}"].zoom_x -= 0.02
      fp["r2#{j}"].zoom_y -= 0.02
    end
    if i >= 24
      @targetSprite.ox += k*2
      k *= -1 if i%2 == 0
      pbSEPlay("EBDX/Anim/normal2",50) if i%4 == 0
    end
    @targetSprite.still
    @scene.wait
  end
  @vector.reset
  for key in fp.keys
    next if key == "bg"
    fp[key].dispose
  end
  16.times do
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  fp["bg"].dispose
  fp.clear
end

#===== FILE: MOONLIGHT.rb =====#
#-------------------------------------------------------------------------------
#  SLACKOFF
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SLACKOFF) do
  EliteBattle.playMoveAnimation(:MOONLIGHT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SOFTBOILED
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SOFTBOILED) do
  EliteBattle.playMoveAnimation(:MOONLIGHT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MILKDRINK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MILKDRINK) do
  EliteBattle.playMoveAnimation(:MOONLIGHT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SWALLOW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SWALLOW) do
  EliteBattle.playMoveAnimation(:MOONLIGHT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MOONLIGHT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MOONLIGHT) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(64,64,64))
  fp["bg"].opacity = 0
  #
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_6")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MORNINGSUN.rb =====#
#-------------------------------------------------------------------------------
#  MORNINGSUN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MORNINGSUN) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(255,255,153))
  fp["bg"].opacity = 0
  #
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MUDBOMB.rb =====#
#-------------------------------------------------------------------------------
#  MUDBOMB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MUDBOMB) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["sludge"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb429_0_2"))
  fp["sludge"].keyFrame = 1
  fp["sludge"].z = @targetSprite.z + 1
  # shooting out the sludge
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["sludge"].x = points[i][0]
    fp["sludge"].y = points[i][1]
    z = 1 + (1-(fp["sludge"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["sludge"].zoom_x = z
    fp["sludge"].zoom_y = z
    fp["sludge"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("EBDX/Anim/ground1")
  @targetSprite.color = Color.new(102,51,0,0)
  fp["sludge"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb429_2_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
    fp["p#{j}"].color = Color.new(102,51,0,0)
  end
  for j in 0...24
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb429_3_2")
    fp["c#{j}"].center!
    fp["c#{j}"].x, fp["c#{j}"].y = @targetSprite.getCenter(true)
    fp["c#{j}"].y -= (@targetSprite.bitmap.height*0.5)*@userSprite.zoom_y
    r = (48 + rand(32))*@targetSprite.zoom_x
    fp["c#{j}"].end_x = fp["c#{j}"].x - r + rand(r*2)
    fp["c#{j}"].end_y = fp["c#{j}"].y - (52 - rand(64))*@targetSprite.zoom_y
    fp["c#{j}"].zoom_x = 0
    fp["c#{j}"].zoom_y = 0
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].z = @targetSprite.z + 1
    fp["c#{j}"].toggle = 1.2 + rand(10)/10.0
    fp["c#{j}"].visible = bomb
  end
  # poison animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
    for j in 0...24
      next if j > i
      fp["c#{j}"].x += (fp["c#{j}"].end_x - fp["c#{j}"].x)*0.1
      fp["c#{j}"].y += (fp["c#{j}"].end_y - fp["c#{j}"].y)*0.1
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].toggle = -1 if fp["c#{j}"].opacity >= 255
      fp["c#{j}"].zoom_x += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_x)*0.1
      fp["c#{j}"].zoom_y += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_y)*0.1
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: MUDDYWATER.rb =====#
#-------------------------------------------------------------------------------
#  MUDDYWATER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MUDDYWATER) do
  # def ini
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  factor = @userIsPlayer ? 1 : 0.75
  factorY = @userIsPlayer ? 0.992 : 1.01#1.01
  BubbleSplash = @userIsPlayer ? 15 : -15
  splash = 30
  shake = 8
  # graphic ini
  fp = {};
  fp["surf"] = Sprite.new(@viewport)
  fp["surf"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  if @userIsPlayer
	fp["surf"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb624_PU_2")
	fp["surf"].x = -200
	fp["surf"].y =  800
	moveX = 15
	moveY = -7
  else
	fp["surf"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb624_EU_2") 
	fp["surf"].x =  900
	fp["surf"].y =  -550
	moveX = -15
	moveY = 7
  end
  fp["surf"].zoom_x = factor
  fp["surf"].zoom_y = factor
  fp["surf"].ox = fp["surf"].bitmap.width/2
  fp["surf"].oy = fp["surf"].bitmap.height/2
  fp["surf"].z = @targetSprite.z + 1
  fp["surf"].opacity = 0
  # sprite ini
  @userSprite.color = Color.new(51,153,255,0)
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  @scene.wait(4,true)
  for i in 0...75
	pbSEPlay("Anim/Water1") if i%25 == 0
    fp["surf"].opacity += 25 if fp["surf"].opacity <= 125
	fp["surf"].x += moveX
	fp["surf"].y += moveY
	fp["surf"].zoom_y = factorY * fp["surf"].zoom_y
	if i == 35
		for v in 0...splash
			fp["p#{v}"] = Sprite.new(@viewport)
			fp["p#{v}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb624_2")
			fp["p#{v}"].center!
			fp["p#{v}"].x, fp["p#{v}"].y = @targetSprite.getCenter(true)
			r = (40 + rand(24))*@targetSprite.zoom_x
			x, y = randCircleCord(r)
			fp["p#{v}"].end_x = fp["p#{v}"].x - r + x
			fp["p#{v}"].end_y = fp["p#{v}"].y - r + y
			fp["p#{v}"].zoom_x = 0
			fp["p#{v}"].zoom_y = 0
			fp["p#{v}"].angle = rand(360)
			fp["p#{v}"].z = @targetSprite.z + 1
		  end
		end
	if i.between?(40,70)
      for j in 0...splash
		  next if j > (i-8)*2
		  fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
		  fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
		  fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1 + BubbleSplash
		  fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1 - BubbleSplash
		  if fp["p#{j}"].zoom_x >= 0.5
			fp["p#{j}"].opacity -= 16
		  end
		  fp["p#{j}"].color.alpha -= 8
	  end
      @targetSprite.ox += shake
      shake = -8 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 8 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
	  if i < 55
		@userSprite.color.alpha += 10
	  else
		@userSprite.color.alpha -= 16
	  end
	  @userSprite.still
	  @userSprite.anim = true
    end
	@scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end
#===== FILE: MUDSHOT.rb =====#
#-------------------------------------------------------------------------------
#  MUDSHOT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MUDSHOT) do
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []; px = []; py = []; rangl = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for k in 0...64
    i = 63-k
    fp["#{i}"] = Sprite.new(@viewport)
    bmp = pbBitmap("Graphics/EBDX/Animations/Moves/eb551_3")
    fp["#{i}"].bitmap = Bitmap.new(bmp.width,bmp.height)
    fp["#{i}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height))
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    fp["#{i}"].color = Color.new(248,248,248,200)
    rndx.push(rand(16)); rndy.push(rand(16)); rangl.push(rand(2))
    dx.push(0); dy.push(0)
  end
  for i in 0...64
    pbSEPlay("EBDX/Anim/water1",60) if i%4==0 && i < 48
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...64
      if fp["#{j}"].opacity == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].zoom_x = 0.8#(!@targetIsPlayer ? 1.2 : 0.8)#@userSprite.zoom_x
        fp["#{j}"].zoom_y = 0.8#(!@targetIsPlayer ? 1.2 : 0.8)#@userSprite.zoom_y
        fp["#{j}"].opacity = 128 if !(j>i*2)
      end
      next if j>(i*2)
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      x0 = dx[j]
      y0 = dy[j]
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x += 0.04#(factor - fp["#{j}"].zoom_x)*0.2
      fp["#{j}"].zoom_y += 0.04#(factor - fp["#{j}"].zoom_y)*0.2
      fp["#{j}"].opacity += 32
      fp["#{j}"].angle += 8*(rangl[j]==0 ? -1 : 1)
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      fp["#{j}"].color.alpha -= 5 if fp["#{j}"].color.alpha > 0
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].visible = false if nextx > cx && nexty < cy
      else
        fp["#{j}"].visible = false if nextx < cx && nexty > cy
      end
    end
    for l in 0...12
      next if i < 2
      next if l>((i-6)/4)
      if fp["p#{l}"].opacity <= 0 && i < 48
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(96)
        px[l] = cx - 48*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 48*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 16
    @vector.inc = 0.1 if i == 64
    @scene.wait(1,true)
  end
  for j in 0...48; fp["#{j}"].visible = false; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: MUDSLAP.rb =====#
#-------------------------------------------------------------------------------
#  SANDATTACK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SANDATTACK) do
  EliteBattle.playMoveAnimation(:MUDSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MUDSLAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MUDSLAP) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  bomb = true
  fp = {}
  fp["sludge"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb429_0_2"))
  fp["sludge"].keyFrame = 1
  fp["sludge"].z = @targetSprite.z + 1
  # shooting out the sludge
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-16,cxT,cyT,24)
    fp["sludge"].x = points[i][0]
    fp["sludge"].y = points[i][1]
    z = 1 + (1-(fp["sludge"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["sludge"].zoom_x = z * 0.5
    fp["sludge"].zoom_y = z * 0.5
    fp["sludge"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("EBDX/Anim/ground1")
  @targetSprite.color = Color.new(102,51,0,0)
  fp["sludge"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb429_2_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
    fp["p#{j}"].color = Color.new(102,51,0,0)
  end
  for j in 0...24
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb429_3_2")
    fp["c#{j}"].center!
    fp["c#{j}"].x, fp["c#{j}"].y = @targetSprite.getCenter(true)
    fp["c#{j}"].y -= (@targetSprite.bitmap.height*0.5)*@userSprite.zoom_y
    r = (48 + rand(32))*@targetSprite.zoom_x
    fp["c#{j}"].end_x = fp["c#{j}"].x - r + rand(r*2)
    fp["c#{j}"].end_y = fp["c#{j}"].y - (52 - rand(64))*@targetSprite.zoom_y
    fp["c#{j}"].zoom_x = 0
    fp["c#{j}"].zoom_y = 0
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].z = @targetSprite.z + 1
    fp["c#{j}"].toggle = 1.2 + rand(10)/10.0
    fp["c#{j}"].visible = bomb
  end
  # poison animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1* 0.5* 0.5
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1* 0.5* 0.5
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)
      if fp["p#{j}"].zoom_x >= 0.5
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
    for j in 0...24
      next if j > i
      fp["c#{j}"].x += (fp["c#{j}"].end_x - fp["c#{j}"].x)*0.1
      fp["c#{j}"].y += (fp["c#{j}"].end_y - fp["c#{j}"].y)#*0.1
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].toggle = -1 if fp["c#{j}"].opacity >= 255
      fp["c#{j}"].zoom_x += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_x)*0.1* 0.5* 0.5
      fp["c#{j}"].zoom_y += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_y)*0.1* 0.5* 0.5
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: MUDSPORT.rb =====#
#-------------------------------------------------------------------------------
#  MUDSPORT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MUDSPORT) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  splash = 50
  fp = {}
  # bg
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(168,133,73))
  fp["bg"].opacity = 0
  # user
  @userSprite.color = Color.new(168,133,73,0)
  # set up animation
  @scene.wait(5,true)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # init splash
  for j in 0...splash
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb223")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @userSprite.z + 1
  end
  for i in 0...64
	pbSEPlay("Anim/Splat",90) if i == 5
    for j in 0...splash
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1 - 15
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
	@scene.wait(1)
	@userSprite.still
    @userSprite.anim = true
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: MYSTICALFIRE.rb =====#
#-------------------------------------------------------------------------------
#  MYSTICALFIRE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MYSTICALFIRE) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(102,102,255))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136_2")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Fire2",80) if i%12==0 && i <= 96
    pbSEPlay("Anim/Smokescreen",120) if i==84
    if i >= 96
      @targetSprite.tone.red += 2.4*2 if @targetSprite.tone.red < 48*2
      @targetSprite.tone.green -= 1.2*2 if @targetSprite.tone.green > -24*2
      @targetSprite.tone.blue -= 2.4*2 if @targetSprite.tone.blue > -48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 2.4*2
    @targetSprite.tone.green += 1.2*2
    @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: NASTYPLOT.rb =====#
#-------------------------------------------------------------------------------
#  HONECLAWS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HONECLAWS) do
  EliteBattle.playMoveAnimation(:NASTYPLOT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  COSMICPOWER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:COSMICPOWER) do
  EliteBattle.playMoveAnimation(:NASTYPLOT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  GRAVITY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GRAVITY) do
  EliteBattle.playMoveAnimation(:NASTYPLOT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  NASTYPLOT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NASTYPLOT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_5")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(64,64,64,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: NATURESMADNESS.rb =====#
#-------------------------------------------------------------------------------
#  NATURESMADNESS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NATURESMADNESS) do | args |
  strike = *args; strike = false if strike.nil?
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  q = 0
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  @userSprite.color = Color.new(217,189,52,0) if strike
  for i in 0...8
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069_2_2")
    fp["#{i}"].src_rect.set(0,0,98,430)
    fp["#{i}"].ox = fp["#{i}"].src_rect.width/2
    fp["#{i}"].oy = fp["#{i}"].src_rect.height
    fp["#{i}"].zoom_x = 0.5
    fp["#{i}"].z = 50
  end
  for i in 0...16
    fp["s#{i}"] = Sprite.new(@viewport)
    fp["s#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069_3_2")
    fp["s#{i}"].ox = fp["s#{i}"].bitmap.width/2
    fp["s#{i}"].oy = fp["s#{i}"].bitmap.height/2
    fp["s#{i}"].opacity = 0
    fp["s#{i}"].z = 51
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069_0_2")
  fp["circle"].ox = fp["circle"].bitmap.width/2 + 4
  fp["circle"].oy = fp["circle"].bitmap.height/2 + 4
  fp["circle"].opacity = 0
  fp["circle"].z = 50
  fp["circle"].zoom_x = 1
  fp["circle"].zoom_y = 1
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @targetSprite.getCenter(true)
  fp["circle"].x = cx
  fp["circle"].y = cy
  for i in 0...96
    for j in 0...8
      next if j>(i/4)
      if fp["#{j}"].y <= 0 && i < 32
        pbSEPlay("Anim/Thunder3",80) if i%8==0
        fp["#{j}"].x = cx - 32*@targetSprite.zoom_x + rand(64)*@targetSprite.zoom_x
        fp["#{j}"].src_rect.x = 98*rand(3)
        t = rand(5)*48
        fp["#{j}"].opacity = 255
        fp["#{j}"].tone = Tone.new(t,t,t)
        fp["#{j}"].mirror = (rand(2)==0 ? true : false)
      end
      fp["#{j}"].src_rect.x += 98
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= 294
      fp["#{j}"].y += (@targetIsPlayer ? @vector.y : @vector.y2)/8.0 if fp["#{j}"].y < (@targetIsPlayer ? @vector.y : @vector.y2) + 32
      fp["#{j}"].opacity -= 32 if fp["#{j}"].y >= (@targetIsPlayer ? @vector.y : @vector.y2) + 32
      fp["#{j}"].y = 0 if fp["#{j}"].opacity <= 0
    end
    for n in 0...16
      next if i < 48
      next if n>(i-48)/4
      if fp["s#{n}"].opacity == 0 && fp["s#{n}"].tone.gray == 0
        pbSEPlay("EBDX/Anim/electric1",60) if i%8==0
        r2 = rand(4)
        fp["s#{n}"].zoom_x = [1,0.8,0.5,0.75][r2]
        fp["s#{n}"].zoom_y = [1,0.8,0.5,0.75][r2]
        fp["s#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48)
        fp["s#{n}"].x = cx - 48*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["s#{n}"].y = cy - 48*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["s#{n}"].angle = -Math.atan(1.0*(fp["s#{n}"].y-cy)/(fp["s#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      fp["s#{n}"].opacity += 128 if fp["s#{n}"].tone.gray == 0
      fp["s#{n}"].angle += 180 if (i-16)%2==0
      fp["s#{n}"].tone.gray = 1 if fp["s#{n}"].opacity >= 255
      q += 1 if fp["s#{n}"].opacity >= 255
      fp["s#{n}"].opacity -= 51 if fp["s#{n}"].tone.gray > 0 && q > 96
    end
    fp["circle"].opacity += (i < 48 ? 32 : - 64)
    fp["circle"].angle += 64
    fp["bg"].opacity -= 32 if i >= 90
    @targetSprite.still if i >= 32
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: NEEDLEARM.rb =====#
#-------------------------------------------------------------------------------
#  NEEDLEARM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NEEDLEARM) do | args |
  kick = args[0]; kick = false if kick.nil?
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(0,204,102))
  fp["bg"].opacity = 0
  for i in 0...20
    fp["#{i}"] = Sprite.new(@viewport)
	if rand(2) == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb208")
	else
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb208_2")
	end
    #fp["#{i}"].src_rect.set(0,0,53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 50
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)/2
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)/2
    rndx.push(rand(144))
    rndy.push(rand(144))
  end
  fp["punch"] = Sprite.new(@viewport)
  fp["punch"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb108")
  fp["punch"].ox = fp["punch"].bitmap.width/2
  fp["punch"].oy = fp["punch"].bitmap.height/2
  fp["punch"].opacity = 0
  fp["punch"].z = 40
  fp["punch"].angle = 180
  fp["punch"].zoom_x = @targetIsPlayer ? 6 : 4
  fp["punch"].zoom_y = @targetIsPlayer ? 6 : 4
  fp["punch"].tone = Tone.new(48,16,6)
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("EBDX/Anim/grass1", 75)
  @sprites["battlebg"].defocus
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["punch"].x = cx
    fp["punch"].y = cy
    fp["punch"].angle -= 45 if i < 40
    fp["punch"].zoom_x -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].zoom_y -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].opacity += 8 if i < 40
    if i >= 40
      fp["punch"].tone = Tone.new(255,255,255) if i == 40
      fp["punch"].tone.all -= 25.5
      fp["punch"].opacity -= 25.5
    end
    pbSEPlay("EBDX/Anim/grass2") if i==40
    for j in 0...20
      next if i < 40
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 72*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 72*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
	  fp["#{j}"].angle += 1 if j%2 == 1
	  fp["#{j}"].angle -= 1 if j%2 == 0
      #fp["#{j}"].src_rect.x += 53 if i%2==0
      #fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 16
        fp["#{j}"].tone.gray += 16
        fp["#{j}"].tone.red -= 4; fp["#{j}"].tone.green -= 4; fp["#{j}"].tone.blue -= 4
        #fp["#{j}"].zoom_x -= 0.005
        #fp["#{j}"].zoom_y += 0.01
      else
        fp["#{j}"].opacity += 45
      end
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      # if i >= 56
        # @targetSprite.tone.red -= 3*2
        # @targetSprite.tone.green += 1.5*2
        # @targetSprite.tone.blue += 3*2
        # fp["bg"].opacity -= 10
      # else
        # @targetSprite.tone.red += 3*2 if @targetSprite.tone.red < 48*2
        # @targetSprite.tone.green -= 1.5*2 if @targetSprite.tone.green > -24*2
        # @targetSprite.tone.blue -= 3*2 if @targetSprite.tone.blue > -48*2
      # end
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: NIGHTSHADE.rb =====#
#-------------------------------------------------------------------------------
#  Night Shade
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NIGHTSHADE) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  factor = @userSprite.zoom_x
  shake = 2
  # play animation
  pbSEPlay("Anim/fog2", 80)
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 8
    @userSprite.still
    @scene.wait(1,true)
  end
  for i in 0...24
    if i < 16
      @userSprite.zoom_x += 0.2*factor/8.0 if @userSprite.zoom_x < 1.2*factor
      @userSprite.zoom_y += 0.2*factor/8.0 if @userSprite.zoom_y < 1.2*factor
      @userSprite.tone.red += 8
      @userSprite.tone.green += 8
      @userSprite.tone.blue += 8
    end
    @userSprite.still
    @scene.wait
  end
  for i in 0...24
    if i < 24
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @targetSprite.tone.red -= 16 if i < 16
    @targetSprite.tone.green -= 16 if i < 16
    @targetSprite.tone.blue -= 16 if i < 16
    @targetSprite.still if i >= 12
    @userSprite.still
    @scene.wait
  end
  8.times do
    @userSprite.zoom_x -= 0.2*factor/8.0
    @userSprite.zoom_y -= 0.2*factor/8.0
    @userSprite.tone.red -= 16
    @userSprite.tone.green -= 16
    @userSprite.tone.blue -= 16
    @userSprite.still
    @targetSprite.still
    @scene.wait
  end
  16.times do
    @targetSprite.tone.red += 16
    @targetSprite.tone.green += 16
    @targetSprite.tone.blue += 16
    fp["bg"].opacity -= 8
    @userSprite.still
    @scene.wait
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: NIGHTSLASH.rb =====#
#-------------------------------------------------------------------------------
#  Night Slash
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NIGHTSLASH) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  dx = []
  dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb027_bg")
  fp["bg"].opacity = 0
  fp["bg"].z = 50
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb027_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 128*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    z = [1,0.75,0.5][rand(3)]
    fp["s#{j}"].zoom_x = z
    fp["s#{j}"].zoom_y = z
    fp["s#{j}"].x = cx
    fp["s#{j}"].y = cy
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    dx.push(x)
    dy.push(y)
  end
  fp["slash"] = Sprite.new(@viewport)
  fp["slash"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb027")
  fp["slash"].oy = fp["slash"].bitmap.height/2
  fp["slash"].y = cy
  fp["slash"].x = @viewport.width
  fp["slash"].opacity = 0
  fp["slash"].z = 50
  # play animation
  pbSEPlay("Anim/gust",90)
  for m in 0...2
    shake = 2
    for i in 0...(m < 1 ? 32 : 16)
      fp["bg"].opacity += 16 if m < 1
      fp["bg"].update
      if m < 1
        fp["slash"].x -= 64 if i >= 28
        fp["slash"].opacity += 64 if i >= 28
      else
        fp["slash"].x += 64 if i >= 12
        fp["slash"].opacity += 64 if i >= 12
      end
      @scene.wait(1,true)
    end
    pbSEPlay("Anim/hit")
    for i in 0...16
      fp["bg"].opacity -= 16
      for j in 0...12
        fp["s#{j}"].visible = true
        fp["s#{j}"].x -= (fp["s#{j}"].x - dx[j])*0.1
        fp["s#{j}"].y -= (fp["s#{j}"].y - dy[j])*0.1
        fp["s#{j}"].zoom_x -= 0.04
        fp["s#{j}"].zoom_y -= 0.04
        fp["s#{j}"].tone.gray += 16
        fp["s#{j}"].tone.red -= 8
        fp["s#{j}"].tone.green -= 8
        fp["s#{j}"].tone.blue -= 8
        fp["s#{j}"].opacity -= 16
      end
      if m < 1
        fp["slash"].x -= 64
      else
        fp["slash"].x += 64
      end
      fp["slash"].opacity -= 32
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
      @scene.wait
    end
    @targetSprite.ox = @targetSprite.bitmap.width/2
    dx.clear
    dy.clear
    fp["slash"].mirror = true
    fp["slash"].ox = fp["slash"].bitmap.width
    fp["slash"].opacity = 0
    fp["slash"].x = 0
    for j in 0...12
      fp["s#{j}"].x = cx
      fp["s#{j}"].y = cy
      fp["s#{j}"].tone = Tone.new(0,0,0,0)
      fp["s#{j}"].opacity = 255
      fp["s#{j}"].visible = false
      z = [1,0.75,0.5][rand(3)]
      fp["s#{j}"].zoom_x = z
      fp["s#{j}"].zoom_y = z
      r = 128*factor
      x, y = randCircleCord(r)
      x = cx - r + x
      y = cy - r + y
      dx.push(x)
      dy.push(y)
    end
  end
  @scene.wait(8)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: OCTAZOOKA.rb =====#
#-------------------------------------------------------------------------------
#  BARRAGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BARRAGE) do
  EliteBattle.playMoveAnimation(:OCTAZOOKA, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  OCTAZOOKA
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:OCTAZOOKA) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(57,106,173))
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...20
    fp["#{i}2"] = Sprite.new(@viewport)
	if true
		fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb223_2") 
	else
		fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")
	end
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 12
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Follow Me")
  for i in 0...40
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...20
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 30
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Water5") if i%10 == 0
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>35) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 20
    @vector.inc = 0.1 if i == 20
    @scene.wait(1,true)
  end
  fp["172"].dispose
  fp["182"].dispose
  fp["192"].dispose
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      #fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: OMINOUSWIND.rb =====#
#-------------------------------------------------------------------------------
#  OMINOUSWIND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:OMINOUSWIND) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(102,0,204))
  fp["bg"].opacity = 0
  fp["wave"] = AnimatedPlane.new(@viewport)
  fp["wave"].bitmap = Bitmap.new(1026,@viewport.height)
  fp["wave"].bitmap.stretch_blt(Rect.new(0,0,fp["wave"].bitmap.width,fp["wave"].bitmap.height),pbBitmap("Graphics/EBDX/Animations/Moves/eb132_2"),Rect.new(0,0,1026,212))
  fp["wave"].opacity = 0
  fp["wave"].z = 50
  @vector.set(EliteBattle.get_vector(:DUAL))
  @vector.inc = 0.1
  pulse = 10
  shake = [4,4,4,4]
  # start animation
  for j in 0...64
    pbSEPlay("Anim/Wind1") if j == 24
	pbSEPlay("Anim/Nightshade") if j == 40
    fp["wave"].ox += 48
    fp["wave"].opacity += pulse
    pulse = -5 if fp["wave"].opacity > 160
    pulse = +5 if fp["wave"].opacity < 100
    fp["bg"].opacity += 1 if fp["bg"].opacity < 255*0.35
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
      @sprites["pokemon_#{i}"].tone.all += 3 if j.between?(16,48)
      if j >= 32
        @sprites["pokemon_#{i}"].ox += shake[i]
        shake[i] = -4 if @sprites["pokemon_#{i}"].ox > @sprites["pokemon_#{i}"].bitmap.width/2 + 2
        shake[i] = 4 if @sprites["pokemon_#{i}"].ox < @sprites["pokemon_#{i}"].bitmap.width/2 - 2
      end
    end
    @sprites["pokemon_#{@userIndex}"].tone.all += 3 if j < 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  for i in 0...4
    next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
    next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
    @sprites["pokemon_#{i}"].ox = @sprites["pokemon_#{i}"].bitmap.width/2
  end
  for j in 0...64
    fp["wave"].ox += 48
    if j < 32
      fp["wave"].opacity += pulse
      pulse = -5 if fp["wave"].opacity > 160
      pulse = +5 if fp["wave"].opacity < 100
    end
    fp["wave"].opacity -= 4 if j >= 32
    fp["bg"].opacity -= 4 if j >= 32
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible)
      @sprites["pokemon_#{i}"].tone.all -= 3 if j >= 32
    end
    @sprites["pokemon_#{@userIndex}"].tone.all -= 3 if j >= 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: ORIGINPULSE.rb =====#
#-------------------------------------------------------------------------------
#  ORIGINPULSE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ORIGINPULSE) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.black)
  fp["bg"].opacity = 0
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  # charging animation
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb634_2")
    fp["s#{j}"].center!
    r = 64*@userSprite.zoom_x
    x1, y1 = randCircleCord(r)
    fp["s#{j}"].x = cx - r + x1
    fp["s#{j}"].y = cy - r + y1
    fp["s#{j}"].opacity = 0
    z = [1.1,1,0.9,1.2,0.8][rand(5)]
    fp["s#{j}"].zoom_x = z
    fp["s#{j}"].zoom_y = z
    fp["s#{j}"].z = @userSprite.z + 1
  end
  fp["glow"] = Sprite.new(@viewport)
  fp["glow"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb634_3")
  fp["glow"].center!
  fp["glow"].x = cx
  fp["glow"].y = cy
  fp["glow"].opacity = 0
  fp["glow"].toggle = 1
  for j in 0...2
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb634_#{5+j}")
    fp["c#{j}"].center!
    fp["c#{j}"].toggle = 1
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].param = 1
    fp["c#{j}"].zoom_x = @userSprite.zoom_x
    fp["c#{j}"].zoom_y = @userSprite.zoom_y
    fp["c#{j}"].z = @userSprite.z + 1
  end
  for j in 0...8
    fp["t#{j}"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb634"))
    fp["t#{j}"].z = @userSprite.z + 1
    r = @viewport.width
    x1, y1 = randCircleCord(r)
    fp["t#{j}"].x = cx - r + x1
    fp["t#{j}"].y = cy - r + y1
    fp["t#{j}"].color = Color.white
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb634_4")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].color = Color.new(192,56,121,0)
  fp["circle"].param = 0
  fp["circle"].z = @userSprite.z + 2
  fp["circle"].opacity = 0
  fp["ripples"] = Sprite.new(@viewport)
  fp["ripples"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb634_7")
  fp["ripples"].center!
  fp["ripples"].x = cx
  fp["ripples"].y = cy
  fp["ripples"].opacity = 0
  fp["ripples"].zoom_x = @userSprite.zoom_x
  fp["ripples"].zoom_y = @userSprite.zoom_y
  fp["ripples"].color = Color.new(255,255,255,0)
  fp["ripples"].z = @userSprite.z + 2
  pbSEPlay("Anim/Harden")
  for i in 0...148
    pbSEPlay("Anim/Refresh") if i == 16
    pbSEPlay("Anim/Saint8") if i == 68
    for j in 0...8
      next if j > i/4
      fp["s#{j}"].opacity += 48
      fp["s#{j}"].zoom_x -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_x > 0
      fp["s#{j}"].zoom_y -= 0.0625 if i > 4 + j*4 && fp["s#{j}"].zoom_y > 0
      fp["s#{j}"].x -= (cx - fp["s#{j}"].x)*0.01
      fp["s#{j}"].y -= (cy - fp["s#{j}"].y)*0.01
    end
    for j in 0...8
      next if i < 16
      next if j > (i-16)/8
      fp["t#{j}"].x -= (fp["t#{j}"].x - cx)*0.1
      fp["t#{j}"].y -= (fp["t#{j}"].y - cy)*0.1
      fp["t#{j}"].color.alpha -= 8
      fp["t#{j}"].update if i < 128
      fp["t#{j}"].visible = false if i == 128
    end
    for j in 0...2
      next if i < 32
      fp["c#{j}"].param -= fp["c#{j}"].toggle*0.0625*(j+1)
      if j == 0
        fp["c#{j}"].zoom_x = fp["c#{j}"].param*@userSprite.zoom_x
      else
        fp["c#{j}"].zoom_y = fp["c#{j}"].param*@userSprite.zoom_y
      end
      fp["c#{j}"].opacity += i < 132 ? 8 : -32
      fp["c#{j}"].toggle *= -1 if fp["c#{j}"].param <= 0 || fp["c#{j}"].param >= 1
      fp["c#{j}"].x = cx
      fp["c#{j}"].y = cy
    end
    if i >= 32
      fp["circle"].zoom_x += 0.03125 if fp["circle"].zoom_x < 1
      fp["circle"].zoom_y += 0.03125 if fp["circle"].zoom_y < 1
      fp["circle"].param = (fp["circle"].param == 0 ? 255 : 0) if i%12 == 0 || i%12 == 4
      fp["circle"].color.alpha = fp["circle"].param if i < 132
      fp["circle"].opacity += 8
      fp["glow"].opacity += i < 132 ? 4 : -32
      fp["glow"].zoom_x -= 0.02*fp["glow"].toggle
      fp["glow"].zoom_y -= 0.02*fp["glow"].toggle
      fp["glow"].toggle *= -1 if i%4 == 0
    end
    pbSEPlay("EBDX/Anim/move2") if i == 132
    pbSEPlay("EBDX/Anim/normal5",80) if i == 132
    # shooting at the target
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 132
    fp["circle"].z = @targetSprite.z + 1 if i == 132
    if i >= 132
      cx, cy = @userSprite.getCenter(true)
      x1, y1 = @targetSprite.getCenter(true)
      fp["ripples"].opacity += i < 140 ? 32 : - 32
      fp["ripples"].zoom_x += 0.1*@userSprite.zoom_x
      fp["ripples"].zoom_y += 0.1*@userSprite.zoom_y
      fp["ripples"].color.alpha += 16
      fp["ripples"].x = cx
      fp["ripples"].y = cy
      fp["circle"].color.alpha = 0
      fp["circle"].zoom_x = @vector.zoom1
      fp["circle"].zoom_y = @vector.zoom1
      fp["circle"].x += (x1 - fp["circle"].x)*0.1
      fp["circle"].y -= (fp["circle"].y - y1)*0.1
      fp["circle"].opacity -= 64 if i >= 144
    end
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/iron4")
  pbSEPlay("EBDX/Anim/iron1")
  # hitting the target
  for j in 0...24
    fp["r2#{j}"] = Sprite.new(@viewport)
    fp["r2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb634_10")
    fp["r2#{j}"].center!
    fp["r2#{j}"].x = @targetSprite.x - @targetSprite.ox + rand(@targetSprite.bitmap.width)
    fp["r2#{j}"].y = @targetSprite.y - @targetSprite.oy + rand(@targetSprite.bitmap.height)
    fp["r2#{j}"].z = @targetSprite.z + 1 + rand(2)
    fp["r2#{j}"].visible = false
  end
  for j in 0...32
    fp["r#{j}"] = Sprite.new(@viewport)
    b = rand(2)
    fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb634_#{8+b}")
    fp["r#{j}"].center!
    fp["r#{j}"].ox /= 2 if b == 0
    fp["r#{j}"].src_rect.set(rand(2)*fp["r#{j}"].bitmap.width/2,0,fp["r#{j}"].bitmap.width/2,fp["r#{j}"].bitmap.height) if b == 0
    fp["r#{j}"].x = x1
    fp["r#{j}"].y = y1
    r = (48 + rand(49))*@targetSprite.zoom_x
    rx, ry = randCircleCord(r)
    fp["r#{j}"].end_x = x1 - r + rx
    fp["r#{j}"].end_y = y1 - r + ry
    fp["r#{j}"].opacity = 0
    fp["r#{j}"].toggle = 2
    fp["r#{j}"].z = @targetSprite.z + 1
    fp["r#{j}"].zoom_x = @targetSprite.zoom_x
    fp["r#{j}"].zoom_y = @targetSprite.zoom_y
    fp["r#{j}"].param = 0
    fp["r#{j}"].speed = rand(15)
  end
  k = 1
  for i in 0...64
    for j in 0...32
      #next if j > i
      fp["r#{j}"].opacity += 16*fp["r#{j}"].toggle
      fp["r#{j}"].toggle = -4 if fp["r#{j}"].param >= 24+fp["r#{j}"].speed
      fp["r#{j}"].x += (fp["r#{j}"].end_x - fp["r#{j}"].x)*0.05
      fp["r#{j}"].y += (fp["r#{j}"].end_y - fp["r#{j}"].y)*0.05
      fp["r#{j}"].zoom_x -= fp["r#{j}"].zoom_x*0.02
      fp["r#{j}"].zoom_y -= fp["r#{j}"].zoom_y*0.02
      fp["r#{j}"].param += 1
    end
    for j in 0...24
      next if i < 8
      next if j > (i-8)/2
      fp["r2#{j}"].visible = true
      fp["r2#{j}"].opacity -= 24
      fp["r2#{j}"].zoom_x -= 0.02
      fp["r2#{j}"].zoom_y -= 0.02
    end
    if i >= 24
      @targetSprite.ox += k*2
      k *= -1 if i%2 == 0
      pbSEPlay("EBDX/Anim/normal2",50) if i%4 == 0
    end
    @targetSprite.still
    @scene.wait
  end
  @vector.reset
  for key in fp.keys
    next if key == "bg"
    fp[key].dispose
  end
  16.times do
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  fp["bg"].dispose
  fp.clear
end

#===== FILE: OUTRAGE.rb =====#
#-------------------------------------------------------------------------------
#  OUTRAGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:OUTRAGE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("EBDX/Anim/fire2",60)
  pbSEPlay("EBDX/Anim/fire3",60)
  @sprites["battlebg"].defocus
  for i in 0...10
    # for j in 0...16
      # next if j>(i/2)
      # fp["f#{j}"].visible = true
      # fp["f#{j}"].y -= 8*@userSprite.zoom_y
      # fp["f#{j}"].opacity -= 32 if frame[j] >= 8
      # frame[j] += 1
    # end
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/fire4",80)
  # @vector.set(vector)
  # @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_2")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_3")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_4")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/fire1",80) if i == 8
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: OVERHEAT.rb =====#
#-------------------------------------------------------------------------------
#  BURNUP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BURNUP) do
  EliteBattle.playMoveAnimation(:OVERHEAT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  OVERHEAT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:OVERHEAT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  #dragondance
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136")
    fp["#{j}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{j}"].ox = 26
    fp["#{j}"].oy = 101
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,0.75,0.8,0.75,0.6][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*2)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_1")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(255,0,0,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0  
    pbSEPlay("EBDX/Anim/fire2") if i%20 == 0
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
	  fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 6*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 54
      else
        fp["#{j}"].opacity += 54
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  #flareblitz
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  frame = []
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  # animation start
  pbSEPlay("EBDX/Anim/fire2",60)
  pbSEPlay("EBDX/Anim/fire3",60)
  @sprites["battlebg"].defocus
  for i in 0...48
    for j in 0...16
      next if j>(i/2)
      fp["f#{j}"].visible = true
      fp["f#{j}"].y -= 8*@userSprite.zoom_y
      fp["f#{j}"].opacity -= 32 if frame[j] >= 8
      frame[j] += 1
    end
    fp["bg"].opacity += 8 if i >= 32
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/fire4",80)
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_2")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_3")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx - 32 + rand(64)
    fp["#{j}"].y = cy - 32 + rand(64)
    fp["#{j}"].z = @targetSprite.z + 1
    fp["#{j}"].visible = false
    fp["#{j}"].zoom_x = @targetSprite.zoom_x
    fp["#{j}"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_4")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/fire1",80) if i%16 == 0
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}"].visible = true
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += 16
      fp["#{j}"].zoom_x += 0.1
      fp["#{j}"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: PAYDAY.rb =====#
#-------------------------------------------------------------------------------
#  PAYDAY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PAYDAY) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["ball"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb644"))
  fp["ball"].keyFrame = 1
  fp["ball"].z = @targetSprite.z + 1
  @vector.set(EliteBattle.get_vector(:DUAL))
  @scene.wait(5,true)
  # shooting out the ball
  for i in 0...24
	pbSEPlay("EBDX/Anim/move1") if i == 5
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    my = @vector.y + (@vector.y2 - @vector.y)*0.5
    points = calculateCurve(cxP,cyP,mx,0,cxT,cyT,24)
    fp["ball"].x = points[i][0]
    fp["ball"].y = points[i][1]
    z = 1 + (1-(fp["ball"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["ball"].zoom_x = z
    fp["ball"].zoom_y = z
    fp["ball"].update
	if i.between?(16,8)
		@targetSprite.color.alpha += 18
		@targetSprite.anim = true
		@targetSprite.still
	end
    @scene.wait(1,true)
  end
  @targetSprite.color = Color.new(70,70,70,0)
  fp["ball"].dispose
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	if rand(1)
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb644_2")
	else
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb644_2")
	end
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/Money") if i == 5 || i == 15 || i == 25
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.01
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.01
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.25
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.25
      if fp["p#{j}"].zoom_x >= 0.5
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: PERISHSONG.rb =====#
#-------------------------------------------------------------------------------
#  PERISHSONG
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PERISHSONG) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  rndNote = 0
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(64,64,64))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
	rndNote = rand(2)
	if rndNote == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_5")
	else
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_6")
	end
    #fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].src_rect.set(0,101*0,53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end 
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/PerishSong",80) if i==0 
    if i >= 96
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    # @targetSprite.tone.red -= 2.4*2
    # @targetSprite.tone.green += 1.2*2
    # @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -1 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 1 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: PETALBLIZZARD.rb =====#
#-------------------------------------------------------------------------------
#  PETALBLIZZARD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PETALBLIZZARD) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_6")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = 50
    rndx.push(rand(256)); prndx.push(rand(72))
    rndy.push(rand(256)); prndy.push(rand(72))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_5")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 1 : 1.5)*0.5
  fp["cir"].zoom_y = (@targetIsPlayer ? 1 : 1.5)*0.5
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_3")
    fp["#{i}s"].ox = fp["#{i}s"].bitmap.width/2
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height + 8*factor
    fp["#{i}s"].angle = rand(360)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.5 : 1)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.5 : 1)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  k = 0
  # start animation
  @vector.set(vector2)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  @sprites["battlebg"].defocus
  for i in 0...30
    if i < 10
      #fp["bg"].opacity += 25.5
    elsif i < 20
      #fp["bg"].color.alpha -= 25.5
    else
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 16*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 25.5
      fp["cir"].zoom_x += (@targetIsPlayer ? 1 : 1.5)*0.05
      fp["cir"].zoom_y += (@targetIsPlayer ? 1 : 1.5)*0.05
      k += 1 if i%4==0; k = 0 if k > 1
      fp["cir"].tone = [Tone.new(0,0,0),Tone.new(155,155,155)][k]
    end
    pbSEPlay("EBDX/Anim/grass2") if i == 20
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/wind1",90)
  for i in 0...96
    pbSEPlay("EBDX/Anim/grass1",60) if i%3==0 && i < 64
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += rangl[j]*2
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].opacity -= 51 if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 51 if nextx < cx && nexty > cy
      end
    end
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 16*(@userIsPlayer ? -1 : 1)
    fp["cir"].opacity -= (i>=72) ? 51 : 2
    k += 1 if i%4==0; k = 0 if k > 1
    fp["cir"].tone = [Tone.new(0,0,0),Tone.new(155,155,155)][k]
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].oy +=6*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = @userSprite.getCenter
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: PETALDANCE.rb =====#
#-------------------------------------------------------------------------------
#  PETALDANCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PETALDANCE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_4")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_2") #dragondance
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")#keep
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(51,255,65,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12 #keep
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("EBDX/Anim/grass1",60)
  pbSEPlay("Anim/Wind1",60)
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/grass2",80)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_2")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_10")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/normal2",80) if i == 8 || i == 16 || i == 24
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: PINMISSILE.rb =====#
#-------------------------------------------------------------------------------
#  PINMISSILE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PINMISSILE) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  shake = 6
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(229,255,204))
  fp["bg"].opacity = 0
  # shooting out the pinmissle
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  fp["pinmissle"] = Sprite.new(@viewport)
  fp["pinmissle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626")
  fp["pinmissle"].mirror = true if @userIsPlayer
  fp["pinmissle"].z = @targetSprite.z + 1
  @targetSprite.color = Color.new(204,255,255,0)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  for v in 0..2
	  for i in 0...24
		pbSEPlay("Anim/Throw") if i == 3
		pbSEPlay("EBDX/Anim/normal1",80) if i == 20
		cxT, cyT = @targetSprite.getCenter(true)
		cxP, cyP = @userSprite.getAnchor(true)
		mx = @vector.x + (@vector.x2 - @vector.x)*0.5
		points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
		fp["pinmissle"].x = points[i][0]
		fp["pinmissle"].y = points[i][1]
		z = 1 + (1-(fp["pinmissle"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
		fp["pinmissle"].zoom_x = z
		fp["pinmissle"].zoom_y = z
		fp["pinmissle"].update
		fp["pinmissle"].angle = -80 - i*3.75 if @userIsPlayer
		fp["pinmissle"].angle = 80 + i*5 if @targetIsPlayer
		if i >= 18 && i%2 == 0
			@targetSprite.ox += shake
		end
		if i >= 18 && i%2 == 1
			@targetSprite.ox -= shake
		end
		if i.between?(17,20)
		    @targetSprite.color.alpha += 25
			@targetSprite.anim = true
			@targetSprite.still
		end
		if i.between?(20,24)
		    @targetSprite.color.alpha -= 25
			@targetSprite.anim = true
			@targetSprite.still
		end
		@scene.wait(1,true)
	  end
  end
  fp["pinmissle"].dispose
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: PLAYROUGH.rb =====#
#-------------------------------------------------------------------------------
#  PLAYROUGH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PLAYROUGH) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_6")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_6")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(182,41,130,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  #animation
  for i in 0...50
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i*3)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("Anim/Love",80) if i%4==0 && i < 16
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    for j in 0...50
      next if j>(i*3)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: POISONFANG.rb =====#
#-------------------------------------------------------------------------------
#  POISONFANG
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POISONFANG) do
  factor = @targetIsPlayer ? 2 : 1.5
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(135,101,144))
  fp["bg"].opacity = 0
  fp["fang1"] = Sprite.new(@viewport)
  fp["fang1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang1"].ox = fp["fang1"].bitmap.width/2
  fp["fang1"].oy = fp["fang1"].bitmap.height - 20
  fp["fang1"].opacity = 0
  fp["fang1"].color = Color.new(207,52,218,50)
  fp["fang1"].z = 41
  fp["fang2"] = Sprite.new(@viewport)
  fp["fang2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang2"].ox = fp["fang1"].bitmap.width/2
  fp["fang2"].oy = fp["fang1"].bitmap.height - 20
  fp["fang2"].opacity = 0
  fp["fang2"].color = Color.new(207,52,218,50)
  fp["fang2"].z = 40
  fp["fang2"].angle = 180
  l = 0; m = 0; q = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb429_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 51
  end
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["fang1"].x = cx; fp["fang1"].y = cy
    if i < 32
      fp["fang1"].zoom_x = @targetSprite.zoom_x; fp["fang1"].zoom_y = @targetSprite.zoom_y
    end
    fp["fang2"].x = cx; fp["fang2"].y = cy
    if i < 32
      fp["fang2"].zoom_x = @targetSprite.zoom_x; fp["fang2"].zoom_y = @targetSprite.zoom_y
    end
    if i.between?(20,29)
      fp["fang1"].opacity += 5
      fp["fang1"].oy += 2
      fp["fang2"].opacity += 5
      fp["fang2"].oy += 2
    elsif i.between?(30,40)
      fp["fang1"].opacity += 25.5
      fp["fang1"].oy -= 4
      fp["fang2"].opacity += 25.5
      fp["fang2"].oy -= 4
    else
      fp["fang1"].opacity -= 26
      fp["fang1"].oy += 2
      fp["fang2"].opacity -= 26
      fp["fang2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Super Fang")
    end
    pbSEPlay("Anim/Poison") if i%8==0 && i>=48
    for n in 0...12
      next if i < 32
      if fp["#{n}"].opacity == 0 && fp["#{n}"].tone.gray == 0
        r2 = rand(4)
        fp["#{n}"].zoom_x = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].zoom_y = [0.2,0.25,0.5,0.75][r2]
        #fp["#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        fp["#{n}"].x = cx - 48*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["#{n}"].y = cy - 48*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["#{n}"].angle = -Math.atan(1.0*(fp["#{n}"].y-cy)/(fp["#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      next if m>(i-32)/4
      fp["#{n}"].opacity += 51 if fp["#{n}"].tone.gray == 0
      fp["#{n}"].angle += 180 if (i-16)%3==0
      fp["#{n}"].tone.gray = 1 if fp["#{n}"].opacity >= 255
      q += 1 if fp["#{n}"].opacity >= 255
      fp["#{n}"].opacity -= 10 if fp["#{n}"].tone.gray > 0 && q > 96
    end
    fp["bg"].opacity += 4 if  i < 40
    fp["bg"].opacity -= 10 if i >= 56
    @targetSprite.tone = Tone.new(107,71,115) if i == 32
    if i >= 32
      if (i-32)/3 > l
        m += 1
        m = 0 if m > 1
        l = (i-32)/3
      end
      @targetSprite.zoom_y -= 0.16*(m==0 ? 1 : -1)
      @targetSprite.zoom_x += 0.08*(m==0 ? 1 : -1)
      @targetSprite.tone.red -= 3 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 3 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 3 if @targetSprite.tone.blue > 0
      @targetSprite.still
    end
    @scene.wait(1,(i < 32))
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: POISONGAS.rb =====#
#-------------------------------------------------------------------------------
#  SMOG
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SMOG) do
  EliteBattle.playMoveAnimation(:POISONGAS, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  POISONPOWDER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POISONPOWDER) do
  EliteBattle.playMoveAnimation(:POISONGAS, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  POISONGAS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POISONGAS) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_4")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(130,38,137,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: POISONJAB.rb =====#
#-------------------------------------------------------------------------------
#  Poison Jab
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POISONJAB) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  for j in 0...32
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = Bitmap.new(8,8)
    fp["s#{j}"].bitmap.bmp_circle(Color.new(25,75,183))
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    fp["s#{j}"].x = cx
    fp["s#{j}"].y = cy
    fp["s#{j}"].z = @targetSprite.z
    fp["s#{j}"].angle = rand(360)
    fp["s#{j}"].visible = false
  end
  for j in 0...16
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb430")
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].angle = rand(360)
    fp["#{j}"].ox = - 80*factor
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @targetSprite.z + 1
    fp["#{j}"].opacity = 0
  end
  # play animation
  for i in 0...48
    for j in 0...16
      next if j>i
      fp["#{j}"].opacity += 32
      fp["#{j}"].ox += (80*factor/8).ceil
      fp["#{j}"].visible = false if fp["#{j}"].ox >= 0
    end
    for j in 0...32
      next if j>i*2
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].oy += 16
    end
    @targetSprite.zoom_y = factor + 0.32 if i%6 == 0 && i < 32
    @targetSprite.zoom_y -= 0.08 if @targetSprite.zoom_y > factor
    pbSEPlay("Anim/hit",80) if i%6==0 && i < 32
    pbSEPlay("EBDX/Anim/poison1",60) if i%4==0 && i < 32
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: POISONSTING.rb =====#
#-------------------------------------------------------------------------------
#  POISONSTING
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POISONSTING) do | args |
  factor = @targetSprite.zoom_x
  factorHorn = @userIsPlayer ? 1.9 : 2.5
  hornXMove = @userIsPlayer ? 2 : -2
  hornYMove = @userIsPlayer ? 10 : -10
  hornXOffset = @userIsPlayer ? 60 : -120
  hornYOffset = @userIsPlayer ? 60 : -120
  hornMoveHit = @userIsPlayer ? 5 : -5
  hornAngle = @userIsPlayer ? 0 : 180
  userOX = @userSprite.ox
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_6")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  # phase 1
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # user move
  for i in 0...30
    @userSprite.still
	#default movement
    if i.between?(0,20)
		@userSprite.ox += hornXMove
	else
		@userSprite.ox -= hornYMove
    end
    @scene.wait(1,true)
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(12,true)
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/normal1",80)
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_0_4")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  fp["horn"] = Sprite.new(@viewport)
  fp["horn"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626_2")
  fp["horn"].ox = fp["horn"].bitmap.width/2
  fp["horn"].oy = fp["horn"].bitmap.height/2
  fp["horn"].x, fp["horn"].y = @targetSprite.getCenter(true)
  fp["horn"].x -= hornXOffset
  fp["horn"].y += hornYOffset
  fp["horn"].opacity = 0
  fp["horn"].zoom = factorHorn
  fp["horn"].angle = hornAngle
  fp["horn"].z = 41
  # horn attack
  for i in 1..30
	if i.between?(1,15)
		fp["horn"].opacity += 20
		fp["horn"].x += hornMoveHit 
		fp["horn"].y -= hornMoveHit
	else
		fp["horn"].opacity -= 20
	end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
	pbSEPlay("Anim/Poison") if i >= 10 && i%10 == 0
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: POISONTAIL.rb =====#
#-------------------------------------------------------------------------------
#  POISONTAIL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POISONTAIL) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632_6")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_1")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb429_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  # start animation
  k = 1
  for i in 0...32
    pbSEPlay("EBDX/Anim/normal4",80) if i == 4
    pbSEPlay("Anim/Poison") if i == 4
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: POUND.rb =====#
#-------------------------------------------------------------------------------
#  POUND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POUND) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  vector2 = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 8
  for i in 0...12
    @userSprite.still
	pbSEPlay("EBDX/Anim/move1",100) if i == 4 || i == 8
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -8 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 8 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  @vector.set(vector2)
  @scene.wait(10,true)
  EliteBattle.playMoveAnimation(:TACKLE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: POWDER.rb =====#
#-------------------------------------------------------------------------------
#  POWDER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POWDER) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_10")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(230,69,242,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: POWERGEM.rb =====#
#-------------------------------------------------------------------------------
#  ROCKWRECKER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROCKWRECKER) do
  EliteBattle.playMoveAnimation(:POWERGEM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  POWERGEM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POWERGEM) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["rock"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb504"))
  fp["rock"].keyFrame = 1
  fp["rock"].z = @targetSprite.z + 1
  # shooting out the rock
  pbSEPlay("Anim/Psych Up")
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-20,cxT,cyT,24)
    fp["rock"].x = points[i][0]
    fp["rock"].y = points[i][1]
    z = 1 + (1-(fp["rock"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["rock"].zoom_x = z
    fp["rock"].zoom_y = z
    fp["rock"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @targetSprite.color = Color.new(112,81,41,0)
  fp["rock"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504_1")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  for j in 0...24
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504_2")
    fp["c#{j}"].center!
    fp["c#{j}"].x, fp["c#{j}"].y = @targetSprite.getCenter(true)
    r = (48 + rand(32))*@targetSprite.zoom_x
    fp["c#{j}"].end_x = fp["c#{j}"].x - r + rand(r*2)
    fp["c#{j}"].end_y = fp["c#{j}"].y - r + rand(r*2)#(52 - rand(64))*@targetSprite.zoom_y
    fp["c#{j}"].zoom_x = 0
    fp["c#{j}"].zoom_y = 0
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].z = @targetSprite.z + 1
    fp["c#{j}"].toggle = 1.2 + rand(10)/10.0
    fp["c#{j}"].visible = bomb
  end
  # poison animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/rock2") if i%8 == 0
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
    for j in 0...24
      next if j > i
      fp["c#{j}"].x += (fp["c#{j}"].end_x - fp["c#{j}"].x)*0.1
      fp["c#{j}"].y += (fp["c#{j}"].end_y - fp["c#{j}"].y)*0.1
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].toggle = -1 if fp["c#{j}"].opacity >= 255
      fp["c#{j}"].zoom_x += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_x)*0.1
      fp["c#{j}"].zoom_y += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_y)*0.1
	  if fp["c#{j}"].zoom_x >= 0.5
        fp["c#{j}"].opacity -= 20
      end
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: POWERSWAP.rb =====#
#-------------------------------------------------------------------------------
#  POWERSPLIT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POWERSPLIT) do
  EliteBattle.playMoveAnimation(:POWERSWAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  POWERTRICK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POWERTRICK) do
  EliteBattle.playMoveAnimation(:POWERSWAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  POWERSWAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POWERSWAP) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["change1"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_7"))
  fp["change1"].keyFrame = 1
  fp["change1"].z = @targetSprite.z + 1
  fp["change2"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_7"))
  fp["change2"].keyFrame = 1
  fp["change2"].z = @userSprite.z + 1
  # shooting out the change1
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["change1"].x = points[i][0]
    fp["change1"].y = points[i][1]
    z = 1 + (1-(fp["change1"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change1"].zoom_x = z
    fp["change1"].zoom_y = z
    fp["change1"].update
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxT,cyT,mx,32,cxP,cyP,24)
    fp["change2"].x = points[i][0]
    fp["change2"].y = points[i][1]
    z = 1 + (1-(fp["change2"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change2"].zoom_x = z
    fp["change2"].zoom_y = z
    fp["change2"].update
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  pbSEPlay("Anim/Saint7")
  @targetSprite.color = Color.new(255,100,100,0)
  @userSprite.color = Color.new(255,100,100,0)
  fp["change1"].dispose
  fp["change2"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha += 18
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_8")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  for j in 0...32
    fp["p2#{j}"] = Sprite.new(@viewport)
    fp["p2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_8")
    fp["p2#{j}"].center!
    fp["p2#{j}"].x, fp["p2#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p2#{j}"].end_x = fp["p2#{j}"].x - r + x
    fp["p2#{j}"].end_y = fp["p2#{j}"].y - r + y
    fp["p2#{j}"].zoom_x = 0
    fp["p2#{j}"].zoom_y = 0
    fp["p2#{j}"].angle = rand(360)
    fp["p2#{j}"].z = @userSprite.z + 1
  end
  # sparkle animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
	  
	  fp["p2#{j}"].zoom_x += (1.6 - fp["p2#{j}"].zoom_x)*0.1
      fp["p2#{j}"].zoom_y += (1.6 - fp["p2#{j}"].zoom_y)*0.1
      fp["p2#{j}"].x += (fp["p2#{j}"].end_x - fp["p2#{j}"].x)*0.1
      fp["p2#{j}"].y += (fp["p2#{j}"].end_y - fp["p2#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
	  if fp["p2#{j}"].zoom_x >= 1
        fp["p2#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
      fp["p2#{j}"].color.alpha -= 8
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha -= 16 if i >= 48
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: POWERTRIP.rb =====#
#-------------------------------------------------------------------------------
#  PUNISHMENT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PUNISHMENT) do
  EliteBattle.playMoveAnimation(:POWERTRIP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FOULPLAY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FOULPLAY) do
  EliteBattle.playMoveAnimation(:POWERTRIP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  POWERTRIP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POWERTRIP) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  EliteBattle.playMoveAnimation(:NASTYPLOT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playMoveAnimation(:BEATUP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: PRESENT.rb =====#
#-------------------------------------------------------------------------------
#  PRESENT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PRESENT) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["bone"] = Sprite.new(@viewport)
  fp["bone"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb635")
  fp["bone"].z = @targetSprite.z + 1
  fp["bone"].opacity = 0
  timeFactor = 40
  # shooting out the bone
  pbSEPlay("Anim/Saint9")
  for i in 0...timeFactor
	#pbSEPlay("Anim/wind7") if i%5 == 0
	fp["bone"].opacity += 50 if fp["bone"].opacity < 250
	fp["bone"].ox = fp["bone"].bitmap.width/2
    fp["bone"].oy = fp["bone"].bitmap.height/2
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,timeFactor)
    fp["bone"].x = points[i][0]
    fp["bone"].y = points[i][1]
    z = 1 + (1-(fp["bone"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["bone"].zoom_x = z
    fp["bone"].zoom_y = z
	fp["bone"].angle += 30
    fp["bone"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  fp["bone"].dispose
  # zooming onto the target
  if $game_switches[212] == true
	  EliteBattle.playCommonAnimation(:SPARKLE_YELLOW, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  else
	  EliteBattle.playCommonAnimation(:EXPLOSION, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  end
  @scene.wait(10,true)
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: PROTECT.rb =====#
#-------------------------------------------------------------------------------
#  MIRRORMOVE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MIRRORMOVE) do
  EliteBattle.playMoveAnimation(:PROTECT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  AURORAVEIL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AURORAVEIL) do
  EliteBattle.playMoveAnimation(:PROTECT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  PROTECT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PROTECT) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb605")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @targetIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 5
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
    if i.between?(7,11)
      #@targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: PSYBEAM.rb =====#
#-----------------------------------------------------------------------------
#  Psybeam
#-----------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYBEAM) do
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  for i in 0...72
    fp["#{i}"] = RainbowSprite.new(@viewport)
    fp["#{i}"].setBitmap("Graphics/EBDX/Animations/Moves/eb460", 24)
    fp["#{i}"].center!
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16)); rndy.push(rand(16))
    dx.push(0); dy.push(0)
  end
  # set vector
  @vector.set(vector)
  # start animation
  for i in 0...96
    @vector.reset if i == 12
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      next if j>(i*2)
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      x0 = dx[j]; y0 = dy[j]
      fp["#{j}"].x += (x2 - x0)*0.02
      fp["#{j}"].y += (y2 - y0)*0.02
      fp["#{j}"].zoom_x = @targetIsPlayer ? @userSprite.zoom_x : @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetIsPlayer ? @userSprite.zoom_y : @targetSprite.zoom_y
      fp["#{j}"].opacity += 32
      fp["#{j}"].update
      nextx = fp["#{j}"].x + (x2 - x0)*0.02
      nexty = fp["#{j}"].y + (y2 - y0)*0.02
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
        fp["#{j}"].visible = false if nextx > cx && nexty < cy
      else
        fp["#{j}"].visible = false if nextx < cx && nexty > cy
      end
    end
    if i >= 32
      @targetSprite.tone.red -= 4 if @targetSprite.tone.red > -64
      @targetSprite.tone.green -= 9 if @targetSprite.tone.green > -144
      @targetSprite.still
    end
    pbSEPlay("EBDX/Anim/psychic1", 75) if i>6 && i%14==0
    @scene.wait(1,true)
  end
  16.times do
    @targetSprite.tone.red += 4
    @targetSprite.tone.green += 9
    @targetSprite.still
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @targetSprite.tone = Tone.new(0,0,0)
  pbDisposeSpriteHash(fp)
end

#===== FILE: PSYCHIC.rb =====#
#-------------------------------------------------------------------------------
#  Psychic
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYCHIC) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  factor = @targetIsPlayer ? 2 : 1.5
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 6
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb452",true)
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  fp["bg"].oy = fp["bg"].src_rect.height/2
  fp["bg"].y = @viewport.height/2
  shake = 8
  zoom = -1
  # start animation
  @vector.set(vector)
  @sprites["battlebg"].defocus
  for i in 0...72
    pbSEPlay("EBDX/Anim/psychic1",80) if i == 40
    pbSEPlay("EBDX/Anim/psychic2",80) if i == 62
    if i < 10
      fp["bg"].opacity += 25.5
    elsif i < 20
      fp["bg"].color.alpha -= 25.5
    elsif i >= 62
      fp["bg"].color.alpha += 25.5
      @targetSprite.tone.red += 18
      @targetSprite.tone.green += 18
      @targetSprite.tone.blue += 18
      @targetSprite.zoom_x += 0.04*factor
      @targetSprite.zoom_y += 0.04*factor
    elsif i >= 40
      @targetSprite.ox += shake
      shake = -8 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
      shake = 8 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
      @targetSprite.still
    end
    zoom *= -1 if i%2 == 0
    fp["bg"].update
    fp["bg"].zoom_y += 0.04*zoom
    @scene.wait(1,(i<62))
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  10.times do
    @targetSprite.tone.red -= 18
    @targetSprite.tone.green -= 18
    @targetSprite.tone.blue -= 18
    @targetSprite.zoom_x -= 0.04*factor
    @targetSprite.zoom_y -= 0.04*factor
    @targetSprite.still
    @scene.wait
  end
  @scene.wait(8)
  @vector.reset if !@multiHit
  10.times do
    fp["bg"].opacity -= 25.5
    @targetSprite.still
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: PSYCHICFANGS.rb =====#
#-------------------------------------------------------------------------------
#  PSYCHICFANGS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYCHICFANGS) do
  factor = @targetIsPlayer ? 2 : 1.5
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(144,101,141))
  fp["bg"].opacity = 0
  fp["fang1"] = Sprite.new(@viewport)
  fp["fang1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang1"].ox = fp["fang1"].bitmap.width/2
  fp["fang1"].oy = fp["fang1"].bitmap.height - 20
  fp["fang1"].opacity = 0
  fp["fang1"].color = Color.new(217,189,52,50)
  fp["fang1"].z = 41
  fp["fang2"] = Sprite.new(@viewport)
  fp["fang2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang2"].ox = fp["fang1"].bitmap.width/2
  fp["fang2"].oy = fp["fang1"].bitmap.height - 20
  fp["fang2"].opacity = 0
  fp["fang2"].color = Color.new(217,189,52,50)
  fp["fang2"].z = 40
  fp["fang2"].angle = 180
  l = 0; m = 0; q = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_3")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 51
  end
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["fang1"].x = cx; fp["fang1"].y = cy
    if i < 32
      fp["fang1"].zoom_x = @targetSprite.zoom_x; fp["fang1"].zoom_y = @targetSprite.zoom_y
    end
    fp["fang2"].x = cx; fp["fang2"].y = cy
    if i < 32
      fp["fang2"].zoom_x = @targetSprite.zoom_x; fp["fang2"].zoom_y = @targetSprite.zoom_y
    end
    if i.between?(20,29)
      fp["fang1"].opacity += 5
      fp["fang1"].oy += 2
      fp["fang2"].opacity += 5
      fp["fang2"].oy += 2
    elsif i.between?(30,40)
      fp["fang1"].opacity += 25.5
      fp["fang1"].oy -= 4
      fp["fang2"].opacity += 25.5
      fp["fang2"].oy -= 4
    else
      fp["fang1"].opacity -= 26
      fp["fang1"].oy += 2
      fp["fang2"].opacity -= 26
      fp["fang2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Super Fang")
    end
    pbSEPlay("EBDX/Anim/psychic3") if i%8==0 && i>=48
    for n in 0...12
      next if i < 32
      if fp["#{n}"].opacity == 0 && fp["#{n}"].tone.gray == 0
        r2 = rand(4)
        fp["#{n}"].zoom_x = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].zoom_y = [0.2,0.25,0.5,0.75][r2]
        #fp["#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        fp["#{n}"].x = cx - 48*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["#{n}"].y = cy - 48*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["#{n}"].angle = -Math.atan(1.0*(fp["#{n}"].y-cy)/(fp["#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      next if m>(i-32)/4
      fp["#{n}"].opacity += 51 if fp["#{n}"].tone.gray == 0
      fp["#{n}"].angle += 180 if (i-16)%3==0
      fp["#{n}"].tone.gray = 1 if fp["#{n}"].opacity >= 255
      q += 1 if fp["#{n}"].opacity >= 255
      fp["#{n}"].opacity -= 10 if fp["#{n}"].tone.gray > 0 && q > 96
    end
    fp["bg"].opacity += 4 if  i < 40
    fp["bg"].opacity -= 10 if i >= 56
    @targetSprite.tone = Tone.new(100,80,60) if i == 32
    if i >= 32
      if (i-32)/3 > l
        m += 1
        m = 0 if m > 1
        l = (i-32)/3
      end
      @targetSprite.zoom_y -= 0.16*(m==0 ? 1 : -1)
      @targetSprite.zoom_x += 0.08*(m==0 ? 1 : -1)
      @targetSprite.tone.red -= 5 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 4 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 3 if @targetSprite.tone.blue > 0
      @targetSprite.still
    end
    @scene.wait(1,(i < 32))
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: PSYCHICTERRAIN.rb =====#
#-------------------------------------------------------------------------------
#  TRICKROOM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TRICKROOM) do
  EliteBattle.playMoveAnimation(:PSYCHICTERRAIN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  WONDERROOM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WONDERROOM) do
  EliteBattle.playMoveAnimation(:PSYCHICTERRAIN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MAGICROOM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MAGICROOM) do
  EliteBattle.playMoveAnimation(:PSYCHICTERRAIN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  PSYCHICTERRAIN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYCHICTERRAIN) do | args |
  beam, strike = *args; beam = false if beam.nil?; strike = false if strike.nil?
  factor = 2
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].create_rect(@viewport.width,@viewport.height,Color.white)
  fp["bg"].opacity = 0
  @userSprite.color = Color.new(201,52,218,0) if strike
  rndx = []
  rndy = []
  for i in 0...8
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb648_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  for i in 0...16
    fp["c#{i}"] = Sprite.new(@viewport)
    fp["c#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb648")
    fp["c#{i}"].ox = fp["c#{i}"].bitmap.width/2
    fp["c#{i}"].oy = fp["c#{i}"].bitmap.height/2
    fp["c#{i}"].opacity = 0
    fp["c#{i}"].z = 51
    rndx.push(0)
    rndy.push(0)
  end
  m = 0
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb648_3")
  fp["circle"].ox = fp["circle"].bitmap.width/4
  fp["circle"].oy = fp["circle"].bitmap.height/2
  fp["circle"].opacity = 0
  fp["circle"].src_rect.set(0,0,484,488)
  fp["circle"].z = 50
  fp["circle"].zoom_x = 0.5
  fp["circle"].zoom_y = 0.5
  # start animation
  #@vector.set(@scene.getRealVector(@userIndex, !@targetIsPlayer))
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...120
    pbSEPlay("EBDX/Anim/psychic4",[i+10, 100].max) if i%14 == 0
    pbSEPlay("Anim/Saint8") if i == 64
    cx, cy = @userSprite.getCenter
    for j in 0...8
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(96*factor)
        fp["#{j}"].x = cx - 96*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 96*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/8)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*(180.0/Math::PI)# + (rand{4}==0 ? 180 : 0)
      fp["#{j}"].mirror = !fp["#{j}"].mirror if i%2==0
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    for k in 0...16
      if fp["c#{k}"].opacity == 0
        r = rand(2)
        fp["c#{k}"].zoom_x = (r==0 ? 1 : 0.5)
        fp["c#{k}"].zoom_y = (r==0 ? 1 : 0.5)
        fp["c#{k}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        rndx[k] = cx - 48*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        rndy[k] = cy - 48*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
        fp["c#{k}"].x = cx
        fp["c#{k}"].y = cy
      end
      next if k>(i/4)
      x2 = rndx[k]
      y2 = rndy[k]
      x0 = fp["c#{k}"].x
      y0 = fp["c#{k}"].y
      fp["c#{k}"].x += (x2 - x0)*0.05
      fp["c#{k}"].y += (y2 - y0)*0.05
      fp["c#{k}"].opacity += 5
    end
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].opacity += 25.5
    if i < 35
      fp["circle"].zoom_x += 0.01
      fp["circle"].zoom_y += 0.01
    end
	if i >=35 && i < 85
      fp["circle"].zoom_x += 0.05
      fp["circle"].zoom_y += 0.05
	  fp["circle"].opacity += 25 if fp["circle"].opacity < 200
	  for k in 0...16
		fp["c#{k}"].opacity -= 10
	  end
    end
	if i >= 85
      fp["circle"].zoom_x += 0.1
      fp["circle"].zoom_y += 0.1
	  for k in 0...16
		fp["c#{k}"].opacity -= 10
	  end
	  fp["circle"].opacity -= 45 if i >= 100
    end
    m = 1 if i%4==0
    fp["circle"].src_rect.x = 484*m
    m = 0 if i%2==0
    if i < 96
      if strike
        fp["bg"].opacity += 10 if fp["bg"].opacity < 255
      else
        fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.75
      end
    else
      fp["bg"].opacity -= 10 if !beam && !strike
    end
    @userSprite.still if !strike
    @userSprite.anim = true if strike
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  if !beam && !strike
    @sprites["battlebg"].focus
    @vector.reset if !@multiHit
    10.times do
      @viewport.color.alpha -= 25.5
      @scene.wait(1,true)
    end
  end
end

#===== FILE: PSYCHOCUT.rb =====#
#-------------------------------------------------------------------------------
#  Psycho Cut
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYCHOCUT) do
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  distance_x = xt - xp
  distance_y = yp - yt
  @vector.set(vector2)
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  fp["blade"] = Sprite.new(@viewport)
  fp["blade"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_3")
  fp["blade"].ox = fp["blade"].bitmap.width/2
  fp["blade"].oy = fp["blade"].bitmap.height/2
  fp["blade"].x = cx
  fp["blade"].y = cy
  fp["blade"].zoom_x = factor
  fp["blade"].zoom_y = factor
  fp["blade"].z = @userIsPlayer ? 29 : 19
  fp["blade"].opacity = 0
  fp["blade"].color = Color.new(255,255,255,128)
  fp["blade2"] = Sprite.new(@viewport)
  fp["blade2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_3")
  fp["blade2"].ox = fp["blade2"].bitmap.width/2
  fp["blade2"].oy = fp["blade2"].bitmap.height/2
  fp["blade2"].x = cx
  fp["blade2"].y = cy
  fp["blade2"].zoom_x = factor
  fp["blade2"].zoom_y = factor
  fp["blade2"].z = @targetIsPlayer ? 29 : 19
  fp["blade2"].opacity = 0
  fp["blade2"].color = Color.new(255,255,255,128)
  for i in 0...96
    cx, cy = @userSprite.getCenter(true)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("EBDX/Anim/normal3",80) if i == 88
    pbSEPlay("EBDX/Anim/normal3",60) if i == 92
    pbSEPlay("EBDX/Anim/ground1",80) if i == 16
    pbSEPlay("Anim/fog2",90) if i == 16
    pbSEPlay("EBDX/Anim/psychic3",80) if i == 64
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
      fp["blade"].opacity += 16
      fp["blade"].angle += 8
      fp["blade"].color.alpha -= 8 if fp["blade"].color.alpha > 0
    else
      fp["blade"].angle += 8
      fp["blade"].opacity -= 16
      fp["blade"].x = cx
      fp["blade"].y = cy
      fp["blade2"].opacity += 32
      fp["blade2"].x = cx + (i-64)*distance_x/24.0
      fp["blade2"].y = cy - (i-64)*distance_y/24.0
      x2, y2 = @targetSprite.getCenter(true)
      x0 = fp["blade2"].x
      y0 = fp["blade2"].y
      fp["blade2"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + 180*(@targetIsPlayer ? 1 : 0) if i < 88
      fp["blade2"].zoom_x -= (@userSprite.zoom_x - @targetSprite.zoom_x)/32.0
      fp["blade2"].zoom_y -= (@userSprite.zoom_y - @targetSprite.zoom_y)/32.0
      if !@targetIsPlayer
        fp["blade2"].z = @targetSprite.z - 1 if x0 > x2 && y0 < y2
      else
        fp["blade2"].z = @targetSprite.z + 1 if x0 < x2 && y0 > y2
      end
    end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: PSYCHOSHIFT.rb =====#
#-------------------------------------------------------------------------------
#  PSYCHOSHIFT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYCHOSHIFT) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["change1"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_5"))
  fp["change1"].keyFrame = 1
  fp["change1"].z = @targetSprite.z + 1
  fp["change2"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_5"))
  fp["change2"].keyFrame = 1
  fp["change2"].z = @userSprite.z + 1
  # shooting out the change1
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["change1"].x = points[i][0]
    fp["change1"].y = points[i][1]
    z = 1 + (1-(fp["change1"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change1"].zoom_x = z
    fp["change1"].zoom_y = z
    fp["change1"].update
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxT,cyT,mx,32,cxP,cyP,24)
    fp["change2"].x = points[i][0]
    fp["change2"].y = points[i][1]
    z = 1 + (1-(fp["change2"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change2"].zoom_x = z
    fp["change2"].zoom_y = z
    fp["change2"].update
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  pbSEPlay("Anim/Saint7")
  @targetSprite.color = Color.new(253,161,255,0)
  @userSprite.color = Color.new(253,161,255,0)
  fp["change1"].dispose
  fp["change2"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha += 18
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_6")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  for j in 0...32
    fp["p2#{j}"] = Sprite.new(@viewport)
    fp["p2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_6")
    fp["p2#{j}"].center!
    fp["p2#{j}"].x, fp["p2#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p2#{j}"].end_x = fp["p2#{j}"].x - r + x
    fp["p2#{j}"].end_y = fp["p2#{j}"].y - r + y
    fp["p2#{j}"].zoom_x = 0
    fp["p2#{j}"].zoom_y = 0
    fp["p2#{j}"].angle = rand(360)
    fp["p2#{j}"].z = @userSprite.z + 1
  end
  # sparkle animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
	  
	  fp["p2#{j}"].zoom_x += (1.6 - fp["p2#{j}"].zoom_x)*0.1
      fp["p2#{j}"].zoom_y += (1.6 - fp["p2#{j}"].zoom_y)*0.1
      fp["p2#{j}"].x += (fp["p2#{j}"].end_x - fp["p2#{j}"].x)*0.1
      fp["p2#{j}"].y += (fp["p2#{j}"].end_y - fp["p2#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
	  if fp["p2#{j}"].zoom_x >= 1
        fp["p2#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
      fp["p2#{j}"].color.alpha -= 8
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha -= 16 if i >= 48
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: PSYCHUP.rb =====#
#-------------------------------------------------------------------------------
#  PSYCHUP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYCHUP) do
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @vector.set(vector2)
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(223,55,255))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/Saint4",80) if i == 8
    pbSEPlay("Anim/Psych Up",90) if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: PSYSTRIKE.rb =====#
#-------------------------------------------------------------------------------
#  PSYSHOCK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYSHOCK) do
  EliteBattle.playMoveAnimation(:PSYSTRIKE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  PSYSTRIKE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYSTRIKE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_5")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_5")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_3") #dragondance
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")#keep
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(242,51,255,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12 #keep
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("EBDX/Anim/psychic3",60) #change
  pbSEPlay("Anim/Psych Up",60) #change
  @sprites["battlebg"].defocus
  for i in 0...10
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/psychic4",80) #change
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_7")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_1")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_5")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/normal2",80) if i == 8 || i == 16 || i == 24 # keep
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: PSYWAVE.rb =====#
#-------------------------------------------------------------------------------
#  PSYWAVE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PSYWAVE) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_7")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
	pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: QUICKATTACK.rb =====#
#-------------------------------------------------------------------------------
#  EXTREMESPEED
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:EXTREMESPEED) do | args |
  EliteBattle.playMoveAnimation(:QUICKATTACK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  QUICKATTACK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:QUICKATTACK) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/move1",80) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playMoveAnimation(:TACKLE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: RAGE.rb =====#
#-------------------------------------------------------------------------------
#  RAGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RAGE) do
    fp = {}
  # set up animation
  @scene.wait(5,true)
  EliteBattle.playMoveAnimation(:DRAGONDANCE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_2")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_3")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(41,145,182,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  #animation
  for i in 0...50
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i*3)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    for j in 0...50
      next if j>(i*3)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: RAGEPOWDER.rb =====#
#-------------------------------------------------------------------------------
#  ACID
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ACID) do
  EliteBattle.playMoveAnimation(:RAGEPOWDER, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  ACIDSPRAY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ACIDSPRAY) do
  EliteBattle.playMoveAnimation(:RAGEPOWDER, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  GASTROACID
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:GASTROACID) do
  EliteBattle.playMoveAnimation(:RAGEPOWDER, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  RAGEPOWDER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RAGEPOWDER) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_10")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(255,84,84,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: RAINDANCE.rb =====#
#-------------------------------------------------------------------------------
#  RAINDANCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RAINDANCE) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["weatherball"] = Sprite.new(@viewport)
  fp["weatherball"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_4")
  fp["weatherball"].ox = fp["weatherball"].bitmap.width/2
  fp["weatherball"].oy = fp["weatherball"].bitmap.height/2
  fp["weatherball"].z = 50
  fp["weatherball"].x, fp["weatherball"].y = @userSprite.getCenter
  fp["weatherball"].opacity = 0
  fp["weatherball"].zoom_x = factor*1.4
  fp["weatherball"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_2")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Bubble2")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].zoom_x -= factor*0.4/10
    fp["weatherball"].zoom_y -= factor*0.4/10
    fp["weatherball"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  10.times do
    fp["weatherball"].zoom_x += factor*0.4/10
    fp["weatherball"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["weatherball"].zoom_y -= factor*0.02
    elsif
      fp["weatherball"].zoom_x -= factor*0.02
      fp["weatherball"].zoom_y += factor*0.04
    end
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying1") if i == 10
  end
  for i in 0...20
    fp["weatherball"].y -= 32
    fp["weatherball"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end
#===== FILE: RAPIDSPIN.rb =====#
#-------------------------------------------------------------------------------
#  RAPIDSPIN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RAPIDSPIN) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(200,200,200))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_9")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_8")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...72#96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/Psych Up",90) if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  EliteBattle.playMoveAnimation(:COMETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: RAZORLEAF.rb =====#
#-------------------------------------------------------------------------------
#  RAZORLEAF
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RAZORLEAF) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = 50
    rndx.push(rand(256)); prndx.push(rand(72))
    rndy.push(rand(256)); prndy.push(rand(72))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 1 : 1.5)*0.5
  fp["cir"].zoom_y = (@targetIsPlayer ? 1 : 1.5)*0.5
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb191_3")
    fp["#{i}s"].ox = fp["#{i}s"].bitmap.width/2
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height + 8*factor
    fp["#{i}s"].angle = rand(360)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.5 : 1)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.5 : 1)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  k = 0
  # start animation
  @vector.set(vector2)
  @sprites["battlebg"].defocus
  for i in 0...30
    if i < 10
      #fp["bg"].opacity += 25.5
    elsif i < 20
      #fp["bg"].color.alpha -= 25.5
    else
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 16*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 25.5
      fp["cir"].zoom_x += (@targetIsPlayer ? 1 : 1.5)*0.05
      fp["cir"].zoom_y += (@targetIsPlayer ? 1 : 1.5)*0.05
      k += 1 if i%4==0; k = 0 if k > 1
      fp["cir"].tone = [Tone.new(0,0,0),Tone.new(155,155,155)][k]
    end
    pbSEPlay("EBDX/Anim/grass2") if i == 20
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/wind1",90)
  for i in 0...96
    pbSEPlay("EBDX/Anim/grass1",60) if i%3==0 && i < 64
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += rangl[j]*2
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].opacity -= 51 if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 51 if nextx < cx && nexty > cy
      end
    end
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 16*(@userIsPlayer ? -1 : 1)
    fp["cir"].opacity -= (i>=72) ? 51 : 2
    k += 1 if i%4==0; k = 0 if k > 1
    fp["cir"].tone = [Tone.new(0,0,0),Tone.new(155,155,155)][k]
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].oy +=6*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = @userSprite.getCenter
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: RAZORSHELL.rb =====#
#-------------------------------------------------------------------------------
#  RAZORSHELL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RAZORSHELL) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  rndx = []
  rndy = []
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,75,131))
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_7")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb540_4")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  pbSEPlay("Anim/Bubble2",75)
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..20
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	cx, cy = @targetSprite.getCenter(true)
	for k in 0...16
		next if i < 4
		if j == 0 && i == 6
			fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
			fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
			@targetSprite.still if k.between?(flashStart,flashStart+2)
			@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
			@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
			@scene.wait(1,true)
			pbSEPlay("EBDX/Anim/normal3",100) if k == 4
			fp["claw"].src_rect.height += 15
			fp["claw"].opacity -= 45 if k >= 5
			j = 1 if k == 15		
		end
		#
		if fp["#{k}"].opacity == 0 && fp["#{k}"].visible
			fp["#{k}"].x = cx
			fp["#{k}"].y = cy
		end
		x2 = cx - 64*@targetSprite.zoom_x + rndx[k]*@targetSprite.zoom_x
		y2 = cy - 64*@targetSprite.zoom_y + rndy[k]*@targetSprite.zoom_y
		x0 = fp["#{k}"].x
		y0 = fp["#{k}"].y
		fp["#{k}"].x += (x2 - x0)*0.2
		fp["#{k}"].y += (y2 - y0)*0.2
		fp["#{k}"].zoom_x += 0.01
		fp["#{k}"].zoom_y += 0.01
		if i < 20
			fp["#{k}"].tone.red -= 6; fp["#{k}"].tone.blue -= 6; fp["#{k}"].tone.green -= 6
		end
		if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
			fp["#{k}"].opacity -= 51
		else
			fp["#{k}"].opacity += 51
		end
		fp["#{k}"].visible = false if fp["#{k}"].opacity <= 0
		#
	end
	@scene.wait(1,true)
  end
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: RAZORWIND.rb =====#
#-------------------------------------------------------------------------------
#  RAZORWIND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RAZORWIND) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:RAZORWIND_CHARGE, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:HURRICANE, @scene, @userIndex, @targetIndex)
  end
end
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RAZORWIND_CHARGE) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  numElements = 3
  for i in 0...numElements
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb637")
    fp["#{i}"].src_rect.set(0,128*rand(3),64,128)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    fp["#{i}"].z += 5
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...80
    ax, ay = @userSprite.getAnchor
    cx, cy = @userSprite.getCenter(true)
    for j in 0...numElements
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@userSprite.zoom_x + rndx[j]*@userSprite.zoom_x
      y2 = cy - 32*@userSprite.zoom_y + rndy[j]*@userSprite.zoom_y + 50*@userSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @userSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @userSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 64 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 12
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 10
      end
    end
    pbSEPlay("Anim/Wind8",80) if i%24==0 && i <= 60
    if i >= 50
      @userSprite.ox += shake
      shake = -2 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 2 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
      @userSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @userSprite.ox += shake
    shake = -2 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
    shake = 2 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    @userSprite.still
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: RECOVER.rb =====#
#-------------------------------------------------------------------------------
#  Recover
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RECOVER) do
  # set up animation
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb195")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  k = 0
  c = [Tone.new(211,186,3),Tone.new(0,0,0)]
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...128
    cx, cy = @userSprite.getCenter
    for j in 0...12
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        x, y = randCircleCord(64*factor)
        fp["#{j}"].x = cx - 64*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 64*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    if i < 96
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.6
    else
      fp["bg"].opacity -= 5
    end
    if i < 112
      if i%16 == 0
        k += 1
        k = 0 if k > 1
      end
      @userSprite.tone.red += (c[k].red - @userSprite.tone.red)*0.2
      @userSprite.tone.green += (c[k].green - @userSprite.tone.green)*0.2
      @userSprite.tone.blue += (c[k].blue - @userSprite.tone.blue)*0.2
    end
    pbSEPlay("Anim/Absorb2",100) if i == 16
    pbSEPlay("Anim/Saint8",70) if i == 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.tone = Tone.new(0,0,0)
  @vector.reset
  pbDisposeSpriteHash(fp)
 end
#===== FILE: RECYCLE.rb =====#
#-------------------------------------------------------------------------------
#  CAMOUFLAGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CAMOUFLAGE) do
  EliteBattle.playMoveAnimation(:RECYCLE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  RECYCLE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RECYCLE) do
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @vector.set(vector2)
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(51,161,54))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_5")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_4")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/Saint4",80) if i == 8
    pbSEPlay("Anim/Psych Up",90) if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: REFLECT.rb =====#
#-------------------------------------------------------------------------------
#  FLOWERSHIELD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLOWERSHIELD) do
  EliteBattle.playMoveAnimation(:REFLECT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  REFLECT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:REFLECT) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb604")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @targetIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 5
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
    if i.between?(7,11)
      #@targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: REFRESH.rb =====#
#-------------------------------------------------------------------------------
#  REFRESH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:REFRESH) do
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @vector.set(vector2)
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(161,156,34))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_7")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_6")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/Saint4",80) if i == 8
    pbSEPlay("Anim/Psych Up",90) if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: RETALIATE.rb =====#
#-------------------------------------------------------------------------------
#  RETALIATE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RETALIATE) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..11
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...16
	    fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
	    fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
		@targetSprite.still if k.between?(flashStart,flashStart+2)
		@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
		@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
		@scene.wait(1,true)
		pbSEPlay("EBDX/Anim/normal3",85) if k == 4
		fp["claw"].src_rect.height += 60
		fp["claw"].opacity -= 60 if k >= 5
		@scene.wait(1,true)
	  end
	  j = 1
	end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: ROAR.rb =====#
#-------------------------------------------------------------------------------
#  ROAR
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROAR) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...12
    @userSprite.still
	 pbSEPlay("Cries/#{@userSprite.species}",100) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROAROFTIME.rb =====#
#-------------------------------------------------------------------------------
#  ROAROFTIME
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROAROFTIME) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  rndx = [[],[]]; rndy = [[],[]]
  dx = [[],[]]; dy = [[],[]]
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb536_bg_2")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  string = ["eb612_8","eb000"]
  rop = [255,80,40,135]
  px = []
  py = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for m in 0...2
    for i in 0...20
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      bmp = pbBitmap("Graphics/EBDX/Animations/Moves/"+string[m])
      fp["#{i}#{m}"].bitmap = Bitmap.new(bmp.width,bmp.height)
      fp["#{i}#{m}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height),(m==0 ? rop[rand(4)] : 255))
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].opacity = 0
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      fp["#{i}#{m}"].zoom_x = [0.5,1][m]
      fp["#{i}#{m}"].zoom_y = [0.5,1][m]
      rndx[m].push(rand(16))
      rndy[m].push(rand(16))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  k = 1
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Psych Up",80)
  @scene.wait(4,true)
  for i in 0...96
    pbSEPlay("Anim/Psych Up") if i%24 == 0
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...20
        if fp["#{j}#{m}"].opacity == 0
          dx[m][j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
        end
        next if j>(i/4)
        x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        x0 = dx[m][j]
        y0 = dy[m][j]
        fp["#{j}#{m}"].x += (x2 - x0)*0.04*(m+1)
        fp["#{j}#{m}"].y += (y2 - y0)*0.04*(m+1)
        fp["#{j}#{m}"].zoom_x += (1 - fp["#{j}#{m}"].zoom_x)*0.1
        fp["#{j}#{m}"].zoom_y += (1 - fp["#{j}#{m}"].zoom_y)*0.1
        fp["#{j}#{m}"].opacity += 51
        fp["#{j}#{m}"].angle += 8*(m+1)*j
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          fp["#{j}#{m}"].visible = false if nextx > cx && nexty < cy
        else
          fp["#{j}#{m}"].visible = false if nextx < cx && nexty > cy
        end
      end
    end
    for l in 0...12
      next if i < 12
      next if l>((i-12)/4)
      if fp["p#{l}"].opacity <= 0
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(128)
        px[l] = cx - 128*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 128*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(vector) if i == 64
    @vector.inc = 0.1 if i == 64
    fp["bg"].update
    if i < 64
      k*=-1 if i%4==0
      @scene.moveEntireScene(0,k*4,true,true)
    end
    #pbSEPlay("Anim/Water1") if i == 84
    if i.between?(85,90)
      @targetSprite.zoom_x += 0.01
      @targetSprite.zoom_y -= 0.04
    elsif i.between?(91,96)
      @targetSprite.zoom_x -= 0.01
      @targetSprite.zoom_y += 0.04
    end
    @scene.wait(1,(i>=64 && i<85))
  end
  for j in 0...20; for m in 0...2; fp["#{j}#{m}"].visible = false; end; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROCKBLAST.rb =====#
#-------------------------------------------------------------------------------
#  ROCKBLAST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROCKBLAST) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(175,118,80))
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...20
    fp["#{i}2"] = Sprite.new(@viewport)
	if i%2 == 0
		fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504") 
	else
		fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")
	end
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 12
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Whirlwind")
  for i in 0...40
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...20
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 30
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("EBDX/Anim/rock2") if i%10 == 0
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>35) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 20
    @vector.inc = 0.1 if i == 20
    @scene.wait(1,true)
  end
  fp["172"].dispose
  fp["182"].dispose
  fp["192"].dispose
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      #fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROCKCLIMB.rb =====#
#-------------------------------------------------------------------------------
#  ROCKCLIMB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROCKCLIMB) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg_7")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...16
    fp["bg"].opacity += 32 if i >= 8
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(182,74,41,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  #animation
  for i in 0...50
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i*3)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal1",80) if i%4==0 && i < 16
    for j in 0...50
      next if j>(i*3)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].color.alpha += 16
    fp["bg"].opacity -= 16
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROCKPOLISH.rb =====#
#-------------------------------------------------------------------------------
#  WISH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WISH) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(175,118,80))
  fp["bg"].opacity = 0
  #
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  pbSEPlay("Anim/Swords Dance",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROCKSLIDE.rb =====#
#-------------------------------------------------------------------------------
#  Rockslide
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROCKSLIDE) do
  indexes = []
  max = @battle.pbSideSize(@targetIsPlayer ? 0 : 1)
  for i in 0...max
    i = (@targetIsPlayer ? i*2 : (i*2 + 1))
    indexes.push(i) if @sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].actualBitmap
  end
  vector = @scene.battle.doublebattle? ? EliteBattle.get_vector(:BATTLER, @targetIsPlayer) : @scene.getRealVector(@targetIndex, @targetIsPlayer)
  @vector.set(vector)
  @scene.wait(16, true)
  # set up animation
  dy = @vector.y2/12
  fp = {}; da = []; factors = []
  for m in 0...indexes.length
    @targetSprite = @sprites["pokemon_#{indexes[m]}"]
    if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
      factors.push(1)
      next
    end
    factors.push(@targetSprite.zoom_x)
  end
  for m in 0...indexes.length
    @targetSprite = @sprites["pokemon_#{indexes[m]}"]
    next if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
    for j in 0...96
      fp["r#{m}#{j}"] = Sprite.new(@viewport)
      fp["r#{m}#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504")
      fp["r#{m}#{j}"].ox = fp["r#{m}#{j}"].bitmap.width/2
      fp["r#{m}#{j}"].oy = fp["r#{m}#{j}"].bitmap.height/2
      r = 64*factors[m]
      z = [1,0.5,0.75,0.25][rand(4)]
      fp["r#{m}#{j}"].zoom_x = z
      fp["r#{m}#{j}"].zoom_y = z
      fp["r#{m}#{j}"].x = @targetSprite.x - r + rand(r*2)
      fp["r#{m}#{j}"].y = rand(32*factors[m])
      fp["r#{m}#{j}"].visible = false
      fp["r#{m}#{j}"].angle = rand(360)
      fp["r#{m}#{j}"].z = @targetSprite.z + 1
      da.push(rand(2)==0 ? 1 : -1)
    end
    width = @targetSprite.bitmap.width/2 - 16
    max = 16# + (width/16)
    for j in 0...max
      fp["d#{m}#{j}"] = Sprite.new(@viewport)
      fp["d#{m}#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/ebDustParticle")
      fp["d#{m}#{j}"].ox = fp["d#{m}#{j}"].bitmap.width/2
      fp["d#{m}#{j}"].oy = fp["d#{m}#{j}"].bitmap.height/2
      fp["d#{m}#{j}"].opacity = 0
      fp["d#{m}#{j}"].angle = rand(360)
      fp["d#{m}#{j}"].x = @targetSprite.x - width*factors[m] + rand(width*2*factors[m])
      fp["d#{m}#{j}"].y = @targetSprite.y - 16*factors[m] + rand(32*factors[m])
      fp["d#{m}#{j}"].z = @targetSprite.z + (fp["d#{m}#{j}"].y < @targetSprite.y ? -1 : 1)
      zoom = [1,0.8,0.9,0.7][rand(4)]
      fp["d#{m}#{j}"].zoom_x = zoom*factors[m]
      fp["d#{m}#{j}"].zoom_y = zoom*factors[m]
    end
  end
  k = [-1,-1]
  # start animation
  for i in 0...80
    pbSEPlay("EBDX/Anim/rock2",70) if i%8==0
    for m in 0...indexes.length
      @targetSprite = @sprites["pokemon_#{indexes[m]}"]
      next if !@targetSprite || @targetSprite.disposed? || @targetSprite.fainted || !@targetSprite.visible
      for j in 0...96
        next if j>(i*2)
        fp["r#{m}#{j}"].y += dy
        fp["r#{m}#{j}"].visible = fp["r#{m}#{j}"].y < @targetSprite.y - 16*factors[m]
        fp["r#{m}#{j}"].angle += 8*da[j]
      end
      for j in 0...max
        next if i < 8
        next if j>(i-8)/2
        fp["d#{m}#{j}"].opacity += 25.5 if i < 18+j*2
        fp["d#{m}#{j}"].opacity -= 25.5 if i >= 22+j*2
        if fp["d#{m}#{j}"].x >= @targetSprite.x
          fp["d#{m}#{j}"].angle += 4
          fp["d#{m}#{j}"].x += 2
        else
          fp["d#{m}#{j}"].angle -= 4
          fp["d#{m}#{j}"].x -= 2
        end
      end
      if i >= 8 && i < 64
        k[m] *= -1 if i%4==0
        @targetSprite.zoom_y -= 0.04*k[m]*factors[m]
        @targetSprite.zoom_x += 0.02*k[m]*factors[m]
        @targetSprite.still
      end
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROCKSMASH.rb =====#
#-------------------------------------------------------------------------------
#  ROCKSMASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROCKSMASH) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  @multiHit = true
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playCommonAnimation(:ROCKSPLASH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @multiHit = false
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROCKTHROW.rb =====#
#-------------------------------------------------------------------------------
#  ROCKTOMB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROCKTOMB) do
  EliteBattle.playMoveAnimation(:ROCKTHROW, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ROCKTHROW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROCKTHROW) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(12, true)
  # set up animation
  dy = @vector.y2/12
  fp = {}; da = []; 
  if @targetIsPlayer
	factors = 2
  else
	factors = 1
  end	
  stones = 20
  for j in 0...stones
      fp["r#{j}"] = Sprite.new(@viewport)
      fp["r#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504")
      fp["r#{j}"].ox = fp["r#{j}"].bitmap.width/2
      fp["r#{j}"].oy = fp["r#{j}"].bitmap.height/2
	  r = 64*factors
      z = [1,0.5,0.75,0.25][rand(4)]
      fp["r#{j}"].zoom_x = z
      fp["r#{j}"].zoom_y = z
      fp["r#{j}"].x = @targetSprite.x - r + rand(r*2)
      fp["r#{j}"].y = rand(32*factors)
      fp["r#{j}"].visible = false
      fp["r#{j}"].angle = rand(360)
      fp["r#{j}"].z = @targetSprite.z + 1
      da.push(rand(2)==0 ? 1 : -1)
    end
    width = @targetSprite.bitmap.width/2 - 16
    max = 16# + (width/16)
    for j in 0...max
      fp["d#{j}"] = Sprite.new(@viewport)
      fp["d#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/ebDustParticle")
      fp["d#{j}"].ox = fp["d#{j}"].bitmap.width/2
      fp["d#{j}"].oy = fp["d#{j}"].bitmap.height/2
      fp["d#{j}"].opacity = 0
      fp["d#{j}"].angle = rand(360)
      fp["d#{j}"].x = @targetSprite.x - width*factors + rand(width*2*factors)
      fp["d#{j}"].y = @targetSprite.y - 16*factors + rand(32*factors)
      fp["d#{j}"].z = @targetSprite.z + (fp["d#{j}"].y < @targetSprite.y ? -1 : 1)
      zoom = [1,0.8,0.9,0.7][rand(4)]
      fp["d#{j}"].zoom_x = zoom*factors
      fp["d#{j}"].zoom_y = zoom*factors
    end
  # start animation
  for i in 0...30
    pbSEPlay("EBDX/Anim/rock2",70) if i%8==0
      for j in 0...stones
        next if j>(i*2)
        fp["r#{j}"].y += dy
        fp["r#{j}"].visible = fp["r#{j}"].y < @targetSprite.y - 16*factors
        fp["r#{j}"].angle += 8*da[j]
      end
      for j in 0...max
        next if i < 8
        next if j>(i-8)/2
        fp["d#{j}"].opacity += 25.5 if i < 18+j*2
        fp["d#{j}"].opacity -= 25.5 if i >= 22+j*2
        if fp["d#{j}"].x >= @targetSprite.x
          fp["d#{j}"].angle += 4
          fp["d#{j}"].x += 2
        else
          fp["d#{j}"].angle -= 4
          fp["d#{j}"].x -= 2
        end
      end
      if i >= 8 && i < 15
        @targetSprite.zoom_y -= 0.04*factors
        @targetSprite.zoom_x += 0.02*factors
        @targetSprite.still
      end
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROLLOUT.rb =====#
#-------------------------------------------------------------------------------
#  ROLLOUT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROLLOUT) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(161,117,52))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_13")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_12")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...72#96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/rock1",90) if i%24 == 0#if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  EliteBattle.playCommonAnimation(:ROCKSPLASH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROOST.rb =====#
#-------------------------------------------------------------------------------
#  ROOST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROOST) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(64,64,64))
  fp["bg"].opacity = 0
  #
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb164")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: ROUND.rb =====#
#-------------------------------------------------------------------------------
#  ROUND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ROUND) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_3")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SACREDFIRE.rb =====#
#-------------------------------------------------------------------------------
#  SACREDFIRE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SACREDFIRE) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(239,246,142))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136_4")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Fire2",80) if i%12==0 && i <= 96
    pbSEPlay("Anim/Smokescreen",120) if i==84
    if i >= 96
      @targetSprite.tone.red += 2.4*2 if @targetSprite.tone.red < 48*2
      @targetSprite.tone.green -= 1.2*2 if @targetSprite.tone.green > -24*2
      @targetSprite.tone.blue -= 2.4*2 if @targetSprite.tone.blue > -48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 2.4*2
    @targetSprite.tone.green += 1.2*2
    @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SAFEGUARD.rb =====#
#-------------------------------------------------------------------------------
#  COTTONGUARD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:COTTONGUARD) do
  EliteBattle.playMoveAnimation(:SAFEGUARD, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SAFEGUARD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SAFEGUARD) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb605_2")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @targetIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 5
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
    if i.between?(7,11)
      #@targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: SANDSTORM.rb =====#
#-------------------------------------------------------------------------------
#  SANDSTORM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SANDSTORM) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["weatherball"] = Sprite.new(@viewport)
  fp["weatherball"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_6")
  fp["weatherball"].ox = fp["weatherball"].bitmap.width/2
  fp["weatherball"].oy = fp["weatherball"].bitmap.height/2
  fp["weatherball"].z = 50
  fp["weatherball"].x, fp["weatherball"].y = @userSprite.getCenter
  fp["weatherball"].opacity = 0
  fp["weatherball"].zoom_x = factor*1.4
  fp["weatherball"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_8")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Earth4")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].zoom_x -= factor*0.4/10
    fp["weatherball"].zoom_y -= factor*0.4/10
    fp["weatherball"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  10.times do
    fp["weatherball"].zoom_x += factor*0.4/10
    fp["weatherball"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["weatherball"].zoom_y -= factor*0.02
    elsif
      fp["weatherball"].zoom_x -= factor*0.02
      fp["weatherball"].zoom_y += factor*0.04
    end
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying1") if i == 10
  end
  for i in 0...20
    fp["weatherball"].y -= 32
    fp["weatherball"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end
#===== FILE: SANDTOMB.rb =====#
#-------------------------------------------------------------------------------
#  SANDTOMB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SANDTOMB) do
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(144,116,101))
  fp["bg"].opacity = 0
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  16.times do
    fp["bg"].opacity += 8
    @scene.wait(1,true)
  end
  # set up animation
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  y0 = @targetSprite.y
  x = [cx - 64*factor, cx + 64*factor, cx]
  y = [y0, y0, y0 + 24*factor]
  dx = []
  for k in 0...3
    fp["f#{k}"] = Sprite.new(@viewport)
    fp["f#{k}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb224_2")
    fp["f#{k}"].ox = fp["f#{k}"].bitmap.width/2
    fp["f#{k}"].oy = fp["f#{k}"].bitmap.height
    fp["f#{k}"].zoom_x = factor + 0.25
    fp["f#{k}"].zoom_y = 0
    fp["f#{k}"].x = x[k]
    fp["f#{k}"].y = y[k]
    fp["f#{k}"].z = @targetSprite.z
    for m in 0...16
      fp["p#{k}#{m}"] = Sprite.new(@viewport)
      fp["p#{k}#{m}"].bitmap = Bitmap.new(8,8)
      fp["p#{k}#{m}"].ox = 4
      fp["p#{k}#{m}"].oy = 4
      c = [Color.new(139,7,7),Color.new(239,90,1)][rand(2)]
      fp["p#{k}#{m}"].bitmap.bmp_circle(c)
      fp["p#{k}#{m}"].visible = false
      z = [1,0.5,0.75,0.25][rand(4)]
      fp["p#{k}#{m}"].zoom_x = z
      fp["p#{k}#{m}"].zoom_y = z
      fp["p#{k}#{m}"].x = x[k] - 16 + rand(32)
      fp["p#{k}#{m}"].y = y[k] - rand(32)
      fp["p#{k}#{m}"].z = @targetSprite.z + 1
      dx.push((rand(2)==0 ? 1 : -1)*2)
    end
  end
  # start animation
  for k in 0...3
    @scene.wait(8,true)
    j = -1
    l = 6
    pbSEPlay("EBDX/Anim/rock1",80)
    pbSEPlay("Anim/Earth4",50,50)
    for i in 0...24
      j *= -1 if i%4==0
      l -= 2 if i%8==0
      fp["f#{k}"].zoom_x -= 0.1 if fp["f#{k}"].zoom_x > 0
      fp["f#{k}"].zoom_y += 0.3
      fp["f#{k}"].opacity -= 24
      @scene.moveEntireScene(0, j*l, true, true) if i < 16
      for m in 0...16
        next if m>(i*2)
        fp["p#{k}#{m}"].visible = true
        fp["p#{k}#{m}"].y -= 16
        fp["p#{k}#{m}"].x += dx[m]
        fp["p#{k}#{m}"].opacity -= 16
      end
      @scene.wait
    end
  end
  16.times do
    fp["bg"].opacity -= 8
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: SCALD.rb =====#
#-------------------------------------------------------------------------------
#  SCALD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SCALD) do
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(2,true)
  EliteBattle.playMoveAnimation(:WATERGUN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(1,true)
  EliteBattle.playCommonAnimation(:BURN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SCARYFACE.rb =====#
#-------------------------------------------------------------------------------
#  SNATCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SNATCH) do
  EliteBattle.playMoveAnimation(:SCARYFACE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MIRACLEEYE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MIRACLEEYE) do
  EliteBattle.playMoveAnimation(:SCARYFACE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  MINDREADER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MINDREADER) do
  EliteBattle.playMoveAnimation(:SCARYFACE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SCARYFACE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SCARYFACE) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(5,true)
  fp = {}
  cx, cy = @userSprite.getCenter(true)
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #eyes
  fp["l"] = Sprite.new(@viewport)
  fp["l"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_5")
  fp["l"].ox = fp["l"].bitmap.width/2
  fp["l"].oy = fp["l"].bitmap.height/2
  if @userIsPlayer
	# fp["l"].x = 212
    # fp["l"].y = 245
	fp["l"].x = cx + 100
    fp["l"].y = cy - 50
  else 
	# fp["l"].x = 230
    # fp["l"].y = 200	
	fp["l"].x = cx - 65
    fp["l"].y = cy + 58
  end
  fp["l"].opacity = 0
  fp["l"].z = 29#(@userIsPlayer ? 29 : 19)
  fp["r"] = Sprite.new(@viewport)
  fp["r"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_5")
  fp["r"].ox = fp["r"].bitmap.width/2
  fp["r"].oy = fp["r"].bitmap.height/2
  if @userIsPlayer
  # fp["r"].x = cx + @userSprite.width/2 + 90
  # fp["r"].y = cy - @userSprite.height/2 - 5
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  else 
	fp["r"].x = fp["l"].x + 40
    fp["r"].y = fp["l"].y
  end
  fp["r"].opacity = 0
  fp["r"].z = 29#(@userIsPlayer ? 29 : 19)
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...19
	pbSEPlay("Anim/ScaryFace",95) if i == 5
    @userSprite.still
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
	if i.between?(2,10)
		fp["l"].opacity += 20
		fp["r"].opacity += 20
	end
	if i.between?(11,19)
		fp["l"].opacity -= 20
		fp["r"].opacity -= 20
	end	
	fp["l"].angle += 15
	fp["r"].angle += 15
	if i.between?(2,10)
		if i%2==0
			fp["l"].zoom_x += 1
			fp["l"].zoom_y += 1
			fp["r"].zoom_x += 1
			fp["r"].zoom_y += 1
		end
		fp["l"].tone.red += 10
		fp["l"].tone.green += 10
		fp["l"].tone.blue += 10
		fp["r"].tone.red += 10
		fp["r"].tone.green += 10
		fp["r"].tone.blue += 10
	end
	if i.between?(11,19)
		if i%2==1
			fp["l"].zoom_x -= 1
			fp["l"].zoom_y -= 1
			fp["r"].zoom_x -= 1
			fp["r"].zoom_y -= 1
		end
		fp["l"].tone.red -= 10
		fp["l"].tone.green -= 10
		fp["l"].tone.blue -= 10
		fp["r"].tone.red -= 10
		fp["r"].tone.green -= 10
		fp["r"].tone.blue -= 10
	end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SCRATCH.rb =====#
#-------------------------------------------------------------------------------
#  Shadow Claw
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SCRATCH) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb601")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...32
		pbSEPlay("EBDX/Anim/normal3",85) if k == 4
		fp["claw"].src_rect.height += 20
		fp["claw"].opacity -= 32 if k >= 16
		@scene.wait(1,true)
	  end
	  j = 1
	end
    if i.between?(7,11)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: SCREECH.rb =====#
#-------------------------------------------------------------------------------
#  SCREECH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SCREECH) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_2")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
	pbSEPlay("Cries/#{@userSprite.species}",100) if i == 5
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SEEDBOMB.rb =====#
#-------------------------------------------------------------------------------
#  SEEDBOMB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SEEDBOMB) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  factor = @targetSprite.zoom_x
  dx = []
  dy = []
  fp = {}
  fp["bomb"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb223"))
  fp["bomb"].keyFrame = 1
  fp["bomb"].z = @targetSprite.z + 1
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  # shooting out the bomb
  for i in 0...24
	pbSEPlay("Anim/throw") if i == 5
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["bomb"].x = points[i][0]
    fp["bomb"].y = points[i][1]
    z = 1 + (1-(fp["bomb"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["bomb"].zoom_x = z *2
    fp["bomb"].zoom_y = z *2
    fp["bomb"].update
	if i.between?(16,8)
		@targetSprite.color.alpha += 18
		@targetSprite.anim = true
		@targetSprite.still
	end
    @scene.wait(1,true)
  end
  @targetSprite.color = Color.new(74,4,4,0)
  fp["bomb"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...24
    fp["#{j}"] = Sprite.new(@viewport)
	if rand(0..1)==0
		fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010")
	else
		fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010_2")
	end
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # rest of the particles
  for i in 0...48
	pbSEPlay("Anim/Explosion1",100) if i%8 == 0
    for j in 0...24
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
		fp["#{j}"].color.alpha += rand(-50..50)
      end
    end
    @scene.wait
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: SHADOWBALL.rb =====#
#-------------------------------------------------------------------------------
#  Shadow Ball
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SHADOWBALL) do
  x1, y1 = @targetSprite.getCenter(true)
  x2, y2 = @userSprite.getCenter(true)
  if @targetIsPlayer
    cx = x1 + (x2 - x1)*0.65
    cy = y1 - (y1 - y2)*0.65
  else
    cx = x2 + (x1 - x2)*0.5
    cy = y2 - (y2 - y1)*0.5
  end
  fp = {}
  for j in 0...16
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb175_2")
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].opacity = 0
    fp["p#{j}"].z = 20
  end
  for j in 0...32
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb175_1")
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].angle = rand(360)
    fp["c#{j}"].ox = 12
    fp["c#{j}"].oy = 18 + rand(24)
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].z = 20
    fp["c#{j}"].color = Color.new(123,64,89,0)
    fp["c#{j}"].toggle = 1
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb175")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].z = 20
  pbSEPlay("Anim/Heal4")
  for i in 0...64
    fp["circle"].zoom_x += 0.125 if fp["circle"].zoom_x < 1
    fp["circle"].zoom_y += 0.125 if fp["circle"].zoom_y < 1
    fp["circle"].angle += 8
    for j in 0...16
      next if j > i/4
      if fp["p#{j}"].ox >= -16
        fp["p#{j}"].ox = -128
        fp["p#{j}"].angle = rand(360)
        fp["p#{j}"].opacity = 0
      end
      fp["p#{j}"].opacity += 32
      fp["p#{j}"].ox += 16
    end
    for j in 0...32
      fp["c#{j}"].toggle *= -1 if i%4==0
      next if j > i/2
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].color.alpha = 255*fp["c#{j}"].toggle
    end
    @scene.wait
  end
  for key in fp.keys
    next if key == "circle"
    fp[key].dispose
    fp.delete(key)
  end
  fp["circle2"] = Sprite.new(@viewport)
  fp["circle2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb175_3")
  fp["circle2"].center!
  fp["circle2"].x = cx
  fp["circle2"].y = cy
  fp["circle2"].z = fp["circle"].z - 1
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  16.times do
    fp["circle2"].zoom_x = @vector.zoom1
    fp["circle2"].zoom_y = @vector.zoom1
    fp["circle"].zoom_x = @vector.zoom1
    fp["circle"].zoom_y = @vector.zoom1
    x1, y1 = @targetSprite.getCenter(true)
    x2, y2 = @userSprite.getCenter(true)
    if @targetIsPlayer
      cx = x1 + (x2 - x1)*0.65
      cy = y1 - (y1 - y2)*0.65
    else
      cx = x2 + (x1 - x2)*0.5
      cy = y2 - (y2 - y1)*0.5
    end
    fp["circle2"].x = cx
    fp["circle2"].y = cy
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].angle += 8
    @scene.wait(1,true)
  end
  fp["circle"].visible = false
  fp["circle2"].z = @targetSprite.z + 1
  pbSEPlay("Anim/Flash")
  8.times do
    fp["circle2"].x += (x1 - fp["circle2"].x)*0.5
    fp["circle2"].y -= (fp["circle2"].y - y1)*0.5
    @scene.wait
  end
  fp["circle2"].visible = false
  @targetSprite.anim = true
  @targetSprite.color = Color.new(122,71,109)
  2.times do
    @targetSprite.anim = true
    @scene.wait
  end
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb175_4")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height
    fp["i#{j}"].angle = rand(360)
    fp["i#{j}"].z = @targetSprite.z + 1
    fp["i#{j}"].x = x1
    fp["i#{j}"].y = y1
  end
  for i in 0...32
    for j in 0...16
      next if j > i
      fp["i#{j}"].opacity -= 16
      fp["i#{j}"].oy += 8
    end
    @targetSprite.color.alpha -= 16
    @targetSprite.anim = true
    @scene.wait
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: SHADOWCLAW.rb =====#
#-------------------------------------------------------------------------------
#  Shadow Claw
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SHADOWCLAW) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  # set up animation
  fp = {}
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb176")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb176_3")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].opacity = 0
    fp["s#{j}"].z = @targetSprite.z
    fp["s#{j}"].angle = rand(360)
  end
  for j in 0...12
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb176_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    r = 48*factor
    fp["p#{j}"].x = cx - r + rand(r*2)
    fp["p#{j}"].y = cy - r + rand(r)
    fp["p#{j}"].opacity = 0
    fp["p#{j}"].z = @targetSprite.z + 1
    fp["p#{j}"].color = Color.new(0,0,0,0)
  end
  pbSEPlay("EBDX/Anim/ground1",75)
  for i in 0...64
    pbSEPlay("EBDX/Anim/normal3",85) if i == 4
    fp["claw"].src_rect.height += 16
    for j in 0...12
      next if i < 8
      fp["s#{j}"].opacity += 16*((i-8) < 24 ? 1 : -2)
      fp["s#{j}"].angle += 2
      fp["s#{j}"].zoom_x -= 0.01 if i >= 12 if fp["s#{j}"].zoom_x > 0
      fp["s#{j}"].zoom_y -= 0.01 if i >= 12 if fp["s#{j}"].zoom_y > 0
    end
    for j in 0...12
      next if i < 8
      next if j>(i-8)
      fp["p#{j}"].opacity += 32*((i-8) < 24 ? 1 : -1)
      fp["p#{j}"].color.alpha += 8
      fp["p#{j}"].zoom_x -= 0.05 if i >= 24 if fp["p#{j}"].zoom_x > 0
      fp["p#{j}"].zoom_y -= 0.05 if i >= 24 if fp["p#{j}"].zoom_y > 0
    end
    fp["claw"].opacity -= 32 if i >= 16
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: SHADOWFORCE.rb =====#
#-------------------------------------------------------------------------------
#  PHANTOMFORCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PHANTOMFORCE) do
  EliteBattle.playMoveAnimation(:SHADOWFORCE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SHADOWFORCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SHADOWFORCE) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:SHADOWFORCE_HIDE, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:SHADOWFORCE_ATTACK, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:SHADOWFORCE_HIDE) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 2
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/ghost1",80) if i == 4
	pbSEPlay("Anim/NightShade",80) if i == 15
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
		@userSprite.opacity -= 5
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  @userSprite.visible = false
  @userSprite.hidden = true
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

EliteBattle.defineMoveAnimation(:SHADOWFORCE_ATTACK) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  frame = []
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg_8")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_9")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_9")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx - 32 + rand(64)
    fp["#{j}"].y = cy - 32 + rand(64)
    fp["#{j}"].z = @targetSprite.z + 1
    fp["#{j}"].visible = false
    fp["#{j}"].zoom_x = @targetSprite.zoom_x
    fp["#{j}"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_10")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/ghost3",80) if i == 8
    pbSEPlay("Anim/Comet Punch",80) if i == 8
	@userSprite.visible = true
    @userSprite.hidden = false
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}"].visible = true
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += 16
      fp["#{j}"].zoom_x += 0.1
      fp["#{j}"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end


#===== FILE: SHADOWPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  SHADOWPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SHADOWPUNCH) do | args |
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(84,42,131))
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136_3")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 50
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)/2
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)/2
    rndx.push(rand(144))
    rndy.push(rand(144))
  end
  fp["punch"] = Sprite.new(@viewport)
  fp["punch"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb108")
  fp["punch"].ox = fp["punch"].bitmap.width/2
  fp["punch"].oy = fp["punch"].bitmap.height/2
  fp["punch"].opacity = 0
  fp["punch"].z = 40
  fp["punch"].angle = 180
  fp["punch"].zoom_x = @targetIsPlayer ? 6 : 4
  fp["punch"].zoom_y = @targetIsPlayer ? 6 : 4
  fp["punch"].tone = Tone.new(48,16,6)
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("Anim/fog2", 75)
  @sprites["battlebg"].defocus
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["punch"].x = cx
    fp["punch"].y = cy
    fp["punch"].angle -= 45 if i < 40
    fp["punch"].zoom_x -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].zoom_y -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].opacity += 8 if i < 40
    if i >= 40
      fp["punch"].tone = Tone.new(255,255,255) if i == 40
      fp["punch"].tone.all -= 25.5
      fp["punch"].opacity -= 25.5
    end
    pbSEPlay("Anim/Fire3") if i==40
    for j in 0...12
      next if i < 40
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 72*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 72*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].src_rect.x += 53 if i%2==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 16
        fp["#{j}"].tone.gray += 16
        fp["#{j}"].tone.red -= 4; fp["#{j}"].tone.green -= 4; fp["#{j}"].tone.blue -= 4
        fp["#{j}"].zoom_x -= 0.005
        fp["#{j}"].zoom_y += 0.01
      else
        fp["#{j}"].opacity += 45
      end
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      if i >= 56
        @targetSprite.tone.red -= 3*2
        @targetSprite.tone.green += 1.5*2
        @targetSprite.tone.blue += 3*2
        fp["bg"].opacity -= 10
      else
        @targetSprite.tone.red += 3*2 if @targetSprite.tone.red < 48*2
        @targetSprite.tone.green -= 1.5*2 if @targetSprite.tone.green > -24*2
        @targetSprite.tone.blue -= 3*2 if @targetSprite.tone.blue > -48*2
      end
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SHADOWSNEAK.rb =====#
#-------------------------------------------------------------------------------
#  SHADOWSNEAK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SHADOWSNEAK) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/move1",80) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playCommonAnimation(:GRUDGE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SIGNALBEAM.rb =====#
#-------------------------------------------------------------------------------
#  EERIEIMPULSE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:EERIEIMPULSE) do | args |
  EliteBattle.playMoveAnimation(:SIGNALBEAM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SIGNALBEAM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SIGNALBEAM) do
  # inital configuration
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}; rndx = []; rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width, @viewport.height)
  fp["bg"].bitmap.fill_rect(0, 0, fp["bg"].bitmap.width, fp["bg"].bitmap.height, Color.new(92,131,42))
  fp["bg"].opacity = 0
  for i in 0...36
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb246_3")
    fp["#{i}"].src_rect.set(44*rand(4),0,44,44)
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/8
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(8))
    rndy.push(rand(8))
  end
  # start animation
  pbSEPlay("Anim/Psych Up")
  @sprites["battlebg"].defocus
  for i in 0...128
    pbSEPlay("EBDX/Anim/ghost3", 75) if i%32==0
    cx, cy = @targetSprite.getCenter(true)
    ax, ay = @userSprite.getAnchor
    for j in 0...36
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay
      end
      next if j>(i/2)
      x2 = cx - 4*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 4*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].angle += 2
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].angle += 2
      else
        fp["#{j}"].opacity += 12
      end
    end
    if i >= 96
      fp["bg"].opacity -= 10
    else
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.7
    end
    if i >= 72
      if i >= 96
        @targetSprite.tone.red -= 4.8/2
        @targetSprite.tone.green -= 4.8/2
        @targetSprite.tone.blue -= 4.8/2
      else
        @targetSprite.tone.red += 4.8 if @targetSprite.tone.red < 96
        @targetSprite.tone.green += 4.8 if @targetSprite.tone.green < 96
        @targetSprite.tone.blue += 4.8 if @targetSprite.tone.blue < 96
      end
      @targetSprite.still
    end
    @vector.set(vector) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @targetSprite.tone = Tone.new(0,0,0,0)
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SILVERWIND.rb =====#
#-------------------------------------------------------------------------------
#  SILVERWIND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SILVERWIND) do
# set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(104,146,164))
  fp["bg"].opacity = 0
  fp["wave"] = AnimatedPlane.new(@viewport)
  fp["wave"].bitmap = Bitmap.new(1026,@viewport.height)
  fp["wave"].bitmap.stretch_blt(Rect.new(0,0,fp["wave"].bitmap.width,fp["wave"].bitmap.height),pbBitmap("Graphics/EBDX/Animations/Moves/eb132_3"),Rect.new(0,0,1026,212))
  fp["wave"].opacity = 0
  fp["wave"].z = 50
  rndx = []
  rndy = []
  @vector.set(EliteBattle.get_vector(:DUAL))
  @vector.inc = 0.1
  pulse = 10
  shake = [4,4,4,4]
  # start animation
  for j in 0...80#64
    pbSEPlay("Anim/Silverwind",150) if j == 24
    fp["wave"].ox += 48
    fp["wave"].opacity += pulse
    pulse = -5 if fp["wave"].opacity > 160
    pulse = +5 if fp["wave"].opacity < 100
    fp["bg"].opacity += 1 if fp["bg"].opacity < 255*0.35
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
      @sprites["pokemon_#{i}"].tone.all += 3 if j.between?(16,48)
      if j >= 32
        @sprites["pokemon_#{i}"].ox += shake[i]
        shake[i] = -4 if @sprites["pokemon_#{i}"].ox > @sprites["pokemon_#{i}"].bitmap.width/2 + 2
        shake[i] = 4 if @sprites["pokemon_#{i}"].ox < @sprites["pokemon_#{i}"].bitmap.width/2 - 2
      end
    end
	ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    pbSEPlay("Anim/Wind8",50) if j%24==0 && j <= 60
    @sprites["pokemon_#{@userIndex}"].tone.all += 3 if j < 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  for i in 0...4
    next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
    next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
    @sprites["pokemon_#{i}"].ox = @sprites["pokemon_#{i}"].bitmap.width/2
  end
  for j in 0...64
    fp["wave"].ox += 48
    if j < 32
      fp["wave"].opacity += pulse
      pulse = -5 if fp["wave"].opacity > 160
      pulse = +5 if fp["wave"].opacity < 100
    end
    fp["wave"].opacity -= 4 if j >= 32
    fp["bg"].opacity -= 4 if j >= 32
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible)
      @sprites["pokemon_#{i}"].tone.all -= 3 if j >= 32
    end
    @sprites["pokemon_#{@userIndex}"].tone.all -= 3 if j >= 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end
#===== FILE: SING.rb =====#
#-------------------------------------------------------------------------------
#  SING
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SING) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  rndNote = 0
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(130,52,42))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
	rndNote = rand(2)
	if rndNote == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617_2")
	else
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb617")
	end
    #fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].src_rect.set(0,101*0,53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end 
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    #fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Sing",80) if i==0 
    if i >= 96
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    # @targetSprite.tone.red -= 2.4*2
    # @targetSprite.tone.green += 1.2*2
    # @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -1 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 1 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    #fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SKILLSWAP.rb =====#
#-------------------------------------------------------------------------------
#  BESTOW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BESTOW) do
  EliteBattle.playMoveAnimation(:SKILLSWAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SKILLSWAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SKILLSWAP) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["change1"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645"))
  fp["change1"].keyFrame = 1
  fp["change1"].z = @targetSprite.z + 1
  fp["change2"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645"))
  fp["change2"].keyFrame = 1
  fp["change2"].z = @userSprite.z + 1
  # shooting out the change1
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["change1"].x = points[i][0]
    fp["change1"].y = points[i][1]
    z = 1 + (1-(fp["change1"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change1"].zoom_x = z
    fp["change1"].zoom_y = z
    fp["change1"].update
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxT,cyT,mx,32,cxP,cyP,24)
    fp["change2"].x = points[i][0]
    fp["change2"].y = points[i][1]
    z = 1 + (1-(fp["change2"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change2"].zoom_x = z
    fp["change2"].zoom_y = z
    fp["change2"].update
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  pbSEPlay("Anim/Saint7")
  @targetSprite.color = Color.new(235,235,235,0)
  @userSprite.color = Color.new(235,235,235,0)
  fp["change1"].dispose
  fp["change2"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha += 18
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  for j in 0...32
    fp["p2#{j}"] = Sprite.new(@viewport)
    fp["p2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_2")
    fp["p2#{j}"].center!
    fp["p2#{j}"].x, fp["p2#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p2#{j}"].end_x = fp["p2#{j}"].x - r + x
    fp["p2#{j}"].end_y = fp["p2#{j}"].y - r + y
    fp["p2#{j}"].zoom_x = 0
    fp["p2#{j}"].zoom_y = 0
    fp["p2#{j}"].angle = rand(360)
    fp["p2#{j}"].z = @userSprite.z + 1
  end
  # sparkle animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
	  
	  fp["p2#{j}"].zoom_x += (1.6 - fp["p2#{j}"].zoom_x)*0.1
      fp["p2#{j}"].zoom_y += (1.6 - fp["p2#{j}"].zoom_y)*0.1
      fp["p2#{j}"].x += (fp["p2#{j}"].end_x - fp["p2#{j}"].x)*0.1
      fp["p2#{j}"].y += (fp["p2#{j}"].end_y - fp["p2#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
	  if fp["p2#{j}"].zoom_x >= 1
        fp["p2#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
      fp["p2#{j}"].color.alpha -= 8
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha -= 16 if i >= 48
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: SKULLBASH.rb =====#
#-------------------------------------------------------------------------------
#  SKULLBASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SKULLBASH) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:SWORDSDANCE, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex)
  end
end
#===== FILE: SKYATTACK.rb =====#
#-------------------------------------------------------------------------------
#  SKYATTACK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SKYATTACK) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:SKYATTACK_CHARGE, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:SKYATTACK_ATK, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:SKYATTACK_CHARGE) do
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb195")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  k = 0
  c = [Tone.new(211,186,3),Tone.new(0,0,0)]
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...128
    cx, cy = @userSprite.getCenter
    for j in 0...12
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        x, y = randCircleCord(64*factor)
        fp["#{j}"].x = cx - 64*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 64*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    if i < 96
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.6
    else
      fp["bg"].opacity -= 5
    end
    if i < 112
      if i%16 == 0
        k += 1
        k = 0 if k > 1
      end
      @userSprite.tone.red += (c[k].red - @userSprite.tone.red)*0.2
      @userSprite.tone.green += (c[k].green - @userSprite.tone.green)*0.2
      @userSprite.tone.blue += (c[k].blue - @userSprite.tone.blue)*0.2
    end
    pbSEPlay("Anim/Absorb2",100) if i == 16
    pbSEPlay("Anim/Saint8",70) if i == 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.tone = Tone.new(0,0,0)
  @vector.reset
  pbDisposeSpriteHash(fp)
end

EliteBattle.defineMoveAnimation(:SKYATTACK_ATK) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb628_bg_2")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  shake = 4; k = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...20
	pbSEPlay("Anim/wind1",80) if i == 2
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
	  @userSprite.opacity-=25
    end
    if i == 8
      @vector.set(vector2)
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb628_4")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  fp["shot"] = Sprite.new(@viewport)
  fp["shot"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb628_3")
  fp["shot"].ox = fp["shot"].bitmap.width/2
  fp["shot"].oy = fp["shot"].bitmap.height/2
  fp["shot"].z = @userSprite.z + 1
  fp["shot"].zoom_x = @userSprite.zoom_x*0.8
  fp["shot"].zoom_y = @userSprite.zoom_y*0.8
  fp["shot"].opacity = 0
  x = defaultvector[0]; y = defaultvector[1]
  x2, y2 = @vector.spoof(defaultvector)
  fp["shot"].x = cx
  fp["shot"].y = cy
  pbSEPlay("EBDX/Anim/normal1",80)
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    @vector.reset if i == 0
    if i > 0
      fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
      fp["shot"].opacity += 32
      fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
      fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
    end
    fp["bg"].update
    factor = @targetSprite.zoom_x if i == 12
    if i >= 12
      k *= -1 if i%4==0
      @targetSprite.zoom_x -= factor*0.01*k
      @targetSprite.zoom_y += factor*0.04*k
      @targetSprite.still
    end
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,i < 12)
  end
  shake = 2
  16.times do
    fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
    fp["shot"].opacity += 32
    fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
    fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
    fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
    fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
    fp["bg"].color.alpha += 16
    fp["bg"].update
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
    @targetSprite.still
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  16.times do
    fp["bg"].update
    fp["bg"].opacity -= 16
	@userSprite.opacity+=20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: SKYDROP.rb =====#
#-------------------------------------------------------------------------------
#  SKYDROP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SKYDROP) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:SKYDROP_UP, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:SKYDROP_DOWN, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:SKYDROP_UP) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb086_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  shake = 4; k = 0; factor = @targetIsPlayer ? 2 : 1.5
  # set up animation
  fp["fly"] = Sprite.new(@viewport)
  fp["fly"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156")
  fp["fly"].ox = fp["fly"].bitmap.width/2
  fp["fly"].oy = fp["fly"].bitmap.height/2
  fp["fly"].z = 50
  fp["fly"].x, fp["fly"].y = @targetSprite.getCenter
  fp["fly"].opacity = 0
  fp["fly"].zoom_x = factor*1.4
  fp["fly"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_2")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...20
	pbSEPlay("Anim/wind1",80) if i == 2
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
	  @userSprite.opacity-=25
    end
    if i == 8
      @vector.set(vector2)
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb628_2")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  fp["shot"] = Sprite.new(@viewport)
  fp["shot"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb628")
  fp["shot"].ox = fp["shot"].bitmap.width/2
  fp["shot"].oy = fp["shot"].bitmap.height/2
  fp["shot"].z = @userSprite.z + 1
  fp["shot"].zoom_x = @userSprite.zoom_x*0.8
  fp["shot"].zoom_y = @userSprite.zoom_y*0.8
  fp["shot"].opacity = 0
  x = defaultvector[0]; y = defaultvector[1]
  x2, y2 = @vector.spoof(defaultvector)
  fp["shot"].x = cx
  fp["shot"].y = cy
  pbSEPlay("EBDX/Anim/normal1",80)
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    @vector.reset if i == 0
    if i > 0
      fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
      fp["shot"].opacity += 32
      fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
      fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
    end
    fp["bg"].update
    factor = @targetSprite.zoom_x if i == 12
    if i >= 12
      k *= -1 if i%4==0
      @targetSprite.zoom_x -= factor*0.01*k
      @targetSprite.zoom_y += factor*0.04*k
      @targetSprite.still
    end
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,i < 12)
  end
  shake = 2
  factor = @targetIsPlayer ? 2 : 1.5
  for i in 0...20
    fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
    fp["shot"].opacity += 32
    fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
    fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
    fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
    fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
    fp["bg"].color.alpha += 16
    fp["bg"].update
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
    @targetSprite.still
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
	cx, cy = @targetSprite.getCenter
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].zoom_x -= factor*0.4/10
    fp["fly"].zoom_y -= factor*0.4/10
    fp["fly"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @targetSprite.visible = false if i == 6
    @targetSprite.hidden = true if i == 6
	fp["bg"].update
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  #flyup
  # start animation
  pbSEPlay("Anim/Refresh")
    10.times do
    fp["fly"].zoom_x += factor*0.4/10
    fp["fly"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  #@vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter
    if i < 10
      fp["fly"].zoom_y -= factor*0.02
    elsif
      fp["fly"].zoom_x -= factor*0.02
      fp["fly"].zoom_y += factor*0.04
    end
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying2") if i == 10
  end
  for i in 0...20
    fp["fly"].y -= 32
    fp["fly"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
    @userSprite.visible = false
    @userSprite.hidden = true 
	@targetSprite.visible = false
    @targetSprite.hidden = true
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

EliteBattle.defineMoveAnimation(:SKYDROP_DOWN) do
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  fp["drop"] = Sprite.new(@viewport)
  fp["drop"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_3")
  fp["drop"].ox = fp["drop"].bitmap.width/2
  fp["drop"].oy = fp["drop"].bitmap.height/2
  fp["drop"].y = 0
  fp["drop"].z = 50
  fp["drop"].visible = false
  # start animation
  @vector.set(defaultvector[0], defaultvector[1]+128, defaultvector[2], defaultvector[3], defaultvector[4], defaultvector[5])
  @sprites["battlebg"].defocus
  32.times do
    fp["bg"].opacity += 2
    @scene.wait(1,true)
  end
  @vector.set(vector)
  maxy = ((@targetIsPlayer ? @vector.y : @vector.y2)*0.1).ceil*10 - 80
  fp["drop"].y = -((maxy-(@targetIsPlayer ? @vector.y-80 : @vector.y2-80))*0.1).ceil*10
  fp["drop"].x = @targetSprite.x
  pbSEPlay("Anim/Wind1")
  for i in 0...20
    @scene.wait(1,true)
    if i >= 10
      fp["drop"].visible = true
      fp["drop"].x = @targetSprite.x
      fp["drop"].y += maxy/10
      fp["drop"].zoom_x = @targetSprite.zoom_x
      fp["drop"].zoom_y = @targetSprite.zoom_y*1.4
    end
    fp["bg"].opacity -= 51 if i >= 15
  end
  @sprites["battlebg"].focus
  @userSprite.hidden = false
  @userSprite.visible = true  
  @userSprite.opacity = 255
  @targetSprite.hidden = false
  @targetSprite.visible = true
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  EliteBattle.playMoveAnimation(:TACKLE, @scene, @userIndex, @targetIndex, 0, false, nil, false, true)
end

#===== FILE: SLASH.rb =====#
#-------------------------------------------------------------------------------
#  SLASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SLASH) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.white)
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..11
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...16
	    fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
	    fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
		@targetSprite.still if k.between?(flashStart,flashStart+2)
		@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
		@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
		@scene.wait(1,true)
		pbSEPlay("EBDX/Anim/normal3",85) if k == 4
		fp["claw"].src_rect.height += 60
		fp["claw"].opacity -= 60 if k >= 5
		@scene.wait(1,true)
	  end
	  j = 1
	end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: SLEEPPOWDER.rb =====#
#-------------------------------------------------------------------------------
#  SPORE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPORE) do
  EliteBattle.playMoveAnimation(:SLEEPPOWDER, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  SLEEPPOWDER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SLEEPPOWDER) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_5")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(0,204,102,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SLEEPTALK.rb =====#
#-------------------------------------------------------------------------------
#  SLEEPTALK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SLEEPTALK) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...12
    @userSprite.still
	 pbSEPlay("Cries/#{@userSprite.species}",100) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SLUDGEBOMB.rb =====#
#-------------------------------------------------------------------------------
#  Sludge Bomb
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SLUDGEBOMB) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["sludge"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb429"))
  fp["sludge"].keyFrame = 1
  fp["sludge"].z = @targetSprite.z + 1
  # shooting out the sludge
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["sludge"].x = points[i][0]
    fp["sludge"].y = points[i][1]
    z = 1 + (1-(fp["sludge"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["sludge"].zoom_x = z
    fp["sludge"].zoom_y = z
    fp["sludge"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @targetSprite.color = Color.new(136,48,128,0)
  fp["sludge"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb429_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
    fp["p#{j}"].color = Color.new(136,48,138)
  end
  for j in 0...24
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb429_3")
    fp["c#{j}"].center!
    fp["c#{j}"].x, fp["c#{j}"].y = @targetSprite.getCenter(true)
    fp["c#{j}"].y -= (@targetSprite.bitmap.height*0.5)*@userSprite.zoom_y
    r = (48 + rand(32))*@targetSprite.zoom_x
    fp["c#{j}"].end_x = fp["c#{j}"].x - r + rand(r*2)
    fp["c#{j}"].end_y = fp["c#{j}"].y - (52 - rand(64))*@targetSprite.zoom_y
    fp["c#{j}"].zoom_x = 0
    fp["c#{j}"].zoom_y = 0
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].z = @targetSprite.z + 1
    fp["c#{j}"].toggle = 1.2 + rand(10)/10.0
    fp["c#{j}"].visible = bomb
  end
  # poison animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
    for j in 0...24
      next if j > i
      fp["c#{j}"].x += (fp["c#{j}"].end_x - fp["c#{j}"].x)*0.1
      fp["c#{j}"].y += (fp["c#{j}"].end_y - fp["c#{j}"].y)*0.1
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].toggle = -1 if fp["c#{j}"].opacity >= 255
      fp["c#{j}"].zoom_x += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_x)*0.1
      fp["c#{j}"].zoom_y += (fp["c#{j}"].toggle - fp["c#{j}"].zoom_y)*0.1
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#-------------------------------------------------------------------------------
#  Sludge
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SLUDGE) do
  EliteBattle.playMoveAnimation(:SLUDGEBOMB, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end

#===== FILE: SMACKDOWN.rb =====#
#-------------------------------------------------------------------------------
#  SMACKDOWN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SMACKDOWN) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["ball"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb504"))
  fp["ball"].keyFrame = 1
  fp["ball"].z = @targetSprite.z + 1
  @vector.set(EliteBattle.get_vector(:DUAL))
  @scene.wait(10,true)
  # shooting out the ball
  for i in 0...24
	pbSEPlay("Anim/rock2") if i == 5
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    my = @vector.y + (@vector.y2 - @vector.y)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["ball"].x = points[i][0]
    fp["ball"].y = points[i][1]
    z = 1 + (1-(fp["ball"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["ball"].zoom_x = z
    fp["ball"].zoom_y = z
    fp["ball"].update
	if i.between?(16,8)
		@targetSprite.color.alpha += 18
		@targetSprite.anim = true
		@targetSprite.still
	end
    @scene.wait(1,true)
  end
  @targetSprite.color = Color.new(70,70,70,0)
  fp["ball"].dispose
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	if rand(1)
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504_1")
	else
		fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504_2")
	end
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/rock2") if i == 5
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.01
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.01
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.25
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.25
      if fp["p#{j}"].zoom_x >= 0.5
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: SMARTSTRIKE.rb =====#
#-------------------------------------------------------------------------------
#  SMARTSTRIKE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SMARTSTRIKE) do | args |
  factor = @targetSprite.zoom_x
  factorHorn = @userIsPlayer ? 1.9 : 2.5
  hornXMove = @userIsPlayer ? 2 : -2
  hornYMove = @userIsPlayer ? 10 : -10
  hornXOffset = @userIsPlayer ? 60 : -120
  hornYOffset = @userIsPlayer ? 60 : -120
  hornMoveHit = @userIsPlayer ? 5 : -5
  hornAngle = @userIsPlayer ? 0 : 180
  userOX = @userSprite.ox
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(192,192,192))
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_2")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  # phase 1
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # user move
  for i in 0...30
    @userSprite.still
	#default movement
    if i.between?(0,20)
		@userSprite.ox += hornXMove
	else
		@userSprite.ox -= hornYMove
    end
    @scene.wait(1,true)
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(7,true)
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/iron2",80)
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_0_2")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  fp["horn"] = Sprite.new(@viewport)
  fp["horn"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb626")
  fp["horn"].ox = fp["horn"].bitmap.width/2
  fp["horn"].oy = fp["horn"].bitmap.height/2
  fp["horn"].x, fp["horn"].y = @targetSprite.getCenter(true)
  fp["horn"].x -= hornXOffset
  fp["horn"].y += hornYOffset
  fp["horn"].opacity = 0
  fp["horn"].zoom = factorHorn
  fp["horn"].angle = hornAngle
  fp["horn"].z = 41
  # horn attack
  for i in 1..30
	if i.between?(1,15)
		fp["horn"].opacity += 20
		fp["horn"].x += hornMoveHit 
		fp["horn"].y -= hornMoveHit
	else
		fp["horn"].opacity -= 20
	end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: SMOKESCREEN.rb =====#
#-------------------------------------------------------------------------------
#  HAZE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:HAZE) do
  EliteBattle.playMoveAnimation(:SMOKESCREEN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SMOKESCREEN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SMOKESCREEN) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_8")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(64,64,64,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SNARL.rb =====#
#-------------------------------------------------------------------------------
#  CONFIDE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CONFIDE) do
  EliteBattle.playMoveAnimation(:SNARL, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SNARL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SNARL) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  for j in 0...24
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 6
  for i in 0...12
    @userSprite.still
	 pbSEPlay("Cries/#{@userSprite.species}",85) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  @scene.wait(5,true)
  #
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_3")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    #fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  # anim2
  for i in 0...32
    for j in 0...12
      next if j>(i*2)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SNORE.rb =====#
#-------------------------------------------------------------------------------
#  SNORE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SNORE) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  for j in 0...24
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 6
  for i in 0...12
    @userSprite.still
	 pbSEPlay("Cries/#{@userSprite.species}",85) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  @scene.wait(5,true)
  #
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_4")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    #fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  # anim2
  for i in 0...32
    for j in 0...12
      next if j>(i*2)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SOLARBEAM.rb =====#
#-------------------------------------------------------------------------------
#  Solar Beam
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SOLARBEAM) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:SOLARBEAM_CHARGE, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:SOLARBEAM_ATK, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:SOLARBEAM_CHARGE) do
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb195")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  k = 0
  c = [Tone.new(211,186,3),Tone.new(0,0,0)]
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...128
    cx, cy = @userSprite.getCenter
    for j in 0...12
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        x, y = randCircleCord(64*factor)
        fp["#{j}"].x = cx - 64*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 64*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    if i < 96
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.6
    else
      fp["bg"].opacity -= 5
    end
    if i < 112
      if i%16 == 0
        k += 1
        k = 0 if k > 1
      end
      @userSprite.tone.red += (c[k].red - @userSprite.tone.red)*0.2
      @userSprite.tone.green += (c[k].green - @userSprite.tone.green)*0.2
      @userSprite.tone.blue += (c[k].blue - @userSprite.tone.blue)*0.2
    end
    pbSEPlay("Anim/Absorb2",100) if i == 16
    pbSEPlay("Anim/Saint8",70) if i == 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.tone = Tone.new(0,0,0)
  @vector.reset
  pbDisposeSpriteHash(fp)
end

EliteBattle.defineMoveAnimation(:SOLARBEAM_ATK) do
  # set up animation
  fp = {}; rndx = []; rndy = []
  dx = []; dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb195")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(64))
    rndy.push(rand(64))
    dx.push(0)
    dy.push(0)
  end
  shake = 4
  # start animation
  pbSEPlay("Anim/Refresh",150)
  @sprites["battlebg"].defocus
  for i in 0...96
    pbSEPlay("Anim/Psych Up",80) if i == 48
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 32*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 32*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      next if j>(i)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = dx[j]
      y0 = dy[j]
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 32
      nextx = fp["#{j}"].x + (x2 - x0)*0.1
      nexty = fp["#{j}"].y + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
    end
    fp["bg"].opacity += 10 if fp["bg"].opacity < 255*0.75
    if i >= 32
      @targetSprite.tone.red += 5.4 if @targetSprite.tone.red < 194.4
      @targetSprite.tone.green += 3.4 if @targetSprite.tone.green < 122.4
      @targetSprite.tone.blue += 0.15 if @targetSprite.tone.blue < 5.4
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 9.7
    @targetSprite.tone.green -= 6.1
    @targetSprite.tone.blue -= 0.27
    @targetSprite.ox += shake
    shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @targetSprite.tone = Tone.new(0,0,0)
  @vector.reset
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SOLARBLADE.rb =====#
#-------------------------------------------------------------------------------
#  SOLARBLADE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SOLARBLADE) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:SOLARBLADE_CHARGE, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:SOLARBLADE_ATK, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:SOLARBLADE_CHARGE) do
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb195")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  k = 0
  c = [Tone.new(211,186,3),Tone.new(0,0,0)]
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...128
    cx, cy = @userSprite.getCenter
    for j in 0...12
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        x, y = randCircleCord(64*factor)
        fp["#{j}"].x = cx - 64*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 64*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    if i < 96
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.6
    else
      fp["bg"].opacity -= 5
    end
    if i < 112
      if i%16 == 0
        k += 1
        k = 0 if k > 1
      end
      @userSprite.tone.red += (c[k].red - @userSprite.tone.red)*0.2
      @userSprite.tone.green += (c[k].green - @userSprite.tone.green)*0.2
      @userSprite.tone.blue += (c[k].blue - @userSprite.tone.blue)*0.2
    end
    pbSEPlay("Anim/Absorb2",100) if i == 16
    pbSEPlay("Anim/Saint8",70) if i == 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.tone = Tone.new(0,0,0)
  @vector.reset
  pbDisposeSpriteHash(fp)
end

EliteBattle.defineMoveAnimation(:SOLARBLADE_ATK) do
  # set up animation
  fp = {}; rndx = []; rndy = []
  dx = []; dy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632_9")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_14")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb195")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # start animation
  k = 1
  for i in 0...32
    pbSEPlay("Anim/Absorb2",100) if i == 1
    pbSEPlay("Anim/Saint8",70) if i == 2
    pbSEPlay("EBDX/Anim/normal4",80) if i == 5
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
end
#===== FILE: SONICBOOM.rb =====#
#-------------------------------------------------------------------------------
#  SONICBOOM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SONICBOOM) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_2")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SPACIALREND.rb =====#
#-------------------------------------------------------------------------------
#  SPACIALREND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPACIALREND) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  rndx = [[],[]]; rndy = [[],[]]
  dx = [[],[]]; dy = [[],[]]
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb641_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  string = ["eb641_2","eb641"]
  rop = [255,80,40,135]
  px = []
  py = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for m in 0...2
    for i in 0...20
      fp["#{i}#{m}"] = Sprite.new(@viewport)
      bmp = pbBitmap("Graphics/EBDX/Animations/Moves/"+string[m])
      fp["#{i}#{m}"].bitmap = Bitmap.new(bmp.width,bmp.height)
      fp["#{i}#{m}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height),(m==0 ? rop[rand(4)] : 255))
      fp["#{i}#{m}"].ox = fp["#{i}#{m}"].bitmap.width/2
      fp["#{i}#{m}"].oy = fp["#{i}#{m}"].bitmap.height/2
      fp["#{i}#{m}"].opacity = 0
      fp["#{i}#{m}"].z = @targetIsPlayer ? 29 : 19
      fp["#{i}#{m}"].zoom_x = [0.5,1][m]
      fp["#{i}#{m}"].zoom_y = [0.5,1][m]
      rndx[m].push(rand(16))
      rndy[m].push(rand(16))
      dx[m].push(0)
      dy[m].push(0)
    end
  end
  k = 1
  @sprites["battlebg"].defocus
  # start animation
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Darkness6",80)
  @scene.wait(4,true)
  for i in 0...96
    pbSEPlay("Anim/Darkness2") if i == 12
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for m in 0...2
      for j in 0...20
        if fp["#{j}#{m}"].opacity == 0
          dx[m][j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[m][j]*@userSprite.zoom_x*0.5
          dy[m][j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[m][j]*@userSprite.zoom_y*0.5
          fp["#{j}#{m}"].x = dx[m][j]
          fp["#{j}#{m}"].y = dy[m][j]
        end
        next if j>(i/4)
        x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[m][j]*@targetSprite.zoom_x*0.5
        y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[m][j]*@targetSprite.zoom_y*0.5
        x0 = dx[m][j]
        y0 = dy[m][j]
        fp["#{j}#{m}"].x += (x2 - x0)*0.04*(m+1)
        fp["#{j}#{m}"].y += (y2 - y0)*0.04*(m+1)
        fp["#{j}#{m}"].zoom_x += (1 - fp["#{j}#{m}"].zoom_x)*0.1
        fp["#{j}#{m}"].zoom_y += (1 - fp["#{j}#{m}"].zoom_y)*0.1
        fp["#{j}#{m}"].opacity += 51
        fp["#{j}#{m}"].angle += 8*(m+1)*j
        nextx = fp["#{j}#{m}"].x# + (x2 - x0)*0.1
        nexty = fp["#{j}#{m}"].y# + (y2 - y0)*0.1
        if !@targetIsPlayer
          fp["#{j}#{m}"].visible = false if nextx > cx && nexty < cy
        else
          fp["#{j}#{m}"].visible = false if nextx < cx && nexty > cy
        end
      end
    end
    for l in 0...12
      next if i < 12
      next if l>((i-12)/4)
      if fp["p#{l}"].opacity <= 0
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(128)
        px[l] = cx - 128*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 128*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(vector) if i == 64
    @vector.inc = 0.1 if i == 64
    fp["bg"].update
    if i < 64
      k*=-1 if i%4==0
      @scene.moveEntireScene(0,k*4,true,true)
    end
    pbSEPlay("EBDX/Anim/dragon2") if i == 84
    if i.between?(85,90)
      @targetSprite.zoom_x += 0.01
      @targetSprite.zoom_y -= 0.04
    elsif i.between?(91,96)
      @targetSprite.zoom_x -= 0.01
      @targetSprite.zoom_y += 0.04
    end
    @scene.wait(1,(i>=64 && i<85))
  end
  for j in 0...20; for m in 0...2; fp["#{j}#{m}"].visible = false; end; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SPARK.rb =====#
#-------------------------------------------------------------------------------
#  VOLTSWITCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:VOLTSWITCH) do
  EliteBattle.playMoveAnimation(:SPARK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  NUZZLE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:NUZZLE) do
  EliteBattle.playMoveAnimation(:SPARK, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SPARK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPARK) do
# Charging animation
  EliteBattle.playMoveAnimation(:CHARGE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  factor = (@targetIsPlayer ? 2 : 1.5)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(217/6,189/6,52/6))
  fp["bg"].opacity = 0
  l = 0; m = 0; q = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 51
  end
  fp["punch"] = Sprite.new(@viewport)
  fp["punch"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069")
  fp["punch"].ox = fp["punch"].bitmap.width/2
  fp["punch"].oy = fp["punch"].bitmap.height/2
  fp["punch"].opacity = 0
  fp["punch"].z = 40
  fp["punch"].angle = 180
  fp["punch"].zoom_x = @targetIsPlayer ? 6 : 4
  fp["punch"].zoom_y = @targetIsPlayer ? 6 : 4
  fp["punch"].color = Color.new(217,189,52,50)
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("Anim/fog2",75)
  for i in 0...72
  i += 1
  pbSEPlay("Anim/hit",80) if i==10
  pbSEPlay("Anim/Paralyze1") if i == 12
    cx, cy = @targetSprite.getCenter(true)
    fp["punch"].x = cx
    fp["punch"].y = cy
    fp["punch"].angle -= 45 if i < 30
    fp["punch"].zoom_x -= @targetIsPlayer ? 0.2 : 0.15 if i < 30
    fp["punch"].zoom_y -= @targetIsPlayer ? 0.2 : 0.15 if i < 30
    fp["punch"].opacity += 8 if i < 30
    if i >= 30
      fp["punch"].tone = Tone.new(255,255,255) if i == 30
      fp["punch"].tone.all-=25.5
      fp["punch"].opacity -= 25.5
    end
    pbSEPlay("Anim/hit") if i==30
    pbSEPlay("Anim/Thunder3") if i==30
    pbSEPlay("Anim/Paralyze1") if i%8==0 && i>=52
    for n in 0...12
      next if i < 40
      if fp["#{n}"].opacity == 0 && fp["#{n}"].tone.gray == 0
        r2 = rand(4)
        fp["#{n}"].zoom_x = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].zoom_y = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        fp["#{n}"].x = cx - 48*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["#{n}"].y = cy - 48*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["#{n}"].angle = -Math.atan(1.0*(fp["#{n}"].y-cy)/(fp["#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      next if m>(i-40)/4
      fp["#{n}"].opacity += 51 if fp["#{n}"].tone.gray == 0
      fp["#{n}"].angle += 180 if (i-16)%3==0
      fp["#{n}"].tone.gray = 1 if fp["#{n}"].opacity >= 255
      q += 1 if fp["#{n}"].opacity >= 255
      fp["#{n}"].opacity -= 10 if fp["#{n}"].tone.gray > 0 && q > 96
    end
    fp["bg"].opacity += 4 if  i < 40
    fp["bg"].opacity -= 10 if i >= 56
    @targetSprite.tone = Tone.new(100,80,60) if i == 40
    if i >= 40
      if (i-40)/3 > l
        m += 1
        m = 0 if m > 1
        l = (i-40)/3
      end
      @targetSprite.zoom_y -= 0.16*(m==0 ? 1 : -1)
      @targetSprite.zoom_x += 0.08*(m==0 ? 1 : -1)
      @targetSprite.tone.red -= 5 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 4 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 3 if @targetSprite.tone.blue > 0
      @targetSprite.still
    end
    @scene.wait(1,(i < 40))
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SPIDERWEB.rb =====#
#-------------------------------------------------------------------------------
#  STRINGSHOT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STRINGSHOT) do
  EliteBattle.playMoveAnimation(:SPIDERWEB, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SPIDERWEB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPIDERWEB) do
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []; px = []; py = []; rangl = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end	
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(229,255,204))
  fp["bg"].opacity = 0
  for k in 0...64
    i = 63-k
    fp["#{i}"] = Sprite.new(@viewport)
    bmp = pbBitmap("Graphics/EBDX/Animations/Moves/eb551_2")
    fp["#{i}"].bitmap = Bitmap.new(bmp.width,bmp.height)
    fp["#{i}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height))
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    #fp["#{i}"].color = Color.new(248,248,248,200)
    rndx.push(rand(16)); rndy.push(rand(16)); rangl.push(rand(2))
    dx.push(0); dy.push(0)
  end
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  for i in 0...64
    pbSEPlay("EBDX/Anim/water1",60) if i%4==0 && i < 48
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...64
      if fp["#{j}"].opacity == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].zoom_x = 0.8#(!@targetIsPlayer ? 1.2 : 0.8)#@userSprite.zoom_x
        fp["#{j}"].zoom_y = 0.8#(!@targetIsPlayer ? 1.2 : 0.8)#@userSprite.zoom_y
        fp["#{j}"].opacity = 128 if !(j>i*2)
      end
      next if j>(i*2)
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      x0 = dx[j]
      y0 = dy[j]
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x += 0.04#(factor - fp["#{j}"].zoom_x)*0.2
      fp["#{j}"].zoom_y += 0.04#(factor - fp["#{j}"].zoom_y)*0.2
      fp["#{j}"].opacity += 32
      fp["#{j}"].angle += 8*(rangl[j]==0 ? -1 : 1)
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      fp["#{j}"].color.alpha -= 5 if fp["#{j}"].color.alpha > 0
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].visible = false if nextx > cx && nexty < cy
      else
        fp["#{j}"].visible = false if nextx < cx && nexty > cy
      end
    end
    @targetSprite.still if i >= 64
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 16
    @vector.inc = 0.1 if i == 64
    @scene.wait(1,true)
  end
    cxT, cyT = @targetSprite.getCenter(true)
    fp["net"] = Sprite.new(@viewport)
	fp["net"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb621")
	fp["net"].center!
	fp["net"].x = cxT
	fp["net"].y = cyT
	fp["net"].zoom_x = 0
	fp["net"].zoom_y = 0
	fp["net"].angle = rand(360)
	fp["net"].z = @targetSprite.z + 30
	for i in 0...30
		pbSEPlay("Anim/Splat",90) if i == 5
		next if i < 1
		fp["net"].zoom_x += (1.6 - fp["net"].zoom_x)*0.1
		fp["net"].zoom_y += (1.6 - fp["net"].zoom_y)*0.1
		if fp["net"].zoom_x >= 1
		  fp["net"].opacity -= 16
		end
	    fp["net"].color.alpha -= 8
		@scene.wait(1,i < 1)
	end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  for j in 0...48; fp["#{j}"].visible = false; end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SPIKES.rb =====#
#-------------------------------------------------------------------------------
#  SPIKES
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPIKES) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  if @userIndex == 0 || @userIndex == 2
	cxT = 367
	cyT = 168
	cxP = 101
	cyP = 317
	cxS = 270
	cyS = 230
	opp = :ENEMY
	zoom = 1
  else 
	cxP = 367
	cyP = 168
	cxT = 101
	cyT = 317
	cxS = 160
	cyS = 290
	opp = :PLAYER
	zoom = 2
  end
  fp = {}
  fp["spike"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb620"))
  fp["spike"].keyFrame = 1
  fp["spike"].z = @targetSprite.z + 30
  # shooting out the spike
  for i in 0...24
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["spike"].x = points[i][0]
    fp["spike"].y = points[i][1]
    z = 1 + (1-(fp["spike"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["spike"].zoom_x = z
    fp["spike"].zoom_y = z
    fp["spike"].update
	pbSEPlay("Anim/Throw",60) if i == 4
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(opp))
  #@targetSprite.color = Color.new(128,128,128,0)
  fp["spike"].dispose
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb620_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x = cxS
	fp["p#{j}"].y = cyS
    r = (40 + rand(24))*1.5#zoom
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 30
    #fp["p#{j}"].color = Color.new(128,128,128)
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/Spikes1",90) if i == 5
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: SPIKYSHIELD.rb =====#
#-------------------------------------------------------------------------------
#  SPIKYSHIELD
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPIKYSHIELD) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  # set up animation
  fp = {}
  fp["x"] = Sprite.new(@viewport)
  fp["x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb609")
  fp["x"].ox = fp["x"].bitmap.width/2
  fp["x"].oy = fp["x"].bitmap.height/2
  if @targetIsPlayer
	  fp["x"].x = cx + 100
	  fp["x"].y = cy - 50
	  fp["x"].z = @targetSprite.z - 1
  else
  	  fp["x"].x = cx - 80
	  fp["x"].y = cy + 45
	  fp["x"].z = @targetSprite.z + 1
  end
  fp["x"].zoom_x = factor
  fp["x"].zoom_y = factor
  fp["x"].src_rect.height = 0
  pbSEPlay("EBDX/Anim/psychic2",60)
  @scene.wait(1,true)
  for i in 1..11
    # if i < 8
      # x=(i/4 < 1) ? 2 : -2
      # @scene.moveEntireScene(0, x*2, true, true)
    # end
    if i.between?(1,5)
      #@targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      #@targetSprite.tone.all-=12.8
    end
	if j == 0 && i == 6
	  for k in 0...50
		pbSEPlay("EBDX/Anim/shine1",60) if k == 25
		fp["x"].src_rect.height += 5
		fp["x"].opacity -= 20 if k >= 25
		@scene.wait(1,true)
	  end
	  #bSEPlay("EBDX/Anim/normal1",80)
	  j = 1
	end
    if i.between?(7,11)
      #@targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      #@targetSprite.tone.all+=12.8
    end
  end
  pbDisposeSpriteHash(fp)
  @vector.reset #if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: SPITUP.rb =====#
#-------------------------------------------------------------------------------
#  SPITUP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPITUP) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb263_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_4")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_3")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb263_2")
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SPLASH.rb =====#
#-------------------------------------------------------------------------------
#  MIMIC
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:MIMIC) do
  EliteBattle.playMoveAnimation(:SPLASH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  METRONOME
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:METRONOME) do
  EliteBattle.playMoveAnimation(:SPLASH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SPLASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPLASH) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  shake = 60
  shakePart = shake/3
  jump = 20
  OX = @userSprite.ox
  OY = @userSprite.oy
  for i in 0...12
    @userSprite.still
	 pbSEPlay("Anim/Bubble1",100) if i == 0 || i == 3 || i == 6 || i == 9
    if i == 1 || i == 10
	  @userSprite.ox += shakePart
	  @userSprite.oy += jump
    end
	if i == 2 || i == 11
	  @userSprite.ox += shakePart
    end
	if i == 3 || i == 12
	  @userSprite.ox += shakePart
	  @userSprite.oy -= jump
    end
	if i == 4 || i == 7
	  @userSprite.ox -= shakePart
	  @userSprite.oy += jump
    end
	if i == 5 || i == 8
	  @userSprite.ox -= shakePart
    end
	if i == 6 || i == 9
	  @userSprite.ox -= shakePart
	  @userSprite.oy -= jump
    end
    @scene.wait(4,true)
  end
  @userSprite.ox = OX
  @userSprite.oy = OY
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end
#===== FILE: SPOTLIGHT.rb =====#
#-------------------------------------------------------------------------------
#  FOLLOWME
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FOLLOWME) do
  EliteBattle.playMoveAnimation(:SPOTLIGHT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SPOTLIGHT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SPOTLIGHT) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...12
    @userSprite.still
	pbSEPlay("Cries/#{@userSprite.species}",85) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  #taunt
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  t = 1
  for j in 0..t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb643_3")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx + 20 if j == 0
    fp["#{j}"].x = cx - 20 if j == 1
    fp["#{j}"].y = cy - 40
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
  end
  # start animation
  for i in 0...30
	pbSEPlay("Anim/Taunt",100) if i == 3 || i == 9
    for j in 0..t
      next if j>(i*2)
	  next if i <= 5 && j == 1
      fp["#{j}"].visible = true
      if i > 20
        fp["#{j}"].opacity -= 32
      else
		if fp["#{j}"].zoom <= 1.5
			fp["#{j}"].zoom += 0.1
		else
		    fp["#{j}"].opacity -= 32
		end
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -=12
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: STEALTHROCK.rb =====#
#-------------------------------------------------------------------------------
#  STEALTHROCK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STEALTHROCK) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  if @userIndex == 0 || @userIndex == 2
	cxT = 367
	cyT = 168
	cxP = 101
	cyP = 317
	cxS = 270
	cyS = 230
	opp = :ENEMY
	zoom = 1
  else 
	cxP = 367
	cyP = 168
	cxT = 101
	cyT = 317
	cxS = 160
	cyS = 290
	opp = :PLAYER
	zoom = 2
  end
  fp = {}
  fp["spike"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb504"))
  fp["spike"].keyFrame = 1
  fp["spike"].z = @targetSprite.z + 30
  # shooting out the spike
  for i in 0...24
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["spike"].x = points[i][0]
    fp["spike"].y = points[i][1]
    z = 1 + (1-(fp["spike"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["spike"].zoom_x = z
    fp["spike"].zoom_y = z
    fp["spike"].update
	pbSEPlay("Anim/Throw",60) if i == 4
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(opp))
  #@targetSprite.color = Color.new(128,128,128,0)
  fp["spike"].dispose
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb504_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x = cxS
	fp["p#{j}"].y = cyS
    r = (40 + rand(24))*1.5#zoom
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 30
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/Spikes2",90) if i == 5
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: STEAMROLLER.rb =====#
#-------------------------------------------------------------------------------
#  STEAMROLLER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STEAMROLLER) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(132,161,52))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_7")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_6")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...72#96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/Psych Up",90) if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  EliteBattle.playMoveAnimation(:COMETPUNCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: STEELWING.rb =====#
#-------------------------------------------------------------------------------
#  STEELWING
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STEELWING) do
  pbSEPlay("EBDX/Anim/flying1",80)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  cx, cy = @targetSprite.getCenter(true)
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_2")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 51
    r = rand(3)
    fp["#{i}"].zoom_x = (factor-0.5)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (factor-0.5)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  wait = []
  for m in 0...8
    fp["w#{m}"] = Sprite.new(@viewport)
    fp["w#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb164_2")
    fp["w#{m}"].ox = 20
    fp["w#{m}"].oy = 16
    fp["w#{m}"].opacity = 0
    fp["w#{m}"].z = 50
    fp["w#{m}"].angle = rand(360)
    fp["w#{m}"].zoom_x = factor - 0.5
    fp["w#{m}"].zoom_y = factor - 0.5
    fp["w#{m}"].x = cx - 32*factor + rand(64*factor)
    fp["w#{m}"].y = cy - 112*factor + rand(112*factor)
    wait.push(0)
  end
  pbSEPlay("Anim/metal",80)
  frame = Sprite.new(@viewport)
  frame.z = 51
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_0_2")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  # start animation
  for i in 1..30
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for m in 0...8
      next if m>(i/2)
      fp["w#{m}"].angle += 2
      fp["w#{m}"].opacity += 32*(wait[m] < 8 ? 1 : -0.25)
      wait[m] +=  1
    end
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: STICKYWEB.rb =====#
#-------------------------------------------------------------------------------
#  STICKYWEB
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STICKYWEB) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  if @userIndex == 0 || @userIndex == 2
	cxT = 367
	cyT = 168
	cxP = 101
	cyP = 317
	cxS = 270
	cyS = 230
	opp = :ENEMY
	zoom = 1
  else 
	cxP = 367
	cyP = 168
	cxT = 101
	cyT = 317
	cxS = 160
	cyS = 290
	opp = :PLAYER
	zoom = 2
  end
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(229,255,204))
  fp["bg"].opacity = 0
  fp["spike"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb223_3"))
  fp["spike"].keyFrame = 1
  fp["spike"].z = @targetSprite.z + 30
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # shooting out the spike
  for i in 0...24
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["spike"].x = points[i][0]
    fp["spike"].y = points[i][1]
    z = 1 + (1-(fp["spike"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["spike"].zoom_x = z
    fp["spike"].zoom_y = z
    fp["spike"].update
	pbSEPlay("Anim/Throw",60) if i == 4
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(opp))
  #@targetSprite.color = Color.new(128,128,128,0)
  fp["spike"].dispose
  # rest of the particles
	@scene.wait(15,true)
	fp["net"] = Sprite.new(@viewport)
	fp["net"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb621")
	fp["net"].center!
	fp["net"].x = cxS
	fp["net"].y = cyS
	fp["net"].zoom_x = 0
	fp["net"].zoom_y = 0
	fp["net"].angle = rand(360)
	fp["net"].z = @targetSprite.z + 30
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/Splat",90) if i == 5
    next if !bomb
    next if i < 8
    fp["net"].zoom_x += (1.6 - fp["net"].zoom_x)*0.1
    fp["net"].zoom_y += (1.6 - fp["net"].zoom_y)*0.1
	if fp["net"].zoom_x >= 1
      fp["net"].opacity -= 16
    end
      fp["net"].color.alpha -= 8
	@scene.wait(1,i < 8)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: STOCKPILE.rb =====#
#-------------------------------------------------------------------------------
#  STOCKPILE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STOCKPILE) do
  # set up animation
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb195_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
  end
  k = 0
  c = [Tone.new(2,194,223),Tone.new(0,0,0)]
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  for i in 0...128
    cx, cy = @userSprite.getCenter
    for j in 0...12
      if fp["#{j}"].opacity == 0
        r = rand(2)
        fp["#{j}"].zoom_x = factor*(r==0 ? 1 : 0.5)
        fp["#{j}"].zoom_y = factor*(r==0 ? 1 : 0.5)
        x, y = randCircleCord(64*factor)
        fp["#{j}"].x = cx - 64*factor*@userSprite.zoom_x + x*@userSprite.zoom_x
        fp["#{j}"].y = cy - 64*factor*@userSprite.zoom_y + y*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx
      y2 = cy
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= fp["#{j}"].zoom_x*0.1
      fp["#{j}"].zoom_y -= fp["#{j}"].zoom_y*0.1
      if i >= 96
        fp["#{j}"].opacity -= 35
      elsif (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity = 0
      else
        fp["#{j}"].opacity += 35
      end
    end
    if i < 96
      fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.6
    else
      fp["bg"].opacity -= 5
    end
    if i < 112
      if i%16 == 0
        k += 1
        k = 0 if k > 1
      end
      @userSprite.tone.red += (c[k].red - @userSprite.tone.red)*0.2
      @userSprite.tone.green += (c[k].green - @userSprite.tone.green)*0.2
      @userSprite.tone.blue += (c[k].blue - @userSprite.tone.blue)*0.2
    end
    pbSEPlay("Anim/Absorb2",100) if i == 16
    pbSEPlay("Anim/Saint8",70) if i == 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @userSprite.tone = Tone.new(0,0,0)
  @vector.reset
  pbDisposeSpriteHash(fp)
 end
#===== FILE: STOMP.rb =====#
#-------------------------------------------------------------------------------
#  STOMP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STOMP) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 5
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...2
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb109")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...15
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb137_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...20
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...2
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...15
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: STONEEDGE.rb =====#
#-------------------------------------------------------------------------------
#  PRECIPICEBLADES
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:PRECIPICEBLADES) do
  EliteBattle.playMoveAnimation(:STONEEDGE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  STONEEDGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STONEEDGE) do
  # set up animation
  blades = 9
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(131,92,42))
  fp["bg"].opacity = 0
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  EliteBattle.playMoveAnimation(:SANDSTORM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  @vector.set(vector)
  @scene.wait(16,true)
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb642_3")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height/2
    fp["i#{j}"].opacity = 0
    fp["i#{j}"].zoom_x = @targetSprite.zoom_x
    fp["i#{j}"].zoom_y = @targetSprite.zoom_y
    fp["i#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["i#{j}"].x = @targetSprite.x + rand(32)*@targetSprite.zoom_x*(rand(2)==0 ? 1 : -1)
    fp["i#{j}"].y = @targetSprite.y - 8*@targetSprite.zoom_y + rand(16)*@targetSprite.zoom_y
  end
  for j in 0...blades
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_0_1")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    fp["s#{j}"].opacity = 0
    fp["s#{j}"].zoom_x = @targetSprite.zoom_x
    fp["s#{j}"].zoom_y = @targetSprite.zoom_y
    fp["s#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["s#{j}"].x = @targetSprite.x - 48*@targetSprite.zoom_x + rand(96)*@targetSprite.zoom_x
    fp["s#{j}"].y = @targetSprite.y - 192*@targetSprite.zoom_y
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_13")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = 2
    fp["p#{j}"].zoom_y = 2
    fp["p#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["p#{j}"].x = fp["s#{j}"].x
    fp["p#{j}"].y = fp["s#{j}"].y + 192*@targetSprite.zoom_y
  end
  k = -2
  for i in 0...64
    k *= -1 if i%4==0 && i >= 8
    pbSEPlay("EBDX/Anim/rock1",70) if i%8==0 && i >0 && i < 48
    pbSEPlay("EBDX/Anim/rock2",70) if i%8==0 && i >0 && i < 48
    for j in 0...blades
      next if j>(i/6)
      fp["s#{j}"].opacity += 64 if fp["s#{j}"].opacity < 150
      fp["s#{j}"].y += 24*@targetSprite.zoom_y if fp["s#{j}"].y < @targetSprite.y
      fp["s#{j}"].zoom_y -= 0.2*@targetSprite.zoom_y if fp["s#{j}"].y >= @targetSprite.y
      fp["s#{j}"].visible = false if fp["s#{j}"].zoom_y <= 0.4*@targetSprite.zoom_y
    end
    for j in 0...blades
      next if i < 8
      next if j>(i-8)/8
      fp["p#{j}"].visible = true
      fp["p#{j}"].opacity -= 32
      fp["p#{j}"].zoom_x += 0.02
      fp["p#{j}"].zoom_y += 0.02
      fp["p#{j}"].angle += 8
    end
    for j in 0...16
      next if i < 8
      next if j>(i-8)/2
      fp["i#{j}"].opacity += 45*(fp["i#{j}"].zoom_x <= 0.5*@targetSprite.zoom_x ? -1 : 1)
      fp["i#{j}"].zoom_x -= 0.04*@targetSprite.zoom_x
      fp["i#{j}"].zoom_y -= 0.04*@targetSprite.zoom_y
      fp["i#{j}"].x += 2*@targetSprite.zoom_x*(fp["i#{j}"].x >= @targetSprite.x ? 1 : -1)
      fp["i#{j}"].angle += 4*(fp["i#{j}"].x >= @targetSprite.x ? 1 : -1)
    end
    @scene.moveEntireScene(0, k, true, true) if i >= 8 && i < 48
    @scene.wait
  end
  16.times do
	fp["i#{j}"].opacity -= 50
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: STRUGGLEBUG.rb =====#
#-------------------------------------------------------------------------------
#  Struggle Bug
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STRUGGLEBUG) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  for j in 0...24
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb010")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...24
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].tone = Tone.new(255,255,255)
    fp["s#{j}"].angle = rand(360)
  end
  # anim2
  for i in 0...32
    for j in 0...12
      next if j>(i*2)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
      fp["s#{j}"].tone.red -= 32
      fp["s#{j}"].tone.green -= 32
      fp["s#{j}"].tone.blue -= 32
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal2",80) if i%4==0 && i < 16
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: STUNSPORE.rb =====#
#-------------------------------------------------------------------------------
#  STUNSPORE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STUNSPORE) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_6")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(242,230,69,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SUNNYDAY.rb =====#
#-------------------------------------------------------------------------------
#  SUNNYDAY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SUNNYDAY) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["weatherball"] = Sprite.new(@viewport)
  fp["weatherball"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_9")
  fp["weatherball"].ox = fp["weatherball"].bitmap.width/2
  fp["weatherball"].oy = fp["weatherball"].bitmap.height/2
  fp["weatherball"].z = 50
  fp["weatherball"].x, fp["weatherball"].y = @userSprite.getCenter
  fp["weatherball"].opacity = 0
  fp["weatherball"].zoom_x = factor*1.4
  fp["weatherball"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_10")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Fire2")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].zoom_x -= factor*0.4/10
    fp["weatherball"].zoom_y -= factor*0.4/10
    fp["weatherball"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  10.times do
    fp["weatherball"].zoom_x += factor*0.4/10
    fp["weatherball"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["weatherball"].zoom_x
    fp["dnt"].zoom_y = fp["weatherball"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["weatherball"].zoom_y -= factor*0.02
    elsif
      fp["weatherball"].zoom_x -= factor*0.02
      fp["weatherball"].zoom_y += factor*0.04
    end
    fp["weatherball"].x = cx
    fp["weatherball"].y = cy
    fp["weatherball"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying1") if i == 10
  end
  for i in 0...20
    fp["weatherball"].y -= 32
    fp["weatherball"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @scene.wait(20,true)
end
#===== FILE: SUPERPOWER.rb =====#
#-------------------------------------------------------------------------------
#  REVENGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:REVENGE) do
  EliteBattle.playMoveAnimation(:SUPERPOWER, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SUPERPOWER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SUPERPOWER) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  EliteBattle.playMoveAnimation(:DRAGONDANCE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playMoveAnimation(:FINALGAMBIT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end
#===== FILE: SUPERSONIC.rb =====#
#-------------------------------------------------------------------------------
#  SUPERSONIC
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SUPERSONIC) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SURF.rb =====#
#-------------------------------------------------------------------------------
#  SURF
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SURF) do
  # def ini
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  factor = @userIsPlayer ? 1 : 0.75
  factorY = @userIsPlayer ? 0.992 : 1.01#1.01
  BubbleSplash = @userIsPlayer ? 15 : -15
  splash = 30
  shake = 8
  # graphic ini
  fp = {};
  fp["surf"] = Sprite.new(@viewport)
  fp["surf"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  if @userIsPlayer
	fp["surf"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb624_PU")
	fp["surf"].x = -200
	fp["surf"].y =  800
	moveX = 15
	moveY = -7
  else
	fp["surf"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb624_EU") 
	fp["surf"].x =  900
	fp["surf"].y =  -550
	moveX = -15
	moveY = 7
  end
  fp["surf"].zoom_x = factor
  fp["surf"].zoom_y = factor
  fp["surf"].ox = fp["surf"].bitmap.width/2
  fp["surf"].oy = fp["surf"].bitmap.height/2
  fp["surf"].z = @targetSprite.z + 1
  fp["surf"].opacity = 0
  # sprite ini
  @userSprite.color = Color.new(51,153,255,0)
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  @scene.wait(4,true)
  for i in 0...75
	pbSEPlay("Anim/Water1") if i%25 == 0
    fp["surf"].opacity += 25 if fp["surf"].opacity <= 125
	fp["surf"].x += moveX
	fp["surf"].y += moveY
	fp["surf"].zoom_y = factorY * fp["surf"].zoom_y
	if i == 35
		for v in 0...splash
			fp["p#{v}"] = Sprite.new(@viewport)
			fp["p#{v}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb540_4")
			fp["p#{v}"].center!
			fp["p#{v}"].x, fp["p#{v}"].y = @targetSprite.getCenter(true)
			r = (40 + rand(24))*@targetSprite.zoom_x
			x, y = randCircleCord(r)
			fp["p#{v}"].end_x = fp["p#{v}"].x - r + x
			fp["p#{v}"].end_y = fp["p#{v}"].y - r + y
			fp["p#{v}"].zoom_x = 0
			fp["p#{v}"].zoom_y = 0
			fp["p#{v}"].angle = rand(360)
			fp["p#{v}"].z = @targetSprite.z + 1
		  end
		end
	if i.between?(40,70)
      for j in 0...splash
		  next if j > (i-8)*2
		  fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
		  fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
		  fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1 + BubbleSplash
		  fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1 - BubbleSplash
		  if fp["p#{j}"].zoom_x >= 0.5
			fp["p#{j}"].opacity -= 16
		  end
		  fp["p#{j}"].color.alpha -= 8
	  end
      @targetSprite.ox += shake
      shake = -8 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 8 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
	  if i < 55
		@userSprite.color.alpha += 10
	  else
		@userSprite.color.alpha -= 16
	  end
	  @userSprite.still
	  @userSprite.anim = true
    end
	@scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end
#===== FILE: SWEETKISS.rb =====#
#-------------------------------------------------------------------------------
#  LOVELYKISS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LOVELYKISS) do
  EliteBattle.playMoveAnimation(:SWEETKISS, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SWEETKISS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SWEETKISS) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  factor = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(142,245,255))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb636_3")
    fp["#{i}"].src_rect.set(0,0*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Love",80) if i%12==0 && i <= 96
    if i >= 96
      @targetSprite.tone.all += 1.4*2 if @targetSprite.tone.all < 48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  #heart splatter
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb636_3")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
	factor[j] = rand(1)
    #fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/LoveSplatter") if i == 1
    for j in 0...32
	  next if !bomb
      next if i < 8
      next if j > (i-8)*2
	  if factor[j] == 0 || true
		  fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.03
		  fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.03
	  else
	  	  fp["p#{j}"].zoom_x += (1.0 - fp["p#{j}"].zoom_x)*0.03
		  fp["p#{j}"].zoom_y += (1.0 - fp["p#{j}"].zoom_y)*0.03
	  end
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 0.8
        fp["p#{j}"].opacity -= 25
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  20.times do
    @targetSprite.tone.all -= 1.6*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @targetSprite.tone.all = 0
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: SWEETSCENT.rb =====#
#-------------------------------------------------------------------------------
#  SWEETSCENT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SWEETSCENT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(0,204,102))
  fp["bg"].opacity = 0
  #
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb611_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = @targetSprite.z + 1
    rndx.push(rand(256)); prndx.push(rand(72))
    rndy.push(rand(256)); prndy.push(rand(72))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  shake = 4
  # start animation
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  @vector.set(vector2)
  pbSEPlay("Anim/Whirlwind")
  for i in 0...72
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += rangl[j]*2
      nextx = fp["#{j}"].x
      nexty = fp["#{j}"].y
      if !@targetIsPlayer
        fp["#{j}"].opacity -= 25 if j > 65#if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 25 if j > 65#if nextx < cx && nexty > cy
      end
    end
    if i >= 64
      #@targetSprite.x += 64*(@targetIsPlayer ? -1 : 1)
    elsif i >= 52
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(vector) if i == 16
    @vector.inc = 0.1 if i == 16
    @scene.wait(1,i < 64)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @vector.inc = 0.2
  @scene.wait(16,true)
end

#===== FILE: SWIFT.rb =====#
#-------------------------------------------------------------------------------
#  SWIFT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SWIFT) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = @targetSprite.z + 1
    rndx.push(rand(256)); prndx.push(rand(24))
    rndy.push(rand(256)); prndy.push(rand(24))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  shake = 4
  # start animation
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  @vector.set(vector2)
  pbSEPlay("Anim/Whirlwind")
  for i in 0...72
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += 25
      nextx = fp["#{j}"].x
      nexty = fp["#{j}"].y
      if !@targetIsPlayer
        fp["#{j}"].opacity -= 25 if j > 65#if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 25 if j > 65#if nextx < cx && nexty > cy
      end
    end
    if i >= 64
      #@targetSprite.x += 64*(@targetIsPlayer ? -1 : 1)
    elsif i >= 52
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(vector) if i == 16
    @vector.inc = 0.1 if i == 16
    @scene.wait(1,i < 64)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  @vector.inc = 0.2
  @scene.wait(16,true)
end

#===== FILE: SWITCHEROO.rb =====#
#-------------------------------------------------------------------------------
#  SWITCHEROO
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SWITCHEROO) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["change1"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_11"))
  fp["change1"].keyFrame = 1
  fp["change1"].z = @targetSprite.z + 1
  fp["change2"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb645_11"))
  fp["change2"].keyFrame = 1
  fp["change2"].z = @userSprite.z + 1
  # shooting out the change1
  for i in 0...24
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["change1"].x = points[i][0]
    fp["change1"].y = points[i][1]
    z = 1 + (1-(fp["change1"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change1"].zoom_x = z
    fp["change1"].zoom_y = z
    fp["change1"].update
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxT,cyT,mx,32,cxP,cyP,24)
    fp["change2"].x = points[i][0]
    fp["change2"].y = points[i][1]
    z = 1 + (1-(fp["change2"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["change2"].zoom_x = z
    fp["change2"].zoom_y = z
    fp["change2"].update
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  pbSEPlay("Anim/Saint7")
  @targetSprite.color = Color.new(58,58,58,0)
  @userSprite.color = Color.new(58,58,58,0)
  fp["change1"].dispose
  fp["change2"].dispose
  # zooming onto the target
  8.times do
    @targetSprite.color.alpha += 18
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha += 18
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,true)
  end
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_12")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  for j in 0...32
    fp["p2#{j}"] = Sprite.new(@viewport)
    fp["p2#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb645_12")
    fp["p2#{j}"].center!
    fp["p2#{j}"].x, fp["p2#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p2#{j}"].end_x = fp["p2#{j}"].x - r + x
    fp["p2#{j}"].end_y = fp["p2#{j}"].y - r + y
    fp["p2#{j}"].zoom_x = 0
    fp["p2#{j}"].zoom_y = 0
    fp["p2#{j}"].angle = rand(360)
    fp["p2#{j}"].z = @userSprite.z + 1
  end
  # sparkle animation
  for i in 0...64
    break if !bomb && i > 15
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
	  
	  fp["p2#{j}"].zoom_x += (1.6 - fp["p2#{j}"].zoom_x)*0.1
      fp["p2#{j}"].zoom_y += (1.6 - fp["p2#{j}"].zoom_y)*0.1
      fp["p2#{j}"].x += (fp["p2#{j}"].end_x - fp["p2#{j}"].x)*0.1
      fp["p2#{j}"].y += (fp["p2#{j}"].end_y - fp["p2#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
	  if fp["p2#{j}"].zoom_x >= 1
        fp["p2#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
      fp["p2#{j}"].color.alpha -= 8
    end
    @targetSprite.color.alpha -= 16 if i >= 48
    @targetSprite.anim = true
    @targetSprite.still
	@userSprite.color.alpha -= 16 if i >= 48
    @userSprite.anim = true
    @userSprite.still
    @scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end
#===== FILE: SWORDSDANCE.rb =====#
#-------------------------------------------------------------------------------
#  SECRETPOWER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SECRETPOWER) do
  EliteBattle.playMoveAnimation(:SWORDSDANCE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  SHARPEN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SHARPEN) do
  EliteBattle.playMoveAnimation(:SWORDSDANCE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  WORKUP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WORKUP) do
  EliteBattle.playMoveAnimation(:SWORDSDANCE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  SWORDSDANCE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SWORDSDANCE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb615_1")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(183,183,183,0)
  # start animation
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: SYNTHESIS.rb =====#
#-------------------------------------------------------------------------------
#  AROMATHERAPY
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:AROMATHERAPY) do
  EliteBattle.playMoveAnimation(:SYNTHESIS, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SYNTHESIS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SYNTHESIS) do
  # configure animation
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  @scene.wait(16,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(0,204,102))
  fp["bg"].opacity = 0
  #
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619_4")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: TACKLE.rb =====#
#-------------------------------------------------------------------------------
#  Tackle
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TACKLE) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(20,true) if withvector
  factor = @targetSprite.zoom_y
  pbSEPlay("EBDX/Anim/normal1",80)
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  # start animation
  for i in 1..30
    if i < 8 && shake
      x=(i/4 < 1) ? 2 : -2
      @scene.moveEntireScene(0, x*2, true, true)
    end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------
#  Substitute
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SUBSTITUTE) do
  pbSEPlay("Anim/Substitute")
  @scene.setSubstitute(@userIndex, true)
end

#===== FILE: TAILSLAP.rb =====#
#-------------------------------------------------------------------------------
#  TAILSLAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TAILSLAP) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb632_8")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb210_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  # start animation
  k = 1
  for i in 0...32
    pbSEPlay("EBDX/Anim/normal4",80) if i == 4
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: TAILWHIP.rb =====#
#-------------------------------------------------------------------------------
#  TAILWHIP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TAILWHIP) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 8
  for i in 0...12
    @userSprite.still
	pbSEPlay("EBDX/Anim/move1",100) if i%6 == 0
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -8 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 8 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: TAILWIND.rb =====#
#-------------------------------------------------------------------------------
#  DEFOG
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DEFOG) do
  EliteBattle.playMoveAnimation(:TAILWIND, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  TAILWIND
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TAILWIND) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(104,146,164))
  fp["bg"].opacity = 0
  fp["wave"] = AnimatedPlane.new(@viewport)
  fp["wave"].bitmap = Bitmap.new(1026,@viewport.height)
  fp["wave"].bitmap.stretch_blt(Rect.new(0,0,fp["wave"].bitmap.width,fp["wave"].bitmap.height),pbBitmap("Graphics/EBDX/Animations/Moves/eb132_3"),Rect.new(0,0,1026,212))
  fp["wave"].opacity = 0
  fp["wave"].z = 50
  @vector.set(EliteBattle.get_vector(:DUAL))
  @vector.inc = 0.1
  pulse = 10
  shake = [4,4,4,4]
  # start animation
  for j in 0...64
    pbSEPlay("Anim/Wind8") if j == 24
    fp["wave"].ox += 48
    fp["wave"].opacity += pulse
    pulse = -5 if fp["wave"].opacity > 160
    pulse = +5 if fp["wave"].opacity < 100
    fp["bg"].opacity += 1 if fp["bg"].opacity < 255*0.35
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
      @sprites["pokemon_#{i}"].tone.all += 3 if j.between?(16,48)
      if j >= 32
        @sprites["pokemon_#{i}"].ox += shake[i]
        shake[i] = -4 if @sprites["pokemon_#{i}"].ox > @sprites["pokemon_#{i}"].bitmap.width/2 + 2
        shake[i] = 4 if @sprites["pokemon_#{i}"].ox < @sprites["pokemon_#{i}"].bitmap.width/2 - 2
      end
    end
    @sprites["pokemon_#{@userIndex}"].tone.all += 3 if j < 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  for i in 0...4
    next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
    next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
    @sprites["pokemon_#{i}"].ox = @sprites["pokemon_#{i}"].bitmap.width/2
  end
  for j in 0...64
    fp["wave"].ox += 48
    if j < 32
      fp["wave"].opacity += pulse
      pulse = -5 if fp["wave"].opacity > 160
      pulse = +5 if fp["wave"].opacity < 100
    end
    fp["wave"].opacity -= 4 if j >= 32
    fp["bg"].opacity -= 4 if j >= 32
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible)
      @sprites["pokemon_#{i}"].tone.all -= 3 if j >= 32
    end
    @sprites["pokemon_#{@userIndex}"].tone.all -= 3 if j >= 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: TAKEDOWN.rb =====#
#-------------------------------------------------------------------------------
#  BODYSLAM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BODYSLAM) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  RETURN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RETURN) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FACADE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FACADE) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FLAIL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLAIL) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ENDEAVOR
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ENDEAVOR) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  STRENGTH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STRENGTH) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SLAM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SLAM) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DOUBLEEDGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DOUBLEEDGE) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  STRUGGLE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:STRUGGLE) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FRUSTRATION
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FRUSTRATION) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  RETURN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:RETURN) do
  EliteBattle.playMoveAnimation(:TAKEDOWN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  TAKEDOWN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TAKEDOWN) do | args |
  factor = @targetSprite.zoom_x
  x1Move = @userIsPlayer ? 3 : -3
  x2Move = @userIsPlayer ? 13 : -13
  shake  = 10
  idx =  0 # counter
  dir = -1 # direction
  userOX = @userSprite.ox
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # phase 1
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # user move
  for i in 0...50
    @userSprite.still
	@userSprite.ox += shake if i == 19
	pbSEPlay("Anim/TakeDownCharge",100) if i == 20 || i == 40
	pbSEPlay("Anim/TakeDownAttack",100) if i == 40
	#default movement
    if i.between?(0,20)
		@userSprite.ox += x1Move
	end
	if i.between?(20,40)
		@userSprite.still
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
			@userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
	end
	if i.between?(40,50)
		@userSprite.ox -= x2Move
    end
    @scene.wait(1,true)
  end
  # phase 2
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  for i in 0...8
	@userSprite.ox += x2Move/2
    @scene.wait(1,true)
  end
  @scene.wait(5,true)
  EliteBattle.playMoveAnimation(:HEADBUTT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = userOX
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: TAUNT.rb =====#
#-------------------------------------------------------------------------------
#  SWAGGER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SWAGGER) do
  EliteBattle.playMoveAnimation(:TAUNT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  TAUNT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TAUNT) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...12
    @userSprite.still
	pbSEPlay("Cries/#{@userSprite.species}",85) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  #taunt
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  t = 1
  for j in 0..t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb643")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx + 20 if j == 0
    fp["#{j}"].x = cx - 20 if j == 1
    fp["#{j}"].y = cy - 40
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
  end
  # start animation
  for i in 0...30
	pbSEPlay("Anim/Taunt",100) if i == 3 || i == 9
    for j in 0..t
      next if j>(i*2)
	  next if i <= 5 && j == 1
      fp["#{j}"].visible = true
      if i > 20
        fp["#{j}"].opacity -= 32
      else
		if fp["#{j}"].zoom <= 1.5
			fp["#{j}"].zoom += 0.1
		else
		    fp["#{j}"].opacity -= 32
		end
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -=12
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: TEARFULLOOK.rb =====#
#-------------------------------------------------------------------------------
#  TEARFULLOOK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TEARFULLOOK) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  factor = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(203,142,255))
  fp["bg"].opacity = 0
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb636_4")
    fp["#{i}"].src_rect.set(0,0*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...16
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Love",80) if i%12==0 && i <= 96
    if i >= 96
      @targetSprite.tone.all += 1.4*2 if @targetSprite.tone.all < 48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  #heart splatter
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
	fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb636_4")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @targetSprite.getCenter(true)
    r = (40 + rand(24))*@targetSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
	factor[j] = rand(1)
    #fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 1
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/LoveSplatter") if i == 1
    for j in 0...32
	  next if !bomb
      next if i < 8
      next if j > (i-8)*2
	  if factor[j] == 0 || true
		  fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.03
		  fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.03
	  else
	  	  fp["p#{j}"].zoom_x += (1.0 - fp["p#{j}"].zoom_x)*0.03
		  fp["p#{j}"].zoom_y += (1.0 - fp["p#{j}"].zoom_y)*0.03
	  end
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 0.8
        fp["p#{j}"].opacity -= 25
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  20.times do
    @targetSprite.tone.all -= 1.6*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @targetSprite.tone.all = 0
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: THIEF.rb =====#
#-------------------------------------------------------------------------------
#  THIEF
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:THIEF) do
  # configure animation
  fp = {};
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_9")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height/2
    r = 32*factor
    fp["s#{j}"].x = cx - r + rand(r*2)
    fp["s#{j}"].y = cy - r + rand(r*2)
    fp["s#{j}"].z = @targetSprite.z + 1
    fp["s#{j}"].visible = false
    fp["s#{j}"].angle = rand(360)
  end
  # anim2
  for i in 0...32
    for j in 0...12
      next if j>(i*2)
      fp["s#{j}"].visible = true
      fp["s#{j}"].opacity -= 32
      fp["s#{j}"].zoom_x += 0.02
      fp["s#{j}"].zoom_y += 0.02
      fp["s#{j}"].angle += 8
    end
    @targetSprite.still
    pbSEPlay("EBDX/Anim/normal1",80) if i%4==0 && i < 16
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: THRASH.rb =====#
#-------------------------------------------------------------------------------
#  THRASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:THRASH) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  speed = []
  frame = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb129_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  for j in 0...32
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].color = Color.new(255,255,255,255)
    z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    fp["#{j}"].opacity = 0
    speed.push((rand(8)+1)*4)
  end
  for j in 0...8
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].z = @userIsPlayer ? 29 : 19
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb057_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    #z = [0.5,1.5,1,0.75,1.25][rand(5)]
    fp["s#{j}"].color = Color.new(255,255,255,255)
    #fp["s#{j}"].zoom_y = z
    fp["s#{j}"].opacity = 0
  end
  @userSprite.color = Color.new(51,153,255,0)
  # start animation
  # charge
  @vector.set(vector2)
  @vector.inc = 0.1
  oy = @userSprite.oy
  k = -1
  for i in 0...64
    k *= -1 if i%4==0
    pbSEPlay("EBDX/Anim/dragon2") if i == 12
    cx, cy = @userSprite.getCenter(true)
    for j in 0...32
      next if i < 8
      next if j>(i-8)
      if fp["#{j}"].opacity == 0 && fp["#{j}"].color.alpha == 255
        fp["#{j}"].y = @userSprite.y + 8*@userSprite.zoom_y - rand(24)*@userSprite.zoom_y
        fp["#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["#{j}"].color.alpha <= 96
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].opacity += 32
      end
      fp["#{j}"].color.alpha -= 16
      fp["#{j}"].y -= speed[j]
    end
    for j in 0...8
      next if i < 12
      next if j>(i-12)/2
      if fp["s#{j}"].opacity == 0 && fp["s#{j}"].color.alpha == 255
        fp["s#{j}"].y = @userSprite.y + 48*@userSprite.zoom_y - rand(16)*@userSprite.zoom_y
        fp["s#{j}"].x = cx - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
      end
      if fp["s#{j}"].color.alpha <= 96
        fp["s#{j}"].opacity -= 32
      else
        fp["s#{j}"].opacity += 32
      end
      fp["s#{j}"].color.alpha -= 16
      fp["s#{j}"].zoom_y += speed[j]*0.25*0.01
      fp["s#{j}"].y -= speed[j]
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
    @userSprite.oy -= 2*k if i%2==0
    @userSprite.still
    @userSprite.anim = true
    @scene.wait(1,true)
  end
  @userSprite.oy = oy
  # clash
  @vector.set(vector)
  @vector.inc = 0.2
  @scene.wait(16,true)
  pbSEPlay("EBDX/Anim/fire2",60)
  pbSEPlay("EBDX/Anim/fire3",60)
  @sprites["battlebg"].defocus
  for i in 0...10
    # for j in 0...16
      # next if j>(i/2)
      # fp["f#{j}"].visible = true
      # fp["f#{j}"].y -= 8*@userSprite.zoom_y
      # fp["f#{j}"].opacity -= 32 if frame[j] >= 8
      # frame[j] += 1
    # end
    fp["bg"].opacity += 14
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/fire4",80)
  # @vector.set(vector)
  # @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_2")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  for j in 0...3
    fp["#{j}x"] = Sprite.new(@viewport)
    fp["#{j}x"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_3")
    fp["#{j}x"].ox = fp["#{j}x"].bitmap.width/2
    fp["#{j}x"].oy = fp["#{j}x"].bitmap.height/2
    fp["#{j}x"].x = cx - 32 + rand(64)
    fp["#{j}x"].y = cy - 32 + rand(64)
    fp["#{j}x"].z = @targetSprite.z + 1
    fp["#{j}x"].visible = false
    fp["#{j}x"].zoom_x = @targetSprite.zoom_x
    fp["#{j}x"].zoom_y = @targetSprite.zoom_y
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb622_4")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
  end
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 32
    pbSEPlay("EBDX/Anim/fire1",80) if i == 8
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}x"].visible = true
      fp["#{j}x"].opacity -= 16
      fp["#{j}x"].angle += 16
      fp["#{j}x"].zoom_x += 0.1
      fp["#{j}x"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: THROATCHOP.rb =====#
#-------------------------------------------------------------------------------
#  BRUTALSWING
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:BRUTALSWING) do | args |
  EliteBattle.playMoveAnimation(:THROATCHOP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  THROATCHOP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:THROATCHOP) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  rndx = []
  rndy = []
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(64,64,64))
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_6")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_5")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..20
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	cx, cy = @targetSprite.getCenter(true)
	pbSEPlay("Anim/Slash10",85) if i == 5
	for k in 0...16
		next if i < 4
		if j == 0 && i == 6
			fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
			fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
			@targetSprite.still if k.between?(flashStart,flashStart+2)
			@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
			@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
			@scene.wait(1,true)
			pbSEPlay("EBDX/Anim/normal3",85) if k == 4
			fp["claw"].src_rect.height += 45
			fp["claw"].opacity -= 45 if k >= 5
			j = 1 if k == 16		
		end
		#
		if fp["#{k}"].opacity == 0 && fp["#{k}"].visible
			fp["#{k}"].x = cx
			fp["#{k}"].y = cy
		end
		x2 = cx - 64*@targetSprite.zoom_x + rndx[k]*@targetSprite.zoom_x
		y2 = cy - 64*@targetSprite.zoom_y + rndy[k]*@targetSprite.zoom_y
		x0 = fp["#{k}"].x
		y0 = fp["#{k}"].y
		fp["#{k}"].x += (x2 - x0)*0.2
		fp["#{k}"].y += (y2 - y0)*0.2
		fp["#{k}"].zoom_x += 0.01
		fp["#{k}"].zoom_y += 0.01
		if i < 20
			fp["#{k}"].tone.red -= 6; fp["#{k}"].tone.blue -= 6; fp["#{k}"].tone.green -= 6
		end
		if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
			fp["#{k}"].opacity -= 51
		else
			fp["#{k}"].opacity += 51
		end
		fp["#{k}"].visible = false if fp["#{k}"].opacity <= 0
		#
	end
	@scene.wait(1,true)
  end
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: THUNDERBOLT.rb =====#
#-------------------------------------------------------------------------------
#  Thunderbolt
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:THUNDERBOLT) do | args |
  strike = *args; strike = false if strike.nil?
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  q = 0
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  @userSprite.color = Color.new(217,189,52,0) if strike
  for i in 0...8
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069_2")
    fp["#{i}"].src_rect.set(0,0,98,430)
    fp["#{i}"].ox = fp["#{i}"].src_rect.width/2
    fp["#{i}"].oy = fp["#{i}"].src_rect.height
    fp["#{i}"].zoom_x = 0.5
    fp["#{i}"].z = 50
  end
  for i in 0...16
    fp["s#{i}"] = Sprite.new(@viewport)
    fp["s#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069_3")
    fp["s#{i}"].ox = fp["s#{i}"].bitmap.width/2
    fp["s#{i}"].oy = fp["s#{i}"].bitmap.height/2
    fp["s#{i}"].opacity = 0
    fp["s#{i}"].z = 51
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069")
  fp["circle"].ox = fp["circle"].bitmap.width/2 + 4
  fp["circle"].oy = fp["circle"].bitmap.height/2 + 4
  fp["circle"].opacity = 0
  fp["circle"].z = 50
  fp["circle"].zoom_x = 1
  fp["circle"].zoom_y = 1
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @targetSprite.getCenter(true)
  fp["circle"].x = cx
  fp["circle"].y = cy
  for i in 0...96
    for j in 0...8
      next if j>(i/4)
      if fp["#{j}"].y <= 0 && i < 32
        pbSEPlay("Anim/Thunder3",80) if i%8==0
        fp["#{j}"].x = cx - 32*@targetSprite.zoom_x + rand(64)*@targetSprite.zoom_x
        fp["#{j}"].src_rect.x = 98*rand(3)
        t = rand(5)*48
        fp["#{j}"].opacity = 255
        fp["#{j}"].tone = Tone.new(t,t,t)
        fp["#{j}"].mirror = (rand(2)==0 ? true : false)
      end
      fp["#{j}"].src_rect.x += 98
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= 294
      fp["#{j}"].y += (@targetIsPlayer ? @vector.y : @vector.y2)/8.0 if fp["#{j}"].y < (@targetIsPlayer ? @vector.y : @vector.y2) + 32
      fp["#{j}"].opacity -= 32 if fp["#{j}"].y >= (@targetIsPlayer ? @vector.y : @vector.y2) + 32
      fp["#{j}"].y = 0 if fp["#{j}"].opacity <= 0
    end
    for n in 0...16
      next if i < 48
      next if n>(i-48)/4
      if fp["s#{n}"].opacity == 0 && fp["s#{n}"].tone.gray == 0
        pbSEPlay("EBDX/Anim/electric1",60) if i%8==0
        r2 = rand(4)
        fp["s#{n}"].zoom_x = [1,0.8,0.5,0.75][r2]
        fp["s#{n}"].zoom_y = [1,0.8,0.5,0.75][r2]
        fp["s#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48)
        fp["s#{n}"].x = cx - 48*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["s#{n}"].y = cy - 48*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["s#{n}"].angle = -Math.atan(1.0*(fp["s#{n}"].y-cy)/(fp["s#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      fp["s#{n}"].opacity += 128 if fp["s#{n}"].tone.gray == 0
      fp["s#{n}"].angle += 180 if (i-16)%2==0
      fp["s#{n}"].tone.gray = 1 if fp["s#{n}"].opacity >= 255
      q += 1 if fp["s#{n}"].opacity >= 255
      fp["s#{n}"].opacity -= 51 if fp["s#{n}"].tone.gray > 0 && q > 96
    end
    fp["circle"].opacity += (i < 48 ? 32 : - 64)
    fp["circle"].angle += 64
    fp["bg"].opacity -= 32 if i >= 90
    @targetSprite.still if i >= 32
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: THUNDERFANG.rb =====#
#-------------------------------------------------------------------------------
#  Thunder Fang
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:THUNDERFANG) do
  factor = @targetIsPlayer ? 2 : 1.5
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(217/6,189/6,52/6))
  fp["bg"].opacity = 0
  fp["fang1"] = Sprite.new(@viewport)
  fp["fang1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang1"].ox = fp["fang1"].bitmap.width/2
  fp["fang1"].oy = fp["fang1"].bitmap.height - 20
  fp["fang1"].opacity = 0
  fp["fang1"].color = Color.new(217,189,52,50)
  fp["fang1"].z = 41
  fp["fang2"] = Sprite.new(@viewport)
  fp["fang2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028")
  fp["fang2"].ox = fp["fang1"].bitmap.width/2
  fp["fang2"].oy = fp["fang1"].bitmap.height - 20
  fp["fang2"].opacity = 0
  fp["fang2"].color = Color.new(217,189,52,50)
  fp["fang2"].z = 40
  fp["fang2"].angle = 180
  l = 0; m = 0; q = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 51
  end
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["fang1"].x = cx; fp["fang1"].y = cy
    if i < 32
      fp["fang1"].zoom_x = @targetSprite.zoom_x; fp["fang1"].zoom_y = @targetSprite.zoom_y
    end
    fp["fang2"].x = cx; fp["fang2"].y = cy
    if i < 32
      fp["fang2"].zoom_x = @targetSprite.zoom_x; fp["fang2"].zoom_y = @targetSprite.zoom_y
    end
    if i.between?(20,29)
      fp["fang1"].opacity += 5
      fp["fang1"].oy += 2
      fp["fang2"].opacity += 5
      fp["fang2"].oy += 2
    elsif i.between?(30,40)
      fp["fang1"].opacity += 25.5
      fp["fang1"].oy -= 4
      fp["fang2"].opacity += 25.5
      fp["fang2"].oy -= 4
    else
      fp["fang1"].opacity -= 26
      fp["fang1"].oy += 2
      fp["fang2"].opacity -= 26
      fp["fang2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Super Fang")
    end
    pbSEPlay("Anim/Paralyze1") if i%8==0 && i>=48
    for n in 0...12
      next if i < 32
      if fp["#{n}"].opacity == 0 && fp["#{n}"].tone.gray == 0
        r2 = rand(4)
        fp["#{n}"].zoom_x = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].zoom_y = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        fp["#{n}"].x = cx - 48*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["#{n}"].y = cy - 48*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["#{n}"].angle = -Math.atan(1.0*(fp["#{n}"].y-cy)/(fp["#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      next if m>(i-32)/4
      fp["#{n}"].opacity += 51 if fp["#{n}"].tone.gray == 0
      fp["#{n}"].angle += 180 if (i-16)%3==0
      fp["#{n}"].tone.gray = 1 if fp["#{n}"].opacity >= 255
      q += 1 if fp["#{n}"].opacity >= 255
      fp["#{n}"].opacity -= 10 if fp["#{n}"].tone.gray > 0 && q > 96
    end
    fp["bg"].opacity += 4 if  i < 40
    fp["bg"].opacity -= 10 if i >= 56
    @targetSprite.tone = Tone.new(100,80,60) if i == 32
    if i >= 32
      if (i-32)/3 > l
        m += 1
        m = 0 if m > 1
        l = (i-32)/3
      end
      @targetSprite.zoom_y -= 0.16*(m==0 ? 1 : -1)
      @targetSprite.zoom_x += 0.08*(m==0 ? 1 : -1)
      @targetSprite.tone.red -= 5 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 4 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 3 if @targetSprite.tone.blue > 0
      @targetSprite.still
    end
    @scene.wait(1,(i < 32))
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: THUNDERPUNCH.rb =====#
#-------------------------------------------------------------------------------
#  Thunder Punch
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:THUNDERPUNCH) do
  factor = (@targetIsPlayer ? 2 : 1.5)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(217/6,189/6,52/6))
  fp["bg"].opacity = 0
  l = 0; m = 0; q = 0
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_2")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 51
  end
  fp["punch"] = Sprite.new(@viewport)
  fp["punch"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb108")
  fp["punch"].ox = fp["punch"].bitmap.width/2
  fp["punch"].oy = fp["punch"].bitmap.height/2
  fp["punch"].opacity = 0
  fp["punch"].z = 40
  fp["punch"].angle = 180
  fp["punch"].zoom_x = @targetIsPlayer ? 6 : 4
  fp["punch"].zoom_y = @targetIsPlayer ? 6 : 4
  fp["punch"].color = Color.new(217,189,52,50)
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("Anim/fog2",75)
  for i in 0...72
    cx, cy = @targetSprite.getCenter(true)
    fp["punch"].x = cx
    fp["punch"].y = cy
    fp["punch"].angle -= 45 if i < 40
    fp["punch"].zoom_x -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].zoom_y -= @targetIsPlayer ? 0.2 : 0.15 if i < 40
    fp["punch"].opacity += 8 if i < 40
    if i >= 40
      fp["punch"].tone = Tone.new(255,255,255) if i == 40
      fp["punch"].tone.all-=25.5
      fp["punch"].opacity -= 25.5
    end
    pbSEPlay("Anim/hit") if i==40
    pbSEPlay("Anim/Thunder3") if i==40
    pbSEPlay("Anim/Paralyze1") if i%8==0 && i>=52
    for n in 0...12
      next if i < 40
      if fp["#{n}"].opacity == 0 && fp["#{n}"].tone.gray == 0
        r2 = rand(4)
        fp["#{n}"].zoom_x = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].zoom_y = [0.2,0.25,0.5,0.75][r2]
        fp["#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48*factor)
        fp["#{n}"].x = cx - 48*factor*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["#{n}"].y = cy - 48*factor*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["#{n}"].angle = -Math.atan(1.0*(fp["#{n}"].y-cy)/(fp["#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      next if m>(i-40)/4
      fp["#{n}"].opacity += 51 if fp["#{n}"].tone.gray == 0
      fp["#{n}"].angle += 180 if (i-16)%3==0
      fp["#{n}"].tone.gray = 1 if fp["#{n}"].opacity >= 255
      q += 1 if fp["#{n}"].opacity >= 255
      fp["#{n}"].opacity -= 10 if fp["#{n}"].tone.gray > 0 && q > 96
    end
    fp["bg"].opacity += 4 if  i < 40
    fp["bg"].opacity -= 10 if i >= 56
    @targetSprite.tone = Tone.new(100,80,60) if i == 40
    if i >= 40
      if (i-40)/3 > l
        m += 1
        m = 0 if m > 1
        l = (i-40)/3
      end
      @targetSprite.zoom_y -= 0.16*(m==0 ? 1 : -1)
      @targetSprite.zoom_x += 0.08*(m==0 ? 1 : -1)
      @targetSprite.tone.red -= 5 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 4 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 3 if @targetSprite.tone.blue > 0
      @targetSprite.still
    end
    @scene.wait(1,(i < 40))
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: THUNDERWAVE.rb =====#
#-------------------------------------------------------------------------------
#  THUNDERSHOCK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:THUNDERSHOCK) do
  EliteBattle.playMoveAnimation(:THUNDERWAVE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  FLASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLASH) do
  EliteBattle.playMoveAnimation(:THUNDERWAVE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  THUNDERWAVE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:THUNDERWAVE) do | args |
  strike = *args; strike = false if strike.nil?
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  q = 0
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  @userSprite.color = Color.new(217,189,52,0) if strike
  for i in 0...2
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069_2")
    fp["#{i}"].src_rect.set(0,0,98,430)
    fp["#{i}"].ox = fp["#{i}"].src_rect.width/2
    fp["#{i}"].oy = fp["#{i}"].src_rect.height
    fp["#{i}"].zoom_x = 0.5
    fp["#{i}"].z = 50
  end
  for i in 0...8
    fp["s#{i}"] = Sprite.new(@viewport)
    fp["s#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069_3")
    fp["s#{i}"].ox = fp["s#{i}"].bitmap.width/2
    fp["s#{i}"].oy = fp["s#{i}"].bitmap.height/2
    fp["s#{i}"].opacity = 0
    fp["s#{i}"].z = 51
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069")
  fp["circle"].ox = fp["circle"].bitmap.width/2 + 4
  fp["circle"].oy = fp["circle"].bitmap.height/2 + 4
  fp["circle"].opacity = 0
  fp["circle"].z = 50
  fp["circle"].zoom_x = 1
  fp["circle"].zoom_y = 1
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  cx, cy = @targetSprite.getCenter(true)
  fp["circle"].x = cx
  fp["circle"].y = cy
  for i in 0...50
    for j in 0...2
      next if j>(i/4)
      if fp["#{j}"].y <= 0 && i < 32
        pbSEPlay("Anim/Thunder3",80) if i%8==0
        fp["#{j}"].x = cx - 32*@targetSprite.zoom_x + rand(64)*@targetSprite.zoom_x
        fp["#{j}"].src_rect.x = 98*rand(3)
        t = rand(5)*48
        fp["#{j}"].opacity = 255
        fp["#{j}"].tone = Tone.new(t,t,t)
        fp["#{j}"].mirror = (rand(2)==0 ? true : false)
      end
      fp["#{j}"].src_rect.x += 98
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= 294
      fp["#{j}"].y += (@targetIsPlayer ? @vector.y : @vector.y2)/8.0 if fp["#{j}"].y < (@targetIsPlayer ? @vector.y : @vector.y2) + 32
      fp["#{j}"].opacity -= 32 if fp["#{j}"].y >= (@targetIsPlayer ? @vector.y : @vector.y2) + 32
      fp["#{j}"].y = 0 if fp["#{j}"].opacity <= 0
    end
    for n in 0...8
      next if i < 25
      next if n>(i-25)/4
      if fp["s#{n}"].opacity == 0 && fp["s#{n}"].tone.gray == 0
        pbSEPlay("EBDX/Anim/electric1",60) if i%8==0
        r2 = rand(4)
        fp["s#{n}"].zoom_x = [1,0.8,0.5,0.75][r2]
        fp["s#{n}"].zoom_y = [1,0.8,0.5,0.75][r2]
        fp["s#{n}"].tone = rand(2)==0 ? Tone.new(196,196,196) : Tone.new(0,0,0)
        x, y = randCircleCord(48)
        fp["s#{n}"].x = cx - 48*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        fp["s#{n}"].y = cy - 48*@targetSprite.zoom_y + y*@targetSprite.zoom_y
        fp["s#{n}"].angle = -Math.atan(1.0*(fp["s#{n}"].y-cy)/(fp["s#{n}"].x-cx))*(180.0/Math::PI) + rand(2)*180 + rand(90)
      end
      fp["s#{n}"].opacity += 128 if fp["s#{n}"].tone.gray == 0
      fp["s#{n}"].angle += 180 if (i-8)%2==0
      fp["s#{n}"].tone.gray = 1 if fp["s#{n}"].opacity >= 255
      q += 1 if fp["s#{n}"].opacity >= 255
      fp["s#{n}"].opacity -= 51 if fp["s#{n}"].tone.gray > 0 && q > 96
    end
    fp["circle"].opacity += (i < 48 ? 32 : - 64)
    fp["circle"].angle += 64
    fp["bg"].opacity -= 32 if i >= 90
    @targetSprite.still if i >= 32
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: TORMENT.rb =====#
#-------------------------------------------------------------------------------
#  QUASH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:QUASH) do
  EliteBattle.playMoveAnimation(:TORMENT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FLATTER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FLATTER) do
  EliteBattle.playMoveAnimation(:TORMENT, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  TORMENT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TORMENT) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  # set up animation
  @scene.wait(5,true)
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  shake = 6
  for i in 0...12
    @userSprite.still
	pbSEPlay("Cries/#{@userSprite.species}",85) if i == 4
    if i.between?(4,12)
      @userSprite.ox += shake
      shake = -6 if @userSprite.ox > @userSprite.bitmap.width/2 + 2
      shake = 6 if @userSprite.ox < @userSprite.bitmap.width/2 - 2
    end
    @scene.wait(1,true)
  end
  #taunt
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  t = 1
  for j in 0..t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb643_4")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx + 20 if j == 0
    fp["#{j}"].x = cx - 20 if j == 1
    fp["#{j}"].y = cy - 40
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
  end
  # start animation
  for i in 0...30
	pbSEPlay("Anim/Taunt",100) if i == 3 || i == 9
    for j in 0..t
      next if j>(i*2)
	  next if i <= 5 && j == 1
      fp["#{j}"].visible = true
      if i > 20
        fp["#{j}"].opacity -= 32
      else
		if fp["#{j}"].zoom <= 1.5
			fp["#{j}"].zoom += 0.1
		else
		    fp["#{j}"].opacity -= 32
		end
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -=12
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: TOXIC.rb =====#
#-------------------------------------------------------------------------------
#  TOXIC
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TOXIC) do
  # configure animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  mass = 40
  for j in 0...mass
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_7")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 40*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @targetSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # target coloring
  @targetSprite.color = Color.new(39,23,54,0)
  # start animation
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...48
    for j in 0...mass
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
	if i < 30
      @targetSprite.color.alpha += 10
    else
      @targetSprite.color.alpha -= 20
    end
	@targetSprite.still
    @targetSprite.anim = true
    @scene.wait
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: TOXICSPIKES.rb =====#
#-------------------------------------------------------------------------------
#  TOXICSPIKES
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TOXICSPIKES) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  if @userIndex == 0 || @userIndex == 2
	cxT = 367
	cyT = 168
	cxP = 101
	cyP = 317
	cxS = 270
	cyS = 230
	opp = :ENEMY
	zoom = 1
  else 
	cxP = 367
	cyP = 168
	cxT = 101
	cyT = 317
	cxS = 160
	cyS = 290
	opp = :PLAYER
	zoom = 2
  end
  fp = {}
  fp["spike"] = TrailingSprite.new(@viewport,pbBitmap("Graphics/EBDX/Animations/Moves/eb620"))
  fp["spike"].keyFrame = 1
  fp["spike"].z = @targetSprite.z + 30
  # shooting out the spike
  for i in 0...24
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    points = calculateCurve(cxP,cyP,mx,-32,cxT,cyT,24)
    fp["spike"].x = points[i][0]
    fp["spike"].y = points[i][1]
    z = 1 + (1-(fp["spike"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["spike"].zoom_x = z
    fp["spike"].zoom_y = z
	fp["spike"].color = Color.new(176,56,219)
    fp["spike"].update
	pbSEPlay("Anim/Throw",60) if i == 4
    @scene.wait(1,true)
  end
  @vector.set(EliteBattle.get_vector(opp))
  #@targetSprite.color = Color.new(128,128,128,0)
  fp["spike"].dispose
  # rest of the particles
  for j in 0...32
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb620_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x = cxS
	fp["p#{j}"].y = cyS
    r = (40 + rand(24))*1.5#zoom
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @targetSprite.z + 30
    fp["p#{j}"].color = Color.new(176,56,219)
  end
  # spike shatter animation
  for i in 0...64
    break if !bomb && i > 15
	pbSEPlay("Anim/Spikes1",90) if i == 5
    for j in 0...32
      next if !bomb
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
	@scene.wait(1,i < 8)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: TRANSFORM.rb =====#
#-------------------------------------------------------------------------------
#  SUBSTITUTE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SUBSTITUTE) do
  EliteBattle.playMoveAnimation(:TRANSFORM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  TRANSFORM
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TRANSFORM) do
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # extra parameters
  xt,yt = @targetSprite.getCenter(true)
  xp,yp = @userSprite.getCenter(true)
  flashStart = 16
  @vector.set(vector2)
  @scene.wait(16,true)
  # set up animation
  cx, cy = @userSprite.getCenter(true)
  factor = @userSprite.zoom_x
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(243,243,243))
  fp["bg"].opacity = 0
  # init
  for j in 0...5
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_9")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height + 16
    fp["#{j}"].zoom_x = factor*0.75
    fp["#{j}"].zoom_y = factor*0.75
    fp["#{j}"].opacity = 0
    fp["#{j}"].x = cx
    fp["#{j}"].y = cy
    fp["#{j}"].z = @userIsPlayer ? 29 : 19
    fp["#{j}"].angle = 60*j + 30
  end
  fp["ring"] = Sprite.new(@viewport)
  fp["ring"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb458_8")
  fp["ring"].ox = fp["ring"].bitmap.width/2
  fp["ring"].oy = fp["ring"].bitmap.height/2
  fp["ring"].x = cx
  fp["ring"].y = cy
  fp["ring"].zoom_x = 0
  fp["ring"].zoom_y = 0
  fp["ring"].z = @userIsPlayer ? 29 : 19
  # animation
  for i in 0...96
	fp["bg"].opacity += 45 if i.between?(flashStart,flashStart+4)
	fp["bg"].opacity -= 45 if i.between?(flashStart+5,flashStart+9)
    @vector.reset if !@multiHit && i == 64
    pbSEPlay("Anim/Saint4",80) if i == 8
    pbSEPlay("Anim/Psych Up",90) if i == 8
    if i < 16
      fp["ring"].zoom_x += factor/16.0
      fp["ring"].zoom_y += factor/16.0
    elsif i < 64
      for j in 0...5
        fp["#{j}"].zoom_x += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].zoom_y += 0.05*factor*((i < 24) ? 0.5 : 0.25)
        fp["#{j}"].opacity += 32*((i < 24) ? 1 : -1)
      end
      fp["ring"].opacity -= 8
    end
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: TRIATTACK.rb =====#
#-------------------------------------------------------------------------------
#  TRIATTACK
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TRIATTACK) do | args |
  bomb = args[0]; bomb = true if bomb.nil?
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  fp["tri"] = Sprite.new(@viewport)
  fp["tri"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb629")
  fp["tri"].z = @targetSprite.z + 1
  fp["tri"].opacity = 0
  timeFactor = 40
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # shooting out the tri
  for i in 0...timeFactor
	pbSEPlay("Anim/Psych Up") if i%20 == 0
	fp["tri"].opacity += 50 if fp["tri"].opacity < 250
	fp["tri"].ox = fp["tri"].bitmap.width/2
    fp["tri"].oy = fp["tri"].bitmap.height/2
    cxT, cyT = @targetSprite.getCenter(true)
    cxP, cyP = @userSprite.getAnchor(true)
    mx = @vector.x + (@vector.x2 - @vector.x)*0.5
    my = @vector.y + (@vector.y2 - @vector.y)*0.5
    points = calculateCurve(cxP,cyP,mx,my,cxT,cyT,timeFactor)
    fp["tri"].x = points[i][0]
    fp["tri"].y = points[i][1]
    z = 1 + (1-(fp["tri"].x - @vector.x).to_f/(@vector.x2 - @vector.x))
    fp["tri"].zoom_x = z
    fp["tri"].zoom_y = z
	fp["tri"].angle += 30
    fp["tri"].update
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  pbSEPlay("Anim/Psych Up")
  fp["tri"].dispose
  @scene.wait(10,true)
  # zooming onto the target
  EliteBattle.playCommonAnimation(:BURN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playCommonAnimation(:PARALYSIS, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  EliteBattle.playCommonAnimation(:FROZEN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: TWISTER.rb =====#
#-------------------------------------------------------------------------------
#  TWISTER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:TWISTER) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(103,113,164))
  fp["bg"].opacity = 0
  fp["wave"] = AnimatedPlane.new(@viewport)
  fp["wave"].bitmap = Bitmap.new(1026,@viewport.height)
  fp["wave"].bitmap.stretch_blt(Rect.new(0,0,fp["wave"].bitmap.width,fp["wave"].bitmap.height),pbBitmap("Graphics/EBDX/Animations/Moves/eb132_5"),Rect.new(0,0,1026,212))
  fp["wave"].opacity = 0
  fp["wave"].z = 50
  rndx = []
  rndy = []
  numElements = 9
  for i in 0...numElements
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb637_3")
    fp["#{i}"].src_rect.set(0,128*rand(3),64,128)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  @vector.set(EliteBattle.get_vector(:DUAL))
  @vector.inc = 0.1
  pulse = 10
  shake = [4,4,4,4]
  # start animation
  for j in 0...80#64
    pbSEPlay("Anim/Wind8") if j == 24
    fp["wave"].ox += 48
    fp["wave"].opacity += pulse
    pulse = -5 if fp["wave"].opacity > 160
    pulse = +5 if fp["wave"].opacity < 100
    fp["bg"].opacity += 1 if fp["bg"].opacity < 255*0.35
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
      @sprites["pokemon_#{i}"].tone.all += 3 if j.between?(16,48)
      if j >= 32
        @sprites["pokemon_#{i}"].ox += shake[i]
        shake[i] = -4 if @sprites["pokemon_#{i}"].ox > @sprites["pokemon_#{i}"].bitmap.width/2 + 2
        shake[i] = 4 if @sprites["pokemon_#{i}"].ox < @sprites["pokemon_#{i}"].bitmap.width/2 - 2
      end
    end
	ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
	for i in 0...numElements
      if fp["#{i}"].opacity == 0 && fp["#{i}"].tone.gray == 0
        fp["#{i}"].zoom_x = @userSprite.zoom_x
        fp["#{i}"].zoom_y = @userSprite.zoom_y
        fp["#{i}"].x = ax
        fp["#{i}"].y = ay + 50*@userSprite.zoom_y
      end
      next if i>(j/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[i]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[i]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{i}"].x
      y0 = fp["#{i}"].y
      fp["#{i}"].x += (x2 - x0)*0.1
      fp["#{i}"].y += (y2 - y0)*0.1
      fp["#{i}"].zoom_x -= (fp["#{i}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{i}"].zoom_y -= (fp["#{i}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{i}"].src_rect.x += 64 if i%4==0
      fp["#{i}"].src_rect.x = 0 if fp["#{i}"].src_rect.x >= fp["#{i}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{i}"].opacity -= 8
        fp["#{i}"].tone.gray += 8
        fp["#{i}"].zoom_x -= 0.02
        fp["#{i}"].zoom_y += 0.04
      else
        fp["#{i}"].opacity += 3
      end
    end
    pbSEPlay("Anim/Wind8",80) if j%24==0 && j <= 60
    @sprites["pokemon_#{@userIndex}"].tone.all += 3 if j < 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  for i in 0...4
    next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
    next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible) || @sprites["pokemon_#{i}"].disposed?
    @sprites["pokemon_#{i}"].ox = @sprites["pokemon_#{i}"].bitmap.width/2
  end
  for j in 0...64
    fp["wave"].ox += 48
    if j < 32
      fp["wave"].opacity += pulse
      pulse = -5 if fp["wave"].opacity > 160
      pulse = +5 if fp["wave"].opacity < 100
    end
    fp["wave"].opacity -= 4 if j >= 32
    fp["bg"].opacity -= 4 if j >= 32
    for i in 0...4
      next if !(@targetIsPlayer ? [0,2] : [1,3]).include?(i)
      next if !(@sprites["pokemon_#{i}"] && @sprites["pokemon_#{i}"].visible)
      @sprites["pokemon_#{i}"].tone.all -= 3 if j >= 32
    end
    @sprites["pokemon_#{@userIndex}"].tone.all -= 3 if j >= 32
    @sprites["pokemon_#{@userIndex}"].still
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: UPROAR.rb =====#
#-------------------------------------------------------------------------------
#  UPROAR
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:UPROAR) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_bg
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
    #
  fp["bg2"] = Sprite.new(@viewport)
  fp["bg2"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg2"].bitmap.fill_rect(0,0,fp["bg2"].bitmap.width,fp["bg2"].bitmap.height,Color.black)
  fp["bg2"].opacity = 0
  #
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_4
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    rndx.push(rand(16))
    rndy.push(rand(16))
    dx.push(0)
    dy.push(0)
  end
  for i in 0...72
    fp["#{i}2"] = Sprite.new(@viewport)
    fp["#{i}2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_3")
    fp["#{i}2"].ox = fp["#{i}2"].bitmap.width/2
    fp["#{i}2"].oy = fp["#{i}2"].bitmap.height/2
    fp["#{i}2"].opacity = 0
    fp["#{i}2"].z = 19
  end
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = 50
  fp["cir"].zoom_x = @targetIsPlayer ? 0.5 : 1
  fp["cir"].zoom_y = @targetIsPlayer ? 0.5 : 1
  fp["cir"].opacity = 0
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")#Graphics/EBDX/Animations/Moves/eb263_2
    fp["#{i}s"].ox = -32 - rand(64)
    fp["#{i}s"].oy = fp["#{i}s"].bitmap.height/2
    fp["#{i}s"].angle = rand(270)
    r = rand(2)
    fp["#{i}s"].zoom_x = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].zoom_y = (r==0 ? 0.1 : 0.2)*factor
    fp["#{i}s"].visible = false
    fp["#{i}s"].opacity = 255 - rand(101)
    fp["#{i}s"].z = 50
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  #
  16.times do
    fp["bg2"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...20
    if i < 10
      fp["bg"].opacity += 25.5
    else
      fp["bg"].color.alpha -= 25.5
    end
    pbSEPlay("Anim/Harden") if i == 4
    fp["bg"].update
    @scene.wait(1,true)
  end
  @scene.wait(4,true)
  pbSEPlay("Anim/Psych Up")
  for i in 0...96
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
      @scene.applySpriteProperties(fp["#{j}"],fp["#{j}2"])
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
	pbSEPlay("Cries/#{@userSprite.species}",100) if i == 5
    pbSEPlay("Anim/Comet Punch") if i == 64
    fp["cir"].x, fp["cir"].y = ax, ay
    fp["cir"].angle += 32
    fp["cir"].opacity += (i>72) ? -51 : 255
    fp["bg"].update
    for m in 0...8
      fp["#{m}s"].visible = true
      fp["#{m}s"].opacity -= 12
      fp["#{m}s"].zoom_x += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].zoom_y += 0.04*factor if fp["#{m}s"].opacity > 0
      fp["#{m}s"].x, fp["#{m}s"].y = ax, ay
    end
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  fp["cir"].opacity = 0
  for i in 0...20
    @targetSprite.still
    if i < 10
      fp["bg"].color.alpha += 25.5
    else
      fp["bg"].opacity -= 25.5
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
    16.times do
    fp["bg2"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: UTURN.rb =====#
#-------------------------------------------------------------------------------
#  LUNGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:LUNGE) do | args |
  EliteBattle.playMoveAnimation(:UTURN, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  UTURN
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:UTURN) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(104,131,42))
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/move1",80) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playMoveAnimation(:TACKLE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: VACUUMWAVE.rb =====#
#-------------------------------------------------------------------------------
#  VACUUMWAVE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:VACUUMWAVE) do
  # inital configuration
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}; dx = []; dy = []
  fp["bg"] = ScrollingSprite.new(@viewport)
  fp["bg"].speed = 64
  fp["bg"].setBitmap("Graphics/EBDX/Animations/Moves/eb536_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  fp["cir"] = Sprite.new(@viewport)
  fp["cir"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_1_3")
  fp["cir"].ox = fp["cir"].bitmap.width/2
  fp["cir"].oy = fp["cir"].bitmap.height/2
  fp["cir"].z = @userSprite.z + 1
  fp["cir"].mirror = @userIsPlayer
  fp["cir"].zoom_x = (@targetIsPlayer ? 0.75 : 1)
  fp["cir"].zoom_y = (@targetIsPlayer ? 0.75 : 1)
  fp["cir"].opacity = 0
  shake = 4; k = 0
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...40
    if i < 8
      fp["bg"].opacity += 32
    else
      fp["bg"].color.alpha -= 32
      fp["cir"].x, fp["cir"].y = @userSprite.getCenter
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity += 24
    end
    if i == 8
      @vector.set(vector2)
      pbSEPlay("Anim/grass2",80)
    end
    fp["bg"].update
    @scene.wait(1,true)
  end
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  for i in 0...8
    fp["#{i}s"] = Sprite.new(@viewport)
    fp["#{i}s"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_2_3")
    fp["#{i}s"].src_rect.set(rand(3)*36,0,36,36)
    fp["#{i}s"].ox = fp["#{i}s"].src_rect.width/2
    fp["#{i}s"].oy = fp["#{i}s"].src_rect.height/2
    r = 128*@userSprite.zoom_x
    z = [0.5,0.25,1,0.75][rand(4)]
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{i}s"].x = cx
    fp["#{i}s"].y = cy
    fp["#{i}s"].zoom_x = z*@userSprite.zoom_x
    fp["#{i}s"].zoom_y = z*@userSprite.zoom_x
    fp["#{i}s"].visible = false
    fp["#{i}s"].z = @userSprite.z + 1
    dx.push(x); dy.push(y)
  end
  fp["shot"] = Sprite.new(@viewport)
  fp["shot"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb093_3_3")
  fp["shot"].ox = fp["shot"].bitmap.width/2
  fp["shot"].oy = fp["shot"].bitmap.height/2
  fp["shot"].z = @userSprite.z + 1
  fp["shot"].zoom_x = @userSprite.zoom_x
  fp["shot"].zoom_y = @userSprite.zoom_x
  fp["shot"].opacity = 0
  x = defaultvector[0]; y = defaultvector[1]
  x2, y2 = @vector.spoof(defaultvector)  
  fp["shot"].x = cx
  fp["shot"].y = cy
  pbSEPlay("EBDX/Anim/normal5",80)
  k = -1
  for i in 0...20
    cx, cy = @userSprite.getCenter
    @vector.reset if i == 0
    if i > 0
      fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
      fp["shot"].opacity += 32
      fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
      fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
      for j in 0...8
        fp["#{j}s"].visible = true
        fp["#{j}s"].opacity -= 32
        fp["#{j}s"].x -= (fp["#{j}s"].x - dx[j])*0.2
        fp["#{j}s"].y -= (fp["#{j}s"].y - dy[j])*0.2
      end
      fp["cir"].angle += 24*(@userIsPlayer ? -1 : 1)
      fp["cir"].opacity -= 16
      fp["cir"].x = cx
      fp["cir"].y = cy
    end
    fp["bg"].update
    factor = @targetSprite.zoom_x if i == 12
    if i >= 12
      k *= -1 if i%4==0
      @targetSprite.zoom_x -= factor*0.01*k
      @targetSprite.zoom_y += factor*0.04*k
      @targetSprite.still
    end
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,i < 12)
  end
  shake = 2
  16.times do
    fp["shot"].angle = Math.atan(1.0*(@vector.y-@vector.y2)/(@vector.x2-@vector.x))*(180.0/Math::PI) + (@targetIsPlayer ? 180 : 0)
    fp["shot"].opacity += 32
    fp["shot"].zoom_x -= (fp["shot"].zoom_x - @targetSprite.zoom_x)*0.1
    fp["shot"].zoom_y -= (fp["shot"].zoom_y - @targetSprite.zoom_y)*0.1
    fp["shot"].x += (@targetIsPlayer ? -1 : 1)*(x2 - x)/24
    fp["shot"].y -= (@targetIsPlayer ? -1 : 1)*(y - y2)/24
    fp["bg"].color.alpha += 16
    fp["bg"].update
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 4
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 4
    @targetSprite.still
    cx, cy = @targetSprite.getCenter(true)
    if !@targetIsPlayer
      fp["shot"].z = @targetSprite.z - 1 if fp["shot"].x > cx && fp["shot"].y < cy
    else
      fp["shot"].z = @targetSprite.z + 1 if fp["shot"].x < cx && fp["shot"].y > cy
    end
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  16.times do
    fp["bg"].update
    @targetSprite.still
    @scene.wait(1,true)
  end
  16.times do
    fp["bg"].update
    fp["bg"].opacity -= 16
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: VINEWHIP.rb =====#
#-------------------------------------------------------------------------------
#  Vine Whip
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:VINEWHIP) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter(true)
  fp = {}
  fp["whip"] = Sprite.new(@viewport)
  fp["whip"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb208")
  fp["whip"].ox = fp["whip"].bitmap.width*0.75
  fp["whip"].oy = fp["whip"].bitmap.height*0.5
  fp["whip"].angle = 315
  fp["whip"].zoom_x = @targetSprite.zoom_x*1.5
  fp["whip"].zoom_y = @targetSprite.zoom_y*1.5
  fp["whip"].color = Color.new(255,255,255,0)
  fp["whip"].opacity = 0
  fp["whip"].x = cx + 32*@targetSprite.zoom_x
  fp["whip"].y = cy - 48*@targetSprite.zoom_y
  fp["whip"].z = @targetIsPlayer ? 29 : 19
  fp["imp"] = Sprite.new(@viewport)
  fp["imp"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_2")
  fp["imp"].ox = fp["imp"].bitmap.width/2
  fp["imp"].oy = fp["imp"].bitmap.height/2
  fp["imp"].zoom_x = @targetSprite.zoom_x*2
  fp["imp"].zoom_y = @targetSprite.zoom_y*2
  fp["imp"].visible = false
  fp["imp"].x = cx
  fp["imp"].y = cy - 48*@targetSprite.zoom_y
  fp["imp"].z = @targetIsPlayer ? 29 : 19
  posx = []
  posy = []
  angl = []
  zoom = []
  for j in 0...12
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb208_2")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["#{j}"].visible = false
    z = [1,1.25,0.75,0.5][rand(4)]
    fp["#{j}"].zoom_x = @targetSprite.zoom_x*z
    fp["#{j}"].zoom_y = @targetSprite.zoom_y*z
    fp["#{j}"].angle = rand(360)
    posx.push(rand(128))
    posy.push(rand(64))
    angl.push((rand(2)==0 ? 1 : -1))
    zoom.push(z)
    fp["#{j}"].opacity = (155+rand(100))
  end
  # start animation
  k = 1
  for i in 0...32
    pbSEPlay("EBDX/Anim/normal4",80) if i == 4
    if i < 16
      fp["whip"].opacity += 128 if i < 4
      fp["whip"].angle += 16
      fp["whip"].color.alpha += 16 if i >= 8
      fp["whip"].zoom_x -= 0.2 if i >= 8
      fp["whip"].zoom_y -= 0.16 if i >= 4
      fp["whip"].opacity -= 64 if i >= 12
      fp["imp"].visible = true if i == 3
      if i >= 4
        fp["imp"].angle += 4
        fp["imp"].zoom_x -= 0.02
        fp["imp"].zoom_x -= 0.02
        fp["imp"].opacity -= 32
      end
      @targetSprite.zoom_y -= 0.04*k
      @targetSprite.zoom_x += 0.02*k
      @targetSprite.tone = Tone.new(255,255,255) if i == 4
      @targetSprite.tone.red -= 51 if @targetSprite.tone.red > 0
      @targetSprite.tone.green -= 51 if @targetSprite.tone.green > 0
      @targetSprite.tone.blue -= 51 if @targetSprite.tone.blue > 0
      k *= -1 if (i-4)%6==0
    end
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...12
      next if i < 4
      next if j>(i-4)
      fp["#{j}"].visible = true
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (i-4)*2*@targetSprite.zoom_y
      fp["#{j}"].angle += angl[j]
    end
    @scene.wait
  end
  @vector.reset if !@multiHit
  for i in 0...16
    @scene.wait(1,true)
    cx, cy = @targetSprite.getCenter(true)
    k = 20 - i
    for j in 0...12
      fp["#{j}"].x = cx - 64*@targetSprite.zoom_x*zoom[j] + posx[j]*@targetSprite.zoom_x*zoom[j]
      fp["#{j}"].y = cy - posy[j]*@targetSprite.zoom_y*zoom[j] - 48*@targetSprite.zoom_y*zoom[j]# - (k)*2*@targetSprite.zoom_y
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += angl[j]
      fp["#{j}"].zoom_x = @targetSprite.zoom_x
      fp["#{j}"].zoom_y = @targetSprite.zoom_y
    end
  end
  pbDisposeSpriteHash(fp)
end

#===== FILE: VITALTHROW.rb =====#
#-------------------------------------------------------------------------------
#  CIRCLETHROW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CIRCLETHROW) do
  EliteBattle.playMoveAnimation(:VITALTHROW, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  SEISMICTOSS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SEISMICTOSS) do
  EliteBattle.playMoveAnimation(:VITALTHROW, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  VITALTHROW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:VITALTHROW) do
  EliteBattle.playMoveAnimation(:DOUBLETEAM, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...12
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...96
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb086_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...72
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...12
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...96
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: VOLTSWITCH.rb =====#
#-------------------------------------------------------------------------------
#  ZINGZAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ZINGZAP) do | args |
  EliteBattle.playMoveAnimation(:VOLTSWITCH, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  VOLTSWITCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:VOLTSWITCH) do | args |
  withvector, shake = *args; withvector = true if withvector.nil?; shake = false if shake.nil?
  withvector = true
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(128,131,42))
  fp["bg"].opacity = 0
  # set up animation
  @scene.wait(5,true)
  # charge
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  shake = 30
  idx =  0 # counter
  dir = -1 # direction
  ports = 25
  xOrigin = @userSprite.ox
  for i in 0...ports
    pbSEPlay("EBDX/Anim/electric2",100) if i == 4
    @userSprite.still
	#default movement
	if i == 3
		@userSprite.ox += shake
	end
    if i.between?(4,ports)
		if dir == -1 #move left 
			@userSprite.ox -= shake
		else # move right
		    @userSprite.ox += shake
		end
	  idx += 1 
	  if idx == 2
		idx = 0
		dir = dir * -1
	  end
    end
	if i.between?(14,ports)
		@userSprite.opacity -= 35
	end
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/electric1",100)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if withvector
  @scene.wait(10,true)
  EliteBattle.playCommonAnimation(:PARALYSIS, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  16.times do
    fp["bg"].opacity -= 20
	@userSprite.opacity += 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  #frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: VOLTTACKLE.rb =====#
#-------------------------------------------------------------------------------
#  VOLTTACKLE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:VOLTTACKLE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  frame = []
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_3")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  # animation start
  pbSEPlay("EBDX/Anim/electric1",100)
  pbSEPlay("EBDX/Anim/electric2",100)
  @sprites["battlebg"].defocus
  for i in 0...48
    for j in 0...16
      next if j>(i/2)
      fp["f#{j}"].visible = true
      fp["f#{j}"].y -= 8*@userSprite.zoom_y
      fp["f#{j}"].opacity -= 32 if frame[j] >= 8
      frame[j] += 1
    end
    fp["bg"].opacity += 8 if i >= 32
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Thunder1",80)
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  pbSEPlay("EBDX/Anim/electric1",100)
  pbSEPlay("EBDX/Anim/electric2",100)
  for j in 0...3
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_3")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx - 32 + rand(64)
    fp["#{j}"].y = cy - 32 + rand(64)
    fp["#{j}"].z = @targetSprite.z + 1
    fp["#{j}"].visible = false
    fp["#{j}"].zoom_x = @targetSprite.zoom_x
    fp["#{j}"].zoom_y = @targetSprite.zoom_y
	fp["#{j}"].angle += 32
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_3")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
	fp["p#{m}"].angle += 32
  end
  pbSEPlay("EBDX/Anim/electric1",100)
  pbSEPlay("EBDX/Anim/electric2",100)
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 5
    pbSEPlay("EBDX/Anim/electric1",80) if i == 8
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}"].visible = true
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += 3
      fp["#{j}"].zoom_x += 0.1
      fp["#{j}"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: WAKEUPSLAP.rb =====#
#-------------------------------------------------------------------------------
#  SMELLINGSALTS
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:SMELLINGSALTS) do
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  FEINT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:FEINT) do
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  KARATECHOP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:KARATECHOP) do
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  ARMTHRUST
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ARMTHRUST) do
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  POWERUPPUNCH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:POWERUPPUNCH) do
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DOUBLESLAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DOUBLESLAP) do
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  DOUBLEHIT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:DOUBLEHIT) do
  EliteBattle.playMoveAnimation(:WAKEUPSLAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false)
end
#-------------------------------------------------------------------------------
#  WAKEUPSLAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WAKEUPSLAP) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  # animation start
  @sprites["battlebg"].defocus
  @vector.set(vector)
  16.times do
    fp["bg"].opacity += 5
    @scene.wait(1,true)
  end
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  for j in 0...2
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb108")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].z = @targetSprite.z + 1
    r = 32*factor
    fp["f#{j}"].x = cx - r + rand(r*2)
    fp["f#{j}"].y = cy - r + rand(r*2)
    fp["f#{j}"].visible = false
    fp["f#{j}"].zoom_x = factor
    fp["f#{j}"].zoom_y = factor
    fp["f#{j}"].color = Color.new(180,53,2,0)
  end
  dx = []
  dy = []
  for j in 0...15
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb137_2")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].z = @targetSprite.z
    r = 148*factor + rand(32)*factor
    x, y = randCircleCord(r)
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = factor
    fp["p#{j}"].zoom_y = factor
    fp["p#{j}"].color = Color.new(180,53,2,0)
    dx.push(cx - r + x)
    dy.push(cy - r + y)
  end
  k = -4
  for i in 0...20
    k *= - 1 if i%4==0
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    for j in 0...2
      next if j>(i/4)
      pbSEPlay("Anim/hit",80) if fp["f#{j}"].opacity == 255
      fp["f#{j}"].visible = true
      fp["f#{j}"].zoom_x -= 0.025
      fp["f#{j}"].zoom_y -= 0.025
      fp["f#{j}"].opacity -= 16
      fp["f#{j}"].color.alpha += 32
    end
    for j in 0...15
      next if j>(i*2)
      fp["p#{j}"].visible = true
      fp["p#{j}"].x -= (fp["p#{j}"].x - dx[j])*0.2
      fp["p#{j}"].y -= (fp["p#{j}"].y - dy[j])*0.2
      fp["p#{j}"].opacity -= 32 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 16
      fp["p#{j}"].color.alpha += 16 if ((fp["p#{j}"].x - dx[j])*0.2).abs < 32
      fp["p#{j}"].zoom_x += 0.1
      fp["p#{j}"].zoom_y += 0.1
      fp["p#{j}"].angle = -Math.atan(1.0*(fp["p#{j}"].y-cy)/(fp["p#{j}"].x-cx))*(180.0/Math::PI)
    end
    fp["bg"].update
    @targetSprite.still
    @targetSprite.zoom_x -= factor*0.01*k if i < 56
    @targetSprite.zoom_y += factor*0.02*k if i < 56
    @scene.wait
  end
  @vector.reset if !@multiHit
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
end

#===== FILE: WATERGUN.rb =====#
#-------------------------------------------------------------------------------
#  Water Gun
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WATERGUN) do
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []; px = []; py = []; rangl = []
  for i in 0...12
    fp["p#{i}"] = Sprite.new(@viewport)
    fp["p#{i}"].bitmap = Bitmap.new(16,16)
    fp["p#{i}"].bitmap.bmp_circle
    fp["p#{i}"].ox = 8
    fp["p#{i}"].oy = 8
    fp["p#{i}"].opacity = 0
    fp["p#{i}"].z = @targetSprite.z
    px.push(0)
    py.push(0)
  end
  for k in 0...64
    i = 63-k
    fp["#{i}"] = Sprite.new(@viewport)
    bmp = pbBitmap("Graphics/EBDX/Animations/Moves/eb551")
    fp["#{i}"].bitmap = Bitmap.new(bmp.width,bmp.height)
    fp["#{i}"].bitmap.blt(0,0,bmp,Rect.new(0,0,bmp.width,bmp.height))
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
    fp["#{i}"].color = Color.new(248,248,248,200)
    rndx.push(rand(16)); rndy.push(rand(16)); rangl.push(rand(2))
    dx.push(0); dy.push(0)
  end
  for i in 0...64
    pbSEPlay("EBDX/Anim/water1",60) if i%4==0 && i < 48
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...64
      if fp["#{j}"].opacity == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].zoom_x = 0.8#(!@targetIsPlayer ? 1.2 : 0.8)#@userSprite.zoom_x
        fp["#{j}"].zoom_y = 0.8#(!@targetIsPlayer ? 1.2 : 0.8)#@userSprite.zoom_y
        fp["#{j}"].opacity = 128 if !(j>i*2)
      end
      next if j>(i*2)
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      x0 = dx[j]
      y0 = dy[j]
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x += 0.04#(factor - fp["#{j}"].zoom_x)*0.2
      fp["#{j}"].zoom_y += 0.04#(factor - fp["#{j}"].zoom_y)*0.2
      fp["#{j}"].opacity += 32
      fp["#{j}"].angle += 8*(rangl[j]==0 ? -1 : 1)
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      fp["#{j}"].color.alpha -= 5 if fp["#{j}"].color.alpha > 0
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].visible = false if nextx > cx && nexty < cy
      else
        fp["#{j}"].visible = false if nextx < cx && nexty > cy
      end
    end
    for l in 0...12
      next if i < 2
      next if l>((i-6)/4)
      if fp["p#{l}"].opacity <= 0 && i < 48
        fp["p#{l}"].opacity = 255 - rand(101)
        fp["p#{l}"].x = cx
        fp["p#{l}"].y = cy
        r = rand(2)
        fp["p#{l}"].zoom_x = r==0 ? 1 : 0.5
        fp["p#{l}"].zoom_y = r==0 ? 1 : 0.5
        x, y = randCircleCord(96)
        px[l] = cx - 48*@targetSprite.zoom_x + x*@targetSprite.zoom_x
        py[l] = cy - 48*@targetSprite.zoom_y + y*@targetSprite.zoom_y
      end
      x2 = px[l]
      y2 = py[l]
      x0 = fp["p#{l}"].x
      y0 = fp["p#{l}"].y
      fp["p#{l}"].x += (x2 - x0)*0.05
      fp["p#{l}"].y += (y2 - y0)*0.05
      fp["p#{l}"].opacity -= 8
    end
    @targetSprite.still if i >= 64
    @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer)) if i == 16
    @vector.inc = 0.1 if i == 64
    @scene.wait(1,true)
  end
  for j in 0...48; fp["#{j}"].visible = false; end
  for l in 0...12; fp["p#{l}"].visible = false; end
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: WATERPULSE.rb =====#
#-------------------------------------------------------------------------------
#  WATERPULSE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WATERPULSE) do
 vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  factor = @userIsPlayer ? 2 : 1
  # set up animation
  fp = {}; rndx = []; rndy = []; dx = []; dy = []; idxZoom = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,78,131))
  fp["bg"].opacity = 0
  for i in 0...72
    fp["#{i}"] = Sprite.new(@viewport)
	if i%6 == 0
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb612_6")
	else
		fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb000")
	end
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
	fp["#{i}"].zoom_x = 1.0
	fp["#{i}"].zoom_y = 1.0
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 19
	idxZoom[i] = 0
	rndx.push(rand(1))
    rndy.push(rand(1))
  end
  shake = 4
  # start animation
  @sprites["battlebg"].defocus
  @vector.set(vector2)
  16.times do
    fp["bg"].opacity += 10
    @scene.wait(1,true)
  end
  for i in 0...96
	pbSEPlay("Anim/Bubble2") if i == 2
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...72
	  pbSEPlay("Anim/Bubble1") if j == 0 && i%10 == 0
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        dx[j] = ax - 8*@userSprite.zoom_x*0.5 + rndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 8*@userSprite.zoom_y*0.5 + rndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
      end
      next if j>(i)
      x0 = dx[j]
      y0 = dy[j]
      x2 = cx - 8*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 8*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
	  if idxZoom[j] < 3
		fp["#{j}"].zoom_x *= 0.85
		fp["#{j}"].zoom_y *= 0.85
	  else
	  	fp["#{j}"].zoom_x *= 1.15
		fp["#{j}"].zoom_y *= 1.15
	  end
	  idxZoom[j] += 1
	  idxZoom[j] = 0 if idxZoom[j] == 6
      fp["#{j}"].x += (x2 - x0)*0.07
      fp["#{j}"].y += (y2 - y0)*0.07
      fp["#{j}"].opacity += 51
      fp["#{j}"].angle = -Math.atan(1.0*(y2-y0)/(x2-x0))*180/Math::PI + (rand(4)==0 ? 180 : 0)
      nextx = fp["#{j}"].x# + (x2 - x0)*0.1
      nexty = fp["#{j}"].y# + (y2 - y0)*0.1
      if !@targetIsPlayer
        fp["#{j}"].z = @targetSprite.z - 1 if nextx > cx && nexty < cy
      else
        fp["#{j}"].z = @targetSprite.z + 1 if nextx < cx && nexty > cy
      end
	  if i > 85
		fp["#{j}"].opacity -= 100
	  end
    end
    if i >= 64
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    pbSEPlay("Anim/Bubble1") if i == 64
    fp["bg"].update
    @vector.set(vector) if i == 32
    @vector.inc = 0.1 if i == 32
    @scene.wait(1,true)
  end
  @targetSprite.ox = @targetSprite.bitmap.width/2
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: WATERSPORT.rb =====#
#-------------------------------------------------------------------------------
#  WATERSPORT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WATERSPORT) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  splash = 60
  fp = {}
  # bg
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(51,153,255))
  fp["bg"].opacity = 0
  # user
  @userSprite.color = Color.new(51,153,255,0)
  # set up animation
  @scene.wait(5,true)
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  # init splash
  for j in 0...splash
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb618_2")
    fp["p#{j}"].center!
    fp["p#{j}"].x, fp["p#{j}"].y = @userSprite.getCenter(true)
    r = (40 + rand(24))*@userSprite.zoom_x
    x, y = randCircleCord(r)
    fp["p#{j}"].end_x = fp["p#{j}"].x - r + x
    fp["p#{j}"].end_y = fp["p#{j}"].y - r + y
    fp["p#{j}"].zoom_x = 0
    fp["p#{j}"].zoom_y = 0
    fp["p#{j}"].angle = rand(360)
    fp["p#{j}"].z = @userSprite.z + 1
  end
  for i in 0...64
	pbSEPlay("Anim/Bubble1",100) if i == 5 || i == 15
    for j in 0...splash
      next if i < 8
      next if j > (i-8)*2
      fp["p#{j}"].zoom_x += (1.6 - fp["p#{j}"].zoom_x)*0.1
      fp["p#{j}"].zoom_y += (1.6 - fp["p#{j}"].zoom_y)*0.1
      fp["p#{j}"].x += (fp["p#{j}"].end_x - fp["p#{j}"].x)*0.1
      fp["p#{j}"].y += (fp["p#{j}"].end_y - fp["p#{j}"].y)*0.1 - 15
      if fp["p#{j}"].zoom_x >= 1
        fp["p#{j}"].opacity -= 16
      end
      fp["p#{j}"].color.alpha -= 8
    end
    if i < 48
      @userSprite.color.alpha += 4
    else
      @userSprite.color.alpha -= 16
    end
	@scene.wait(1)
	@userSprite.still
    @userSprite.anim = true
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: WATERSPOUT.rb =====#
#-------------------------------------------------------------------------------
#  WATERSPOUT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WATERSPOUT) do
  # set up animation
  blades = 9
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,87,131))
  fp["bg"].opacity = 0
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  pbSEPlay("EBDX/Anim/water1",90)
  EliteBattle.playMoveAnimation(:RAINDANCE, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, false, true)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  @vector.set(vector)
  @scene.wait(16,true)
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb642_4")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height/2
    fp["i#{j}"].opacity = 0
    fp["i#{j}"].zoom_x = @targetSprite.zoom_x
    fp["i#{j}"].zoom_y = @targetSprite.zoom_y
    fp["i#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["i#{j}"].x = @targetSprite.x + rand(32)*@targetSprite.zoom_x*(rand(2)==0 ? 1 : -1)
    fp["i#{j}"].y = @targetSprite.y - 8*@targetSprite.zoom_y + rand(16)*@targetSprite.zoom_y
  end
  for j in 0...blades
    fp["s#{j}"] = Sprite.new(@viewport)
    fp["s#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb540_2")
    fp["s#{j}"].ox = fp["s#{j}"].bitmap.width/2
    fp["s#{j}"].oy = fp["s#{j}"].bitmap.height
    fp["s#{j}"].opacity = 0
    fp["s#{j}"].zoom_x = @targetSprite.zoom_x/2
    fp["s#{j}"].zoom_y = @targetSprite.zoom_y/2
    fp["s#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["s#{j}"].x = @targetSprite.x - 48*@targetSprite.zoom_x + rand(96)*@targetSprite.zoom_x
    fp["s#{j}"].y = @targetSprite.y - 192*@targetSprite.zoom_y
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb244_6")
    fp["p#{j}"].ox = fp["p#{j}"].bitmap.width/2
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].visible = false
    fp["p#{j}"].zoom_x = 2
    fp["p#{j}"].zoom_y = 2
    fp["p#{j}"].z = @targetIsPlayer ? 29 : 19
    fp["p#{j}"].x = fp["s#{j}"].x
    fp["p#{j}"].y = fp["s#{j}"].y + 192*@targetSprite.zoom_y
  end
  k = -2
  for i in 0...64
    k *= -1 if i%4==0 && i >= 8
    pbSEPlay("Anim/Water5",70) if i%8==0 && i >0 && i < 48
    pbSEPlay("Anim/Water1",90) if i%8==0 && i >0 && i < 48
    for j in 0...blades
      next if j>(i/6)
      fp["s#{j}"].opacity += 64 if fp["s#{j}"].opacity < 100
      fp["s#{j}"].y += 24*@targetSprite.zoom_y if fp["s#{j}"].y < @targetSprite.y
      fp["s#{j}"].zoom_y -= 0.2*@targetSprite.zoom_y if fp["s#{j}"].y >= @targetSprite.y
      fp["s#{j}"].visible = false if fp["s#{j}"].zoom_y <= 0.4*@targetSprite.zoom_y
    end
    for j in 0...blades
      next if i < 8
      next if j>(i-8)/8
      fp["p#{j}"].visible = true
      fp["p#{j}"].opacity -= 32
      fp["p#{j}"].zoom_x += 0.02
      fp["p#{j}"].zoom_y += 0.02
      fp["p#{j}"].angle += 8
    end
    for j in 0...16
      next if i < 8
      next if j>(i-8)/2
      fp["i#{j}"].opacity += 45*(fp["i#{j}"].zoom_x <= 0.5*@targetSprite.zoom_x ? -1 : 1)
      fp["i#{j}"].zoom_x -= 0.04*@targetSprite.zoom_x
      fp["i#{j}"].zoom_y -= 0.04*@targetSprite.zoom_y
      fp["i#{j}"].x += 2*@targetSprite.zoom_x*(fp["i#{j}"].x >= @targetSprite.x ? 1 : -1)
      fp["i#{j}"].angle += 4*(fp["i#{j}"].x >= @targetSprite.x ? 1 : -1)
    end
    @scene.moveEntireScene(0, k, true, true) if i >= 8 && i < 48
    @scene.wait
  end
  16.times do
	fp["i#{j}"].opacity -= 50
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: WEATHERBALL.rb =====#
#-------------------------------------------------------------------------------
#  WEATHERBALL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WEATHERBALL) do
    EliteBattle.playMoveAnimation(:WEATHERBALL_UP, @scene, @userIndex, @targetIndex)
    EliteBattle.playMoveAnimation(:WEATHERBALL_DOWN, @scene, @userIndex, @targetIndex)
end

EliteBattle.defineMoveAnimation(:WEATHERBALL_UP) do
  factor = @targetIsPlayer ? 2 : 1.5
  vector = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  fp["fly"] = Sprite.new(@viewport)
  fp["fly"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_13")
  fp["fly"].ox = fp["fly"].bitmap.width/2
  fp["fly"].oy = fp["fly"].bitmap.height/2
  fp["fly"].z = 50
  fp["fly"].x, fp["fly"].y = @userSprite.getCenter
  fp["fly"].opacity = 0
  fp["fly"].zoom_x = factor*1.4
  fp["fly"].zoom_y = factor*1.4
  fp["dnt"] = Sprite.new(@viewport)
  fp["dnt"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_14")
  fp["dnt"].ox = fp["dnt"].bitmap.width/2
  fp["dnt"].oy = fp["dnt"].bitmap.height/2
  fp["dnt"].z = 50
  fp["dnt"].opacity = 0
  # start animation
  @vector.set(vector)
  @scene.wait(20,true)
  pbSEPlay("Anim/Refresh")
  for i in 0...20
    cx, cy = @userSprite.getCenter
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].zoom_x -= factor*0.4/10
    fp["fly"].zoom_y -= factor*0.4/10
    fp["fly"].opacity += 51
    fp["dnt"].x = cx
    fp["dnt"].y = cy
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity += 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  10.times do
    fp["fly"].zoom_x += factor*0.4/10
    fp["fly"].zoom_y += factor*0.4/10
    fp["dnt"].zoom_x = fp["fly"].zoom_x
    fp["dnt"].zoom_y = fp["fly"].zoom_y
    fp["dnt"].opacity -= 25.5
    fp["dnt"].angle -= 16
    @scene.wait(1,true)
  end
  @vector.set(vector[0],vector[1]+128,vector[2],vector[3],vector[4],vector[5])
  for i in 0...20
    @scene.wait(1,true)
    cx, cy = @userSprite.getCenter
    if i < 10
      fp["fly"].zoom_y -= factor*0.02
    elsif
      fp["fly"].zoom_x -= factor*0.02
      fp["fly"].zoom_y += factor*0.04
    end
    fp["fly"].x = cx
    fp["fly"].y = cy
    fp["fly"].y -= 32*(i-10) if i >= 10
    pbSEPlay("EBDX/Anim/flying2") if i == 10
  end
  for i in 0...20
    fp["fly"].y -= 32
    fp["fly"].opacity -= 25.5 if i >= 10
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
  #@scene.wait(20,true)
end

EliteBattle.defineMoveAnimation(:WEATHERBALL_DOWN) do
  defaultvector = EliteBattle.get_vector(:MAIN, @battle)
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  fp["drop"] = Sprite.new(@viewport)
  fp["drop"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb156_3")
  fp["drop"].ox = fp["drop"].bitmap.width/2
  fp["drop"].oy = fp["drop"].bitmap.height/2
  fp["drop"].y = 0
  fp["drop"].z = 50
  fp["drop"].visible = false
  # start animation
  @vector.set(defaultvector[0], defaultvector[1]+128, defaultvector[2], defaultvector[3], defaultvector[4], defaultvector[5])
  @sprites["battlebg"].defocus
  32.times do
    fp["bg"].opacity += 2
    @scene.wait(1,true)
  end
  @vector.set(vector)
  maxy = ((@targetIsPlayer ? @vector.y : @vector.y2)*0.1).ceil*10 - 80
  fp["drop"].y = -((maxy-(@targetIsPlayer ? @vector.y-80 : @vector.y2-80))*0.1).ceil*10
  fp["drop"].x = @targetSprite.x
  pbSEPlay("Anim/Wind1")
  for i in 0...20
    @scene.wait(1,true)
    if i >= 10
      fp["drop"].visible = true
      fp["drop"].x = @targetSprite.x
      fp["drop"].y += maxy/10
      fp["drop"].zoom_x = @targetSprite.zoom_x
      fp["drop"].zoom_y = @targetSprite.zoom_y*1.4
    end
    fp["bg"].opacity -= 51 if i >= 15
  end
  @sprites["battlebg"].focus
  pbDisposeSpriteHash(fp)
  EliteBattle.playMoveAnimation(:TACKLE, @scene, @userIndex, @targetIndex, 0, false, nil, false, true)
end

#===== FILE: WHIRLPOOL.rb =====#
#-------------------------------------------------------------------------------
#  WHIRLPOOL
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WHIRLPOOL) do
  #-----------------------------------------------------------------------------
  #  configure variables
  @scene.wait(16, true) if @scene.afterAnim
  fp = {}; k = -1; flames = 8; shake = 2
  factor = @targetSprite.zoom_x
  reversed = []; cx, cy = @targetSprite.getCenter(true)
  #-----------------------------------------------------------------------------
  #  set up sprites
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(42,92,131))
  fp["bg"].opacity = 0
  for j in 0...flames
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136_7")
    fp["#{j}"].src_rect.set(0,135*rand(3),50,135)
    fp["#{j}"].ox = 25
    fp["#{j}"].oy = 135
    fp["#{j}"].zoom_x = factor
    fp["#{j}"].zoom_y = factor
    fp["#{j}"].opacity = 0
    fp["#{j}"].y = cy - 48*factor - k*2*factor
    fp["#{j}"].x = cx + 64*factor - (j%4)*32*factor
    reversed.push([false,true][j/4])
  end
  #-----------------------------------------------------------------------------
  #  play animation
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  vol = 80
  for i in 0...70
    k = i if i < 16
    pbSEPlay("Anim/Water1",80) if i%12==0
    pbSEPlay("Anim/Water1",120) if i==50
    vol -= 5 if i%8 == 0
    for j in 0...flames
      reversed[j] = true if fp["#{j}"].x <= cx - 64*factor
      reversed[j] = false if fp["#{j}"].x >= cx + 64*factor
      fp["#{j}"].z = reversed[j] ? @targetSprite.z - 1 : @targetSprite.z + 1
      fp["#{j}"].y = cy - 48*factor - k*2*factor - (reversed[j] ? 4*factor : 0) + 120 if !@targetIsPlayer
      fp["#{j}"].y = cy - 48*factor - k*2*factor - (reversed[j] ? 4*factor : 0) + 200 if @targetIsPlayer
      fp["#{j}"].x -= reversed[j] ? -4*factor : 4*factor
	  next if j>(i/4)
      fp["#{j}"].opacity += 16 if fp["#{j}"].opacity < 150
      fp["#{j}"].opacity -= 25 if i >= 48
	  fp["#{j}"].src_rect.x += 50 if j%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
    end
	if i >= 30
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
	end
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  #-----------------------------------------------------------------------------
  #  dispose sprites
  @userSprite.ox = @userSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
  #-----------------------------------------------------------------------------
end

#===== FILE: WHIRLWIND.rb =====#
#-------------------------------------------------------------------------------
#  Whirlwind
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WHIRLWIND) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  vector2 = @scene.getRealVector(@userIndex, @userIsPlayer)
  # set up animation
  fp = {}
  rndx = []; prndx = []
  rndy = []; prndy = []
  rangl = []
  dx = []
  dy = []
  for i in 0...128
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb423")
    fp["#{i}"].ox = fp["#{i}"].bitmap.width/2
    fp["#{i}"].oy = fp["#{i}"].bitmap.height/2
    fp["#{i}"].visible = false
    fp["#{i}"].z = @targetSprite.z + 1
    rndx.push(rand(256)); prndx.push(rand(72))
    rndy.push(rand(256)); prndy.push(rand(72))
    rangl.push(rand(9))
    dx.push(0)
    dy.push(0)
  end
  shake = 4
  # start animation
  @vector.set(vector2)
  pbSEPlay("Anim/Whirlwind")
  for i in 0...72
    ax, ay = @userSprite.getCenter
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...128
      next if j>(i*2)
      if !fp["#{j}"].visible
        dx[j] = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
        dy[j] = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
        fp["#{j}"].x = dx[j]
        fp["#{j}"].y = dy[j]
        fp["#{j}"].visible = true
      end
      x0 = ax - 46*@userSprite.zoom_x*0.5 + prndx[j]*@userSprite.zoom_x*0.5
      y0 = ay - 46*@userSprite.zoom_y*0.5 + prndy[j]*@userSprite.zoom_y*0.5
      x2 = cx - 128*@targetSprite.zoom_x*0.5 + rndx[j]*@targetSprite.zoom_x*0.5
      y2 = cy - 128*@targetSprite.zoom_y*0.5 + rndy[j]*@targetSprite.zoom_y*0.5
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].angle += rangl[j]*2
      nextx = fp["#{j}"].x
      nexty = fp["#{j}"].y
      if !@targetIsPlayer
        fp["#{j}"].opacity -= 51 if nextx > cx && nexty < cy
      else
        fp["#{j}"].opacity -= 51 if nextx < cx && nexty > cy
      end
    end
    if i >= 64
      @targetSprite.x += 64*(@targetIsPlayer ? -1 : 1)
    elsif i >= 52
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(vector) if i == 16
    @vector.inc = 0.1 if i == 16
    @scene.wait(1,i < 64)
  end
  @targetSprite.visible = false
  @targetSprite.hidden = true
  @targetSprite.ox = @targetSprite.bitmap.width/2
  pbDisposeSpriteHash(fp)
  @vector.reset
  @vector.inc = 0.2
  @scene.wait(16,true)
end

#===== FILE: WILDCHARGE.rb =====#
#-------------------------------------------------------------------------------
#  WILDCHARGE
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WILDCHARGE) do
  vector = @scene.getRealVector(@targetIndex, @targetIsPlayer)
  # set up animation
  frame = []
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb614_bg")
  fp["bg"].color = Color.new(0,0,0,255)
  fp["bg"].opacity = 0
  for j in 0...16
    fp["f#{j}"] = Sprite.new(@viewport)
    fp["f#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_3")
    fp["f#{j}"].ox = fp["f#{j}"].bitmap.width/2
    fp["f#{j}"].oy = fp["f#{j}"].bitmap.height/2
    fp["f#{j}"].x = @userSprite.x - 64*@userSprite.zoom_x + rand(128)*@userSprite.zoom_x
    fp["f#{j}"].y = @userSprite.y - 16*@userSprite.zoom_y + rand(32)*@userSprite.zoom_y
    fp["f#{j}"].visible = false
    z = [1,0.75,0.5,0.8][rand(4)]
    fp["f#{j}"].zoom_x = @userSprite.zoom_x*z
    fp["f#{j}"].zoom_y = @userSprite.zoom_y*z
    fp["f#{j}"].z = @userSprite.z + 1
    frame.push(0)
  end
  # animation start
  pbSEPlay("EBDX/Anim/electric1",100)
  pbSEPlay("EBDX/Anim/electric2",100)
  @sprites["battlebg"].defocus
  for i in 0...48
    for j in 0...16
      next if j>(i/2)
      fp["f#{j}"].visible = true
      fp["f#{j}"].y -= 8*@userSprite.zoom_y
      fp["f#{j}"].opacity -= 32 if frame[j] >= 8
      frame[j] += 1
    end
    fp["bg"].opacity += 8 if i >= 32
    @scene.wait(1,true)
  end
  pbSEPlay("Anim/Thunder1",80)
  @vector.set(vector)
  @scene.wait(16,true)
  cx, cy = @targetSprite.getCenter
  fp["flare"] = Sprite.new(@viewport)
  fp["flare"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb069")
  fp["flare"].ox = fp["flare"].bitmap.width/2
  fp["flare"].oy = fp["flare"].bitmap.height/2
  fp["flare"].x = cx
  fp["flare"].y = cy
  fp["flare"].zoom_x = @targetSprite.zoom_x
  fp["flare"].zoom_y = @targetSprite.zoom_y
  fp["flare"].z = @targetSprite.z
  fp["flare"].opacity = 0
  pbSEPlay("EBDX/Anim/electric1",100)
  pbSEPlay("EBDX/Anim/electric2",100)
  for j in 0...3
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_3")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    fp["#{j}"].x = cx - 32 + rand(64)
    fp["#{j}"].y = cy - 32 + rand(64)
    fp["#{j}"].z = @targetSprite.z + 1
    fp["#{j}"].visible = false
    fp["#{j}"].zoom_x = @targetSprite.zoom_x
    fp["#{j}"].zoom_y = @targetSprite.zoom_y
	fp["#{j}"].angle += 32
  end
  for m in 0...12
    fp["p#{m}"] = Sprite.new(@viewport)
    fp["p#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb064_3")
    fp["p#{m}"].ox = fp["p#{m}"].bitmap.width/2
    fp["p#{m}"].oy = fp["p#{m}"].bitmap.height/2
    fp["p#{m}"].x = cx - 48 + rand(96)
    fp["p#{m}"].y = cy - 48 + rand(96)
    fp["p#{m}"].z = @targetSprite.z + 2
    fp["p#{m}"].visible = false
    fp["p#{m}"].zoom_x = @targetSprite.zoom_x
    fp["p#{m}"].zoom_y = @targetSprite.zoom_y
	fp["p#{m}"].angle += 32
  end
  pbSEPlay("EBDX/Anim/electric1",100)
  pbSEPlay("EBDX/Anim/electric2",100)
  @targetSprite.color = Color.new(0,0,0,0)
  for i in 0...64
    fp["bg"].opacity += 16 if fp["bg"].opacity < 255 && i < 32
    fp["bg"].color.alpha -= 32 if fp["bg"].color.alpha > 0
    fp["flare"].opacity += 32*(i < 8 ? 1 : -1)
    fp["flare"].angle += 5
    pbSEPlay("EBDX/Anim/electric1",80) if i == 8
    for j in 0...3
      next if i < 12
      next if j>(i-12)/4
      fp["#{j}"].visible = true
      fp["#{j}"].opacity -= 16
      fp["#{j}"].angle += 3
      fp["#{j}"].zoom_x += 0.1
      fp["#{j}"].zoom_y += 0.1
    end
    for m in 0...12
      next if i < 6
      next if m>(i-6)
      fp["p#{m}"].visible = true
      fp["p#{m}"].opacity -= 16
      fp["p#{m}"].y -= 8
    end
    if i >= 48
      fp["bg"].opacity -= 16
      @targetSprite.color.alpha -= 16
    else
      @targetSprite.color.alpha += 16 if @targetSprite.color.alpha < 192
    end
    @targetSprite.anim = true
    @scene.wait
  end
  @sprites["battlebg"].focus
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: WILLOWISP.rb =====#
#-------------------------------------------------------------------------------
#  WILLOWISP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WILLOWISP) do
  itself = (@userIndex==@targetIndex)
  # set up animation
  fp = {}
  rndx = []
  rndy = []
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(128,128,128))
  fp["bg"].opacity = 0
  for i in 0...10
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb136_2")
    fp["#{i}"].src_rect.set(0,101*rand(3),53,101)
    fp["#{i}"].ox = 26
    fp["#{i}"].oy = 101
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = (@targetIsPlayer ? 29 : 19)
    rndx.push(rand(64))
    rndy.push(rand(64))
  end
  shake = 2
  # start animation
  @sprites["battlebg"].defocus
  for i in 0...132
    ax, ay = @userSprite.getAnchor
    cx, cy = @targetSprite.getCenter(true)
    for j in 0...10
      if fp["#{j}"].opacity == 0 && fp["#{j}"].tone.gray == 0
        fp["#{j}"].zoom_x = @userSprite.zoom_x
        fp["#{j}"].zoom_y = @userSprite.zoom_y
        fp["#{j}"].x = ax
        fp["#{j}"].y = ay + 50*@userSprite.zoom_y
      end
      next if j>(i/4)
      x2 = cx - 32*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 32*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y + 50*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.1
      fp["#{j}"].y += (y2 - y0)*0.1
      fp["#{j}"].zoom_x -= (fp["#{j}"].zoom_x - @targetSprite.zoom_x)*0.1
      fp["#{j}"].zoom_y -= (fp["#{j}"].zoom_y - @targetSprite.zoom_y)*0.1
      fp["#{j}"].src_rect.x += 53 if i%4==0
      fp["#{j}"].src_rect.x = 0 if fp["#{j}"].src_rect.x >= fp["#{j}"].bitmap.width
      if (x2 - x0)*0.1 < 1 && (y2 - y0)*0.1 < 1
        fp["#{j}"].opacity -= 8
        fp["#{j}"].tone.gray += 8
        fp["#{j}"].tone.red -= 2; fp["#{j}"].tone.green -= 2; fp["#{j}"].tone.blue -= 2
        fp["#{j}"].zoom_x -= 0.02
        fp["#{j}"].zoom_y += 0.04
      else
        fp["#{j}"].opacity += 12
      end
    end
    fp["bg"].opacity += 5 if fp["bg"].opacity < 255*0.5
    pbSEPlay("Anim/Fire2",80) if i%12==0 && i <= 96
    pbSEPlay("Anim/Smokescreen",120) if i==84
    if i >= 96
      @targetSprite.tone.red += 2.4*2 if @targetSprite.tone.red < 48*2
      @targetSprite.tone.green -= 1.2*2 if @targetSprite.tone.green > -24*2
      @targetSprite.tone.blue -= 2.4*2 if @targetSprite.tone.blue > -48*2
      @targetSprite.ox += shake
      shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @vector.set(EliteBattle.get_vector(:DUAL)) if i == 24
    @vector.inc = 0.1 if i == 24
    @scene.wait(1,true)
  end
  20.times do
    @targetSprite.tone.red -= 2.4*2
    @targetSprite.tone.green += 1.2*2
    @targetSprite.tone.blue += 2.4*2
    @targetSprite.ox += shake
    shake = -2 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
    shake = 2 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
    @targetSprite.still
    fp["bg"].opacity -= 15
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  @vector.inc = 0.2
  pbDisposeSpriteHash(fp)
end

#===== FILE: WINGATTACK.rb =====#
#-------------------------------------------------------------------------------
#  Wing Attack
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WINGATTACK) do
  pbSEPlay("EBDX/Anim/flying1",80)
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  cx, cy = @targetSprite.getCenter(true)
  for i in 0...12
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 51
    r = rand(3)
    fp["#{i}"].zoom_x = (factor-0.5)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (factor-0.5)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  wait = []
  for m in 0...8
    fp["w#{m}"] = Sprite.new(@viewport)
    fp["w#{m}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb164")
    fp["w#{m}"].ox = 20
    fp["w#{m}"].oy = 16
    fp["w#{m}"].opacity = 0
    fp["w#{m}"].z = 50
    fp["w#{m}"].angle = rand(360)
    fp["w#{m}"].zoom_x = factor - 0.5
    fp["w#{m}"].zoom_y = factor - 0.5
    fp["w#{m}"].x = cx - 32*factor + rand(64*factor)
    fp["w#{m}"].y = cy - 112*factor + rand(112*factor)
    wait.push(0)
  end
  pbSEPlay("EBDX/Anim/normal1",80)
  frame = Sprite.new(@viewport)
  frame.z = 51
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303")
  frame.src_rect.set(0,0,64,64)
  frame.ox = 32
  frame.oy = 32
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  frame.y -= 32*@targetSprite.zoom_y
  # start animation
  for i in 1..30
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 64 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for m in 0...8
      next if m>(i/2)
      fp["w#{m}"].angle += 2
      fp["w#{m}"].opacity += 32*(wait[m] < 8 ? 1 : -0.25)
      wait[m] +=  1
    end
    for j in 0...12
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: WISH.rb =====#
#-------------------------------------------------------------------------------
#  WISH
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WISH) do
  if @hitNum == 1
    EliteBattle.playMoveAnimation(:RECOVER, @scene, @userIndex, @targetIndex)
  elsif @hitNum == 0
    EliteBattle.playMoveAnimation(:WISH_CAST, @scene, @userIndex, @targetIndex)
  end
end

EliteBattle.defineMoveAnimation(:WISH_CAST) do
  @vector.set(@scene.getRealVector(@userIndex, @userIsPlayer))
  fp = {}
  # set up animation
  @scene.wait(5,true)
  factor = @userSprite.zoom_x
  cx, cy = @userSprite.getCenter(true)
  dx = []
  dy = []
  fp = {}
  t = 35
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  for j in 0...t
    fp["#{j}"] = Sprite.new(@viewport)
    fp["#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb619")
    fp["#{j}"].ox = fp["#{j}"].bitmap.width/2
    fp["#{j}"].oy = fp["#{j}"].bitmap.height/2
    r = 64*factor
    x, y = randCircleCord(r)
    x = cx - r + x
    y = cy - r + y
    fp["#{j}"].x = cx
    fp["#{j}"].y = cx
    fp["#{j}"].z = @userSprite.z
    fp["#{j}"].visible = false
    fp["#{j}"].angle = rand(360)
    z = [0.5,1,0.75][rand(3)]
    fp["#{j}"].zoom_x = z
    fp["#{j}"].zoom_y = z
    dx.push(x)
    dy.push(y)
  end
  # start animation

  pbSEPlay("Anim/Wish",80)
  for i in 0...2*t
    for j in 0...t
      next if j>(i*2)
      fp["#{j}"].visible = true
      if ((fp["#{j}"].x - dx[j])*0.1).abs < 1
        fp["#{j}"].opacity -= 32
      else
        fp["#{j}"].x -= (fp["#{j}"].x - dx[j])*0.1
        fp["#{j}"].y -= (fp["#{j}"].y - dy[j])*0.1
      end
    end
    @scene.wait
  end
  16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: WITHDRAW.rb =====#
#-------------------------------------------------------------------------------
#  WITHDRAW
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WITHDRAW) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(153,204,255))
  fp["bg"].opacity = 0
  fp["wrap1"] = Sprite.new(@viewport)
  fp["wrap1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_2")
  fp["wrap1"].ox = fp["wrap1"].bitmap.width/2 - 10
  fp["wrap1"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap1"].angle = -90
  fp["wrap1"].opacity = 0
  fp["wrap1"].z = 41
  fp["wrap2"] = Sprite.new(@viewport)
  fp["wrap2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_2")
  fp["wrap2"].ox = fp["wrap1"].bitmap.width/2 + 10
  fp["wrap2"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap2"].opacity = 0
  fp["wrap2"].z = 40
  fp["wrap2"].mirror = true
  fp["wrap2"].angle = 90
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...80
    cx, cy = @targetSprite.getCenter(true)
    fp["wrap1"].x = cx; fp["wrap1"].y = cy
    fp["wrap1"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap1"].zoom_y = 1.5*@targetSprite.zoom_y
    fp["wrap2"].x = cx; fp["wrap2"].y = cy
    fp["wrap2"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap2"].zoom_y = 1.5*@targetSprite.zoom_y
    if i.between?(20,35)
      fp["wrap1"].opacity += 5
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity += 5
      fp["wrap2"].oy += 2
    elsif i.between?(35,45)
      fp["wrap1"].opacity += 25.5
      fp["wrap1"].oy -= 2
      fp["wrap2"].opacity += 25.5
      fp["wrap2"].oy -= 2
    else
      fp["wrap1"].opacity -= 26
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity -= 26
      fp["wrap2"].oy += 2
    end
    if i==20 || i == 30
      pbSEPlay("Anim/Bubble1")
	  pbSEPlay("Anim/Bubble2")
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: WOODHAMMER.rb =====#
#-------------------------------------------------------------------------------
#  WOODHAMMER
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WOODHAMMER) do
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  pbSEPlay("EBDX/Anim/iron2",80,80)
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...2
    4.times do
      @userSprite.x += 8*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @userSprite.x -= 2*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @scene.wait
    end
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb208_2")
    fp["#{i}"].ox = 6
    fp["#{i}"].oy = 6
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
	fp["#{i}"].angle = rand(360)
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  factor = 1
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb520_2")
  frame.src_rect.set(0,0,114,114)
  frame.ox = 57
  frame.oy = 57
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  # start animation
  for i in 1..30
    if i == 6
      pbSEPlay("EBDX/Anim/grass1",100)
      pbSEPlay("EBDX/Anim/iron1",80)
    end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 114 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...16
      next if i < 6
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      fp["#{j}"].angle += 2
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

#===== FILE: WRAP.rb =====#
#-------------------------------------------------------------------------------
#  WRINGOUT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WRINGOUT) do
  EliteBattle.playMoveAnimation(:WRAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  CONSTRICT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:CONSTRICT) do
  EliteBattle.playMoveAnimation(:WRAP, @scene, @userIndex, @targetIndex, @hitNum, @multiHit, nil, true)
end
#-------------------------------------------------------------------------------
#  WRAP
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:WRAP) do
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(66,60,81))
  fp["bg"].opacity = 0
  fp["wrap1"] = Sprite.new(@viewport)
  fp["wrap1"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_3")
  fp["wrap1"].ox = fp["wrap1"].bitmap.width/2 - 10
  fp["wrap1"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap1"].angle = -90
  fp["wrap1"].opacity = 0
  fp["wrap1"].z = 41
  fp["wrap2"] = Sprite.new(@viewport)
  fp["wrap2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb028_3")
  fp["wrap2"].ox = fp["wrap1"].bitmap.width/2 + 10
  fp["wrap2"].oy = fp["wrap1"].bitmap.height - 60
  fp["wrap2"].opacity = 0
  fp["wrap2"].z = 40
  fp["wrap2"].mirror = true
  fp["wrap2"].angle = 90
  shake = 4
  # start animation
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @sprites["battlebg"].defocus
  for i in 0...80
    cx, cy = @targetSprite.getCenter(true)
    fp["wrap1"].x = cx; fp["wrap1"].y = cy
    fp["wrap1"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap1"].zoom_y = 1.5*@targetSprite.zoom_y
    fp["wrap2"].x = cx; fp["wrap2"].y = cy
    fp["wrap2"].zoom_x = 1.5*@targetSprite.zoom_x; fp["wrap2"].zoom_y = 1.5*@targetSprite.zoom_y
    if i.between?(20,35)
      fp["wrap1"].opacity += 5
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity += 5
      fp["wrap2"].oy += 2
    elsif i.between?(35,45)
      fp["wrap1"].opacity += 25.5
      fp["wrap1"].oy -= 2
      fp["wrap2"].opacity += 25.5
      fp["wrap2"].oy -= 2
    else
      fp["wrap1"].opacity -= 26
      fp["wrap1"].oy += 2
      fp["wrap2"].opacity -= 26
      fp["wrap2"].oy += 2
    end
    if i==32
      pbSEPlay("Anim/Wrap")
    end
    fp["bg"].opacity += 4 if  i < 40
    if i >= 40
      fp["bg"].opacity -= 10 if i >= 56
      @targetSprite.ox += shake
      shake = -4 if @targetSprite.ox > @targetSprite.bitmap.width/2 + 2
      shake = 4 if @targetSprite.ox < @targetSprite.bitmap.width/2 - 2
      @targetSprite.still
    end
    @scene.wait(1,true)
  end
  @sprites["battlebg"].focus
  @targetSprite.ox = @targetSprite.bitmap.width/2
  @vector.reset if !@multiHit
  pbDisposeSpriteHash(fp)
end

#===== FILE: XSCISSOR.rb =====#
#-------------------------------------------------------------------------------
#  XSCISSOR
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:XSCISSOR) do
  factor = @targetSprite.zoom_x
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(8,true)
  factor = @targetSprite.zoom_x
  cx, cy = @targetSprite.getCenter(true)
  j = 0
  rndx = []
  rndy = []
  # set up animation
  fp = {}
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.new(204,255,204))
  fp["bg"].opacity = 0
  fp["claw"] = Sprite.new(@viewport)
  fp["claw"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb602_2")
  fp["claw"].ox = fp["claw"].bitmap.width/2
  fp["claw"].oy = fp["claw"].bitmap.height/2
  fp["claw"].x = cx
  fp["claw"].y = cy
  fp["claw"].zoom_x = factor
  fp["claw"].zoom_y = factor
  fp["claw"].src_rect.height = 0
  fp["claw"].z = @targetSprite.z + 1
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb303_2_4")
    fp["#{i}"].ox = 10
    fp["#{i}"].oy = 10
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(64))
  end
  pbSEPlay("EBDX/Anim/ground1",75)
  @scene.wait(1,true)
  flashStart = 2
  for i in 1..20
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
    end
	cx, cy = @targetSprite.getCenter(true)
	for k in 0...16
		next if i < 4
		if j == 0 && i == 6
			fp["bg"].opacity += 45 if k.between?(flashStart,flashStart+2)
			fp["bg"].opacity -= 45 if k.between?(flashStart+3,flashStart+4)
			@targetSprite.still if k.between?(flashStart,flashStart+2)
			@targetSprite.zoom_y+=0.05*factor if k.between?(flashStart,flashStart+2)
			@targetSprite.tone.all+=12.8 if k.between?(flashStart,flashStart+2)
			@scene.wait(1,true)
			pbSEPlay("EBDX/Anim/normal3",100) if k == 4
			fp["claw"].src_rect.height += 15
			fp["claw"].opacity -= 45 if k >= 5
			j = 1 if k == 15		
		end
		#
		if fp["#{k}"].opacity == 0 && fp["#{k}"].visible
			fp["#{k}"].x = cx
			fp["#{k}"].y = cy
		end
		x2 = cx - 64*@targetSprite.zoom_x + rndx[k]*@targetSprite.zoom_x
		y2 = cy - 64*@targetSprite.zoom_y + rndy[k]*@targetSprite.zoom_y
		x0 = fp["#{k}"].x
		y0 = fp["#{k}"].y
		fp["#{k}"].x += (x2 - x0)*0.2
		fp["#{k}"].y += (y2 - y0)*0.2
		fp["#{k}"].zoom_x += 0.01
		fp["#{k}"].zoom_y += 0.01
		if i < 20
			fp["#{k}"].tone.red -= 6; fp["#{k}"].tone.blue -= 6; fp["#{k}"].tone.green -= 6
		end
		if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
			fp["#{k}"].opacity -= 51
		else
			fp["#{k}"].opacity += 51
		end
		fp["#{k}"].visible = false if fp["#{k}"].opacity <= 0
		#
	end
	@scene.wait(1,true)
  end
  @scene.wait(1,true)
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end
#-------------------------------------------------------------------------------

#===== FILE: ZAPCANNON.rb =====#
#-------------------------------------------------------------------------------
#  ZAPCANNON
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ZAPCANNON) do
  x1, y1 = @targetSprite.getCenter(true)
  x2, y2 = @userSprite.getCenter(true)
  if @targetIsPlayer
    cx = x1 + (x2 - x1)*0.65
    cy = y1 - (y1 - y2)*0.65
  else
    cx = x2 + (x1 - x2)*0.5
    cy = y2 - (y2 - y1)*0.5
  end
  fp = {}
  #
  fp["bg"] = Sprite.new(@viewport)
  fp["bg"].bitmap = Bitmap.new(@viewport.width,@viewport.height)
  fp["bg"].bitmap.fill_rect(0,0,fp["bg"].bitmap.width,fp["bg"].bitmap.height,Color.black)
  fp["bg"].opacity = 0
  #
  for j in 0...16
    fp["p#{j}"] = Sprite.new(@viewport)
    fp["p#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610_2")
    fp["p#{j}"].oy = fp["p#{j}"].bitmap.height/2
    fp["p#{j}"].x = cx
    fp["p#{j}"].y = cy
    fp["p#{j}"].opacity = 0
    fp["p#{j}"].z = 20
  end
  for j in 0...32
    fp["c#{j}"] = Sprite.new(@viewport)
    fp["c#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610_1")
    fp["c#{j}"].opacity = 0
    fp["c#{j}"].angle = rand(360)
    fp["c#{j}"].ox = 12
    fp["c#{j}"].oy = 18 + rand(24)
    fp["c#{j}"].x = cx
    fp["c#{j}"].y = cy
    fp["c#{j}"].z = 20
    fp["c#{j}"].color = Color.new(255,255,0,0)
    fp["c#{j}"].toggle = 1
  end
  fp["circle"] = Sprite.new(@viewport)
  fp["circle"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610")
  fp["circle"].center!
  fp["circle"].x = cx
  fp["circle"].y = cy
  fp["circle"].zoom_x = 0
  fp["circle"].zoom_y = 0
  fp["circle"].z = 20
  pbSEPlay("Anim/Heal4")
  #start animation
  #
  16.times do
    fp["bg"].opacity += 12
    @scene.wait(1,true)
  end
  #
  for i in 0...64
    fp["circle"].zoom_x += 0.125 if fp["circle"].zoom_x < 1
    fp["circle"].zoom_y += 0.125 if fp["circle"].zoom_y < 1
    fp["circle"].angle += 8
    for j in 0...16
      next if j > i/4
      if fp["p#{j}"].ox >= -16
        fp["p#{j}"].ox = -128
        fp["p#{j}"].angle = rand(360)
        fp["p#{j}"].opacity = 0
      end
      fp["p#{j}"].opacity += 32
      fp["p#{j}"].ox += 16
    end
    for j in 0...32
      fp["c#{j}"].toggle *= -1 if i%4==0
      next if j > i/2
      fp["c#{j}"].opacity += 16
      fp["c#{j}"].color.alpha = 255*fp["c#{j}"].toggle
    end
	pbSEPlay("Anim/Paralyze1",85) if i%8==0
    @scene.wait
  end
  for key in fp.keys
    next if key == "circle" || key == "bg"
    fp[key].dispose
    fp.delete(key)
  end
  fp["circle2"] = Sprite.new(@viewport)
  fp["circle2"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610_3")
  fp["circle2"].center!
  fp["circle2"].x = cx
  fp["circle2"].y = cy
  fp["circle2"].z = fp["circle"].z - 1
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))

  16.times do
    fp["circle2"].zoom_x = @vector.zoom1
    fp["circle2"].zoom_y = @vector.zoom1
    fp["circle"].zoom_x = @vector.zoom1
    fp["circle"].zoom_y = @vector.zoom1
    x1, y1 = @targetSprite.getCenter(true)
    x2, y2 = @userSprite.getCenter(true)
    if @targetIsPlayer
      cx = x1 + (x2 - x1)*0.65
      cy = y1 - (y1 - y2)*0.65
    else
      cx = x2 + (x1 - x2)*0.5
      cy = y2 - (y2 - y1)*0.5
    end
    fp["circle2"].x = cx
    fp["circle2"].y = cy
    fp["circle"].x = cx
    fp["circle"].y = cy
    fp["circle"].angle += 8
    @scene.wait(1,true)
  end
  fp["circle"].visible = false
  fp["circle2"].z = @targetSprite.z + 1
  pbSEPlay("Anim/Flash")
  8.times do
    fp["circle2"].x += (x1 - fp["circle2"].x)*0.5
    fp["circle2"].y -= (fp["circle2"].y - y1)*0.5
    @scene.wait
  end
  fp["circle2"].visible = false
  @targetSprite.anim = true
  @targetSprite.color = Color.new(240,240,0)
  2.times do
    @targetSprite.anim = true
    @scene.wait
  end
  for j in 0...16
    fp["i#{j}"] = Sprite.new(@viewport)
    fp["i#{j}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb610_4")
    fp["i#{j}"].ox = fp["i#{j}"].bitmap.width/2
    fp["i#{j}"].oy = fp["i#{j}"].bitmap.height
    fp["i#{j}"].angle = rand(360)
    fp["i#{j}"].z = @targetSprite.z + 1
    fp["i#{j}"].x = x1
    fp["i#{j}"].y = y1
  end
  pbSEPlay("EBDX/Anim/electric1",85)
  for i in 0...32
    for j in 0...16
      next if j > i
      fp["i#{j}"].opacity -= 16
      fp["i#{j}"].oy += 8
    end
    @targetSprite.color.alpha -= 16
    @targetSprite.anim = true
    @scene.wait
  end
    16.times do
    fp["bg"].opacity -= 20
    @scene.wait(1,true)
  end
  pbDisposeSpriteHash(fp)
  @vector.reset
end

#===== FILE: ZENHEADBUTT.rb =====#
#-------------------------------------------------------------------------------
#  ZENHEADBUTT
#-------------------------------------------------------------------------------
EliteBattle.defineMoveAnimation(:ZENHEADBUTT) do
  factor = @targetSprite.zoom_x
  # set up animation
  fp = {}; rndx = []; rndy = []
  pbSEPlay("EBDX/Anim/iron2",80,80)
  pbSEPlay("EBDX/Anim/ground1",80)
  for i in 0...2
    4.times do
      @userSprite.x += 8*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @userSprite.x -= 2*(@targetIsPlayer ? -1 : 1)*(i==0 ? 1 : -1)
      @scene.wait
    end
  end
  @vector.set(@scene.getRealVector(@targetIndex, @targetIsPlayer))
  @scene.wait(16,true)
  for i in 0...16
    fp["#{i}"] = Sprite.new(@viewport)
    fp["#{i}"].bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb59_3_2")
    fp["#{i}"].ox = 6
    fp["#{i}"].oy = 6
    fp["#{i}"].opacity = 0
    fp["#{i}"].z = 50
	fp["#{i}"].angle = rand(360)
    r = rand(3)
    fp["#{i}"].zoom_x = (@targetSprite.zoom_x)*(r==0 ? 1 : 0.5)
    fp["#{i}"].zoom_y = (@targetSprite.zoom_y)*(r==0 ? 1 : 0.5)
    fp["#{i}"].tone = Tone.new(60,60,60)
    rndx.push(rand(128))
    rndy.push(rand(128))
  end
  factor = 1
  frame = Sprite.new(@viewport)
  frame.z = 50
  frame.bitmap = pbBitmap("Graphics/EBDX/Animations/Moves/eb520_4")
  frame.src_rect.set(0,0,114,114)
  frame.ox = 57
  frame.oy = 57
  frame.zoom_x = 0.5*factor
  frame.zoom_y = 0.5*factor
  frame.x, frame.y = @targetSprite.getCenter(true)
  frame.opacity = 0
  frame.tone = Tone.new(255,255,255)
  # start animation
  for i in 1..30
    if i == 6
      pbSEPlay("EBDX/Anim/psychic3",100)
      pbSEPlay("EBDX/Anim/iron1",80)
    end
    if i.between?(1,5)
      @targetSprite.still
      @targetSprite.zoom_y-=0.05*factor
      @targetSprite.tone.all-=12.8
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.opacity += 51
    end
    frame.tone = Tone.new(0,0,0) if i == 6
    if i.between?(6,10)
      @targetSprite.still
      @targetSprite.zoom_y+=0.05*factor
      @targetSprite.tone.all+=12.8
      frame.angle += 2
    end
    frame.src_rect.x = 114 if i == 10
    if i >= 10
      frame.opacity -= 25.5
      frame.zoom_x += 0.1*factor
      frame.zoom_y += 0.1*factor
      frame.angle += 2
    end
    for j in 0...16
      next if i < 6
      cx = frame.x; cy = frame.y
      if fp["#{j}"].opacity == 0 && fp["#{j}"].visible
        fp["#{j}"].x = cx
        fp["#{j}"].y = cy
      end
      x2 = cx - 64*@targetSprite.zoom_x + rndx[j]*@targetSprite.zoom_x
      y2 = cy - 64*@targetSprite.zoom_y + rndy[j]*@targetSprite.zoom_y
      x0 = fp["#{j}"].x
      y0 = fp["#{j}"].y
      fp["#{j}"].x += (x2 - x0)*0.2
      fp["#{j}"].y += (y2 - y0)*0.2
      fp["#{j}"].zoom_x += 0.01
      fp["#{j}"].zoom_y += 0.01
      fp["#{j}"].angle += 2
      if i < 20
        fp["#{j}"].tone.red -= 6; fp["#{j}"].tone.blue -= 6; fp["#{j}"].tone.green -= 6
      end
      if (x2 - x0)*0.2 < 1 && (y2 - y0)*0.2 < 1
        fp["#{j}"].opacity -= 51
      else
        fp["#{j}"].opacity += 51
      end
      fp["#{j}"].visible = false if fp["#{j}"].opacity <= 0
    end
    @scene.wait
  end
  frame.dispose
  pbDisposeSpriteHash(fp)
  @vector.reset if !@multiHit
end

